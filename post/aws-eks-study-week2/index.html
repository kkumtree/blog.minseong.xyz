<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 2ì£¼ì°¨ | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 2ì£¼ì°¨" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week2/cover.png' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week2/cover.png' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week2/cover.png' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.8c1fb07f2dee90a6523f7317a7d023e3c1b14bd4706bff237c94e366d59facf9.css">
</head><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>
     
     <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸŒ
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
            
            
          </ul>
        </li>
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
<div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.png'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 2ì£¼ì°¨</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-05-04T16:37:11&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/network" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">network</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <pre tabindex="0"><code class="language-note" data-lang="note"># ì•„ì‰½ê²Œë„ ì‹ ê·œ í•­ëª©ì¸ istio, kube-ops-viewëŠ” ì‹¤ìŠµ ì‹¤íŒ¨
- istio: `myhome.yaml` ì„ ì–´ë–»ê²Œ ìƒì„±í• ì§€ ëª°ë¼ì„œ ì¤‘ë‹¨
- kube-ops-view: Aë ˆì½”ë“œì— ì œëŒ€ë¡œ ì¡íˆì§€ ì•ŠìŒ
</code></pre><p>ì§€ë‚œ 1ì£¼ì°¨ì— ì´ì–´, ì´ë²ˆ ì£¼ì—ëŠ” EKSì˜ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ì— ëŒ€í•´ ì•Œì•„ë³´ëŠ” ì‹œê°„ì´ì—ˆìŠµë‹ˆë‹¤.</p>
<p>ì§ì „ ìŠ¤í„°ë””ì—ì„œë„ ë°”ë¡œ ê´‘íƒˆë‹¹í•˜ë‚˜?í•˜ë©° ë°¤ê³¼ ì£¼ë§ì„ í•˜ì–—ê²Œ ë¶ˆíƒœì› ì„ ì •ë„ë¡œ<br>
ê°€ì¥ ê³ ë‚œë„ë¼ê³  ìƒê°í–ˆë˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ë‹¤ì‹œ ë§Œë‚˜ë‹ˆ ì´ì œ 1% ì¹œê·¼ê°ì´ ëŠê»´ì§€ê³  ìˆë„¤ìš”.</p>
<p><img src="./images/00_intro.jpeg" alt="ì´í•´í–ˆëƒê³ ìš”?"></p>
<p>ì ê·¸ëŸ¼ í•´ë³´ë„ë¡ í•©ì‹œë‹¤.</p>
<h2 id="1-cloudformationì„-í™œìš©í•œ-eks-ì›í´ë¦­-êµ¬ì„±">1. cloudformationì„ í™œìš©í•œ EKS ì›í´ë¦­ êµ¬ì„±</h2>
<ul>
<li>í•™ìŠµì„ ìœ„í•´, ì´ë²ˆì—ë„ <a href="https://www.notion.so/gasidaseo/CloudNet-Blog-c9dfa44a27ff431dafdd2edacc8a1863">ê°€ì‹œë‹¤</a>ë‹˜ì´ ì¤€ë¹„í•´ì£¼ì‹  ì›í´ë¦­ ë°°í¬ yamlì„ í™œìš©í•˜ì—¬ ë°°í¬.</li>
<li><strong>ì™„ì „ ë°°í¬ê¹Œì§€ ëŒ€ëµ 20ë¶„ ê°€ëŸ‰ ì†Œìš”</strong></li>
<li>IAMì—ì„œ ë¯¸ë¦¬ ë°œê¸‰í•´ë‘” ì•¡ì„¸ìŠ¤í‚¤/ì‹œí¬ë¦¿í‚¤ë¥¼ ì•Œì•„ë‘ì–´ì•¼í•©ë‹ˆë‹¤.</li>
<li>ìŠ¤í¬ë¦°ìƒ·ì€ 1ì£¼ì°¨ë¡œ ê°ˆìŒ.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì›í´ë¦­ ì…‹ì—…</span>
</span></span><span style="display:flex;"><span>aws cloudformation deploy --template-file ~/Documents/aews/eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName<span style="color:#f92672">=</span>aews SgIngressSshCidr<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s ipinfo.io/ip<span style="color:#66d9ef">)</span>/32 MyIamUserAccessKeyID<span style="color:#f92672">={</span>ACSSKEY|AKIA..<span style="color:#f92672">}</span>  MyIamUserSecretAccessKey<span style="color:#f92672">={</span>SECUKEY|7ob..<span style="color:#f92672">}</span> ClusterBaseName<span style="color:#f92672">=</span>myeks --region ap-northeast-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸(ë§ˆìŠ¤í„°ë…¸ë“œ) ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh -i ~/.ssh/aews.pem ec2-user@<span style="color:#66d9ef">$(</span>aws cloudformation describe-stacks --stack-name myeks --query <span style="color:#e6db74">&#39;Stacks[*].Outputs[0].OutputValue&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><h2 id="2-aws-vpc-cni-wê¸°ë³¸-ì…‹ì—…-in-control-plane">2. AWS VPC CNI w/ê¸°ë³¸ ì…‹ì—… (in Control Plane)</h2>
<ul>
<li>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë¯¸ë¦¬ defaultë¡œ ì„¤ì •.<br>
ì´ê±¸ ê¹œë°•í•´ì„œ, ì§€ë‚œ ìŠ¤í„°ë”” ë•Œ í—›ëœ ì‹œí–‰ì°©ì˜¤ë¥¼ ë°˜ë³µí–ˆë˜ ì´ë ¥ì´ ìˆìŒ.</li>
<li>(ì›Œì»¤)ë…¸ë“œ IP í™•ì¸ ë° ë³€ìˆ˜ ì§€ì •<br>
ì›Œì»¤ë…¸ë“œëŠ” EKSì—ì„œ <code>ë°ì´í„°í”Œë ˆì¸</code>ì´ë¼ê³ ë„ í•¨.</li>
<li>eksctl addonìœ¼ë¡œ ì„¤ì¹˜ëœ ì•„ë˜ 3ê°€ì§€ í•­ëª©ì˜ ì •ìƒ ì„¤ì¹˜ í™•ì¸
<ul>
<li>codedns</li>
<li>kube-proxy</li>
<li><strong>vpc-cni</strong></li>
</ul>
</li>
<li>ìŠ¤í„°ë””ì—ì„œëŠ” ê²½ì´ë¡œìš´(?) AWS VPC CNIë¥¼ ì‚¬ìš©.<br>
Calico CNIì™€ ë‹¬ë¦¬ ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì˜ AWS ENI(Elastic Network Interface)ì™€ Podê°€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­(CIDR)ì„ ì‚¬ìš©í•œë‹¤!</li>
<li>ì˜ˆì‹œ:
<ul>
<li>eth0(ENI): 10.10.1.1/24</li>
<li>Pod1: 10.10.1.<strong>10</strong></li>
<li>Pod2: 10.10.1.<strong>20</strong></li>
</ul>
</li>
<li>ì‹¤ì œë¡œë„ ë°ì´í„°í”Œë ˆì¸ê³¼ Podê°€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ì‚¬ìš©í•œë‹¤.<br>
(ì‹¤ìŠµí•´ë³´ë‹ˆ ì™œ IPê¹Œì§€ ë™ì¼í•˜ì§€&hellip;? CIDR /32ê°€ ê±¸ë¦°ê±´ê°€? í˜¼ë€ì— ë¹ ì¡Œë‹¤!) <strong>(To-Do)</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„¤ì •</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl ns default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ IP í™•ì¸ ë° ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>N1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2a -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>N2<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2b -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>N3<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2c -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N1=</span>$N1<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N2=</span>$N2<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N3=</span>$N3<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile 
</span></span><span style="display:flex;"><span>echo $N1, $N2, $N3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ &lt;-&gt; ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ssh ì ‘ì†ì„ ìœ„í•´ ëª¨ë“  í”„ë¡œí† ì½œ í—ˆìš©</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NGSGID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ec2 describe-security-groups --filters Name<span style="color:#f92672">=</span>group-name,Values<span style="color:#f92672">=</span>*ng1* --query <span style="color:#e6db74">&#34;SecurityGroups[*].[GroupId]&#34;</span> --output text<span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>aws ec2 authorize-security-group-ingress --group-id $NGSGID --protocol <span style="color:#e6db74">&#39;-1&#39;</span> --cidr 192.168.1.100/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ssh ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 hostname 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 hostname 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 hostname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eksctl addon í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get addon --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2023-05-04 19:04:32 [â„¹]  Kubernetes version &#34;1.24&#34; in use by cluster &#34;myeks&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2023-05-04 19:04:32 [â„¹]  getting all addons</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2023-05-04 19:04:33 [â„¹]  to see issues for an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME  VERSION   STATUS </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># coredns  v1.9.3-eksbuild.3 ACTIVE </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-proxy v1.24.10-eksbuild.2 ACTIVE </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vpc-cni  v1.12.6-eksbuild.1 ACTIVE </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS VPC CNI ê´€ë ¨</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê°ê° ë…¸ë“œ(ì»¨íŠ¸ë¡¤í”Œë ˆì¸)IP ì™€ Pod IP í™•ì¸í•˜ëŠ” ëª…ë ¹ì–´</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output table
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -o<span style="color:#f92672">=</span>custom-columns<span style="color:#f92672">=</span>NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-proxy config í™•ì¸ (mode: â€œiptablesâ€ ì‚¬ìš©)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe cm -n kube-system kube-proxy-config | grep mode
</span></span></code></pre></div><p><img src="./images/01_oneclick.png" alt="oneclick_templete"></p>
<p><img src="./images/02_oneclick-node-setup.png" alt="oneclick-node-setup"></p>
<p><img src="./images/03_eks-addon.png" alt="eksctl_addon"></p>
<p><img src="./images/04_kube-proxy-config.png" alt="kube-proxy-config"></p>
<h3 id="2-1-kube-proxyì—ì„œ-ipvs-ëŒ€ì‹ -iptablesë¥¼-ì‚¬ìš©í•˜ëŠ”-ì´ìœ ">2-1. kube-proxyì—ì„œ ipvs ëŒ€ì‹  iptablesë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ?</h3>
<ul>
<li>
<p>ê°€ì‹œë‹¤ë‹˜ì´ ì„¤ëª…í•˜ì‹œê¸¸ ARPê³ ì •ì´ë‚˜ ê°€ìƒ ì¸í„°í˜ì´ìŠ¤ ì´ìŠˆ ë“±ìœ¼ë¡œ iptablesë¥¼ ì“°ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤ê³  í•˜ì˜€ìŒ.</p>
</li>
<li>
<p>ë” ì°¾ì•„ë³´ë‹ˆ, í•´ë‹¹ ì´ìŠˆëŠ” <code>19ë…„ 1ì›”</code>ë¶€í„° ì œê¸°ë˜ì–´ ì™”ìŒ.<br>
ì°¸ì¡°: <a href="https://github.com/aws/containers-roadmap/issues/142#issuecomment-1367437044">AWS-github</a></p>
</li>
<li>
<p><code>22ë…„ 12ì›”</code>ì— ipvsì— ëŒ€í•œ ì§€ì›ì´ GAë˜ì—ˆìŒ.<br>
ì°¸ì¡°: <a href="https://aws.amazon.com/blogs/containers/amazon-eks-add-ons-advanced-configuration/">AWS-blog</a></p>
</li>
<li>
<p>ipvsê°€ iptablesë³´ë‹¤ ë‚˜ì€ê°€?<br>
í•´ë‹¹ ë‚´ìš©ì€ <a href="https://github.com/sbueringer/kubecon-slides/blob/master/slides/2017-kubecon-eu/Scale%20Kubernetes%20to%20Support%2050%2C000%20Services%20%5BI%5D%20-%20Haibin%20Xie%20%26%20Quinton%20Hoole%2C%20Huawei%20Technologies%20-%20Scale%20Kubernetes%20to%20Support%2050000%20Services.pdf">KubeCon Europe 2019ì—ì„œ ë°œí‘œëœ ë‚´ìš©</a>ì—ì„œ ì–¸ê¸‰ëœë‹¤.</p>
<ul>
<li>ì•„ë˜ì™€ ê°™ì´ ì„œë¹„ìŠ¤ì˜ ìˆ˜ì— ë”°ë¼ <a href="https://blog.naver.com/alice_k106/221606077410">ì‹œê°„ë³µì¡ë„</a>ì— ì˜í•´ ë°œìƒí•˜ëŠ” ì§€ì—°ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. (iptables: O(N), ipvs: O(1))</li>
</ul>
</li>
</ul>
<p><img src="./images/2017-kubecon-eu-huawei.png" alt="CC BY 3.0 The Linux Foundation"></p>
<h2 id="3-ë°ì´í„°í”Œë ˆì¸ë…¸ë“œì˜-ë„¤íŠ¸ì›Œí¬-ê¸°ë³¸-ì •ë³´-í™•ì¸">3. ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì˜ ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì •ë³´ í™•ì¸</h2>
<ul>
<li>ë…¸ë“œì— tcpdump ë“± ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ë„êµ¬ë¥¼ ì„¤ì¹˜ë¥¼ í•˜ì—¬ í™•ì¸í•´ë³¸ë‹¤.</li>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">k8s CNI</a> : ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ êµ¬ì„±í•´ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸ (Container Network Interface)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê° ë°ì´í„°í”Œë ˆì¸ì— ë„êµ¬ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo yum install links tree jq tcpdump -y 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo yum install links tree jq tcpdump -y 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 sudo yum install links tree jq tcpdump -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CNI ì •ë³´ í™•ì¸(ë¹„ìŠ·ë¹„ìŠ·í•˜ë¯€ë¡œ N2ë§Œ ì§„í–‰)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 tree /var/log/aws-routed-eni 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 cat /var/log/aws-routed-eni/plugin.log | jq <span style="color:#75715e"># IP í• ë‹¹ì‹œ CIDR 32 í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 cat /var/log/aws-routed-eni/ipamd.log | jq  <span style="color:#75715e"># maxENI 5ê°œ, í• ë‹¹ëœ IP 1ê°œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 cat /var/log/aws-routed-eni/egress-v4-plugin.log | jq <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸ : eniYëŠ” pod network ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ veth pair </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo ip -br -c addr 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo ip -c addr 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo ip -c route 
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo iptables -t nat -S <span style="color:#75715e"># iptables ë£° í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo iptables -t nat -L -n -v 
</span></span></code></pre></div><p><img src="./images/05_network-tool.png" alt="install_network_tool"></p>
<p><img src="./images/06_CNI-information.png" alt="cni-info"></p>
<h3 id="3-1-ë°ì´í„°í”Œë ˆì¸ì˜-ê¸°ë³¸-ë„¤íŠ¸ì›Œí¬-ì •ë³´-í™•ì¸-ë³´ì¡°-ipv4-ì£¼ì†Œ-í™•ì¸">3-1. ë°ì´í„°í”Œë ˆì¸ì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸: ë³´ì¡° IPv4 ì£¼ì†Œ í™•ì¸</h3>
<ul>
<li>ê°€ì‹œë‹¤ë‹˜ì´ ì œê³µí•´ì£¼ì‹  ì¥í‘œì™€ í•¨ê»˜ í™•ì¸.</li>
</ul>
<p><img src="./images/gasida-network.png" alt="gasida-network"></p>
<ul>
<li>(coredns Pod ê¸°ì¤€)AWS ì›¹ì½˜ì†”ì—ì„œ í™•ì¸í•´ë³´ë©´, 2ê°€ì§€ IPê°€ ìˆìŒ.
<ul>
<li>í”„ë¼ì´ë¹— ì£¼ì†Œ IP: ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì˜ IPì£¼ì†Œ</li>
<li>ë³´ì¡° í”„ë¼ì´ë¹— ì£¼ì†Œ IP:
<ul>
<li>ë°ì´í„°í”Œë ˆì¸ì— Podê°€ ìƒì„±ë˜ë©´ ë°”ë¡œ IPë¥¼ ë¶™ì´ê¸° ìœ„í•´ ì˜ˆì•½ëœ IP</li>
<li>L(ocal)-IPAM Warm <strong>IP Pool</strong></li>
<li>ìƒˆë¡œìš´ Podì— í• ë‹¹í•  Poolì´ ì—†ìœ¼ë©´, ìƒˆë¡œ ENI(eth1 ë“±)ì„ ë§Œë“¤ì–´ì„œ í• ë‹¹í•¨ (3-3 ì°¸ì¡°)</li>
</ul>
</li>
</ul>
</li>
<li>ìŠ¤í¬ë¦°ìƒ·ì—ì„œëŠ” veth í˜ì–´ì˜ IP ì£¼ì†ŒëŠ” <code>192.168.2.86</code>ì„ì„ í™•ì¸.</li>
</ul>
<p><img src="./images/07_veth-pair.png" alt="veth-pair"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># coredns íŒŒë“œ IP ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì•„ë˜ ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë©´ ì•Œë“¯ì´ í•œêµ­ ë¦¬ì „ Bì¡´ì˜ ë…¸ë“œì— ìƒì„±ëœ coredns íŒŒë“œì˜ IPì„ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l k8s-app<span style="color:#f92672">=</span>kube-dns -owide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œì˜ ë¼ìš°íŒ… ì •ë³´ í™•ì¸ &gt;&gt; EC2 ë„¤íŠ¸ì›Œí¬ ì •ë³´ì˜ &#39;ë³´ì¡° í”„ë¼ì´ë¹— IPv4 ì£¼ì†Œ&#39;ì™€ ë¹„êµ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›¹ ì½˜ì†”ì—ì„œ í•œêµ­ ë¦¬ì „ Bë¡œ í™•ì¸í–ˆìœ¼ë¯€ë¡œ, N2ì˜ ì •ë³´ë¥¼ í™•ì¸.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># veth í˜ì–´ì˜ IP ì£¼ì†ŒëŠ” Podì˜ IP ì£¼ì†Œì™€ ë™ì¼í•¨.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo ip -c route
</span></span></code></pre></div><p><img src="./images/08_veth-pair-console.png" alt="veth-pair-console"></p>
<h2 id="3-2-vethv-eth-virtual-ethernet-interface">3-2. veth(v-eth, virtual ethernet interface)</h2>
<ul>
<li>ë‹¨ì–´ë¥¼ ë³´ê³  ë‹¨ë°•ì— ê°€ìƒeth ì¸ê±´ ì•Œì•˜ì§€ë§Œ, ìì„¸í•œ ê±´ ì•„ë˜ì˜ ê¸€ì„ í†µí•´ì„œ ì•Œ ìˆ˜ ìˆìŒ.
<ul>
<li><a href="https://www.44bits.io/ko/keyword/veth">44bits-veth</a></li>
</ul>
</li>
<li>ì•„ë˜ê¹Œì§€ ì°¸ê³ í•œë‹¤ë©´, vethì˜ ì‹¤ì œë¥¼ ì•Œ ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ íŒë‹¨.
<ul>
<li><a href="https://www.44bits.io/ko/post/container-network-2-ip-command-and-network-namespace">44bit-ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ê¸°ì´ˆ 2í¸</a></li>
</ul>
</li>
</ul>
<h3 id="3-3-í…ŒìŠ¤íŠ¸ìš©-íŒŒë“œ-ìƒì„±-wnetshoot">3-3. í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ìƒì„± w/netshoot</h3>
<ul>
<li><a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot</a> a.k.a. ë„¤íŠ¸ì›Œí¬ ì¥ì• í•´ê²°ìš© ë§¥ê°€ì´ë²„ì¹¼</li>
<li>ë‹¤ë¥¸ í„°ë¯¸ë„ë¡œ ë°ì´í„°í”Œë ˆì¸ ëª¨ë‹ˆí„°ë§ì„ ë³‘í–‰</li>
<li>ìŠ¤í¬ë¦°ìƒ·ì„ ì°¸ì¡°í•˜ë©´ N1ì—ì„œ ì²˜ìŒì— ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ê°€ í•˜ë‚˜ ë°–ì— ì—†ë‹¤ëŠ” ê²ƒì„ ì•Œì•˜ìœ¼ë¯€ë¡œ,<br>
ì´ë²ˆ ì‹¤ìŠµì„ í†µí•´ ë„¤íŠ¸ì›Œí¬ ì–´ëŒ‘í„°ê°€ í•˜ë‚˜ ë” ìƒê¸°ëŠ” ê²ƒì„ ê´€ì°°í•˜ê¸° ìœ„í•´ì„œì„
<ul>
<li><code>2.</code>ì—ì„œ ìƒê²¼ë˜ ê¶ê¸ˆì¦ì´ ì•½ê°„? í•´ì†Œëœ ê²ƒ ê°™ë‹¤.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># (ë‹¤ë¥¸ í„°ë¯¸ë„ì„ ë„ì›Œì„œ) ì•„ë˜ì™€ ê°™ì´ 3ê°œë¥¼ ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#34;ip link | egrep &#39;eth|eni&#39; ;echo;echo &#34;</span><span style="color:#f92672">[</span>ROUTE TABLE<span style="color:#f92672">]</span><span style="color:#e6db74">&#34;; route -n | grep eni&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#34;ip link | egrep &#39;eth|eni&#39; ;echo;echo &#34;</span><span style="color:#f92672">[</span>ROUTE TABLE<span style="color:#f92672">]</span><span style="color:#e6db74">&#34;; route -n | grep eni&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#34;ip link | egrep &#39;eth|eni&#39; ;echo;echo &#34;</span><span style="color:#f92672">[</span>ROUTE TABLE<span style="color:#f92672">]</span><span style="color:#e6db74">&#34;; route -n | grep eni&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ netshoot íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ëŸ¬ë©´ ê° ë°ì´í„°í”Œë ˆì¸ì—ì„œ ë³€í™”ê°€ ìƒê¸°ëŠ”ë° </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´ë²ˆ ê²½ìš°ì—ëŠ” $N3ì—ì„œ eth1ì´ ìƒì„±ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: nicolaka/netshoot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        command: [&#34;tail&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        args: [&#34;-f&#34;, &#34;/dev/null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><img src="./images/09_node-2-before-netshoot-pod.png" alt="before-netshoot-pod"></p>
<p><img src="./images/10_node-2-after-netshoot-pod.png" alt="after-netshoot-pod"></p>
<h2 id="4-ë°ì´í„°í”Œë ˆì¸ë…¸ë“œê°„-í†µì‹ -í™•ì¸">4. ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ê°„ í†µì‹  í™•ì¸</h2>
<ul>
<li>AWS VPC CNIë¥¼ ì“°ëŠ” ê²½ìš°, NAT ë™ì‘(Overlay) ì—†ì´, VPC ë‚´ë¶€ì—ì„œ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤.
<ul>
<li>ë°ì´í„°í”Œë ˆì¸ì— ìˆëŠ” ENI(eth0 ë“±)ì„ íƒ€ê³  ë…¸ë“œ ê°„ í†µì‹ ì„ í•œë‹¤.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì´ë¦„ ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PODNAME1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.metadata.name<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>PODNAME2<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>.metadata.name<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>PODNAME3<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.metadata.name<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ IP ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PODIP1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>PODIP2<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>PODIP3<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>netshoot-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê° íŒŒë“œ(ë°ì´í„°í”Œë ˆì¸)ì—ì„œ tcpdumpë¡œ ping íŒ¨í‚· ë¯¸ë¦¬ ëŒ€ê¸°</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [$N1, $N2, $N3]</span>
</span></span><span style="display:flex;"><span>sudo tcpdump -i any -nn icmp
</span></span></code></pre></div><p><img src="./images/11_internal-any-eni.png" alt="tcpdump-icmp"></p>
<h3 id="ë²ˆì™¸-eth0-ë‚˜-eth1-ë§Œ-íŒ¨í‚·-ëª¨ë‹ˆí„°ë§í•´ë³´ê¸°">ë²ˆì™¸: eth0 ë‚˜ eth1 ë§Œ íŒ¨í‚· ëª¨ë‹ˆí„°ë§í•´ë³´ê¸°</h3>
<ul>
<li>ì´ë¡  ìƒìœ¼ë¡œëŠ” eth0ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì“°ê³  ìˆì–´ì„œ eth1ì—ì„œëŠ” ì•ˆ ë– ì•¼(?)í•˜ëŠ”ë°,<br>
ì‹¤ì œ <code>$N2</code>ì—ì„œëŠ” eth0ì€ ì•ˆì“°ê³ , eth1ì„ ì“°ëŠ” ê²ƒìœ¼ë¡œ í™•ì¸ë¨. ë¬´ìŠ¨ ì¼ì¸ê°€.. <strong>To-Do</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tcpdump -i eth0 -nn icmp
</span></span><span style="display:flex;"><span>sudo tcpdump -i eth1 -nn icmp
</span></span></code></pre></div><p><img src="./images/12_internal-eth0.png" alt="tcpdump-icmp-eth0"></p>
<p><img src="./images/13_internal-eth1.png" alt="tcpdump-icmp-eth1"></p>
<h2 id="5-ë°ì´í„°í”Œë ˆì¸ë…¸ë“œì—ì„œ-ì™¸ë¶€-í†µì‹ ">5. ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì—ì„œ ì™¸ë¶€ í†µì‹ </h2>
<ul>
<li>EXTERNAL SNAT(Source Network Address Translation) ì„¤ì •ì— ë”°ë¼,<br>
ì™¸ë¶€ í†µì‹  ì‹œ SNAT ì‚¬ìš© ì—¬ë¶€ë¥¼ ê²°ì •í•  ìˆ˜ ìˆìŒ</li>
<li>ì•„ë˜ ì‹¤ìŠµì„ í†µí•´ í™•ì¸
<ul>
<li>ì™¸ë¶€ ping í…ŒìŠ¤íŠ¸</li>
<li>ë°ì´í„°í”Œë ˆì¸ì—ì„œ ì •ë³´(tcpdump, iptables) í™•ì¸</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ì™¸ë¶€ ping í…ŒìŠ¤íŠ¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl exec -it $PODNAME1 -- ping -c <span style="color:#ae81ff">1</span> www.google.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ EC2 : TCPDUMP í™•ì¸ ($N3) ë° iptables ê·œì¹™ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo tcpdump -i any -nn icmp
</span></span><span style="display:flex;"><span>sudo tcpdump -i eth0 -nn icmp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip rule
</span></span><span style="display:flex;"><span>ip route show table main
</span></span><span style="display:flex;"><span>sudo iptables -L -n -v -t nat
</span></span><span style="display:flex;"><span>sudo iptables -t nat -S
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS-SNAT-CHAIN-0, AWS-SNAT-CHAIN-1ì— ëŒ€í•œ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo iptables -t nat -S | grep <span style="color:#e6db74">&#39;A AWS-SNAT-CHAIN&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># conntrack í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 169.254.169.x : ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤ì˜ IPv4 ì£¼ì†Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¶œì²˜: https://zetawiki.com/wiki/IP%EC%A3%BC%EC%86%8C_169.254.169.254</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo conntrack -L -n |grep -v <span style="color:#e6db74">&#39;169.254.169&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ì—ì„œ SNATì²´ì¸ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#39;sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-1; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ì™¸ë¶€ ping í…ŒìŠ¤íŠ¸ </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl exec -it $PODNAME1 -- ping -i 0.1 www.google.com
</span></span></code></pre></div><p><img src="./images/14_external-ping-test.png" alt="external_ping"></p>
<p><img src="./images/15_compare-node_ip-pod_ip-same.png" alt="compare_node_ip_pod_ip_same"></p>
<ul>
<li>ì—¬íƒœê» $N1ì— $PODNAME1ì´ ìˆëŠ” ì¤„ ì•Œì•˜ëŠ”ë°, ì˜ˆìƒê°’ì´ ì´ìƒí•´ì„œ ì°ì–´ë³´ë‹ˆ $N3ì˜€ìŒ;</li>
</ul>
<p><img src="./images/16_mask-with-node-ip.png" alt="masquerading"></p>
<p><img src="./images/17_monitor-snat-chaining.png" alt="snat-chain"></p>
<ul>
<li>
<p>ìœ„ì—ì„œ ë³´ë‹¤ì‹œí”¼, AWS-SNAT-CHAIN-0ì— ì˜í•´ ë°ì´í„°í”Œë ˆì¸ CIDRëŒ€ì—­ì´ ì•„ë‹ˆë©´,<br>
AWS-SNAT-CHAIN-1ë¡œ ì í”„ì‹œì¼œì„œ, ë°ì´í„°í”Œë ˆì¸ì˜ Private IPë¡œ ì…í˜€ì„œ ì™¸ë¶€ë¡œ ë‚´ë³´ë‚¸ë‹¤.</p>
<ul>
<li>ê·¸ë˜ì„œ, ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì˜ Public IPë¡œ ë‚˜ê°€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</li>
</ul>
</li>
<li>
<p><a href="https://www.joongang.co.kr/article/1051848#home"><strong>ë§¤ìŠ¤ì»¤ë ˆì´ë”©</strong></a></p>
</li>
</ul>
<h2 id="6-ë°ì´í„°í”Œë ˆì¸ë…¸ë“œì—-íŒŒë“œ-ìƒì„±-ê°¯ìˆ˜-ì œí•œ">6. ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì— íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</h2>
<ul>
<li>
<p>ìš”ì•½: <strong>((MaxENI * (IPv4addr-1)) + 2)</strong></p>
<ul>
<li>MaxENI:<br>
Number of network interfaces for the instance type</li>
<li>IPv4addr:<br>
the number of IP address per network interface</li>
</ul>
</li>
<li>
<p>t3.medium ê²½ìš° :</p>
<ul>
<li>(3 * (6 - 1)) + 2 = 17ê°œ</li>
<li>ê·¸ëŸ¬ë‚˜, aws-node ì™€ kube-proxy 2ê°œ ì œì™¸í•˜ë©´ 15ê°œ</li>
</ul>
</li>
<li>
<p>Secondary IPv4 addressë¡œëŠ” ê° ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ì œí•œì´ ìˆìŒ.</p>
<ul>
<li>IPv4 ì ‘ë‘ì‚¬ ìœ„ì„(Prefix Delegation)ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•˜ì§€ë§Œ,<br>
ì´ë²ˆì—ëŠ” ë‹¤ë£¨ì§€ ì•ŠìŒ(ê¸°ë³¸ ë‚´ìš©ìœ¼ë¡œë„ ì‚´ì§ ë¶€í•˜)</li>
</ul>
</li>
<li>
<p>ì‹¤ìŠµì—ì„œëŠ” t3 íƒ€ì…ì˜ ì •ë³´ ë° ë°ì´í„°í”Œë ˆì¸ ë‚´ì—ì„œ í• ë‹¹ ê°¯ìˆ˜ë¥¼ í™•ì¸í•œ ë‹¤ìŒ,<br>
ì‹¤ì œë¡œ íŒŒë“œë¥¼ ìƒì„±í•´ë³´ë©´ì„œ í™•ì¸í•´ë³¸ë‹¤.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># t3 íƒ€ì…ì˜ ì •ë³´(í•„í„°) í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws ec2 describe-instance-types --filters Name<span style="color:#f92672">=</span>instance-type,Values<span style="color:#f92672">=</span>t3.* <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --query <span style="color:#e6db74">&#34;InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ ìƒì„¸ ì •ë³´ í™•ì¸ : ë…¸ë“œ ìƒì„¸ ì •ë³´ì˜ Allocatable ì— pods ì— 17ê°œ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe node | grep Allocatable: -A7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ì´í„°í”Œë ˆì¸ì—ì„œ ëª¨ë‹ˆí„°ë§ ëŒ€ê¸°</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> ip -br -c addr show <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;--------------&#34;</span> ; date <span style="color:#e6db74">&#34;+%Y-%m-%d %H:%M:%S&#34;</span> ; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ëª¨ë‹ˆí„°ë§ ëŒ€ê¸°</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#39;kubectl get pods -o wide&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/2/nginx-dp.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f nginx-dp.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸(50ê°œ) ë° ì‚´íŒ¨ í™•ì¸: Too many pods</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl scale deployment nginx-deployment --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>kubectl get pods | grep Pending
</span></span><span style="display:flex;"><span>kubectl describe pod <span style="color:#e6db74">${</span>Pendingëœ íŒŒë“œ<span style="color:#e6db74">}</span> | grep Events: -A5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë””í”Œë¡œì´ë¨¼íŠ¸ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete deploy nginx-deployment
</span></span></code></pre></div><p><img src="./images/18_t2-allocatable.png" alt="t2-allocatable"></p>
<p><img src="./images/19-before-scaling.png" alt="before-scaling"></p>
<p><img src="./images/20_after-scaling.png" alt="after-scaling"></p>
<p><img src="./images/21_failed-pods.png" alt="failed-pods"></p>
<h2 id="7-service--aws-loadbalancer-controller">7. Service &amp; AWS LoadBalancer Controller</h2>
<ul>
<li>
<p>ì„œë¹„ìŠ¤ ë°©ë²•ì—ëŠ” ì•„ë˜ì™€ ê°™ì€ ì¢…ë¥˜ê°€ ìˆìŒ</p>
<ol>
<li>ClusterIP:
<ul>
<li>ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì˜ iptablesë£°ì— ì˜í•´ ë°ì´í„°í”Œë ˆì¸ ë‚´ì˜ <code>Pod IP</code>ë¡œ ì ‘ê·¼</li>
<li>í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥</li>
</ul>
</li>
<li>NodePort:
<ul>
<li>ê³ ì • í¬íŠ¸(NodePort)ë¡œ ê° ë°ì´í„°í”Œë ˆì¸ì˜ IPì— ì ‘ê·¼</li>
<li>ê° ë°ì´í„°í”Œë ˆì¸(ë…¸ë“œ)ì— ìˆëŠ” iptablesë£°ì— ì˜í•´ <code>Pod IP</code>ë¡œ ì ‘ê·¼</li>
</ul>
</li>
<li>LoadBalancer: <strong>ê¸°ë³¸ê°’</strong>
<ul>
<li>í´ë¼ìš°ë“œ ê³µê¸‰ì(CSP)ì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í™œìš©, ë°ì´í„°í”Œë ˆì¸ ì•ì— ë¡œë“œë°¸ëŸ°ì„œê°€ ìˆìŒ.</li>
<li>(NLB ì¸ìŠ¤í„´ìŠ¤ ìœ í˜• ê¸°ì¤€) ì´ê±¸ ê±°ì¹œ ë‹¤ìŒ ê° ë°ì´í„°í”Œë ˆì¸ì˜ iptablesë¥¼ íƒ€ê³ , íŒŒë“œë¡œ ì ‘ê·¼</li>
</ul>
</li>
<li>Service (LoadBalancer Controller + NLB IPëª¨ë“œ)
<ul>
<li>w/<strong>AWS VPC CNI</strong>: ì´ë²ˆ ì‹¤ìŠµì—ì„œ AWS VPC CNIë¥¼ ì“°ëŠ” ì´ìœ </li>
<li>iptablesë¥¼ íƒ€ì§€ ì•Šê³ , <strong>Bypass</strong>ë¡œ ë°”ë¡œ <code>Pod IP</code>ë¡œ ì ‘ê·¼</li>
<li>ì´ê²Œ ê°€ëŠ¥í•œ ì´ìœ ëŠ” ë³„ë„ì˜ LB ì»¨íŠ¸ë¡¤ëŸ¬ íŒŒë“œê°€ ìˆê³ ,<br>
ì—¬ê¸°ì— Pod IP ì •ë³´ë¥¼ ì§€ì†ì ìœ¼ë¡œ ì œê³µ</li>
</ul>
</li>
</ol>
</li>
<li>
<p>ê·¸ë˜ì„œ ë§ˆì§€ë§‰ì˜ ë°©ë²•ì„ ì“°ë ¤ë©´ OIDCë¥¼ í™œìš©í•´ì„œ, LBì»¨íŠ¸ë¡¤ëŸ¬ IAM ì •ì±…ì„ ì ìš©í•´ì•¼í•¨.</p>
<ul>
<li>OIDC: OpenID Connect(IdP)
<ul>
<li>OAuth2.0ì™€ ê±°ì˜ ìœ ì‚¬í•˜ë‹¤ê³  ê¹€ì„¸ì›…ë‹˜ê»˜ì„œ ì„¤ëª…í•´ì£¼ì‹¬.</li>
</ul>
</li>
<li>ì´ì „ ìŠ¤í„°ë””ì—ì„œ IAM ì •ì±…ì´ ì ìš©ë˜ì–´ì„œ ì¤‘ë³µ ì—ëŸ¬ê°€ ëœ¨ì§€ë§Œ, í™•ì¸ì—ëŠ” ë¬¸ì œ ì—†ìŒ.</li>
<li>ì´ë ‡ê²Œ ê¶Œí•œì„ ì£¼ëŠ” ê²ƒì„ <strong>IRSA(IAM Roles Service Account)</strong> ë¼ê³  í•¨.
<ul>
<li>ì¶œì²˜: <a href="https://channel.io/ko/blog/tech-aws-cross-accounts-irsa">IRSA@ì±„ë„í†¡</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># OIDC í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws eks describe-cluster --name $CLUSTER_NAME --query <span style="color:#e6db74">&#34;cluster.identity.oidc.issuer&#34;</span> --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws iam list-open-id-connect-providers | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IAM Policy (AWSLoadBalancerControllerIAMPolicy) ìƒì„±</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´ë¯¸ ìˆë‹¤ë©´, ì•„ë˜ì˜ ëª…ë ¹ì–´ëŠ” ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ì§€ë§Œ ë¬´ì‹œí•´ë„ ë¨.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„±ëœ IAM Policy Arn í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws iam list-policies --scope Local
</span></span><span style="display:flex;"><span>aws iam get-policy --policy-arn arn:aws:iam::$ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicy
</span></span><span style="display:flex;"><span>aws iam get-policy --policy-arn arn:aws:iam::$ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicy --query <span style="color:#e6db74">&#39;Policy.Arn&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IRSA ìƒì„± w/cloudformation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount --cluster<span style="color:#f92672">=</span>$CLUSTER_NAME --namespace<span style="color:#f92672">=</span>kube-system --name<span style="color:#f92672">=</span>aws-load-balancer-controller <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--attach-policy-arn<span style="color:#f92672">=</span>arn:aws:iam::$ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicy --override-existing-serviceaccounts --approve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IRSA ë° ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>kubectl get serviceaccounts -n kube-system aws-load-balancer-controller -o yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Helm Chart ì„¤ì¹˜ for AWS LoadBalancer Controller</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm repo add eks https://aws.github.io/eks-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName<span style="color:#f92672">=</span>$CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set serviceAccount.create<span style="color:#f92672">=</span>false --set serviceAccount.name<span style="color:#f92672">=</span>aws-load-balancer-controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get crd
</span></span><span style="display:flex;"><span>kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span style="display:flex;"><span>kubectl describe deploy -n kube-system aws-load-balancer-controller | grep <span style="color:#e6db74">&#39;Service Account&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í´ëŸ¬ìŠ¤í„°ë¡¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
</span></span></code></pre></div><p><img src="./images/22_ODIC-IAM-policy.png" alt="ODIC-IAM-policy"></p>
<p><img src="./images/23_apply-IAM-2-cluster-with-cloudformation.png" alt="apply IRSA"></p>
<p><img src="./images/24_cloudformation-IAM-LB-controller.png" alt="cloudformation"></p>
<p><img src="./images/25_helm-chart-to-install-AWS-LB-controller.png" alt="helm-chart-install-AWS-RB-Controller"></p>
<ul>
<li>ì›¹ ì½˜ì†”ì—ì„œ IAM ì‹ ë¢°ê´€ê³„(Trust Relationships)ë¥¼ í™•ì¸
<ul>
<li>í‰ì†Œì—ëŠ” <code>sts:AssumeRole</code>ì„ ë§ì´ ë´ì™”ëŠ”ë°, ì´ë²ˆì—ëŠ” <code>sts:AssumeRoleWithWebIdentity</code>ë¥¼ ë³¼ ìˆ˜ ìˆìŒ.</li>
<li><a href="https://aws.amazon.com/ko/blogs/korea/how-to-use-trust-policies-with-iam-roles-html/">IAMì‹ ë¢°ê´€ê³„@AWS</a></li>
</ul>
</li>
</ul>
<p><img src="./images/26_IRSA-in-console.png" alt="IRSA-trust-relationships"></p>
<h3 id="7-1-nlbë¥¼-í™œìš©í•œ-ì„œë¹„ìŠ¤íŒŒë“œ-ìƒì„±">7-1. NLBë¥¼ í™œìš©í•œ ì„œë¹„ìŠ¤/íŒŒë“œ ìƒì„±</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>watch -d kubectl get pod,svc,ep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë””í”Œë¡œì´ë¨¼íŠ¸ &amp; ì„œë¹„ìŠ¤ ìƒì„±</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/2/echo-service-nlb.yaml
</span></span><span style="display:flex;"><span>cat echo-service-nlb.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f echo-service-nlb.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get deploy,pod
</span></span><span style="display:flex;"><span>kubectl get svc,ep,ingressclassparams,targetgroupbindings
</span></span><span style="display:flex;"><span>kubectl get targetgroupbindings -o json | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS ELB(NLB) ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws elbv2 describe-load-balancers | jq
</span></span><span style="display:flex;"><span>aws elbv2 describe-load-balancers --query <span style="color:#e6db74">&#39;LoadBalancers[*].State.Code&#39;</span> --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get svc svc-nlb-ip-type -o jsonpath<span style="color:#f92672">={</span>.status.loadBalancer.ingress<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.hostname<span style="color:#f92672">}</span> | awk <span style="color:#e6db74">&#39;{ print &#34;Pod Web URL = http://&#34;$1 }&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ë¡œê¹… ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>kubectl logs -l app<span style="color:#f92672">=</span>deploy-websrv -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¶„ì‚° ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>NLB<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get svc svc-nlb-ip-type -o jsonpath<span style="color:#f92672">={</span>.status.loadBalancer.ingress<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.hostname<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>curl -s $NLB
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..100<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> curl -s $NLB | grep Hostname ; <span style="color:#66d9ef">done</span> | sort | uniq -c | sort -nr
</span></span></code></pre></div><p><img src="./images/27_create-deploy-service-in-LB.png" alt="test"></p>
<p><img src="./images/28_chk-creation.png" alt="check-creation"></p>
<p><img src="./images/29_get-Pod-Web-URL.png" alt="get-pod-web-url"></p>
<p><img src="./images/30_Pod-Web-in-browser.png" alt="pod-web-in-browser"></p>
<p><img src="./images/31_chk-LB-100req.png" alt="check-loadbalancing"></p>
<h3 id="7-2-scaling-downup">7-2. Scaling down/up</h3>
<ul>
<li>íŒŒë“œ 2ê°œ -&gt; 1ê°œ -&gt; 3ê°œë¡œ ìŠ¤ì¼€ì¼ë§
<ul>
<li>íŠ¹íˆ, draining ì¤‘ì¸ íŒŒë“œëŠ” ë¬´ì‹œí•˜ê³  ìŠ¤ì¼€ì¼ë§ì„ ì§„í–‰í•¨.</li>
</ul>
</li>
<li>ë‹¹ì—°í•œ ë§ì´ê² ì§€ë§Œ, LB Controller íŒŒë“œê°€ ë”°ë¡œ ìˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ë ˆí”Œë¦¬ì¹´ ìˆ˜ ë³€ê²½ (2 -&gt; 1 -&gt; 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›¹ ì½˜ì†”ì—ì„œ NLB ìƒíƒœ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl scale deployment deploy-echo --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment deploy-echo --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS LB Controller</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe deploy -n kube-system aws-load-balancer-controller | grep <span style="color:#e6db74">&#39;Service count&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„° ë¡¤ ë°”ì¸ë”© ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„°ë¡¤ í™•ì¸ </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type
</span></span></code></pre></div><p><img src="./images/32_pod-scale-down.png" alt="pod-scale-down"></p>
<p><img src="./images/33_pod-scale-up.png" alt="pod-scale-up"></p>
<p><img src="./images/34_AWS-LB-controller.png" alt="AWS-LB-controller"></p>
<h3 id="7-3-nlb-ëŒ€ìƒ-íƒ€ê²Ÿì„-instance-modeë¡œ-ì„¤ì •í•´ë³´ê¸°">7-3. NLB ëŒ€ìƒ íƒ€ê²Ÿì„ Instance modeë¡œ ì„¤ì •í•´ë³´ê¸°</h3>
<ul>
<li>NLB IP Target &amp; Proxy Protocol v2 í™œì„±í™” : NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì… ë° ClientIP í™•ì¸ ì„¤ì •</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„±</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: gasida-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: gasida-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: gasida-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: gasida-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: gasida/httpd:pp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - containerPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: svc-nlb-ip-type-pp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      targetPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  type: LoadBalancer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  loadBalancerClass: service.k8s.aws/nlb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: gasida-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get svc,ep
</span></span><span style="display:flex;"><span>kubectl describe svc svc-nlb-ip-type-pp
</span></span><span style="display:flex;"><span>kubectl describe svc svc-nlb-ip-type-pp | grep Annotations: -A5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># apacheì— proxy protocol í™œì„±í™” í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl exec deploy/gasida-web -- apachectl -t -D DUMP_MODULES
</span></span><span style="display:flex;"><span>kubectl exec deploy/gasida-web -- cat /usr/local/apache2/conf/httpd.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NLB<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get svc svc-nlb-ip-type-pp -o jsonpath<span style="color:#f92672">={</span>.status.loadBalancer.ingress<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.hostname<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>curl -s $NLB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì§€ì†ì ì¸ ì ‘ì† ì‹œë„ : ì•„ë˜ ìƒì„¸ ë™ì‘ í™•ì¸ ì‹œ ìœ ìš©(íŒ¨í‚· ë¤í”„ ë“±)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> curl -s --connect-timeout <span style="color:#ae81ff">1</span> $NLB; echo <span style="color:#e6db74">&#34;----------&#34;</span> ; date <span style="color:#e6db74">&#34;+%Y-%m-%d %H:%M:%S&#34;</span> ; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl logs -l app<span style="color:#f92672">=</span>gasida-web -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete deploy gasida-web; kubectl delete svc svc-nlb-ip-type-pp
</span></span></code></pre></div><p><img src="./images/35_test-pod-create.png" alt="test-pod"></p>
<p><img src="./images/36_get-nlb-information-and-enable-apachectl.png" alt="get-nlb-info-and-enable-apachectl"></p>
<p><img src="./images/37_check-with-continous-connection.png" alt="check-with-connection"></p>
<p><img src="./images" alt="1"></p>

  </div>
  </section>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho@ubuntu-kr.org">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/aws-eks-study-week1/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">AWS EKS ìŠ¤í„°ë”” 1ì£¼ì°¨</span>
        </a>
        
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho@ubuntu-kr.org">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <p></p>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
