<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 4ì£¼ì°¨ - Observability | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 4ì£¼ì°¨ - Observability" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week4/cover.jpg' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week4/cover.jpg' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week4/cover.jpg' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.8c1fb07f2dee90a6523f7317a7d023e3c1b14bd4706bff237c94e366d59facf9.css">
</head><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>
     
     <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸŒ
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
            
            
          </ul>
        </li>
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
<div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.jpg'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 4ì£¼ì°¨ - Observability</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-05-21T06:13:52&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/observability" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">observability</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>ì´ë²ˆ ì£¼ì°¨ì—ëŠ” Observabilityì— ëŒ€í•´ ìŠ¤í„°ë””ê°€ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
ìì› ëª¨ë‹ˆí„°ë§ íˆ´ë“¤ì˜ ì ìš© ë° ì‚¬ìš©ì´ ì¤‘ì‹¬ì…ë‹ˆë‹¤.</p>
<p>ê·¸ë‚˜ì €ë‚˜ k8s 1.26ì—ì„œ metricsì˜ ì¼ë¶€ ëª…ì¹­ì´ ë°”ë€ŒëŠ” ê±¸ ë³´ê³  ì‹ê²í–ˆìŠµë‹ˆë‹¤.<br>
(<code>etcd_db_total_size_bytes</code> ëŒ€ì‹ , <code>apiserver_storage_db_total_size_in_bytes</code> ìœ¼ë¡œ ë³€ê²½)<br>
ë˜í•œ kubecostì˜ ê²½ìš°, cloudformation ìŠ¤íƒ ì œê±° í›„ì—ë„ ë³¼ë¥¨ ë°ì´í„°ê°€ ë‚¨ì•„ìˆì–´ì„œ ë³„ë„ë¡œ ì‚­ì œí•´ì•¼ í–ˆìŠµë‹ˆë‹¤.</p>
<h2 id="1-ì‹¤ìŠµí™˜ê²½-ë°°í¬">1. ì‹¤ìŠµí™˜ê²½ ë°°í¬</h2>
<ul>
<li>NATê²Œì´íŠ¸ì›¨ì´, EBS addon, IAM role, ISRA for LB/EFS, PreCommand í¬í•¨</li>
<li>ë…¸ë“œ: t3.xlarge
<ul>
<li>t3<strong>a</strong>.xlarge(AMD)ëŠ” ì„œìš¸ ë¦¬ì „ b AZ(ap-northeast-2b)ì—ì„œ ë¯¸ì§€ì›</li>
</ul>
</li>
<li>ë” ë§ì€ ê°’ë“¤ì´ ì…ë ¥ë˜ì–´ì„œ, ìƒì„± ì™„ë£Œê¹Œì§€ ë” ë§ì€ ì‹œê°„ì´ ì†Œìš” (ì•½ 20ì—¬ë¶„ ì´ë‚´)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick3.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´í•˜ ìƒëµ, 3ì£¼ì°¨ ì°¸ê³ </span>
</span></span></code></pre></div><p><img src="./images/cloudformation.png" alt="cloudformation"></p>
<h2 id="2-eks-console">2. EKS Console</h2>
<ul>
<li>ì¿ ë²„ë„¤í‹°ìŠ¤ APIë¥¼ í†µí•´ì„œ ë¦¬ì†ŒìŠ¤ ë° ì •ë³´ í™•ì¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get ClusterRole | grep eks
</span></span></code></pre></div><ul>
<li>
<p>EKS Clusterì— ëŒ€í•œ IAM Role ì •ë³´ í™•ì¸: ì—°ê²° ì •ì±…</p>
</li>
<li>
<p>ì›¹ ì½˜ì†”ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ í™•ì¸ ê°€ëŠ¥ <a href="https://www.eksworkshop.com/docs/observability/resource-view/">(ì¶œì²˜: EKS Workshop)</a></p>
<ul>
<li>Workloads, Cluster, Service&amp;Networking, Config&amp;Secret, Storage, Authentication, Authoriztion, Policy, Extensions</li>
</ul>
</li>
</ul>
<h2 id="3-logging-in-eks">3. Logging in EKS</h2>
<ul>
<li>ë¡œê¹… ëŒ€ìƒ êµ¬ë¶„
<ol>
<li>Control Plane</li>
<li>Node</li>
<li>Application</li>
</ol>
</li>
</ul>
<h3 id="3-1-control-plane-logging">3-1. Control Plane Logging</h3>
<ul>
<li>ì¶œì²˜: <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/control-plane-logs.html">EKS Docs</a></li>
<li>ë¡œê·¸ ê·¸ë£¹ ì´ë¦„: <code>/aws/eks/&lt;cluster-name&gt;/cluster</code></li>
<li>ë¡œê¹…ì€ 5ê°€ì§€ê°€ ì§€ì›
<ul>
<li><code>api</code> : k8s API server component logs</li>
<li><code>audit</code></li>
<li><code>authenticator</code></li>
<li><code>controllerManager</code></li>
<li><code>scheduler</code></li>
</ul>
</li>
<li>ë¡œê¹…ì„ í™œì„±í™” í•œ í›„ì— í™•ì¸
<ul>
<li>ì•„ë˜ì—ì„œëŠ” kube-controller-managerë¥¼ ëŒ€ìƒìœ¼ë¡œ coredns ë ˆí”Œë¦¬ì¹´ ìˆ˜ë¥¼ ì¡°ì •í•˜ë©´ì„œ ë¡œê·¸ë¥¼ í™•ì¸</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë“  ë¡œê¹… í™œì„±í™”</span>
</span></span><span style="display:flex;"><span>aws eks update-cluster-config --region $AWS_DEFAULT_REGION --name $CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --logging <span style="color:#e6db74">&#39;{&#34;clusterLogging&#34;:[{&#34;types&#34;:[&#34;api&#34;,&#34;audit&#34;,&#34;authenticator&#34;,&#34;controllerManager&#34;,&#34;scheduler&#34;],&#34;enabled&#34;:true}]}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ ê·¸ë£¹ í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws logs describe-log-groups | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ tail í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws logs tail /aws/eks/$CLUSTER_NAME/cluster | more
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹œê°„ ì§€ì •: 1ì´ˆ(s) 1ë¶„(m) 1ì‹œê°„(h) í•˜ë£¨(d) í•œì£¼(w) / ì§§ê²Œ ì¶œë ¥</span>
</span></span><span style="display:flex;"><span>aws logs tail /aws/eks/$CLUSTER_NAME/cluster --since 1h30m --format short
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ ìŠ¤íŠ¸ë¦¼</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment -n kube-system coredns --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment -n kube-system coredns --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span></code></pre></div><p><img src="./images/control-plane-logs.png" alt="control-plane-logs-with-coredns-replica"></p>
<h3 id="3-2-cloudwatchì´í•˜-cw-log-insights">3-2. CloudWatch(ì´í•˜, CW) Log Insights</h3>
<ul>
<li>ì›¹ ì½˜ì†”ì—ì„œ ë¡œê·¸ ê·¸ë£¹ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰</li>
</ul>
<pre tabindex="0"><code class="language-query" data-lang="query"># EC2 Instanceê°€ NodeNotReady ìƒíƒœì¸ ë¡œê·¸ ê²€ìƒ‰, ì •ìƒì ì¸ ê²½ìš° ëœ¨ì§€ ì•ŠìŒ
fields @timestamp, @message
| filter @message like /NodeNotReady/
| sort @timestamp desc

# kube-apiserver-audit ë¡œê·¸ì—ì„œ userAgent ì •ë ¬í•˜ì—¬ í™•ì¸
# ì•ì„œ í™œì„±í™”í•œ ë‹¤ë¥¸ ë¡œê·¸(kube-scheduler, authenticator, kube-controller-Manager)ë„ í™•ì¸ ê°€ëŠ¥
fields userAgent, requestURI, @timestamp, @message
| filter @logStream ~= &#34;kube-apiserver-audit&#34;
| stats count(userAgent) as count by userAgent
| sort count desc
</code></pre><p><img src="./images/cw-log-insights-audit.png" alt="cw-log-insights-audit"></p>
<p><img src="./images/cw-log-insights-scheduler.png" alt="cw-log-insights-scheduler"></p>
<p><img src="./images/cw-log-insights-authenticator.png" alt="cw-log-insights-authenticator"></p>
<p><img src="./images/cw-log-insights-controller-manager.png" alt="cw-log-insights-controller-manager"></p>
<h3 id="3-3-cw-log-insights-query-with-aws-cli">3-3. CW Log Insights Query with aws-cli</h3>
<ul>
<li>ì•„ë˜ì™€ ê°™ì´ clië¡œë„ ì¿¼ë¦¬ ê°€ëŠ¥</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># CloudWatch Log Insight Query</span>
</span></span><span style="display:flex;"><span>aws logs get-query-results --query-id <span style="color:#66d9ef">$(</span>aws logs start-query <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--log-group-name <span style="color:#e6db74">&#39;/aws/eks/myeks/cluster&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--start-time <span style="color:#e6db74">`</span>date -d <span style="color:#e6db74">&#34;-1 hours&#34;</span> +%s<span style="color:#e6db74">`</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--end-time <span style="color:#e6db74">`</span>date +%s<span style="color:#e6db74">`</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--query-string <span style="color:#e6db74">&#39;fields @timestamp, @message | filter @logStream ~= &#34;kube-scheduler&#34; | sort @timestamp desc&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq --raw-output <span style="color:#e6db74">&#39;.queryId&#39;</span><span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p><img src="./images/cw-log-insights-aws-cli.png" alt="cw-log-insights-aws-cli"></p>
<h3 id="3-4-control-plane-raw-metrics-with-cw-logs-insight">3-4. Control Plane raw metrics with CW Logs Insight</h3>
<ul>
<li>ì¶œì²˜: <a href="https://docs.aws.amazon.com/eks/latest/userguide/prometheus.html">EKS Docs</a></li>
<li>
<dl>
<dt>ì•„ë˜ì˜ ì¿¼ë¦¬ëŠ” Prometheus í¬ë§·ìœ¼ë¡œ raw metrics ì¶œë ¥</dt>
<dd><code>metric_name{&quot;tag&quot;=&quot;value&quot;[,...]} value</code></dd>
</dl>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get --raw /metrics | more
</span></span></code></pre></div><h3 id="3-5-managing-etcd-database-size-on-eks-clusters">3-5. Managing etcd database size on EKS clusters</h3>
<ul>
<li>ì¶œì²˜: <a href="https://aws.amazon.com/ko/blogs/containers/managing-etcd-database-size-on-amazon-eks-clusters/">AWS Blog</a></li>
<li>ì•„ë˜ì™€ ê°™ì´ ì…ë ¥í•˜ë©´ etcdì˜ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ì´ì¦ˆë¥¼ í™•ì¸ ê°€ëŠ¥</li>
<li>ì´ë•Œ ì˜†ì— ëœ¨ëŠ” ì—”ë“œí¬ì¸íŠ¸ëŠ” etcd ì„œë²„ì˜ ì—”ë“œí¬ì¸íŠ¸. (ì°¸ì¡°: <a href="https://github.com/kubernetes/apiserver/blob/master/pkg/storage/storagebackend/factory/etcd3.go#L404">Github</a>)
ì°¸ê³ ë¡œ, EKSì—ì„œëŠ” etcdê°€ AWS-managed</li>
<li>k8s v1.26 ë¶€í„°ëŠ” <code>etcd_db_total_size_bytes</code> ëŒ€ì‹ ,<br>
<code>apiserver_storage_db_total_size_in_bytes</code> ìœ¼ë¡œ ë³€ê²½ (ì°¸ì¡°: <a href="https://sysdig.com/blog/kubernetes-1-26-whats-new/">sysdig</a>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get --raw /metrics | grep <span style="color:#e6db74">&#34;etcd_db_total_size_in_bytes&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># etcd_db_total_size_in_bytes{endpoint=&#34;http://10.0.160.16:2379&#34;} 4.665344e+06</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># etcd_db_total_size_in_bytes{endpoint=&#34;http://10.0.32.16:2379&#34;} 4.636672e+06</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># etcd_db_total_size_in_bytes{endpoint=&#34;http://10.0.96.16:2379&#34;} 4.640768e+06</span>
</span></span></code></pre></div><ul>
<li>CW Logs Insights Query for exceeded etcd database space</li>
</ul>
<pre tabindex="0"><code class="language-query" data-lang="query">fields @timestamp, @message, @logStream
| filter @logStream like /kube-apiserver-audit/
| filter @message like /mvcc: database space exceeded/
| limit 10
</code></pre><ul>
<li>Identify what is consuming etcd database space</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get --raw<span style="color:#f92672">=</span>/metrics | grep apiserver_storage_objects |awk <span style="color:#e6db74">&#39;$2&gt;50&#39;</span> |sort -g -k <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># apiserver_storage_objects{resource=&#34;clusterrolebindings.rbac.authorization.k8s.io&#34;} 78</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># apiserver_storage_objects{resource=&#34;clusterroles.rbac.authorization.k8s.io&#34;} 92</span>
</span></span></code></pre></div><ul>
<li>CW Logs Insights Query for Request volume</li>
</ul>
<pre tabindex="0"><code class="language-query" data-lang="query"># By userAgents
fields userAgent, requestURI, @timestamp, @message
| filter @logStream like /kube-apiserver-audit/
| stats count(*) as count by userAgent
| sort count desc

# By Requests by Universal Resource Identifier (URI)/Verb:
filter @logStream like /kube-apiserver-audit/
| stats count(*) as count by requestURI, verb, user.username
| sort count desc

# Object revision updates
fields requestURI
| filter @logStream like /kube-apiserver-audit/
| filter requestURI like /pods/
| filter verb like /patch/
| filter count &gt; 8
| stats count(*) as count by requestURI, responseStatus.code
| filter responseStatus.code not like /500/
| sort count desc
</code></pre><p><img src="./images/cw-log-insights-request-volume-by-useragents.png" alt="cw-log-insights-request-volume-by-useragents"></p>
<p><img src="./images/cw-log-insights-request-volume-by-uri-verb.png" alt="cw-log-insights-request-volume-by-uri-verb"></p>
<p><img src="./images/cw-log-insights-request-volume-by-object-revision-updates.png" alt="cw-log-insights-request-volume-by-object-revision-updates"></p>
<ul>
<li>ì •í™•í•œ ë‚´ìš©ì€ ë„ì…ë¶€ì˜ AWS Blog ì°¸ê³ </li>
</ul>
<h3 id="3-6-ì»¨í…Œì´ë„ˆpod-ë¡œê¹…-with-nginx">3-6. ì»¨í…Œì´ë„ˆ(Pod) ë¡œê¹… with Nginx</h3>
<ul>
<li>ì•„ë˜ì™€ ê°™ì´ nginxë¥¼ ë°°í¬í•˜ê³ , ë°˜ë³µ ì ‘ì†. ì´ì–´ì§ˆ Prometheusì™€ Grafana ì‹¤ìŠµì—ì„œë„ metric ìë£Œë¡œ í™œìš©</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># NGINX ì›¹ì„œë²„ ë°°í¬</span>
</span></span><span style="display:flex;"><span>helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚¬ìš© ë¦¬ì „ì˜ ì¸ì¦ì„œ ARN í™•ì¸</span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë„ë©”ì¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>echo $MyDomain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; nginx-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  hostname: nginx.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  path: /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/load-balancer-name: $CLUSTER_NAME-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>cat nginx-values.yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>helm install nginx bitnami/nginx --version 14.1.0 -f nginx-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get ingress,deploy,svc,ep nginx
</span></span><span style="display:flex;"><span>kubectl get targetgroupbindings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì ‘ì† ì£¼ì†Œ í™•ì¸ ë° ì ‘ì†</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Nginx WebServer URL = https://nginx.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>curl -s https://nginx.$MyDomain
</span></span><span style="display:flex;"><span>kubectl logs deploy/nginx -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°˜ë³µ ì ‘ì†</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> curl -s https://nginx.$MyDomain -I | head -n 1; date; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì°¸ê³ ) ì‚­ì œ ì‹œ</span>
</span></span><span style="display:flex;"><span>helm uninstall nginx
</span></span></code></pre></div><p><img src="./images/nginx-ingress.png" alt="nginx-ingress"></p>
<p><img src="./images/nginx-test-for-logs.png" alt="nginx-test-for-logs"></p>
<ul>
<li>ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ë° ì»¨í…Œì´ë„ˆ ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜ í™•ì¸
<ul>
<li>ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ëŠ” í‘œì¤€ ì¶œë ¥(stdout)ê³¼ í‘œì¤€ ì—ëŸ¬(stderr)ë¡œ ë‚˜ë‰˜ì–´ì„œ ë³´ë‚´ëŠ” ê²ƒì´ ê¶Œê³ ì‚¬í•­ (ì°¸ì¡°: <a href="https://kubernetes.io/ko/docs/concepts/cluster-administration/logging/">k8s Docs</a>)</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>kubectl logs deploy/nginx -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx ì›¹ ì ‘ì† ì‹œë„ ì‹œ ìœ„ì˜ ëª¨ë‹ˆí„°ë§ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨í…Œì´ë„ˆ ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it deploy/nginx -- ls -l /opt/bitnami/nginx/logs/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># total 0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># lrwxrwxrwx 1 root root 11 Feb 18 13:35 access.log -&gt; /dev/stdout</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># lrwxrwxrwx 1 root root 11 Feb 18 13:35 error.log -&gt; /dev/stderr</span>
</span></span></code></pre></div><p><img src="./images/container-logs-stdout-stderr.png" alt="container-logs-stdout-stderr"></p>
<h2 id="4-fluent-bit-integration-in-ccicw-container-insights-for-eks">4. Fluent Bit integration in CCI(CW Container Insights) for EKS</h2>
<ul>
<li>ì¶œì²˜: <a href="https://aws.amazon.com/ko/blogs/containers/fluent-bit-integration-in-cloudwatch-container-insights-for-eks/">AWS Docs</a></li>
<li>ë…¸ë“œì— CW Agent(Pod)ëŠ” Metrics ìˆ˜ì§‘, Fluent Bit PodëŠ” Logs ìˆ˜ì§‘ì„ ìœ„í•˜ì—¬ ë°ëª¬ ì…‹ìœ¼ë¡œ ë™ì‘</li>
<li>Fluent Bitì€ Fluentdì˜ ê²½ëŸ‰í™” ë²„ì „. config ì„¤ì •ì— ì°¨ì´ê°€ ìˆìŒ (ì°¸ì¡°: <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html">AWS Docs</a>)</li>
</ul>
<h3 id="4-1-application-ë°-host-ë¡œê·¸-ì†ŒìŠ¤-í™•ì¸">4-1. application ë° host ë¡œê·¸ ì†ŒìŠ¤ í™•ì¸</h3>
<ul>
<li>application ë¡œê·¸ ì†ŒìŠ¤: ê° ì»¨í…Œì´ë„ˆ/íŒŒë“œ ë¡œê·¸
<ul>
<li><code>/var/log/containers</code> â†’ ì‹¬ë³¼ë¦­ ë§í¬ <code>/var/log/pods/&lt;ì»¨í…Œì´ë„ˆ&gt;</code></li>
</ul>
</li>
<li>host ë¡œê·¸ ì†ŒìŠ¤: ë…¸ë“œ(í˜¸ìŠ¤íŠ¸) ë¡œê·¸
<ul>
<li><code>/var/log/dmesg</code>,Â <code>/var/log/secure</code>, <code>/var/log/messages</code></li>
</ul>
</li>
<li>dataplane ë¡œê·¸ ì†ŒìŠ¤: ì¿ ë²„ë„¤í‹°ìŠ¤ ë°ì´í„°í”Œë ˆì¸ ë¡œê·¸
<ul>
<li><code>/var/log/journal</code>Â forÂ kubelet.service/kubeproxy.service/docker.service</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># application ë¡œê·¸ ìœ„ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo tree /var/log/containers; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo ls -al /var/log/containers; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê°œë³„ íŒŒë“œ ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo tail -f /var/log/pods/default_nginx-&lt;íŒŒë“œ ê³ ìœ  ì´ë¦„&gt;/nginx/0.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># host ë¡œê·¸ ìœ„ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo tree /var/log/ -L 1; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo ls -la /var/log/; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># host ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> log in dmesg secure messages; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; Node1: /var/log/</span>$log<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$N1 sudo tail /var/log/$log; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> log in dmesg secure messages; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; Node2: /var/log/</span>$log<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$N2 sudo tail /var/log/$log; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> log in dmesg secure messages; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; Node3: /var/log/</span>$log<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$N3 sudo tail /var/log/$log; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dataplane ë¡œê·¸ ìœ„ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo tree /var/log/journal -L 1; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì €ë„ ë¡œê·¸ í™•ì¸ - ë§í¬</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 sudo journalctl -x -n <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 sudo journalctl -f
</span></span></code></pre></div><p><img src="./images/logs-source-check.png" alt="logs-source-check"></p>
<h3 id="4-2-ccicw-agent-ë°-fluent-bit-ì„¤ì¹˜-ë°-fluent-bit-ì„¤ì •">4-2. CCI(CW-agent ë° fluent-bit) ì„¤ì¹˜ ë° Fluent Bit ì„¤ì •</h3>
<ul>
<li>ì¶œì²˜: <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html#Container-Insights-FluentBit-setup">AWS Docs</a></li>
<li>CW-agentë‚˜ fluent-bitì´ë‚˜ <code>HostPath</code>ì— ìˆ˜ì§‘ëœ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆìŒì„ í™•ì¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>FluentBitHttpServer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;On&#39;</span>
</span></span><span style="display:flex;"><span>FluentBitHttpPort<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2020&#39;</span>
</span></span><span style="display:flex;"><span>FluentBitReadFromHead<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Off&#39;</span>
</span></span><span style="display:flex;"><span>FluentBitReadFromTail<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;On&#39;</span>
</span></span><span style="display:flex;"><span>curl -s https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml | sed <span style="color:#e6db74">&#39;s/{{cluster_name}}/&#39;</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;/;s/{{region_name}}/&#39;</span><span style="color:#e6db74">${</span>AWS_DEFAULT_REGION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;/;s/{{http_server_toggle}}/&#34;&#39;</span><span style="color:#e6db74">${</span>FluentBitHttpServer<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;/;s/{{http_server_port}}/&#34;&#39;</span><span style="color:#e6db74">${</span>FluentBitHttpPort<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;/;s/{{read_from_head}}/&#34;&#39;</span><span style="color:#e6db74">${</span>FluentBitReadFromHead<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;/;s/{{read_from_tail}}/&#34;&#39;</span><span style="color:#e6db74">${</span>FluentBitReadFromTail<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;/&#39;</span> | kubectl apply -f -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get-all -n amazon-cloudwatch
</span></span><span style="display:flex;"><span>kubectl get ds,pod,cm,sa -n amazon-cloudwatch
</span></span><span style="display:flex;"><span>kubectl describe clusterrole cloudwatch-agent-role fluent-bit-role                          <span style="color:#75715e"># í´ëŸ¬ìŠ¤í„°ë¡¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe clusterrolebindings cloudwatch-agent-role-binding fluent-bit-role-binding  <span style="color:#75715e"># í´ëŸ¬ìŠ¤í„°ë¡¤ ë°”ì¸ë”© í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl -n amazon-cloudwatch logs -l name<span style="color:#f92672">=</span>cloudwatch-agent -f <span style="color:#75715e"># íŒŒë“œ ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl -n amazon-cloudwatch logs -l k8s-app<span style="color:#f92672">=</span>fluent-bit -f    <span style="color:#75715e"># íŒŒë“œ ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt; </span>$node<span style="color:#e6db74"> &lt;&lt;&lt;&lt;&lt;&#34;</span>; ssh ec2-user@$node sudo ss -tnlp | grep fluent-bit; echo; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cloudwatch-agent ì„¤ì • í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe cm cwagentconfig -n amazon-cloudwatch
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;agent&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;region&#34;</span>: <span style="color:#e6db74">&#34;ap-northeast-2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;logs&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;metrics_collected&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;kubernetes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;myeks&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;metrics_collection_interval&#34;</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;force_flush_interval&#34;</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CW íŒŒë“œê°€ ìˆ˜ì§‘í•˜ëŠ” ë°©ë²• : Volumes -&gt; HostPath</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ssh ec2-user@$N1 sudo tree /dev/disk</span>
</span></span><span style="display:flex;"><span>kubectl describe -n amazon-cloudwatch ds cloudwatch-agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fluent Bit Cluster Info í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get cm -n amazon-cloudwatch fluent-bit-cluster-info -o yaml | yh
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  cluster.name: myeks
</span></span><span style="display:flex;"><span>  http.port: <span style="color:#e6db74">&#34;2020&#34;</span>
</span></span><span style="display:flex;"><span>  http.server: <span style="color:#e6db74">&#34;On&#34;</span>
</span></span><span style="display:flex;"><span>  logs.region: ap-northeast-2
</span></span><span style="display:flex;"><span>  read.head: <span style="color:#e6db74">&#34;Off&#34;</span>
</span></span><span style="display:flex;"><span>  read.tail: <span style="color:#e6db74">&#34;On&#34;</span>
</span></span><span style="display:flex;"><span>kind: ConfigMap
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fluent Bit ë¡œê·¸ INPUT/FILTER/OUTPUT ì„¤ì • í™•ì¸ - ë§í¬</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ì„¤ì • ë¶€ë¶„ êµ¬ì„± : application-log.conf , dataplane-log.conf , fluent-bit.conf , host-log.conf , parsers.conf</span>
</span></span><span style="display:flex;"><span>kubectl describe cm fluent-bit-config -n amazon-cloudwatch
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>application-log.conf:
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INPUT<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Name                tail
</span></span><span style="display:flex;"><span>    Tag                 application.*
</span></span><span style="display:flex;"><span>    Exclude_Path        /var/log/containers/cloudwatch-agent*, /var/log/containers/fluent-bit*, /var/log/containers/aws-node*, /var/log/containers/kube-proxy*
</span></span><span style="display:flex;"><span>    Path                /var/log/containers/*.log
</span></span><span style="display:flex;"><span>    multiline.parser    docker, cri
</span></span><span style="display:flex;"><span>    DB                  /var/fluent-bit/state/flb_container.db
</span></span><span style="display:flex;"><span>    Mem_Buf_Limit       50MB
</span></span><span style="display:flex;"><span>    Skip_Long_Lines     On
</span></span><span style="display:flex;"><span>    Refresh_Interval    <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    Rotate_Wait         <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>    storage.type        filesystem
</span></span><span style="display:flex;"><span>    Read_from_Head      <span style="color:#e6db74">${</span>READ_FROM_HEAD<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>FILTER<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Name                kubernetes
</span></span><span style="display:flex;"><span>    Match               application.*
</span></span><span style="display:flex;"><span>    Kube_URL            https://kubernetes.default.svc:443
</span></span><span style="display:flex;"><span>    Kube_Tag_Prefix     application.var.log.containers.
</span></span><span style="display:flex;"><span>    Merge_Log           On
</span></span><span style="display:flex;"><span>    Merge_Log_Key       log_processed
</span></span><span style="display:flex;"><span>    K8S-Logging.Parser  On
</span></span><span style="display:flex;"><span>    K8S-Logging.Exclude Off
</span></span><span style="display:flex;"><span>    Labels              Off
</span></span><span style="display:flex;"><span>    Annotations         Off
</span></span><span style="display:flex;"><span>    Use_Kubelet         On
</span></span><span style="display:flex;"><span>    Kubelet_Port        <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>    Buffer_Size         <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>OUTPUT<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    Name                cloudwatch_logs
</span></span><span style="display:flex;"><span>    Match               application.*
</span></span><span style="display:flex;"><span>    region              <span style="color:#e6db74">${</span>AWS_REGION<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    log_group_name      /aws/containerinsights/<span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span>/application
</span></span><span style="display:flex;"><span>    log_stream_prefix   <span style="color:#e6db74">${</span>HOST_NAME<span style="color:#e6db74">}</span>-
</span></span><span style="display:flex;"><span>    auto_create_group   true
</span></span><span style="display:flex;"><span>    extra_user_agent    container-insights
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fluent Bit íŒŒë“œê°€ ìˆ˜ì§‘í•˜ëŠ” ë°©ë²• : Volumes -&gt; HostPath</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ssh ec2-user@$N1 sudo tree /var/log</span>
</span></span><span style="display:flex;"><span>kubectl describe -n amazon-cloudwatch ds fluent-bit
</span></span></code></pre></div><p><img src="./images/cw-agent-fluent-bit.png" alt="cw-agent-fluent-bit"></p>
<p><img src="./images/cw-agent-fluent-bit-hostpath.png" alt="cw-agent-fluent-bit-hostpath"></p>
<p><img src="./images/cw-agent-fluent-bit-hostpath-ssh.png" alt="cw-agent-fluent-bit-hostpath-ssh"></p>
<ul>
<li>ì›¹ ì½˜ì†”ì—ì„œë„ Logs/Metrics í™•ì¸ ê°€ëŠ¥
<ul>
<li>Logs : CW -&gt; Logs -&gt; Log groups -&gt; /aws/containerinsights/myeks/application
<ul>
<li>NGINX ì›¹ì„œë²„ ë¶€í•˜ ë°œìƒì„ í†µí•œ ë¡œê·¸ í™•ì¸: Logsë¥¼ ëŒ€ìƒìœ¼ë¡œ <code>nginx</code> ê²€ìƒ‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë¶€í•˜ ë°œìƒ</span>
</span></span><span style="display:flex;"><span>curl -s https://nginx.$MyDomain
</span></span><span style="display:flex;"><span>yum install -y httpd
</span></span><span style="display:flex;"><span>ab -c <span style="color:#ae81ff">500</span> -n <span style="color:#ae81ff">30000</span> https://nginx.$MyDomain/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì§ì ‘ ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>kubectl logs deploy/nginx -f
</span></span></code></pre></div><p><img src="./images/cw-web-console-nginx-logs.png" alt="cw-web-console-nginx-logs"></p>
<ul>
<li>Metrics : CloudWatch -&gt; Insights -&gt; ContainerInsights -&gt; myeks
<ul>
<li>Container mapì„ í†µí•œ ì‹œê°í™”ê°€ ê°€ëŠ¥í•œë°, ê°„ê²©ì´ ë„ˆë¬´ ë²Œì–´ì ¸ì„œ ìˆì–´ í•œë²ˆì— ë³´ê¸° ë¶ˆí¸</li>
<li>ì´ì™¸ì—ë„, ë¦¬ì†ŒìŠ¤ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ ì§€ì›</li>
</ul>
</li>
</ul>
<p><img src="./images/cw-web-console-container-insights-container-map.png" alt="cw-web-console-container-insights-container-map"></p>
<p><img src="./images/cw-web-console-container-insights-performance-monitoring.png" alt="cw-web-console-container-insights-performance-monitoring"></p>
<p><img src="./images/cw-web-console-container-insights-application-stderr-query.png" alt="cw-web-console-container-insights-application-stderr-query"></p>
<h2 id="5-metric-server--kwatch--botkube-addon-tools">5. Metric-server / kwatch / botkube (addon tools)</h2>
<ul>
<li>Metric-server: kubeletìœ¼ë¡œë¶€í„° ìˆ˜ì§‘í•œ ë¦¬ì†ŒìŠ¤ metricsë¥¼ ìˆ˜ì§‘-ì§‘ê³„í•˜ëŠ” cluster addon</li>
<li>kwatch: k8s í´ëŸ¬ìŠ¤í„°ì˜ ë³€í™”ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì—¬, Slack/Discord ë“±ìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ë‚´ì£¼ëŠ” ë„êµ¬
<ul>
<li>Slack ë“±ì—ì„œ ì‚¬ìš©ì„ ìœ„í•´ Webhook í† í° í•„ìš”</li>
</ul>
</li>
<li>botkube: Slack/Discord í™˜ê²½ì—ì„œ Botì„ í†µí•´, ê°„ë‹¨í•˜ê²Œ k8s ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬
<ul>
<li>ì‹¤ìŠµì—ì„œëŠ” Slack API Bot/App í† í° ì‚¬ìš©</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Metric-server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë©”íŠ¸ë¦­ ì„œë²„ í™•ì¸ : ë©”íŠ¸ë¦­ì€ 15ì´ˆ ê°„ê²©ìœ¼ë¡œ cAdvisorë¥¼ í†µí•˜ì—¬ ê°€ì ¸ì˜´</span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l k8s-app<span style="color:#f92672">=</span>metrics-server
</span></span><span style="display:flex;"><span>kubectl api-resources | grep metrics
</span></span><span style="display:flex;"><span>kubectl get apiservices |egrep <span style="color:#e6db74">&#39;(AVAILABLE|metrics)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ë©”íŠ¸ë¦­ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl top node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ë©”íŠ¸ë¦­ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl top pod -A
</span></span><span style="display:flex;"><span>kubectl top pod -n kube-system --sort-by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cpu&#39;</span>
</span></span><span style="display:flex;"><span>kubectl top pod -n kube-system --sort-by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;memory&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#########</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## kwatch</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#########</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># configmap ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; ~/kwatch-config.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Namespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: kwatch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ConfigMap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: kwatch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kwatch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">data:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  config.yaml: |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alert:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      slack:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        webhook: &#39;https://hooks.slack.com/services/&lt;Webhook í† í°&gt;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        title: $NICK-EKS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #text:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    pvcMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      interval: 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      threshold: 70
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kwatch-config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/abahmed/kwatch/v0.8.3/deploy/deploy.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## (ì¥ì•  ì¬í˜„)ì˜ëª»ëœ ì´ë¯¸ì§€ë¥¼ ë°°í¬í•˜ì—¬, kwatchê°€ ì•Œë¦¼ì„ ë³´ë‚´ëŠ”ì§€ í™•ì¸</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>watch kubectl get pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì˜ëª»ëœ ì´ë¯¸ì§€ ì •ë³´ì˜ íŒŒë“œ ë°°í¬</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/junghoon2/kube-books/main/ch05/nginx-error-pod.yml
</span></span><span style="display:flex;"><span>kubectl get events -w
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ë°©ì•ˆ : set ì‚¬ìš© - image ë“± ì¼ë¶€ ë¦¬ì†ŒìŠ¤ ê°’ì„ ë³€ê²½ ê°€ëŠ¥!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì—…ë°ì´íŠ¸ í•˜ì˜€ì„ ì‹œ, ì—ëŸ¬ ì•Œë¦¼ì´ ì˜¤ì§€ ì•ŠìŒ</span>
</span></span><span style="display:flex;"><span>kubectl set 
</span></span><span style="display:flex;"><span>kubectl set image pod nginx-19 nginx-pod<span style="color:#f92672">=</span>nginx:1.19
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod nginx-19
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## botkube</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##########</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># repo ì¶”ê°€</span>
</span></span><span style="display:flex;"><span>helm repo add botkube https://charts.botkube.io
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>export SLACK_API_BOT_TOKEN<span style="color:#f92672">=</span>&lt;Bot í† í°&gt;
</span></span><span style="display:flex;"><span>export SLACK_API_APP_TOKEN<span style="color:#f92672">=</span>&lt;App í† í°&gt;
</span></span><span style="display:flex;"><span>export ALLOW_KUBECTL<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>export ALLOW_HELM<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>export SLACK_CHANNEL_NAME<span style="color:#f92672">=</span>webhook3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; botkube-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">actions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#39;describe-created-resource&#39;: # kubectl describe
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#39;show-logs-on-error&#39;: # kubectl logs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">executors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  k8s-default-tools:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    botkube/helm:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    botkube/kubectl:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>helm install --version v1.0.0 botkube --namespace botkube --create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set communications.default-group.socketSlack.enabled<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set communications.default-group.socketSlack.channels.default.name<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SLACK_CHANNEL_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set communications.default-group.socketSlack.appToken<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SLACK_API_APP_TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set communications.default-group.socketSlack.botToken<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SLACK_API_BOT_TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set settings.clusterName<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set <span style="color:#e6db74">&#39;executors.k8s-default-tools.botkube/kubectl.enabled&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ALLOW_KUBECTL<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set <span style="color:#e6db74">&#39;executors.k8s-default-tools.botkube/helm.enabled&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ALLOW_HELM<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f botkube-values.yaml botkube/botkube
</span></span></code></pre></div><p><img src="./images/metrics-server.png" alt="metrics-server"></p>
<p><img src="./images/kwatch-installation-and-make-wrong-pod.png" alt="kwatch-installation-and-make-wrong-pod"></p>
<p><img src="./images/kwatch-webhook-slack-with-error.png" alt="kwatch-webhook-slack-with-error"></p>
<pre tabindex="0"><code class="language-slack" data-lang="slack"># Slackì—ì„œ botkube ì•±ì„ ì¶”ê°€í•˜ê³ , ì±„ë„ì— ì´ˆëŒ€

# ì—°ê²° ìƒíƒœ, notifications ìƒíƒœ í™•ì¸
@Botkube ping
@Botkube status notifications

# ì˜ëª»ëœ ì´ë¯¸ì§€ ì •ë³´ì˜ íŒŒë“œ ë°°í¬ í›„ íŒŒë“œ ì •ë³´ ì¡°íšŒ
# kubectl apply -f https://raw.githubusercontent.com/junghoon2/kube-books/main/ch05/nginx-error-pod.yml
# kubectl get events -w
@Botkube k get pod
@Botkube kc get pod --namespace kube-system
@Botkube kubectl get pod --namespace kube-system -o wide

# Actionable notifications: ë“œë¡­ë‹¤ìš´ì„ í†µí•´ ëª…ë ¹ì–´ ì„ íƒ ê°€ëŠ¥
@Botkube kubectl
</code></pre><p><img src="./images/botkube-webhook-slack.png" alt="botkube-webhook-slack"></p>
<h2 id="6-prometheus-ìŠ¤íƒ">6. Prometheus ìŠ¤íƒ</h2>
<ul>
<li>Prometheus ë° Grafanaë¥¼ ë‹¨ì¼ ìŠ¤íƒìœ¼ë¡œ ì„¤ì¹˜</li>
<li>ì‹¤ìŠµì—ì„œëŠ” ACM, Route53, ALBë¥¼ ì—°ë™í•˜ì—¬ HTTPS ë¦¬ë””ë ‰ì…˜ì„ ì ìš©</li>
</ul>
<p><img src="./images/alb-with-acm-route53.png" alt="alb-with-acm-route53"></p>
<p><img src="./images/alb-https-redirection.png" alt="alb-https-redirection"></p>
<h3 id="6-1-prometheus-ìŠ¤íƒ-ì„¤ì¹˜">6-1. Prometheus ìŠ¤íƒ ì„¤ì¹˜</h3>
<ul>
<li><del>alertmanager-0</del>:
<ul>
<li>ê³ ì§ˆì ì¸ firing ì—ëŸ¬(?)ë¡œ ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” skip</li>
<li>ì‚¬ì „ì— ì •ì˜í•œ ì •ì±… ê¸°ë°˜(ì˜ˆ: ë…¸ë“œ ë‹¤ìš´, íŒŒë“œ Pending ë“±)ìœ¼ë¡œ ì‹œìŠ¤í…œ ê²½ê³  ë©”ì‹œì§€ë¥¼ ìƒì„± í›„ ê²½ë³´ ì±„ë„(ìŠ¬ë™ ë“±)ë¡œ ì „ì†¡</li>
</ul>
</li>
<li>grafana:<br>
í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•˜ë©°, ê·¸ë¼íŒŒë‚˜ë¡œ ì‹œê°í™” ì²˜ë¦¬</li>
<li>prometheus-0:<br>
ëª¨ë‹ˆí„°ë§ ëŒ€ìƒì´ ë˜ëŠ” íŒŒë“œëŠ” â€˜exporterâ€™ë¼ëŠ” ë³„ë„ì˜ ì‚¬ì´ë“œì¹´ í˜•ì‹ì˜ íŒŒë“œì—ì„œ ëª¨ë‹ˆí„°ë§ ë©”íŠ¸ë¦­ì„ ë…¸ì¶œ, pull ë°©ì‹ìœ¼ë¡œ ê°€ì ¸ì™€ ë‚´ë¶€ì˜ ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</li>
<li>node-exporter:<br>
ë…¸ë“œìµìŠ¤í¬í„°ëŠ” ë¬¼ë¦¬ ë…¸ë“œì— ëŒ€í•œ ìì› ì‚¬ìš©ëŸ‰(ë„¤íŠ¸ì›Œí¬, ìŠ¤í† ë¦¬ì§€ ë“± ì „ì²´) ì •ë³´ë¥¼ ë©”íŠ¸ë¦­ í˜•íƒœë¡œ ë³€ê²½í•˜ì—¬ ë…¸ì¶œ</li>
<li>operator:<br>
ì‹œìŠ¤í…œ ê²½ê³  ë©”ì‹œì§€ ì •ì±…(prometheus rule), ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ ì¶”ê°€ ë“±ì˜ ì‘ì—…ì„ í¸ë¦¬í•˜ê²Œ í• ìˆ˜ ìˆê²Œ CRD ì§€ì›</li>
<li>kube-state-metrics:<br>
ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœ(kube-state)ë¥¼ ë©”íŠ¸ë¦­ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” íŒŒë“œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>kubectl create ns monitoring
</span></span><span style="display:flex;"><span>watch kubectl get pod,pvc,svc,ingress -n monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚¬ìš© ë¦¬ì „ì˜ ì¸ì¦ì„œ ARN í™•ì¸</span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># repo ì¶”ê°€</span>
</span></span><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; monitor-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  prometheusSpec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    podMonitorSelectorNilUsesHelmValues: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    serviceMonitorSelectorNilUsesHelmValues: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    retention: 5d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    retentionSize: &#34;10GiB&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - prometheus.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    paths: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">grafana:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  defaultDashboardsTimezone: Asia/Seoul
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  adminPassword: prom-operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - grafana.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    paths: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  create: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeControllerManager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeEtcd:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeScheduler:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alertmanager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># alertmanager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#   ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#     enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#     ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#     hosts: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       - alertmanager.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#     paths: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       - /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#     annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#       alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>cat monitor-values.yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 45.27.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set prometheus.prometheusSpec.scrapeInterval<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;15s&#39;</span> --set prometheus.prometheusSpec.evaluationInterval<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;15s&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f monitor-values.yaml --namespace monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>helm list -n monitoring
</span></span><span style="display:flex;"><span>kubectl get pod,svc,ingress -n monitoring
</span></span><span style="display:flex;"><span>kubectl get-all -n monitoring
</span></span><span style="display:flex;"><span>kubectl get prometheus,servicemonitors -n monitoring
</span></span><span style="display:flex;"><span>kubectl get crd | grep monitoring
</span></span></code></pre></div><p><img src="./images/prometheus-stack-installation.png" alt="prometheus-stack-installation"></p>
<h3 id="6-2-prometheus-ê¸°ë³¸ì -ì‚¬ìš©">6-2. Prometheus ê¸°ë³¸ì  ì‚¬ìš©</h3>
<ul>
<li>ëª¨ë‹ˆí„°ë§ ëŒ€ìƒì¸ ì„œë¹„ìŠ¤ëŠ” 3ì—ì„œ ë‹¤ë£¨ì—ˆë“¯ì´ /metrics ì—”ë“œí¬ì¸íŠ¸ê°€ ë…¸ì¶œë˜ì–´ìˆìŒ
<ul>
<li>p8sëŠ” http get ë°©ì‹ìœ¼ë¡œ metricsë¥¼ ê°€ì ¸ì™€ TSDB í˜•ì‹ìœ¼ë¡œ ì €ì¥</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì•„ë˜ ì²˜ëŸ¼ í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ê° ì„œë¹„ìŠ¤ì˜ 9100 ì ‘ì†í•˜ì—¬ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ìˆ˜ì§‘</span>
</span></span><span style="display:flex;"><span>kubectl get node -owide
</span></span><span style="display:flex;"><span>kubectl get svc,ep -n monitoring kube-prometheus-stack-prometheus-node-exporter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œì˜ 9100ë²ˆì˜ /metrics ì ‘ì† ì‹œ ë‹¤ì–‘í•œ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ í™•ì¸í• ìˆ˜ ìˆìŒ : ë§ˆìŠ¤í„° ì´ì™¸ì— ì›Œì»¤ë…¸ë“œë„ í™•ì¸ ê°€ëŠ¥</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 curl -s localhost:9100/metrics
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get ingress -n monitoring kube-prometheus-stack-prometheus
</span></span><span style="display:flex;"><span>kubectl describe ingress -n monitoring kube-prometheus-stack-prometheus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í”„ë¡œë©”í…Œìš°ìŠ¤ ingress ë„ë©”ì¸ìœ¼ë¡œ ì›¹ ì ‘ì†</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Prometheus Web URL = https://prometheus.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p><img src="./images/prometheus-metrics-with-ssh.png" alt="prometheus-metrics-with-ssh"></p>
<ul>
<li>í”„ë¡œë©”í…Œìš°ìŠ¤ ingress ë„ë©”ì¸ìœ¼ë¡œ ì›¹ ì ‘ì†
<ol>
<li>ê²½ê³ (Alert) : ì‚¬ì „ì— ì •ì˜í•œ ì‹œìŠ¤í…œ ê²½ê³  ì •ì±…(Prometheus Rules)ì— ëŒ€í•œ ìƒí™©</li>
<li>ê·¸ë˜í”„(Graph) : í”„ë¡œë©”í…Œìš°ìŠ¤ ìì²´ ê²€ìƒ‰ ì–¸ì–´ PromQLì„ ì´ìš©í•˜ì—¬ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ì¡°íšŒ -&gt; ë‹¨ìˆœí•œ ê·¸ë˜í”„ í˜•íƒœ ì¡°íšŒ</li>
<li>ìƒíƒœ(Status) : ê²½ê³  ë©”ì‹œì§€ ì •ì±…(Rules), ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ(Targets) ë“± ë‹¤ì–‘í•œ í”„ë¡œë©”í…Œìš°ìŠ¤ ì„¤ì • ë‚´ì—­ì„ í™•ì¸ &gt; ë²„ì „(2.42.0)</li>
<li>ë„ì›€ë§(Help)</li>
</ol>
</li>
<li>í”„ë¡œë©”í…Œìš°ìŠ¤ ì„¤ì •(Configuration) í™•ì¸:
<ol>
<li>Status â†’ Runtime &amp; Build Information â‡’ Storage retention
<ul>
<li>5d or 10GiB: ë©”íŠ¸ë¦­ ì €ì¥ ê¸°ê°„ì´ 5ì¼ ê²½ê³¼ í˜¹ì€ 10GiB ì´ìƒ ì‹œ ì‚­ì œ</li>
<li>helm íŒŒë¼ë¯¸í„°ì—ì„œ ìˆ˜ì • í›„ ì ìš© ê°€ëŠ¥</li>
<li>Status â†’ Command-Line Flags ì—ì„œë„ í™•ì¸ ê°€ëŠ¥
<ul>
<li>&ndash;storage.tsdb.retention.time=5d</li>
<li>&ndash;storage.tsdb.retention.size=10GB</li>
</ul>
</li>
</ul>
</li>
<li>Status â†’ Configuration â‡’ â€œnode-exporterâ€ ê²€ìƒ‰
<ul>
<li><code>metrics_path: /metrics, scheme: http</code>, <code>role: endpoints</code> ë¥¼ í™•ì¸</li>
</ul>
</li>
</ol>
</li>
<li>ì „ì²´ metrics targets(ëŒ€ìƒ) í™•ì¸:
<ul>
<li>Status â†’ Targets</li>
<li>ê° ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ê°€ëŠ¥</li>
</ul>
</li>
<li>ë©”íŠ¸ë¦­ì„ ê·¸ë˜í”„(Graph)ë¡œ ì¡°íšŒ:
<ul>
<li>Graph</li>
<li>ì•„ë˜ PromQL ì¿¼ë¦¬(ì „ì²´ í´ëŸ¬ìŠ¤í„° ë…¸ë“œì˜ CPU ì‚¬ìš©ëŸ‰ í•©ê³„)ì…ë ¥ í›„ ì¡°íšŒ â†’ Graph í™•ì¸</li>
<li><code>1- avg(rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[1m]))</code> ì…ë ¥</li>
</ul>
</li>
</ul>
<p><img src="./images/prometheus-storage-retention.png" alt="prometheus-storage-retention"></p>
<p><img src="./images/prometheus-storage-retention-flags.png" alt="prometheus-storage-retention-flags"></p>
<p><img src="./images/prometheus-service-discovery-endpoints.png" alt="prometheus-service-discovery-endpoints"></p>
<p><img src="./images/prometheus-targets-with-endpoints.png" alt="prometheus-targets-with-endpoints"></p>
<p><img src="./images/promql-query-node-cpu-total.png" alt="promql-query-node-cpu-total"></p>
<h3 id="6-3-grafana">6-3. Grafana</h3>
<ul>
<li>TSDB ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ëŠ” ëŒ€ì‹œë³´ë“œ ì œê³µ</li>
<li>ì ‘ì† ì •ë³´ í™•ì¸ ë° ë¡œê·¸ì¸: ì´ˆê¸° ê³„ì • - admin / prom-operator</li>
<li>ì„¤ì¹˜í•œ ìŠ¤íƒì—ì„œëŠ” ìë™ìœ¼ë¡œ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ë°ì´í„° ì†ŒìŠ¤ë¡œ ì¶”ê°€í•´ë‘ 
<ul>
<li><code>http://kube-prometheus-stack-prometheus.monitoring:9090/</code></li>
</ul>
</li>
</ul>
<p><img src="./images/prometheus-stack-auto-data-source.png" alt="prometheus-stack-auto-data-source"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ë¼íŒŒë‚˜ ë²„ì „ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it -n monitoring deploy/kube-prometheus-stack-grafana -- grafana-cli --version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get ingress -n monitoring kube-prometheus-stack-grafana
</span></span><span style="display:flex;"><span>kubectl describe ingress -n monitoring kube-prometheus-stack-grafana
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress ë„ë©”ì¸ìœ¼ë¡œ ì›¹ ì ‘ì† : ê¸°ë³¸ ê³„ì • - admin / prom-operator</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Grafana Web URL = https://grafana.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ë°ì´í„° ì†ŒìŠ¤ ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: netshoot-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: nicolaka/netshoot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command: [&#34;tail&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    args: [&#34;-f&#34;, &#34;/dev/null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl get pod netshoot-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it netshoot-pod -- nslookup kube-prometheus-stack-prometheus.monitoring
</span></span><span style="display:flex;"><span>kubectl exec -it netshoot-pod -- curl -s kube-prometheus-stack-prometheus.monitoring:9090/graph -v ; echo
</span></span></code></pre></div><p><img src="./images/prometheus-stack-auto-data-source-in-cli.png" alt="prometheus-stack-auto-data-source-in-cli"></p>
<h3 id="6-4-grafana-ëŒ€ì‹œë³´ë“œ-import">6-4. Grafana ëŒ€ì‹œë³´ë“œ import</h3>
<ul>
<li>Kubernetes All-in-one Cluster Monitoring KR( 13770 )</li>
</ul>
<p><img src="./images/k8s-cluster-monitoring-kr-13770.png" alt="k8s-cluster-monitoring-kr-13770"></p>
<ul>
<li>AWS EKS CNI Metrics( 16032 ): ì´ ëŒ€ì‹œë³´ë“œë¥¼ ì“°ë ¤ë©´ ì•„ë˜ì˜ ì‘ì—…ì´ ì„ í–‰ì¡°ê±´</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># PodMonitor ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: monitoring.coreos.com/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PodMonitor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: aws-cni-metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  jobLabel: k8s-app
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespaceSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchNames:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - kube-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  podMetricsEndpoints:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - interval: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port: metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      k8s-app: aws-node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PodMonitor í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get podmonitor -n kube-system
</span></span></code></pre></div><p><img src="./images/aws-cni-metrics-16032.png" alt="aws-cni-metrics-16032"></p>
<ul>
<li>NGINX application ëª¨ë‹ˆí„°ë§( 12708 ):
<ul>
<li>6-5ì—ì„œ ë¶€í•˜ ì§„í–‰</li>
<li>ë°˜ë³µ ì ‘ì†(ë¶€í•˜)í•˜ì—¬ metrics ë³€í™” í™•ì¸</li>
<li><strong>helmìœ¼ë¡œ ì„¤ì¹˜ì‹œ, <code>nginx-exporter</code> ì˜µì…˜ì„ ê±¸ë©´, p8s ëª¨ë‹ˆí„°ë§ì— ìë™ ë“±ë¡</strong></li>
<li>ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„° ë°©ì‹ìœ¼ë¡œ nginx ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ ë“±ë¡ì„ ìœ„í•œ ì‹¤ìŠµ íŒŒë¼ë¯¸í„°
<ul>
<li>export ëŠ” 9113 í¬íŠ¸ ì‚¬ìš©</li>
<li>nginx ì›¹ì„œë²„ ë…¸ì¶œì€ AWS CLB ê¸°ë³¸ ì‚¬ìš©</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>watch -d kubectl get pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„± : </span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; ~/nginx_metric-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metrics:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port: 9113
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  serviceMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: monitoring
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    interval: 10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>helm upgrade nginx bitnami/nginx --reuse-values -f nginx_metric-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod,svc,ep
</span></span><span style="display:flex;"><span>kubectl get servicemonitor -n monitoring nginx
</span></span><span style="display:flex;"><span>kubectl get servicemonitor -n monitoring nginx -o json | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë©”íŠ¸ë¦­ í™•ì¸ &gt;&gt; í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ Target í™•ì¸</span>
</span></span><span style="display:flex;"><span>NGINXIP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app.kubernetes.io/instance<span style="color:#f92672">=</span>nginx -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>curl -s http://$NGINXIP:9113/metrics <span style="color:#75715e"># nginx_connections_active Y ê°’ í™•ì¸í•´ë³´ê¸°</span>
</span></span><span style="display:flex;"><span>curl -s http://$NGINXIP:9113/metrics | grep ^nginx_connections_active
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx íŒŒë“œë‚´ì— ì»¨í…Œì´ë„ˆ ê°¯ìˆ˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod -l app.kubernetes.io/instance<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>kubectl describe pod -l app.kubernetes.io/instance<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì ‘ì† ì£¼ì†Œ í™•ì¸ ë° ì ‘ì†</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Nginx WebServer URL = https://nginx.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>curl -s https://nginx.$MyDomain
</span></span><span style="display:flex;"><span>kubectl logs deploy/nginx -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°˜ë³µ ì ‘ì†</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> curl -s https://nginx.$MyDomain -I | head -n 1; date; sleep 1; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p><img src="./images/nginx-exporter-for-prometheus.png" alt="nginx-exporter-for-prometheus"></p>
<p><img src="./images/target-added-in-prometheus.png" alt="target-added-in-prometheus"></p>
<h3 id="6-5-grafana-alert">6-5. Grafana Alert</h3>
<ul>
<li>Alert rules ë° Contact point ì„¤ì •í•˜ì—¬ í…ŒìŠ¤íŠ¸
<ul>
<li>Alert rules : Alert ë°œìƒ ì¡°ê±´ ì„¤ì •</li>
<li>Contact point : Alert ë°œìƒì‹œ ì•Œë¦¼ì„ ë°›ì„ ëŒ€ìƒ ì„¤ì • (Slack ì›¹í›… í™œìš©)</li>
</ul>
</li>
<li>Slackìš©ìœ¼ë¡œ Notification policiesì˜ ê¸°ë³¸ ì •ì±…ë„ Slackìœ¼ë¡œ ë³€ê²½</li>
<li>ì´í›„ì— NGINX ë°˜ë³µ ì ‘ì†ìœ¼ë¡œ ìŠ¬ë™ ì±„ë„ ì•ŒëŒ í™•ì¸
<ul>
<li><code>while true; do curl -s https://nginx.$MyDomain -I | head -n 1; date; sleep 1; done</code></li>
</ul>
</li>
<li>Contact point ì„¤ì • ì‹œ, ì§€ì • ëŒ€ìƒì—ê²Œ ì œëŒ€ë¡œ ë©˜ì…˜ì´ ê±¸ë¦¬ì§€ ì•ŠìŒì„ í™•ì¸.</li>
</ul>
<p><img src="./images/alert-rules-set-in-grafana.png" alt="alert-rules-set-in-grafana"></p>
<p><img src="./images/grafana-dashboard-after-making-alert-situation.png" alt="grafana-dashboard-after-making-alert-situation"></p>
<p><img src="./images/grafana-alert-in-slack.png" alt="grafana-alert-in-slack"></p>
<h2 id="7-kubecost">7. kubecost</h2>
<ul>
<li>k8s ë¦¬ì†ŒìŠ¤ë³„ ë¹„ìš© ë¶„ë¥˜ ëŒ€ì‹œë³´ë“œ, ì²˜ìŒ ë„ìš´ í›„ 15ë¶„ ì •ë„ ê¸°ë‹¤ë ¤ì•¼ ë°ì´í„° í‘œì¶œ</li>
<li>kubecostì˜ ê²½ìš°, cloudformation ì œê±° í›„ì—ë„ ë°ì´í„°(dynamic-pvc)ê°€ ë‚¨ì•„ìˆì–´ì„œ ì™„ì „íˆ ì—†ì• ê³ ì ì›¹ ì½˜ì†”ì—ì„œ ë³¼ë¥¨ ì‚­ì œë¥¼ ì§„í–‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; cost-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  grafana:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    proxy: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">priority:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">networkPolicy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">podSecurityPolicy:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">persistentVolume:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    storageClass: &#34;gp3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kube-state-metrics:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    disabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  nodeExporter:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">reporting:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  productAnalytics: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubecost chart ì— í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë‹ˆ, ê¸°ì¡´ í”„ë¡œë©”í…Œìš°ìŠ¤-ìŠ¤íƒì€ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node-export í¬íŠ¸ ì¶©ëŒ ë°œìƒ</span>
</span></span><span style="display:flex;"><span>helm uninstall -n monitoring kube-prometheus-stack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>kubectl create ns kubecost
</span></span><span style="display:flex;"><span>helm install kubecost oci://public.ecr.aws/kubecost/cost-analyzer --version 1.103.2 --namespace kubecost -f cost-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get-all -n kubecost
</span></span><span style="display:flex;"><span>kubectl get all -n kubecost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubecost-cost-analyzer íŒŒë“œ IPë³€ìˆ˜ ì§€ì • ë° ì ‘ì† í™•ì¸</span>
</span></span><span style="display:flex;"><span>CAIP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -n kubecost -l app<span style="color:#f92672">=</span>cost-analyzer -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>curl -s $CAIP:9090
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì™¸ë¶€ì—ì„œ bastion EC2 ì ‘ì†í•˜ì—¬ íŠ¹ì • íŒŒë“œ ì ‘ì† ë°©ë²• : socat(SOcket CAT) í™œìš©</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ bastion EC2 IPë¡œ ì ‘ì†</span>
</span></span><span style="display:flex;"><span>yum -y install socat
</span></span><span style="display:flex;"><span>socat TCP-LISTEN:80,fork TCP:$CAIP:9090
</span></span></code></pre></div><p><img src="./images/kubecost-installation.png" alt="kubecost-installation"></p>
<p><img src="./images/kubecost-dashboard-after-about-15-minutes.png" alt="kubecost-dashboard-after-about-15-minutes"></p>
<p><img src="./images/kubecost-dynamic-pvc-after-delete-cloudformation-stack.png" alt="kubecost-dynamic-pvc-after-delete-cloudformation-stack"></p>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho@ubuntu-kr.org">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/modify-bastion-cidr-with-aws-cli/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">aws-clië¥¼ ì´ìš©í•œ bastion CIDR ë³€ê²½</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/aws-eks-study-week5/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">AWS EKS ìŠ¤í„°ë”” 5ì£¼ì°¨ - Autoscaling</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho@ubuntu-kr.org">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <p></p>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
