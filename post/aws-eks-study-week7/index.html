<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 7ì£¼ì°¨ - Automation | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 7ì£¼ì°¨ - Automation" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week7/cover.jpg' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week7/cover.jpg' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week7/cover.jpg' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.8c1fb07f2dee90a6523f7317a7d023e3c1b14bd4706bff237c94e366d59facf9.css">
</head><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>
     
     <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸŒ
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
            
            
          </ul>
        </li>
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
<div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.jpg'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 7ì£¼ì°¨ - Automation</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-06-10T15:13:19&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/automation" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">automation</span>
              </div>
            </a>
            
            <a href="/tags/ack" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">ACK</span>
              </div>
            </a>
            
            <a href="/tags/flux" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">flux</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>EKS ìŠ¤í„°ë””ë„ ë§ˆì§€ë§‰ 7ì£¼ì°¨ë¥¼ ë§ì´í–ˆìŠµë‹ˆë‹¤.</p>
<p>ì´ë²ˆì—ëŠ” AWS Controller for k8s(ACK)ì™€ fluxë¥¼ ê°€ë³ê²Œ ì‹¤ìŠµí•´ë³´ê³ <br>
ìë™í™”ì— ëŒ€í•´ ë§›ë³´ê¸°ë¥¼ í•´ë³´ì•˜ìŠµë‹ˆë‹¤.</p>
<p>ì•ì„œ í•™ìŠµí•´ë³¸ IRSA ê°œë… ì™¸ì—ë„ CRD(CustomResourceDefinition)ì„ í™œìš©í•©ë‹ˆë‹¤.</p>
<h2 id="1-ì‹¤ìŠµí™˜ê²½-ë°°í¬">1. ì‹¤ìŠµí™˜ê²½ ë°°í¬</h2>
<p>ì‹¤ìŠµì„ ìœ„í•œ YAMLíŒŒì¼ì´ ë³€ê²½ëœê±° ë§ê³ ëŠ” 6ì£¼ì°¨ì™€ ìœ ì‚¬í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick6.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´í•˜ ì¤‘ëµ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CERT_ARN(ACM)ì˜ ê²½ìš°ì—ëŠ” /etc/profileì— í™˜ê²½ë³€ìˆ˜ ì €ì¥ì„ ì•ˆí•´ë‘¬ì„œ  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¸ì…˜ì´ ë§Œë£Œë˜ë©´, ë‹¤ì‹œ ì¬ì„¤ì • í•„ìš”</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span></code></pre></div><h2 id="2-ackaws-controller-for-k8s">2. ACK(AWS Controller for k8s)</h2>
<ul>
<li>ì›¹ì½˜ì†”ì— ì ‘ê·¼í•˜ì§€ ì•Šê³ ë„, AWS ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì§ì ‘ k8sì—ì„œ ì •ì˜ ë° ì‚¬ìš©ê°€ëŠ¥</li>
<li>ìˆœì„œ: ACK ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜ -&gt; IRSA ì„¤ì • -&gt; AWS ë¦¬ì†ŒìŠ¤ ì»¨íŠ¸ë¡¤
<ul>
<li>ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ìˆëŠ”ë°, Cloudformationì„ ì“°ë‹¤ë³´ë‹ˆ ì¤‘ê°„ì¤‘ê°„ ëŒ€ê¸° ì‹œê°„ ë°œìƒ</li>
</ul>
</li>
<li>(23/05/29) GA: 17ê°œ ì„œë¹„ìŠ¤, Preview: 10ê°œ ì„œë¹„ìŠ¤</li>
</ul>
<h3 id="2-1-s3">2-1. S3</h3>
<ul>
<li>[ACK S3 Controller ì„¤ì¹˜]</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¹„ìŠ¤ëª… ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>export SERVICE<span style="color:#f92672">=</span>s3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>export RELEASE_VERSION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sL https://api.github.com/repos/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep <span style="color:#e6db74">&#39;&#34;tag_name&#34;:&#39;</span> | cut -d<span style="color:#e6db74">&#39;&#34;&#39;</span> -f4 | cut -c 2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>helm pull oci://public.ecr.aws/aws-controllers-k8s/$SERVICE-chart --version<span style="color:#f92672">=</span>$RELEASE_VERSION
</span></span><span style="display:flex;"><span>tar xzvf $SERVICE-chart-$RELEASE_VERSION.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm chart í™•ì¸</span>
</span></span><span style="display:flex;"><span>tree ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ACK S3 Controller ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>export ACK_SYSTEM_NAMESPACE<span style="color:#f92672">=</span>ack-system
</span></span><span style="display:flex;"><span>export AWS_REGION<span style="color:#f92672">=</span>ap-northeast-2
</span></span><span style="display:flex;"><span>helm install --create-namespace -n $ACK_SYSTEM_NAMESPACE ack-$SERVICE-controller --set aws.region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$AWS_REGION<span style="color:#e6db74">&#34;</span> ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>helm list --namespace $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>kubectl -n ack-system get pods
</span></span><span style="display:flex;"><span>kubectl get crd | grep $SERVICE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get all -n ack-system
</span></span><span style="display:flex;"><span>kubectl get-all -n ack-system
</span></span><span style="display:flex;"><span>kubectl describe sa -n ack-system ack-s3-controller
</span></span></code></pre></div><ul>
<li>[IRSA ì„¤ì •] AmazonS3FullAccess
<ul>
<li>ì„¤ì • í›„ì—ëŠ” rolloutìœ¼ë¡œ ë°˜ì˜í•´ì£¼ì–´ì•¼í•¨</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create an iamserviceaccount - AWS IAM role bound to a Kubernetes service account</span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name ack-$SERVICE-controller <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace ack-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster $CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn <span style="color:#66d9ef">$(</span>aws iam list-policies --query <span style="color:#e6db74">&#39;Policies[?PolicyName==`AmazonS3FullAccess`].Arn&#39;</span> --output text<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --override-existing-serviceaccounts --approve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>kubectl get sa -n ack-system
</span></span><span style="display:flex;"><span>kubectl describe sa ack-$SERVICE-controller -n ack-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restart ACK service controller deployment using the following commands.</span>
</span></span><span style="display:flex;"><span>kubectl -n ack-system rollout restart deploy ack-$SERVICE-controller-$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IRSA ì ìš©ìœ¼ë¡œ Env, projected Volume ì¶”ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe pod -n ack-system -l k8s-app<span style="color:#f92672">=</span>$SERVICE-chart
</span></span></code></pre></div><p><img src="./images/ISRA-with-override.png" alt="ISRA with override"></p>
<p><img src="./images/check-helm-chart-after-applying-IRSA.png" alt="check helm chart after applying IRSA"></p>
<ul>
<li>[ë¦¬ì†ŒìŠ¤ ì¡°ì‘] S3 ë²„í‚· ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ
<ul>
<li>ìƒˆë¡œìš´ ì‰˜ë¡œ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>watch -d aws s3 ls</code></li>
<li>S3 ë²„í‚·ë„¤ì„ì€ ì „ì„¸ê³„ì—ì„œ ê³ ìœ í•´ì•¼í•˜ë¯€ë¡œ ê°ì ë³¸ì¸ì´ ì“°ê³  ìˆëŠ” ê³„ì •ëª…ìœ¼ë¡œ ëª…ëª…</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ìƒì„±ì„ ìœ„í•œ ì„¤ì • íŒŒì¼ ìƒì„±</span>
</span></span><span style="display:flex;"><span>export AWS_ACCOUNT_ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws sts get-caller-identity --query <span style="color:#e6db74">&#34;Account&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>export BUCKET_NAME<span style="color:#f92672">=</span>my-ack-s3-bucket-$AWS_ACCOUNT_ID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>read -r -d <span style="color:#e6db74">&#39;&#39;</span> BUCKET_MANIFEST <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: s3.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Bucket
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: $BUCKET_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: $BUCKET_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUCKET_MANIFEST<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> &gt; bucket.yaml
</span></span><span style="display:flex;"><span>cat bucket.yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ìƒì„±</span>
</span></span><span style="display:flex;"><span>aws s3 ls
</span></span><span style="display:flex;"><span>kubectl create -f bucket.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws s3 ls
</span></span><span style="display:flex;"><span>kubectl get buckets
</span></span><span style="display:flex;"><span>kubectl describe bucket/$BUCKET_NAME | head -6
</span></span><span style="display:flex;"><span>aws s3 ls | grep $BUCKET_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ì—…ë°ì´íŠ¸: íƒœê·¸ ì •ë³´ ì…ë ¥</span>
</span></span><span style="display:flex;"><span>read -r -d <span style="color:#e6db74">&#39;&#39;</span> BUCKET_MANIFEST <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: s3.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Bucket
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: $BUCKET_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: $BUCKET_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tagging:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    tagSet:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: myTagKey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: myTagValue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUCKET_MANIFEST<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> &gt; bucket.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤í–‰ : í•„ìš” ì£¼ì„ ìë™ ì—…ëƒ ë‚´ìš©ì´ë‹ˆ ë¬´ì‹œí•´ë„ë¨!</span>
</span></span><span style="display:flex;"><span>kubectl apply -f bucket.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ì—…ë°ì´íŠ¸ í™•ì¸ </span>
</span></span><span style="display:flex;"><span>kubectl describe bucket/$BUCKET_NAME | grep Spec: -A5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># S3 ë²„í‚· ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f bucket.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get bucket/$BUCKET_NAME
</span></span><span style="display:flex;"><span>aws s3 ls | grep $BUCKET_NAME
</span></span></code></pre></div><p><img src="./images/applying-s3-bucket-manifest.png" alt="applying s3 bucket manifest"></p>
<ul>
<li>[ACK S3 Controller ì‚­ì œ] helm -&gt; CRD -&gt; IRSA</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># helm uninstall</span>
</span></span><span style="display:flex;"><span>export SERVICE<span style="color:#f92672">=</span>s3
</span></span><span style="display:flex;"><span>helm uninstall -n $ACK_SYSTEM_NAMESPACE ack-$SERVICE-controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ACK S3 Controller ê´€ë ¨ crd ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f ~/$SERVICE-chart/crds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IRSA ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>eksctl delete iamserviceaccount --cluster myeks --name ack-$SERVICE-controller --namespace ack-system
</span></span></code></pre></div><h3 id="2-2-ec2--vpc">2-2. EC2 &amp; VPC</h3>
<ul>
<li>
<p>ë°˜ë³µìˆ™ë‹¬ì˜ ë°˜ë³µ.</p>
<ul>
<li>S3(2-1)ë¥¼ ê±´ë„ˆë›°ì—ˆë‹¤ë©´, helm ì„¤ì¹˜ ì‹œ <code>--create-namespace</code> ì¶”ê°€</li>
</ul>
</li>
<li>
<p>[ACK EC2-Controller ì„¤ì¹˜]</p>
<ul>
<li>EC2 ì™¸ì—ë„, í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìœ„í•œ êµ¬ì„±ìš”ì†Œë“¤ì„ ìœ„í•œ CRDë„ í¬í•¨ëœë‹¤.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¹„ìŠ¤ëª… ë³€ìˆ˜ ì§€ì • ë° helm ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>export SERVICE<span style="color:#f92672">=</span>ec2
</span></span><span style="display:flex;"><span>export RELEASE_VERSION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sL https://api.github.com/repos/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep <span style="color:#e6db74">&#39;&#34;tag_name&#34;:&#39;</span> | cut -d<span style="color:#e6db74">&#39;&#34;&#39;</span> -f4 | cut -c 2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>helm pull oci://public.ecr.aws/aws-controllers-k8s/$SERVICE-chart --version<span style="color:#f92672">=</span>$RELEASE_VERSION
</span></span><span style="display:flex;"><span>tar xzvf $SERVICE-chart-$RELEASE_VERSION.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm chart í™•ì¸</span>
</span></span><span style="display:flex;"><span>tree ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ACK EC2-Controller ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>export ACK_SYSTEM_NAMESPACE<span style="color:#f92672">=</span>ack-system
</span></span><span style="display:flex;"><span>export AWS_REGION<span style="color:#f92672">=</span>ap-northeast-2
</span></span><span style="display:flex;"><span>helm install -n $ACK_SYSTEM_NAMESPACE ack-$SERVICE-controller --set aws.region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$AWS_REGION<span style="color:#e6db74">&#34;</span> ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>helm list --namespace $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>kubectl -n $ACK_SYSTEM_NAMESPACE get pods -l <span style="color:#e6db74">&#34;app.kubernetes.io/instance=ack-</span>$SERVICE<span style="color:#e6db74">-controller&#34;</span>
</span></span><span style="display:flex;"><span>kubectl get crd | grep $SERVICE
</span></span></code></pre></div><ul>
<li>[IRSA ì„¤ì •] AmazonEC2FullAccess</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name ack-$SERVICE-controller <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace $ACK_SYSTEM_NAMESPACE <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster $CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn <span style="color:#66d9ef">$(</span>aws iam list-policies --query <span style="color:#e6db74">&#39;Policies[?PolicyName==`AmazonEC2FullAccess`].Arn&#39;</span> --output text<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --override-existing-serviceaccounts --approve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get sa -n $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>kubectl describe sa ack-$SERVICE-controller -n $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl -n $ACK_SYSTEM_NAMESPACE rollout restart deploy ack-$SERVICE-controller-$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IRSA ì ìš©ìœ¼ë¡œ Env, projected Volume ì¶”ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe pod -n $ACK_SYSTEM_NAMESPACE -l k8s-app<span style="color:#f92672">=</span>$SERVICE-chart
</span></span></code></pre></div><ul>
<li>[ë¦¬ì†ŒìŠ¤ ì¡°ì‘] VPC, Subnet ìƒì„± ë° ì‚­ì œ
<ul>
<li>ìƒˆë¡œìš´ ì‰˜ë¡œ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>while true; do aws ec2 describe-vpcs --query 'Vpcs[*].{VPCId:VpcId, CidrBlock:CidrBlock}' --output text; echo &quot;-----&quot;; sleep 1; done</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># VPC ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; vpc.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: VPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: vpc-tutorial-test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cidrBlocks: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enableDNSSupport: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enableDNSHostnames: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>kubectl apply -f vpc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VPC ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get vpcs
</span></span><span style="display:flex;"><span>kubectl describe vpcs
</span></span><span style="display:flex;"><span>aws ec2 describe-vpcs --query <span style="color:#e6db74">&#39;Vpcs[*].{VPCId:VpcId, CidrBlock:CidrBlock}&#39;</span> --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë‹¤ë¥¸ ìƒˆë¡œìš´ ì‰˜ì´ë‚˜ ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì‰˜ ë³€ê²½í•˜ì—¬ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>VPCID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get vpcs vpc-tutorial-test -o jsonpath<span style="color:#f92672">={</span>.status.vpcID<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> aws ec2 describe-subnets --filters <span style="color:#e6db74">&#34;Name=vpc-id,Values=</span>$VPCID<span style="color:#e6db74">&#34;</span> --query <span style="color:#e6db74">&#39;Subnets[*].{SubnetId:SubnetId, CidrBlock:CidrBlock}&#39;</span> --output text; echo <span style="color:#e6db74">&#34;-----&#34;</span>; sleep <span style="color:#ae81ff">1</span> ; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¸Œë„· ìƒì„±</span>
</span></span><span style="display:flex;"><span>VPCID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get vpcs vpc-tutorial-test -o jsonpath<span style="color:#f92672">={</span>.status.vpcID<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; subnet.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Subnet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: subnet-tutorial-test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cidrBlock: 10.0.0.0/20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcID: $VPCID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f subnet.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¸Œë„· ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get subnets
</span></span><span style="display:flex;"><span>kubectl describe subnets
</span></span><span style="display:flex;"><span>aws ec2 describe-subnets --filters <span style="color:#e6db74">&#34;Name=vpc-id,Values=</span>$VPCID<span style="color:#e6db74">&#34;</span> --query <span style="color:#e6db74">&#39;Subnets[*].{SubnetId:SubnetId, CidrBlock:CidrBlock}&#39;</span> --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¦¬ì†ŒìŠ¤ ì‚­ì œ: ì„œë¸Œë„·, VPC</span>
</span></span><span style="display:flex;"><span>kubectl delete -f subnet.yaml <span style="color:#f92672">&amp;&amp;</span> kubectl delete -f vpc.yaml
</span></span></code></pre></div><p><img src="images/creating-vpc.png" alt="creating VPC"></p>
<p><img src="images/creating-subnet.png" alt="creating subnet"></p>
<p><img src="images/subnet-mapped-with-vpc.png" alt="subnet mapped with VPC"></p>
<h3 id="2-4-vpc-workflow-ì‹¤ìŠµ">2-4. VPC Workflow ì‹¤ìŠµ</h3>
<ul>
<li>
<p>2-3ì˜ ACK ë° IRSAëŠ” ê·¸ëŒ€ë¡œ í™œìš©</p>
</li>
<li>
<p>VPC, Subnet, SG, RT, EIP, IGW, NATGW, Instance ìƒì„±</p>
</li>
<li>
<p>client &lt;-&gt; public subnet(ssh tunneling) &lt;-&gt; private subnet ì ‘ì†</p>
</li>
<li>
<p>ACKë¡œ ìœ„ì˜ í™˜ê²½ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€ ì‹¤ìŠµí•˜ëŠ” ì‘ì—…</p>
</li>
<li>
<p>[VPC í™˜ê²½ì„¤ì •]</p>
<ul>
<li>ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: watch -d kubectl get routetables,subnet</li>
<li>NATGW ìƒì„± ì™„ë£Œ í›„, ì•„ë˜ ìš”ì†Œë“¤ì´ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸ë¨ (ì•½ 5ë¶„ ì†Œìš”)
<ul>
<li>tutorial-private-route-table-az1: ë¼ìš°íŒ… í…Œì´ë¸” ID</li>
<li>tutorial-private-subnet1: ì„œë¸Œë„· ID</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="images/route-table-and-subnet-created-consequently-in-private-vpc-1.png" alt="route table and subnet created consequently in private VPC 1"></p>
<p><img src="images/route-table-and-subnet-created-consequently-in-private-vpc-2.png" alt="route table and subnet created consequently in private VPC 2"></p>
<p><img src="images/route-table-and-subnet-created-consequently-in-private-vpc-3.png" alt="route table and subnet created consequently in private VPC 3"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; vpc-workflow.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: VPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cidrBlocks: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enableDNSSupport: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enableDNSHostnames: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: vpc-tutorial
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: InternetGateway
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-igw
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: NATGateway
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-natgateway1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subnetRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-public-subnet1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  allocationRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-eip1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ElasticIPAddress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-eip1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: eip-tutorial
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RouteTable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-public-route-table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - destinationCIDRBlock: 0.0.0.0/0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    gatewayRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: tutorial-igw
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: RouteTable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-private-route-table-az1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - destinationCIDRBlock: 0.0.0.0/0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    natGatewayRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: tutorial-natgateway1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Subnet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-public-subnet1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  availabilityZone: ap-northeast-2a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cidrBlock: 10.0.0.0/20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mapPublicIPOnLaunch: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routeTableRefs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-public-route-table
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Subnet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-private-subnet1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  availabilityZone: ap-northeast-2a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cidrBlock: 10.0.128.0/20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  routeTableRefs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: tutorial-private-route-table-az1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: SecurityGroup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-security-group
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  description: &#34;ack security group&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-sg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - ipProtocol: tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fromPort: 22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      toPort: 22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ipRanges:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - cidrIP: &#34;0.0.0.0/0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          description: &#34;ingress&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f vpc-workflow.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VPC í™˜ê²½ ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe vpcs
</span></span><span style="display:flex;"><span>kubectl describe internetgateways
</span></span><span style="display:flex;"><span>kubectl describe routetables
</span></span><span style="display:flex;"><span>kubectl describe natgateways
</span></span><span style="display:flex;"><span>kubectl describe elasticipaddresses
</span></span><span style="display:flex;"><span>kubectl describe securitygroups
</span></span></code></pre></div><ul>
<li>Public Subnetì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># public ì„œë¸Œë„· ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>PUBSUB1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get subnets tutorial-public-subnet1 -o jsonpath<span style="color:#f92672">={</span>.status.subnetID<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $PUBSUB1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³´ì•ˆê·¸ë£¹ ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>TSG<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get securitygroups tutorial-security-group -o jsonpath<span style="color:#f92672">={</span>.status.id<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $TSG
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Amazon Linux 2 ìµœì‹  AMI ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>AL2AMI<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ec2 describe-images --owners amazon --filters <span style="color:#e6db74">&#34;Name=name,Values=amzn2-ami-hvm-2.0.*-x86_64-gp2&#34;</span> --query <span style="color:#e6db74">&#39;Images[0].ImageId&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $AL2AMI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SSH í‚¤í˜ì–´ ì´ë¦„ ë³€ìˆ˜ ì§€ì •: ì‚¬ìš©í•  AWS keypair </span>
</span></span><span style="display:flex;"><span>MYKEYPAIR<span style="color:#f92672">=</span>ryzen1600
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³€ìˆ˜ í™•ì¸ &gt; íŠ¹íˆ ì„œë¸Œë„· IDê°€ í™•ì¸ë˜ì—ˆëŠ”ì§€ ê¼­ í™•ì¸í•˜ì!</span>
</span></span><span style="display:flex;"><span>echo $PUBSUB1 , $TSG , $AL2AMI , $MYKEYPAIR
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output table; date ; sleep <span style="color:#ae81ff">1</span> ; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># public ì„œë¸Œë„·ì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; tutorial-bastion-host.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-bastion-host
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imageID: $AL2AMI # AL2 AMI ID - ap-northeast-2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  instanceType: t3.medium
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subnetID: $PUBSUB1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  securityGroupIDs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - $TSG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  keyName: $MYKEYPAIR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: producer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: ack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f tutorial-bastion-host.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get instance
</span></span><span style="display:flex;"><span>kubectl describe instance
</span></span><span style="display:flex;"><span>aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output table
</span></span></code></pre></div><p><img src="./images/instance-ip-in-public-ip.png" alt="Instance IP in Public IP"></p>
<ul>
<li>Public Subnetì˜ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†
<ul>
<li>ping test ì‹¤íŒ¨í•´ì•¼ ì •ìƒ</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## Client PC</span>
</span></span><span style="display:flex;"><span>ssh -i <span style="color:#e6db74">${</span>ì‚¬ìš©í•  keypair<span style="color:#e6db74">}</span> ec2-user@<span style="color:#e6db74">${</span>ì•ì—ì„œ í™•ì¸í•œ Public IP<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ping -c <span style="color:#ae81ff">2</span> 8.8.8.8
</span></span></code></pre></div><p><img src="./images/ping-test-failure-without-engress-rule.png" alt="ping test failure without engress rule"></p>
<ul>
<li>ë³´ì•ˆ ê·¸ë£¹ ì •ì±… ìˆ˜ì •: egress ê·œì¹™ ì¶”ê°€</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; modify-sg.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: SecurityGroup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-security-group
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  description: &#34;ack security group&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-sg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  vpcRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       name: tutorial-vpc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - ipProtocol: tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      fromPort: 22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      toPort: 22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ipRanges:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - cidrIP: &#34;0.0.0.0/0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          description: &#34;ingress&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  egressRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - ipProtocol: &#39;-1&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ipRanges:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - cidrIP: &#34;0.0.0.0/0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          description: &#34;egress&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f modify-sg.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³€ê²½ í™•ì¸ &gt;&gt; ë³´ì•ˆê·¸ë£¹ì— ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl logs -n $ACK_SYSTEM_NAMESPACE -l k8s-app<span style="color:#f92672">=</span>ec2-chart -f
</span></span></code></pre></div><p><img src="./images/logs-about-addition-of-egress-rule-to-security-group.png" alt="logs about addition of egress rule to security group"></p>
<ul>
<li>ë‹¤ì‹œ, Public Subnetìƒ ì¸ìŠ¤í„´ìŠ¤ ì ‘ì† ìƒíƒœì—ì„œ, ping test: ì •ìƒ
<ul>
<li>curlë¡œ ì¶œë ¥ë˜ëŠ” IPëŠ” ì¸ìŠ¤í„´ìŠ¤ Public IP ì£¼ì†Œ</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## Client PC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ssh -i ${ì‚¬ìš©í•  keypair} ec2-user@${ì•ì—ì„œ í™•ì¸í•œ Public IP}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ping -c <span style="color:#ae81ff">2</span> 8.8.8.8
</span></span><span style="display:flex;"><span>curl ipinfo.io/ip ; echo <span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ Public UP(ê³µì¸IP)</span>
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><p><img src="./images/ping-test-success-with-egress-rule.png" alt="ping test success with egress rule"></p>
<ul>
<li>Private Subnetì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
<ul>
<li>2-3 ì‹¤ìŠµì—ì„œë„ ë´¤ë“¯ì´ Private Subnet ID í™•ì¸ê¹Œì§€ ì‹œê°„ ì†Œìš”</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># private ì„œë¸Œë„· ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>PRISUB1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get subnets tutorial-private-subnet1 -o jsonpath<span style="color:#f92672">={</span>.status.subnetID<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $PRISUB1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³€ìˆ˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>echo $PRISUB1 , $TSG , $AL2AMI , $MYKEYPAIR
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Private Subnetì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; tutorial-instance-private.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: ec2.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: tutorial-instance-private
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  imageID: $AL2AMI # AL2 AMI ID - ap-northeast-2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  instanceType: t3.medium
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subnetID: $PRISUB1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  securityGroupIDs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - $TSG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  keyName: $MYKEYPAIR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: producer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      value: ack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f tutorial-instance-private.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get instance
</span></span><span style="display:flex;"><span>kubectl describe instance
</span></span><span style="display:flex;"><span>aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output table
</span></span></code></pre></div><p><img src="./images/launch-instance-in-private-subnet.png" alt="launch instance in Private Subnet"></p>
<ul>
<li>Public Subnet ì¸ìŠ¤í„´ìŠ¤ì— SSH í„°ë„ë§ ì„¤ì •
<ul>
<li>í„°ë„ë§ì´ë¯€ë¡œ, ì ‘ì† ì´í›„ ê·¸ëŒ€ë¡œ ë‘ê¸°</li>
<li>ì‹¤ìŠµì—ì„œëŠ” ì„ì˜ í¬íŠ¸ë¥¼ <code>9999</code>ë¡œ ì„¤ì •</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -i ~/.ssh/id_ed25518 -L 9999:<span style="color:#e6db74">${</span>Private Subnetì˜ ì¸ìŠ¤í„´ìŠ¤ private IP<span style="color:#e6db74">}</span>:22 ec2-user@<span style="color:#e6db74">${</span>Public Subnetì˜ ì¸ìŠ¤í„´ìŠ¤ public IP<span style="color:#e6db74">}</span> -v 
</span></span></code></pre></div><ul>
<li>ì•ì—ì„œ ì„¤ì •í•œ ì„ì˜ ì„¤ì • í¬íŠ¸(<code>9999</code>)ë¡œ SSH ì ‘ì† ì‹œ Private Subnetì˜ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì† ê°€ëŠ¥ [Jump Host]</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -i ~/.ssh/id_ed25519 -p <span style="color:#ae81ff">9999</span> ec2-user@localhost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IP ë° ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>ip -c addr
</span></span><span style="display:flex;"><span>sudo ss -tnp
</span></span><span style="display:flex;"><span>ping -c <span style="color:#ae81ff">2</span> 8.8.8.8
</span></span><span style="display:flex;"><span>curl ipinfo.io/ip ; echo <span style="color:#75715e"># NATGW IP</span>
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><p><img src="./images/connection-success-in-private-instance-and-check-natgw-ip.png" alt="connection success in Private instance and check NATGW IP"></p>
<ul>
<li>ì‹¤ìŠµ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
<ul>
<li>VPC ê´€ë ¨ ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹œ, ë‹¤ì†Œ ì‹œê°„ì´ ì†Œìš”</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete -f tutorial-bastion-host.yaml <span style="color:#f92672">&amp;&amp;</span> kubectl delete -f tutorial-instance-private.yaml
</span></span><span style="display:flex;"><span>kubectl delete -f vpc-workflow.yaml
</span></span></code></pre></div><h3 id="2-5-rds-ìƒì„±">2-5. RDS ìƒì„±</h3>
<ul>
<li>
<p>ì§€ì› ì—”ì§„: Aurora(MySQL, PostgreSQL), RDS(MySQL, MariaDB, Oracle, SQL Server)</p>
</li>
<li>
<p>[ACK RDS Controller ì„¤ì¹˜]</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì„œë¹„ìŠ¤ëª… ë³€ìˆ˜ ì§€ì • ë° helm ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>export SERVICE<span style="color:#f92672">=</span>rds
</span></span><span style="display:flex;"><span>export RELEASE_VERSION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sL https://api.github.com/repos/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep <span style="color:#e6db74">&#39;&#34;tag_name&#34;:&#39;</span> | cut -d<span style="color:#e6db74">&#39;&#34;&#39;</span> -f4 | cut -c 2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>helm pull oci://public.ecr.aws/aws-controllers-k8s/$SERVICE-chart --version<span style="color:#f92672">=</span>$RELEASE_VERSION
</span></span><span style="display:flex;"><span>tar xzvf $SERVICE-chart-$RELEASE_VERSION.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm chart í™•ì¸</span>
</span></span><span style="display:flex;"><span>tree ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ACK EC2-Controller ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>export ACK_SYSTEM_NAMESPACE<span style="color:#f92672">=</span>ack-system
</span></span><span style="display:flex;"><span>export AWS_REGION<span style="color:#f92672">=</span>ap-northeast-2
</span></span><span style="display:flex;"><span>helm install -n $ACK_SYSTEM_NAMESPACE ack-$SERVICE-controller --set aws.region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$AWS_REGION<span style="color:#e6db74">&#34;</span> ~/$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>helm list --namespace $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>kubectl -n $ACK_SYSTEM_NAMESPACE get pods -l <span style="color:#e6db74">&#34;app.kubernetes.io/instance=ack-</span>$SERVICE<span style="color:#e6db74">-controller&#34;</span>
</span></span><span style="display:flex;"><span>kubectl get crd | grep $SERVICE
</span></span></code></pre></div><p><img src="./images/install-ack-rds-controller.png" alt="install ACK RDS Controller"></p>
<ul>
<li>[IRSA ì„¤ì •] AmazonRDSFullAccess</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name ack-$SERVICE-controller <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace $ACK_SYSTEM_NAMESPACE <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster $CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn <span style="color:#66d9ef">$(</span>aws iam list-policies --query <span style="color:#e6db74">&#39;Policies[?PolicyName==`AmazonRDSFullAccess`].Arn&#39;</span> --output text<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --override-existing-serviceaccounts --approve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get sa -n $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>kubectl describe sa ack-$SERVICE-controller -n $ACK_SYSTEM_NAMESPACE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl -n $ACK_SYSTEM_NAMESPACE rollout restart deploy ack-$SERVICE-controller-$SERVICE-chart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Env, projected Volume ì¶”ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe pod -n $ACK_SYSTEM_NAMESPACE -l k8s-app<span style="color:#f92672">=</span>$SERVICE-chart
</span></span></code></pre></div><p><img src="./images/applying-irsa-to-ack-rds-controller.png" alt="applying IRSA to ACK RDS Controller"></p>
<ul>
<li>[ë¦¬ì†ŒìŠ¤ ì¡°ì‘] AWS RDS for MariaDB ìƒì„± ë° ì‚­ì œ
<ul>
<li>ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>watch -d &quot;kubectl describe dbinstance &quot;${RDS_INSTANCE_NAME}&quot; | grep 'Db Instance Status'&quot;</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># DB ì•”í˜¸ë¥¼ ìœ„í•œ secret ìƒì„±</span>
</span></span><span style="display:flex;"><span>RDS_INSTANCE_NAME<span style="color:#f92672">=</span>myrds
</span></span><span style="display:flex;"><span>RDS_INSTANCE_PASSWORD<span style="color:#f92672">=</span>qwe12345
</span></span><span style="display:flex;"><span>kubectl create secret generic <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">-password&#34;</span> --from-literal<span style="color:#f92672">=</span>password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RDS_INSTANCE_PASSWORD<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get secret $RDS_INSTANCE_NAME-password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RDS ë°°í¬ ìƒì„± : 15ë¶„ ì´ë‚´ ì‹œê°„ ì†Œìš” &gt;&gt; ë³´ì•ˆê·¸ë£¹, ì„œë¸Œë„· ë“± í•„ìš”í•œ ì˜µì…˜ë“¤ì€ ì¶”ê°€í•´ì„œ ì„¤ì •í•´ë³´ì!</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; rds-mariadb.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rds.services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: DBInstance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;${RDS_INSTANCE_NAME}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  allocatedStorage: 20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  dbInstanceClass: db.t4g.micro
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  dbInstanceIdentifier: &#34;${RDS_INSTANCE_NAME}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  engine: mariadb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  engineVersion: &#34;10.6&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  masterUsername: &#34;admin&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  masterUserPassword:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: &#34;${RDS_INSTANCE_NAME}-password&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    key: password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f rds-mariadb.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get dbinstances  <span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>kubectl describe dbinstance <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>aws rds describe-db-instances --db-instance-identifier $RDS_INSTANCE_NAME | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Db Instance Status: creating/backing-up/available</span>
</span></span><span style="display:flex;"><span>kubectl describe dbinstance <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | grep <span style="color:#e6db74">&#39;Db Instance Status&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„± ì™„ë£Œ ëŒ€ê¸° : for ì§€ì • ìƒíƒœê°€ ì™„ë£Œë˜ë©´ ì •ìƒ ì¢…ë£Œë¨</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dbinstance.rds.services.k8s.aws/myrds condition met</span>
</span></span><span style="display:flex;"><span>kubectl wait dbinstances <span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span> --for<span style="color:#f92672">=</span>condition<span style="color:#f92672">=</span>ACK.ResourceSynced --timeout<span style="color:#f92672">=</span>15m
</span></span></code></pre></div><h3 id="2-6-maria-db-ì ‘ì†">2-6. Maria DB ì ‘ì†</h3>
<ul>
<li>RDSë¥¼ ì‚¬ìš©í•˜ëŠ” íŒŒë“œë¥¼ ìƒì„±í•˜ì—¬ í…ŒìŠ¤íŠ¸
<ul>
<li>fieldexportë¥¼ ë¨¼ì € ìƒì„± í›„ ì´ë¥¼ í™œìš©</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>RDS_INSTANCE_CONN_CM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RDS_INSTANCE_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">-conn-cm&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; rds-field-exports.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ConfigMap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">data: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: FieldExport
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${RDS_INSTANCE_NAME}-host
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: configmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: &#34;.status.endpoint.address&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      group: rds.services.k8s.aws
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kind: DBInstance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: ${RDS_INSTANCE_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: FieldExport
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${RDS_INSTANCE_NAME}-port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: configmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: &#34;.status.endpoint.port&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      group: rds.services.k8s.aws
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kind: DBInstance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: ${RDS_INSTANCE_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: services.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: FieldExport
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${RDS_INSTANCE_NAME}-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: configmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: &#34;.spec.masterUsername&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      group: rds.services.k8s.aws
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kind: DBInstance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: ${RDS_INSTANCE_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f rds-field-exports.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒíƒœ ì •ë³´ í™•ì¸ : address ì™€ port ì •ë³´ </span>
</span></span><span style="display:flex;"><span>kubectl get dbinstances myrds -o jsonpath<span style="color:#f92672">={</span>.status.endpoint<span style="color:#f92672">}</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒíƒœ ì •ë³´ í™•ì¸ : masterUsername í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get dbinstances myrds -o jsonpath<span style="color:#f92672">={</span>.spec.masterUsername<span style="color:#f92672">}</span> ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì»¨í”¼ê·¸ë§µ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get cm myrds-conn-cm -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># fieldexport ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get crd | grep fieldexport
</span></span><span style="display:flex;"><span>kubectl get fieldexport
</span></span><span style="display:flex;"><span>kubectl get fieldexport myrds-host -o yaml | k neat | yh
</span></span></code></pre></div><p><img src="./images/check-rdb-and-configmap-data-with-fieldexport.png" alt="check rdb and configmap data with fieldexport"></p>
<p><img src="./images/check-crd-and-fieldexport.png" alt="check crd and fieldexport"></p>
<ul>
<li>RDS ì‚¬ìš© íŒŒë“œ ìƒì„±</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>APP_NAMESPACE<span style="color:#f92672">=</span>default
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; rds-pods.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: app
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: ${APP_NAMESPACE}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   - image: busybox
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     name: myapp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     command:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - sleep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - &#34;3600&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     imagePullPolicy: IfNotPresent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: DBHOST
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          key: &#34;${APP_NAMESPACE}.${RDS_INSTANCE_NAME}-host&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: DBPORT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          key: &#34;${APP_NAMESPACE}.${RDS_INSTANCE_NAME}-port&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: DBUSER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         configMapKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: ${RDS_INSTANCE_CONN_CM}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          key: &#34;${APP_NAMESPACE}.${RDS_INSTANCE_NAME}-user&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: DBPASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        valueFrom:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          secretKeyRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           name: &#34;${RDS_INSTANCE_NAME}-password&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           key: password
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f rds-pods.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- env | grep DB
</span></span></code></pre></div><p><img src="./images/check-pod-env.png" alt="check pod env"></p>
<ul>
<li>RDSì˜ identifier(ì ‘ì† ì‹ë³„ì)ë¥¼ ë³€ê²½í•´ë³´ê³  í™•ì¸
<ul>
<li>Roll-outì´ ì•„ë‹Œ, ìƒˆë¡œìš´ ì‹ë³„ìë¥¼ ê¸°ë°˜ìœ¼ë¡œ RDSê°€ ìƒì„±</li>
<li>ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>watch -d &quot;kubectl get dbinstance; echo; kubectl get cm myrds-conn-cm -o yaml | kubectl neat&quot;</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># DB ì‹ë³„ìë¥¼ ì—…ë°ì´íŠ¸ </span>
</span></span><span style="display:flex;"><span>kubectl patch dbinstance myrds --type<span style="color:#f92672">=</span>merge -p <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;dbInstanceIdentifier&#34;:&#34;studyend&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get dbinstance myrds
</span></span><span style="display:flex;"><span>kubectl describe dbinstance myrds
</span></span></code></pre></div><p><img src="./images/check-rds-creation-in-aws-web-console.png" alt="check rds creation in AWS web console"></p>
<ul>
<li>ë³€ê²½ ì •ë³´ ë°˜ì˜ í™•ì¸
<ul>
<li>RDS address: ë³€ê²½ í™•ì¸ (<code>&quot;address&quot;: &quot;studyend.-&quot;</code>)</li>
<li>pod í™˜ê²½ë³€ìˆ˜: ë³€ê²½ë˜ì§€ ì•ŠìŒ (<code>DBHOST=myrds.-</code>)
<ul>
<li>í™˜ê²½ ë³€ìˆ˜(env)ë¡œ ì •ë³´ë¥¼ ì£¼ì…í–ˆê¸° ë•Œë¬¸ì— ì—…ë°ì´íŠ¸ ë˜ì§€ ì•ŠìŒ</li>
<li>pod rolloutìœ¼ë¡œ env ë³€ê²½ ì ìš© ê°€ëŠ¥ (deployments/daemonsets/statefulsets)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./images/rds-address-is-not-changed-after-rds-identifier-changed.png" alt="RDS address is not changed after RDS identifier changed"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ìƒíƒœ ì •ë³´ í™•ì¸ : address ë³€ê²½ í™•ì¸!</span>
</span></span><span style="display:flex;"><span>kubectl get dbinstances myrds -o jsonpath<span style="color:#f92672">={</span>.status.endpoint<span style="color:#f92672">}</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ &gt;&gt; íŒŒë“œì˜ ê²½ìš° í™˜ê²½ ë³€ìˆ˜ envë¡œ ì •ë³´ë¥¼ ì£¼ì…í–ˆê¸° ë•Œë¬¸ì— ë³€ê²½ëœ ì •ë³´ë¥¼ í™•ì¸ í•  ìˆ˜ ì—†ë‹¤</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- env | grep DB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚­ì œ í›„ ì¬ìƒì„± í›„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app <span style="color:#f92672">&amp;&amp;</span> kubectl apply -f rds-pods.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì˜ í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í™•ì¸!</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- env | grep DB
</span></span></code></pre></div><p><img src="./images/check-rds-address-changed-in-configmap.png" alt="check rds address changed in configmap"></p>
<p><img src="./images/rollout-pod-to-apply-changed-env.png" alt="rollout pod to apply changed env"></p>
<ul>
<li>RDS ì‚­ì œ: ë‹¨, ACKì˜ ê´€ë¦¬ì—ì„œ ë²—ì–´ë‚œ myrdsëŠ” ì§ì ‘ ì‚­ì œí•´ì•¼í•¨</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RDS ì‚­ì œ </span>
</span></span><span style="display:flex;"><span>kubectl delete -f rds-mariadb.yaml
</span></span></code></pre></div><p><img src="./images/delete-not-tracked-rds.png" alt="delete not tracked rds"></p>
<h2 id="3-flux">3. Flux</h2>
<ul>
<li>Fluxí•˜ë©´, <a href="https://justgetflux.com/">f.lux</a> ì‹œê°„ë³„ í™”ë©´ ìƒ‰ì¡° ë³€ê²½í”„ë¡œê·¸ë¨ì´ ë– ì˜¤ë¥´ëŠ”ë°&hellip; ì•„ì‰½ì§€ë§Œ, ì´ë²ˆì—” GitOpsìš© ì†”ë£¨ì…˜.</li>
<li>GitHub í† í°ì„ í™œìš©
<ul>
<li>í•œë²ˆ ìƒì„±ë˜ê³ , ì¬ ì¡°íšŒê°€ ì•ˆë˜ë¯€ë¡œ ë©”ëª¨ë¥¼ í•˜ê±°ë‚˜ ë‹¤ì‹œ ìƒì„±</li>
<li>ê°™ì€ ê³„ì •ì—ì„œ ë°œê¸‰í•œ ë‹¤ë¥¸ í† í°ì„ ì¨ë„ Fluxì‚¬ìš©ì€ ì—°ì†ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥</li>
</ul>
</li>
<li>ë¶€íŠ¸ìŠ¤íŠ¸ë©ìœ¼ë¡œ Github private repo ìƒì„± í›„, manifest ì¶”ê°€í•˜ì—¬ ì‚¬ìš©</li>
</ul>
<p><img src="./images/github-token-needed.png" alt="GitHub token needed"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Flux CLI ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>curl -s https://fluxcd.io/install.sh | sudo bash
</span></span><span style="display:flex;"><span>. &lt;<span style="color:#f92672">(</span>flux completion bash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë²„ì „ í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux --version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitHub í† í° ì£¼ì…</span>
</span></span><span style="display:flex;"><span>export GITHUB_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ghp_###<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>export GITHUB_USER<span style="color:#f92672">=</span>kkumtree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bootstrap</span>
</span></span><span style="display:flex;"><span>flux bootstrap github <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --owner<span style="color:#f92672">=</span>$GITHUB_USER <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --repository<span style="color:#f92672">=</span>fleet-infra <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --branch<span style="color:#f92672">=</span>main <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --path<span style="color:#f92672">=</span>./clusters/my-cluster <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --personal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitHubì—ì„œ ì‹ ê·œ private repo(fleet-infra) ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n flux-system
</span></span><span style="display:flex;"><span>kubectl get-all -n flux-system
</span></span><span style="display:flex;"><span>kubectl get crd | grep fluxc
</span></span><span style="display:flex;"><span>kubectl get gitrepository -n flux-system
</span></span></code></pre></div><p><img src="./images/private-repo-created.png" alt="private repo created"></p>
<ul>
<li>GitOps ë„êµ¬ ì„¤ì¹˜: flux ëŒ€ì‹œë³´ë“œ
<ul>
<li>admin / password</li>
<li>ingress ì„¤ì •: p8s, grafana ì„¤ì¹˜ë¥¼ ì•ˆí–ˆë‹¤ë©´ ì‹œê°„ ì†Œìš”</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># gitops ë„êµ¬ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>curl --silent --location <span style="color:#e6db74">&#34;https://github.com/weaveworks/weave-gitops/releases/download/v0.24.0/gitops-</span><span style="color:#66d9ef">$(</span>uname<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">.tar.gz&#34;</span> | tar xz -C /tmp
</span></span><span style="display:flex;"><span>sudo mv /tmp/gitops /usr/local/bin
</span></span><span style="display:flex;"><span>gitops version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flux ëŒ€ì‹œë³´ë“œ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>gitops create dashboard ww-gitops --password<span style="color:#f92672">=</span>$PASSWORD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux -n flux-system get helmrelease
</span></span><span style="display:flex;"><span>kubectl -n flux-system get pod,svc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ingress ë°°í¬ë¥¼ ìœ„í•œ ACM ARN</span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ingress ì„¤ì •</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; gitops-ingress.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: networking.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: gitops-ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/ssl-redirect: &#34;443&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - host: gitops.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    http:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      paths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - backend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            name: ww-gitops-weave-gitops
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            port:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              number: 9001
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        path: /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pathType: Prefix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f gitops-ingress.yaml -n flux-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get ingress -n flux-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitOps ì ‘ì† ì •ë³´ í™•ì¸ &gt;&gt; ì›¹ ì ‘ì† í›„ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;GitOps Web https://gitops.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p><img src="./images/flux-dashboard.png" alt="flux dashboard"></p>
<h3 id="3-1-kustomize-ì˜ˆì œë¡œ-ìƒ˜í”Œ-ì‹¤ìŠµ">3-1. kustomize ì˜ˆì œë¡œ ìƒ˜í”Œ ì‹¤ìŠµ</h3>
<ul>
<li>ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>watch -d kubectl get pod,svc nginx-example1</code></li>
<li>GitHubì— ìˆëŠ” Nginx manifestë¥¼ k8sì— ë°°í¬
<ul>
<li>ë°°í¬ ì‹œì— kustomizeë¥¼ ì‚¬ìš©</li>
</ul>
</li>
<li>flux ì§€ì› ì†ŒìŠ¤: git / helm / oci / bucket
<ul>
<li>`flux create source {target source}</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GITURL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/sungwook-practice/fluxcd-test.git&#34;</span>
</span></span><span style="display:flex;"><span>flux create source git nginx-example1 --url<span style="color:#f92672">=</span>$GITURL --branch<span style="color:#f92672">=</span>main --interval<span style="color:#f92672">=</span>30s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì†ŒìŠ¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux get sources git
</span></span><span style="display:flex;"><span>kubectl -n flux-system get gitrepositories
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flux ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±: ìœ í˜•(kustomization), git ì†ŒìŠ¤ ê²½ë¡œ(--path)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìƒì„± í›„ GitOps ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux create kustomization nginx-example1 --target-namespace<span style="color:#f92672">=</span>default --interval<span style="color:#f92672">=</span>1m --source<span style="color:#f92672">=</span>nginx-example1 --path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./nginx&#34;</span> --health-check-timeout<span style="color:#f92672">=</span>2m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pod,svc nginx-example1
</span></span><span style="display:flex;"><span>kubectl get kustomizations -n flux-system
</span></span><span style="display:flex;"><span>flux get kustomizations
</span></span></code></pre></div><p><img src="./images/git-source-creation-with-flux.png" alt="git source creation with flux"></p>
<p><img src="./images/nginx-manifest-deployment-with-kustomize.png" alt="Nginx manifest deployment with kustomize"></p>
<p><img src="./images/deployment-status-in-gitops-dashboard.png" alt="deployment status in GitOps dashboard"></p>
<p><img src="./images/graph-view-in-gitops-dashboard.png" alt="graph view in GitOps dashboard"></p>
<ul>
<li>ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚­ì œ
<ul>
<li>ì²˜ìŒ ì‚­ì œ ì‹œ: pod, svcëŠ” ì‚¬ë¼ì§€ì§€ ì•ŠìŒ. annotation ê°œë…</li>
<li><code>--prune=true</code>ë¥¼ í†µí•´ ê°™ì´ ì‚­ì œë˜ë„ë¡ í•  ìˆ˜ ìˆìŒ (default: false)</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># flux ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>flux delete kustomization nginx-example1
</span></span><span style="display:flex;"><span>flux get kustomizations
</span></span><span style="display:flex;"><span>kubectl get pod,svc nginx-example1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flux ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ì‹œ ìƒì„± :  --prune ì˜µì…˜ true</span>
</span></span><span style="display:flex;"><span>flux create kustomization nginx-example1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --target-namespace<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --prune<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --interval<span style="color:#f92672">=</span>1m <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --source<span style="color:#f92672">=</span>nginx-example1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./nginx&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --health-check-timeout<span style="color:#f92672">=</span>2m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux get kustomizations
</span></span><span style="display:flex;"><span>kubectl get pod,svc nginx-example1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flux ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚­ì œ: pod, svc í•¨ê»˜ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>flux delete kustomization nginx-example1
</span></span><span style="display:flex;"><span>flux get kustomizations
</span></span><span style="display:flex;"><span>kubectl get pod,svc nginx-example1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flux ì†ŒìŠ¤ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>flux delete source git nginx-example1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì†ŒìŠ¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux get sources git
</span></span><span style="display:flex;"><span>kubectl -n flux-system get gitrepositories
</span></span></code></pre></div><p><img src="./images/delete-kustomization-without-prune-option.png" alt="delete kustomization without prune option"></p>
<p><img src="./images/only-kustomization-deleted.png" alt="only kustomization deleted"></p>
<p><img src="./images/pod-and-service-survived-without-flux-prune-option.png" alt="pod and service survived without flux prune option"></p>
<p><img src="./images/kustomization-reconciliation-with-existed-pod-and-service.png" alt="kustomization reconciliation with existed pod and service"></p>
<p><img src="./images/delete-with-prune-option-1.png" alt="delete with prune option 1"></p>
<p><img src="./images/delete-with-prune-option-2.png" alt="delete with prune option 2"></p>
<h3 id="3-2-flux-ê³µì‹-docs-ìƒ˜í”Œ-ì‹¤ìŠµ">3-2. Flux ê³µì‹ Docs ìƒ˜í”Œ ì‹¤ìŠµ</h3>
<ul>
<li>ì•ì„œ ìµœì„±ìš±(ì•…ì„±ì½”ë“œë¶„ì„)ë‹˜ê»˜ì„œ ë§Œë“¤ì–´ì£¼ì‹  ìƒ˜í”Œë¡œ ê³„ì† í•˜ë ¤ í–ˆìœ¼ë‚˜,
<ul>
<li>ìƒ˜í”Œ ì‹¤ìŠµì—ì„œì˜ replica ë³€ê²½ì´ ì ìš©ë˜ì§€ ì•Šì•„ ìƒˆë¡œì´ ì§„í–‰</li>
</ul>
</li>
<li>ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: <code>watch -d kubectl get pod,svc</code>
<ul>
<li>scale down ì‹œ podê°€ ì‚­ì œë˜ì—ˆë‹¤ê°€, ë‹¤ì‹œ ì¬ìƒì„± ë¨</li>
</ul>
</li>
</ul>
<p><img src="./images/pratice-with-new-flux-sample.png" alt="pratice with new flux sample"></p>
<p><img src="./images/another-git-source-creation-with-flux.png" alt="another git source creation with flux"></p>
<p><img src="./images/source-events-in-gitops-dashboard.png" alt="source events in GitOps dashboard"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Clone the git repository : ìì‹ ì˜ Github ì˜ Username, Token ì…ë ¥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Username for &#39;https://github.com&#39;: &lt;ìì‹ ì˜ Github ì˜ Username&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Password for &#39;https://kkumtree@github.com&#39;: &lt;ìì‹ ì˜ Githubì˜ Token&gt;</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/$GITHUB_USER/fleet-infra
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd fleet-infra
</span></span><span style="display:flex;"><span>tree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ADD podinfo repository to Flux</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitRepository yaml íŒŒì¼ ìƒì„±</span>
</span></span><span style="display:flex;"><span>flux create source git podinfo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --url<span style="color:#f92672">=</span>https://github.com/stefanprodan/podinfo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --branch<span style="color:#f92672">=</span>master <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --interval<span style="color:#f92672">=</span>30s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --export &gt; ./clusters/my-cluster/podinfo-source.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitRepository yaml íŒŒì¼ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat ./clusters/my-cluster/podinfo-source.yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Commit and push the podinfo-source.yaml file to the fleet-infra repository</span>
</span></span><span style="display:flex;"><span>git config --global user.name <span style="color:#e6db74">&#34;Your Name&#34;</span>
</span></span><span style="display:flex;"><span>git config --global user.email <span style="color:#e6db74">&#34;you@example.com&#34;</span>
</span></span><span style="display:flex;"><span>git add -A <span style="color:#f92672">&amp;&amp;</span> git commit -m <span style="color:#e6db74">&#34;Add podinfo GitRepository&#34;</span>
</span></span><span style="display:flex;"><span>git push
</span></span><span style="display:flex;"><span>Username <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;https://github.com&#39;</span>: &lt;ìì‹ ì˜ Github ì˜ Username&gt;
</span></span><span style="display:flex;"><span>Password <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;https://gasida@github.com&#39;</span>: &lt;ìì‹ ì˜ Githubì˜ Token&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì†ŒìŠ¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span>flux get sources git
</span></span><span style="display:flex;"><span>kubectl -n flux-system get gitrepositories
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Deploy podinfo application</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Configure Flux to build and apply theÂ kustomizeÂ directory located in the podinfo repository</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use the flux create command to create a Kustomization that applies the podinfo deployment.</span>
</span></span><span style="display:flex;"><span>flux create kustomization podinfo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --target-namespace<span style="color:#f92672">=</span>default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --source<span style="color:#f92672">=</span>podinfo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./kustomize&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --prune<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --interval<span style="color:#f92672">=</span>5m <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --export &gt; ./clusters/my-cluster/podinfo-kustomization.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒì¼ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat ./clusters/my-cluster/podinfo-kustomization.yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Commit and push the Kustomization manifest to the repository:</span>
</span></span><span style="display:flex;"><span>git add -A <span style="color:#f92672">&amp;&amp;</span> git commit -m <span style="color:#e6db74">&#34;Add podinfo Kustomization&#34;</span>
</span></span><span style="display:flex;"><span>git push
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod,svc
</span></span><span style="display:flex;"><span>kubectl get kustomizations -n flux-system
</span></span><span style="display:flex;"><span>flux get kustomizations
</span></span><span style="display:flex;"><span>tree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Watch Flux sync the application </span>
</span></span><span style="display:flex;"><span>kubectl scale deployment podinfo --replicas <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment podinfo --replicas <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>flux delete kustomization podinfo
</span></span><span style="display:flex;"><span>flux delete source git podinfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flux uninstall --namespace<span style="color:#f92672">=</span>flux-system
</span></span></code></pre></div><p><img src="./images/podinfo-running-as-default-in-2-replicas.png" alt="podinfo running as default in 2 replicas"></p>
<p><img src="./images/health-check-in-gitops-dashboard.png" alt="health check in GitOps dashboard"></p>
<p><img src="./images/podinfo-pod-scaled-to-1-but-failed.png" alt="podinfo pod scaled to 1 but failed"></p>
<p><img src="./images/new-replica-created-to-fit-2-replicas.png" alt="new replica created to fit 2 replicas"></p>
<p><img src="./images/cause-desiredReplicas-2-scaling-down-to-1-is-failed.png" alt="cause desiredReplicas 2, scaling down to 1 is failed"></p>
<p><img src="./images/podinfo-pod-scaled-to-3-success.png" alt="podinfo pod scaled to 3 success"></p>
<p><img src="./images/replica-status-when-scale-out-to-3.png" alt="replica status when scale out to 3"></p>
<p><img src="./images/delete-kustomization-and-source.png" alt="delete kustomization and source"></p>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho@ubuntu-kr.org">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/date/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">ì œëª©</span>
        </a>
        
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho@ubuntu-kr.org">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <p></p>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
