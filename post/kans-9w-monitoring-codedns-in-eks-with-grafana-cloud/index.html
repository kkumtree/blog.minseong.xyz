<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>Monitoring CoreDNS in EKS with Grafana Cloud | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="Monitoring CoreDNS in EKS with Grafana Cloud" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/kans-9w-monitoring-codedns-in-eks-with-grafana-cloud/cover.png' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/kans-9w-monitoring-codedns-in-eks-with-grafana-cloud/cover.png' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/kans-9w-monitoring-codedns-in-eks-with-grafana-cloud/cover.png' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.05bc9a89b9988ba7449154a7ccd83133b7df79fac13cc1945cffac151ac54dbb.css">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCJ1CESNKD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCJ1CESNKD');
</script><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src='/img/BlogWhite.svg' alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>

      <ul class="p-navigation__items">
        
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            <li>
              <a href="https://github.com/kkumtree" class="p-navigation__dropdown-item" target="_blank"
                rel="noopener noreferrer">GitHub</a>
            </li>
            <li>
              <a href="https://www.linkedin.com/in/mscho7969" class="p-navigation__dropdown-item" target="_blank"
                rel="noopener noreferrer">Linkedin</a>
            </li>
            <li>
              <a href="https://launchpad.net/~mscho7969" class="p-navigation__dropdown-item" target="_blank"
                rel="noopener noreferrer">Launchpad Profile</a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header><div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.png'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>Monitoring CoreDNS in EKS with Grafana Cloud</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2024-10-30T23:44:01&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/kans" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">kans</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">eks</span>
              </div>
            </a>
            
            <a href="/tags/grafana" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">grafana</span>
              </div>
            </a>
            
            <a href="/tags/otel" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">otel</span>
              </div>
            </a>
            
            <a href="/tags/coredns" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">coredns</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <blockquote>
<p>Grafana Cloud ì²« ì‚¬ìš©ê¸°</p>
</blockquote>
<p><a href="https://gasidaseo.notion.site/CloudNet-Blog-c9dfa44a27ff431dafdd2edacc8a1863">CloudNet@</a>ì—ì„œ ì§„í–‰í•˜ê³  ìˆëŠ” <strong>K</strong>8s <strong>A</strong>dvanced <strong>N</strong>etwork <strong>S</strong>tudy(ì´í•˜, KANS)ë¥¼ í†µí•´ í•™ìŠµí•œ ë‚´ìš©ì„ ì •ë¦¬í•©ë‹ˆë‹¤.</p>
<p>ì´ë²ˆ ì£¼ì°¨ëŠ” ì‹¤ê°ì´ ì•„ì§ ì•ˆë‚˜ëŠ”ë°, ìŠ¤í„°ë”” ë§ˆì§€ë§‰ ì£¼ì°¨ì…ë‹ˆë‹¤.<br>
ê·¸ë˜ì„œ <strong>ì—¬ëŸ¬ë¶„ì´ ì˜ ì•Œê³ , ë§¤ìš° ì¢‹ì•„í•˜ëŠ”</strong> EKSë¥¼ í†µí•´, CoreDNS ì´ìŠˆë¥¼ ëª¨ë‹ˆí„°ë§í•˜ëŠ” Hands-onì„ ì°¨ê·¼ì°¨ê·¼ ë”°ë¼í•´ë³´ë ¤ê³ í•©ë‹ˆë‹¤.</p>
<ul>
<li><a href="https://aws.amazon.com/ko/blogs/mt/monitoring-coredns-for-dns-throttling-issues-using-aws-open-source-monitoring-services/">AWS Cloud Operations Blog/Monitoring CoreDNS for DNS throttling issues using AWS Open source monitoring services</a></li>
</ul>
<p>ìœ„ì˜ Blogë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¼í•´ë³¼ ê²ë‹ˆë‹¤.</p>
<h2 id="0-eks-cluster-ìƒì„±">0. EKS Cluster ìƒì„±</h2>
<p>ìŠ¤í„°ë””ì—ì„œ ì œê³µëœ CloudFormationì„ í†µí•´ EKS Clusterë¥¼ ìƒì„±í•´ë³¼ê¹Œí•©ë‹ˆë‹¤.<br>
<code>eksctl</code>ì´ ì–¸ê¸‰ë˜ì–´ ìˆì–´ì„œ ì™ ì§€&hellip; ë‚˜ì¤‘ì— ë¡¤ë°±í•˜ê³  íƒœì´ˆë§ˆì„ë¶€í„° <code>eksctl</code> ê¸°ë°˜ CloudFormation ë°°í¬ë¥¼ í•  ê²ƒ ê°™ì€ ë¶ˆì•ˆí•¨ì´ ìˆì§€ë§Œ í•´ë³´ì£ (?).</p>
<p>ìŒ ì•„ì§ì€ ê¸°ìš°ì˜€ë„¤ìš”. ê¸°ì–µì„ ë„ì§‘ì–´ë‚´ë³´ë‹ˆ bation hostì—ì„œ <code>eksctl</code> ì„ ì‚¬ìš©í•´ì„œ EKS Cluster ìƒì„±í•˜ëŠ” ê²ƒê¹Œì§€ ìŠ¤í¬ë¦½íŒ… ë˜ì–´ ìˆë‹¤ê³ , ë§ì”€ì„ ë“¤ì—ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<p><img src="images/about-15-mins-later.png" alt="about-15-mins-needed"></p>
<p><img src="images/instances-eks-bastion.png" alt="instances-from-cloudformation"></p>
<p>ìƒì„±ëœ bastionì— ì ‘ì†í•´ì„œ, í™˜ê²½ë³€ìˆ˜ ë“±ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -i ~/.ssh/id_ed25519 ec2-user@43.201.85.169 <span style="color:#75715e"># BASTION-HOST-IP  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The authenticity of host &#39;43.201.85.169 (43.201.85.169)&#39; can&#39;t be established.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ED25519 key fingerprint is SHA256:efFNF+24E7UUEzXzhqBDU0ss74yBmhGiaOI25XOVG9A.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This key is not known by any other names.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Warning: Permanently added &#39;43.201.85.169&#39; (ED25519) to the list of known hosts.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    ,     #_</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    ~\_  ####_        Amazon Linux 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   ~~  \_#####\</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   ~~     \###|       AL2 End of Life is 2025-06-30.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   ~~       \#/ ___</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    ~~       V~&#39; &#39;-&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ~~~         /    A newer version of Amazon Linux is available!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       ~~._.   _/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#          _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#        _/m/&#39;           https://aws.amazon.com/linux/amazon-linux-2023/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10 package(s) needed for security, out of 13 available</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run &#34;sudo yum update&#34; to apply all updates.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (cm112@myeks:N/A) [root@myeks-bastion ~]# clear</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tail -f /var/log/cloud-init-output.log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e">#  66 â€ php8.1                   available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  67  awscli1                  available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  68 â€ php8.2                   available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  69  dnsmasq                  available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  70  unbound1.17              available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  72  collectd-python3         available    [ =stable ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># â€  Note on end-of-support. Use &#39;info&#39; subcommand.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cloudinit End!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud-init v. 19.3-46.amzn2.0.2 finished at Sat, 02 Nov 2024 09:44:24 +0000. Datasource DataSourceEc2.  Up 91.81 seconds</span>
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>tail -f /root/create-eks.log
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;availabilityZones&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ap-northeast-2c&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ap-northeast-2b&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ap-northeast-2a&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cloudWatch&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;clusterLogging&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>kubectl ns default
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Context &#34;cm112@myeks.ap-northeast-2.eksctl.io&#34; modified.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Active namespace is &#34;default&#34;.</span>
</span></span><span style="display:flex;"><span>eksctl get cluster
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME	REGION		EKSCTL CREATED</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks	ap-northeast-2	True</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eksctl get nodegroup --cluster $CLUSTER_NAME</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CLUSTER	NODEGROUP	STATUS	CREATED			MIN SIZE	MAX SIZEDESIRED CAPACITY	INSTANCE TYPE	IMAGE ID	ASG NAME		TYPE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># myeks	ng1		ACTIVE	2024-11-02T09:55:58Z	3		3	3t3.medium	AL2_x86_64	eks-ng1-2cc97626-bf01-5bcc-d680-091e003bd586	managed</span>
</span></span><span style="display:flex;"><span>export | egrep <span style="color:#e6db74">&#39;ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet&#39;</span> | egrep -v <span style="color:#e6db74">&#39;SECRET|KEY&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x ACCOUNT_ID=&#34;&lt;ACCOUNT-ID&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x AWS_DEFAULT_REGION=&#34;ap-northeast-2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x AWS_PAGER=&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x AWS_REGION=&#34;ap-northeast-2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x CLUSTER_NAME=&#34;myeks&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x KUBERNETES_VERSION=&#34;1.30&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PrivateSubnet1=&#34;subnet-044cf8b34576820ea&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PrivateSubnet2=&#34;subnet-0ac2f3cd52e1ae640&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PrivateSubnet3=&#34;subnet-0e5b144c0039c348b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PubSubnet1=&#34;subnet-0fef215562a97f319&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PubSubnet2=&#34;subnet-0ca12b8db356bd486&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x PubSubnet3=&#34;subnet-01628d89d7c34590b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># declare -x VPCID=&#34;vpc-0bcfa9363c4ff0069&#34;</span>
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME                                               STATUS   ROLES    AGE   VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip-192-168-1-219.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   12m   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip-192-168-2-198.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   12m   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2b</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip-192-168-3-85.ap-northeast-2.compute.internal    Ready    &lt;none&gt;   12m   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster myeks
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ARN											USERNAME				GROUPS					ACCOUNT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># arn:aws:iam::&lt;ACCOUNT-ID&gt;:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-bU6W7Cr0ugY5	system:node:{{EC2PrivateDNSName}}	system:bootstrappers,system:nodes	</span>
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster myeks
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ARN											USERNAME				GROUPS					ACCOUNT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># arn:aws:iam::&lt;ACCOUNT-ID&gt;:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-bU6W7Cr0ugY5	system:node:{{EC2PrivateDNSName}}	system:bootstrappers,system:nodes</span>
</span></span></code></pre></div><h2 id="1-hands-onì„-ìœ„í•œ-í™˜ê²½-êµ¬ì„±">1. Hands-onì„ ìœ„í•œ í™˜ê²½ êµ¬ì„±</h2>
<p>ì´ì œëŠ” Hands-onì—ì„œ Pre-requisiteë¡œ ìš”êµ¬í•˜ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ ì¶”ê°€ë¡œ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export EKS_CLUSTER_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $CLUSTER_NAME<span style="color:#66d9ef">)</span>  
</span></span><span style="display:flex;"><span>export SERVICE<span style="color:#f92672">=</span>prometheusservice  
</span></span><span style="display:flex;"><span>export ACK_SYSTEM_NAMESPACE<span style="color:#f92672">=</span>ack-system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># export RELEASE_NAME=`curl -sL https://api.github.com/repos/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep &#39;&#34;tag_name&#34;:&#39; | cut -d&#39;&#34;&#39; -f4`</span>
</span></span></code></pre></div><p>ì—¬ê¸°ì„œ ì˜¤ë˜ëœ í¬ìŠ¤íŒ…ì˜ ì´ìŠˆë¥¼ ë°œê²¬í•˜ê²Œ ë˜ëŠ”ë°,<br>
GitHub REST APIê°€ ë” ì•ˆì „í•´ì¡Œê¸° ë•Œë¬¸ì—, REALASE_NAME ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥ì— ê°€ê¹Œì›Œì¡ŒìŠµë‹ˆë‹¤!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -sL https://api.github.com/repos/aws-controllers-k8s/$SERVICE-controller/releases/latest 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   &#34;message&#34;: &#34;Not Found&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   &#34;documentation_url&#34;: &#34;https://docs.github.com/rest/releases/releases#get-the-latest-release&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   &#34;status&#34;: &#34;404&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span></code></pre></div><p><del>ë°°íŠ¸ë§¨! ì´ˆëŠ¥ë ¥ë„ ì—†ëŠ” ìš°ë¦° ë­˜ í•  ìˆ˜ ìˆì£ ?</del><br>
<img src="images/meme-for-github-api.png" alt="rest-api-404"></p>
<p>ë³´í†µì´ë©´ ë ˆí¬ë¥¼ ë‹¹ê²¨ì™€ì„œ, <code>git tag</code>ë¥¼ í†µí•´ í™•ì¸í•˜ëŠ”ê²Œ ë§ëŠ”ë°, í•¸ì¦ˆì˜¨ì´ë‹ˆ ë§í¬ë¥¼ ì—´ì–´ì„œ ìµœì‹  íƒœê·¸ë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
<ul>
<li><a href="https://github.com/aws-controllers-k8s/prometheusservice-controller/releases">aws-controllers-k8s/
prometheusservice-controller@GitHub</a></li>
</ul>
<p>ì €ë„ ë²ˆê±°ë¡œì›Œì„œ <code>302 Found</code> ì²˜ë¦¬í•˜ì—¬ íƒœê·¸ ë°›ì•„ì™”ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -sS -I -G  https://github.com/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep -i location | awk -F<span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#e6db74">&#39;{print $NF}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v1.2.15</span>
</span></span><span style="display:flex;"><span>export RELEASE_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sS -I -G  https://github.com/aws-controllers-k8s/$SERVICE-controller/releases/latest | grep -i location | awk -F<span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#e6db74">&#39;{print $NF}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $RELEASE_NAME
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v1.2.15</span>
</span></span></code></pre></div><h2 id="2-hands-on-ë¬´ì‘ì •-ë”°ë¼í•˜ê¸°">2. Hands-On ë¬´ì‘ì • ë”°ë¼í•˜ê¸°</h2>
<h3 id="a-amazon-managed-prometheus-workspace-ìƒì„±">(a) Amazon Managed Prometheus Workspace ìƒì„±</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws amp create-workspace --alias blog-workspace --region $AWS_REGION
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;arn&#34;: &#34;arn:aws:aps:ap-northeast-2:&lt;ACCOUNT-ID&gt;:workspace/ws-0d032a51-2b98-43b1-90cb-f5069329f1af&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;status&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;statusCode&#34;: &#34;CREATING&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;tags&#34;: {},</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;workspaceId&#34;: &#34;ws-0d032a51-2b98-43b1-90cb-f5069329f1af&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span></code></pre></div><p><img src="images/amazon-prometheus-workspace.png" alt="create-workspace"></p>
<h3 id="b-prometheus-ethtool-exporter-ë°°í¬">(b) Prometheus ethtool exporter ë°°í¬</h3>
<ul>
<li>ì•ˆë‚´ëœëŒ€ë¡œ exporterë¥¼ ë°°í¬ë¬¸ì„ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">cat &lt;&lt; EOF &gt; ethtool-exporter.yaml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">100</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#39;9417&#39;</span>      
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">IP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">status.podIP      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">drdivano/ethtool-exporter@sha256:39e0916b16de07f62c2becb917c94cbb3a6e124a577e1325505e4d0cdd550d7b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;sh&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;-exc&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;python3 /ethtool-exporter.py -l \$(IP):9417 -I &#39;(eth|em|eno|ens|enp)[0-9s]+&#39;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9417</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">9417</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">250m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">10m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">50Mi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tolerations</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">NoSchedule</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#ae81ff">node-role.kubernetes.io/master</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9417</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">ethtool-exporter</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f ethtool-exporter.yaml
</span></span></code></pre></div><p>ë‹¨ìˆœ exporterë‹ˆê¹Œ ë°°í¬ëŠ” ì˜ ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pods,svc -owide
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME                         READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pod/ethtool-exporter-b62vt   1/1     Running   0          51s   192.168.2.198   ip-192-168-2-198.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pod/ethtool-exporter-jbdlx   1/1     Running   0          51s   192.168.1.219   ip-192-168-1-219.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pod/ethtool-exporter-pj2r7   1/1     Running   0          51s   192.168.3.85    ip-192-168-3-85.ap-northeast-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME                       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service/ethtool-exporter   ClusterIP   None         &lt;none&gt;        9417/TCP   51s   app=ethtool-exporter</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service/kubernetes         ClusterIP   10.100.0.1   &lt;none&gt;        443/TCP    16h   &lt;none&gt;</span>
</span></span></code></pre></div><h3 id="c-adotaws-distro-for-opentelemetry-collector-ìš”êµ¬ì‚¬í•­-ì²´í¬">(c) ADOT(AWS Distro for OpenTelemetry) Collector ìš”êµ¬ì‚¬í•­ ì²´í¬</h3>
<blockquote>
<p>Pre-requisite ë¥¼ ìœ ì˜í•´ì•¼í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
</blockquote>
<ul>
<li>
<p>Docs: <a href="https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/requirements">Requirements for Getting Started with ADOT using EKS Add-Ons</a></p>
</li>
<li>
<p>kubectl, eksctl, AWS CLI v2 : ì„¤ì¹˜ í™•ì¸</p>
</li>
<li>
<p>Cluster ë²„ì „ í™•ì¸ : v1.21 ì´ìƒ í™•ì¸</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl version | grep <span style="color:#e6db74">&#34;Server Version&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server Version: v1.30.6-eks-7f9249a</span>
</span></span></code></pre></div><ul>
<li>ADOT add-on í˜¸í™˜ ë²„ì „ í™•ì¸ : v0.62.1 ì´í•˜ ë²„ì „ì´ ì•„ë‹ˆë©´ ë³„ë„ ì‘ì—… í•„ìš”ì—†ìŒ.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws eks describe-addon-versions --addon-name adot --kubernetes-version 1.30 --query <span style="color:#e6db74">&#39;addons[0].addonVersions[*].addonVersion&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;v0.102.1-eksbuild.2&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;v0.102.1-eksbuild.1&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;v0.102.0-eksbuild.1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ]</span>
</span></span></code></pre></div><h3 id="d-adot-collectorë¥¼-ìœ„í•œ-cert-manager-ì„¤ì¹˜">(d) ADOT Collectorë¥¼ ìœ„í•œ cert-manager ì„¤ì¹˜</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.2/cert-manager.yaml  
</span></span><span style="display:flex;"><span>kubectl get pod -n cert-manager  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME                                       READY   STATUS    RESTARTS   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cert-manager-cainjector-5dbdc949c4-r2wpn   1/1     Running   0          29s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cert-manager-d68cffc95-wsx5c               1/1     Running   0          29s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cert-manager-webhook-759ddb6555-fzl24      1/1     Running   0          29s</span>
</span></span></code></pre></div><h3 id="e-adot-collectorë¥¼-ìœ„í•œ-irsa-ìƒì„±">(e) ADOT Collectorë¥¼ ìœ„í•œ IRSA ìƒì„±</h3>
<blockquote>
<p>í•´ë‹¹ Policy ARNì´ ì‹¤ì œ ì¡´ì¬í•˜ëŠ”ì§€ ì •ë„ëŠ” ì²´í¬í•˜ê³  ìƒì„±í•˜ë©´ ì •ì‹ ê±´ê°•ì— ì¢‹ìŠµë‹ˆë‹¤.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo :$AWS_REGION:$EKS_CLUSTER_NAME:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :ap-northeast-2:myeks:</span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name adot-collector <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace default <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region $AWS_REGION <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cluster $EKS_CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--attach-policy-arn arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--approve <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--override-existing-serviceaccounts
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:22 [â„¹]  1 iamserviceaccount (default/adot-collector) was included (based on the include/exclude rules)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:22 [!]  metadata of serviceaccounts that exist in Kubernetes will be updated, as --override-existing-serviceaccounts was set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:22 [â„¹]  1 task: { </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     2 sequential sub-tasks: { </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         create IAM role for serviceaccount &#34;default/adot-collector&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         create serviceaccount &#34;default/adot-collector&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     } }2024-11-03 11:27:22 [â„¹]  building iamserviceaccount stack &#34;eksctl-myeks-addon-iamserviceaccount-default-adot-collector&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:22 [â„¹]  deploying stack &#34;eksctl-myeks-addon-iamserviceaccount-default-adot-collector&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:22 [â„¹]  waiting for CloudFormation stack &#34;eksctl-myeks-addon-iamserviceaccount-default-adot-collector&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:52 [â„¹]  waiting for CloudFormation stack &#34;eksctl-myeks-addon-iamserviceaccount-default-adot-collector&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2024-11-03 11:27:52 [â„¹]  created serviceaccount &#34;default/adot-collector&#34;</span>
</span></span></code></pre></div><h3 id="f-adot-add-on-ì„¤ì¹˜">(f) ADOT add-on ì„¤ì¹˜</h3>
<p>ì´ë¯¸ ë²„ì „ ì²´í¬ë¥¼ í•´ë³´ì•˜ì§€ë§Œ, ë‹¤ì‹œ í•´ë´…ì‹œë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws eks describe-addon-versions --addon-name adot --kubernetes-version 1.30 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--query <span style="color:#e6db74">&#34;addons[].addonVersions[].[addonVersion, compatibilities[].defaultVersion]&#34;</span> --output text  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v0.102.1-eksbuild.2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># True</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v0.102.1-eksbuild.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># False</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v0.102.0-eksbuild.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># False</span>
</span></span><span style="display:flex;"><span>aws eks create-addon --addon-name adot --addon-version v0.102.1-eksbuild.2 --cluster-name $EKS_CLUSTER_NAME
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#34;addon&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;addonName&#34;: &#34;adot&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;clusterName&#34;: &#34;myeks&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;status&#34;: &#34;CREATING&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;addonVersion&#34;: &#34;v0.102.1-eksbuild.2&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;health&#34;: {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             &#34;issues&#34;: []</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         },</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;addonArn&#34;: &#34;arn:aws:eks:ap-northeast-2:&lt;ACCOUNT-ID&gt;:addon/myeks/adot/eec977ee-84a1-85fe-ecbe-a2f51c90e9e7&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;createdAt&#34;: &#34;2024-11-03T11:31:33.678000+09:00&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;modifiedAt&#34;: &#34;2024-11-03T11:31:33.694000+09:00&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         &#34;tags&#34;: {}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># }</span>
</span></span></code></pre></div><p>ì œëŒ€ë¡œ ë°°í¬ë˜ì—ˆë‚˜ ì²´í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get po -n opentelemetry-operator-system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME                                     READY   STATUS    RESTARTS   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># opentelemetry-operator-b7dbbdf7c-tqvfl   2/2     Running   0          64s</span>
</span></span></code></pre></div><h3 id="g-adot-collector-êµ¬ì„±">(g) ADOT Collector êµ¬ì„±</h3>
<p>ì•„ë˜ì™€ ê°™ì´ <code>collector-config-amp.yaml</code>ì„ ì‘ì„±í•˜ê³ , ë°°í¬í•©ë‹ˆë‹¤.</p>
<ul>
<li>í™˜ê²½ë³€ìˆ˜ ì˜ ì²´í¬í•´ì•¼í•©ë‹ˆë‹¤.
<ul>
<li><code>AMP_REMOTE_WRITE_ENDPOINT</code> : ë¨¼ì € ìƒì„±í–ˆë˜ ê·¸ê±° ë§ìŠµë‹ˆë‹¤.</li>
<li><code>AWS_REGION</code></li>
<li><code>EKS_CLUSTER_NAME</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># export AMP_REMOTE_WRITE_ENDPOINT=&lt;AMP_REMOTE_WRITE_ENDPOINT&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">export AMP_REMOTE_WRITE_ENDPOINT=https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/ws-0d032a51-2b98-43b1-90cb-f5069329f1af/api/v1/remote_write</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">echo $AMP_REMOTE_WRITE_ENDPOINT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/ws-0d032a51-2b98-43b1-90cb-f5069329f1af/api/v1/remote_write</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">cat &gt; collector-config-amp.yaml &lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">opentelemetry.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">OpenTelemetryCollector</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-collector-amp</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceAccount</span>: <span style="color:#ae81ff">adot-collector</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podAnnotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#39;8888&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">config</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    extensions:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sigv4auth:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        region: $AWS_REGION
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        service: &#34;aps&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      #
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Scrape configuration for the Prometheus Receiver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # This is the same configuration used when Prometheus is installed using the community Helm chart
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            scrape_interval: 60s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            scrape_timeout: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            external_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cluster: $EKS_CLUSTER_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - job_name: kubernetes-pods
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            scrape_timeout: 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - role: pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: (https?)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              target_label: __scheme__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_annotation_prometheus_io_path
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              replacement: \$\$1:\$\$2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_annotation_prometheus_io_port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              replacement: __param_\$\$1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: __meta_kubernetes_pod_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              target_label: kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              target_label: kubernetes_pod_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - action: drop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              regex: Pending|Succeeded|Failed|Completed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - __meta_kubernetes_pod_phase
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    processors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      batch/metrics:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        timeout: 60s         
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    exporters:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      prometheusremotewrite:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        endpoint: $AMP_REMOTE_WRITE_ENDPOINT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        auth:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          authenticator: sigv4auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      extensions: [sigv4auth]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      pipelines:   
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        metrics:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          receivers: [prometheus]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          processors: [batch/metrics]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          exporters: [prometheusremotewrite]</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">otel-prometheus-role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">nodes/proxy</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">extensions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">nonResourceURLs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">otel-prometheus-role-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">otel-prometheus-role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">adot-collector</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">cat collector-config-amp.yaml | grep remote_write</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># endpoint: https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/ws-0d032a51-2b98-43b1-90cb-f5069329f1af/api/v1/remote_write</span>
</span></span></code></pre></div><ul>
<li>ë°°í¬&hellip;!</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f collector-config-amp.yaml
</span></span></code></pre></div><h2 id="3-grafana-cloud-êµ¬ì„±">3. Grafana Cloud êµ¬ì„±</h2>
<blockquote>
<p>AMG ëŒ€ì‹  Grafana Cloudë¥¼ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤. ì‚¬ìš©ë°©ë²•ì€ ë§¤ìš° ê°„ë‹¨!</p>
</blockquote>
<ul>
<li><a href="https://grafana.com/grafana/plugins/grafana-amazonprometheus-datasource/">Plugin: Amazon Managed Service for Prometheus@Grafana Labs</a></li>
</ul>
<h3 id="a-grafana-cloud-ê°€ì…">(a) Grafana Cloud ê°€ì…</h3>
<p>ë„¤ ì´ê±° ê°€ì…í•´ë³¸ ì ì´ ì—†ì–´ì„œ ì ì–´ë³´ì•˜ìŠµë‹ˆë‹¤.</p>
<h3 id="b-í”ŒëŸ¬ê·¸ì¸-í™œì„±í™”-with-ë”¸ê¹">(b) í”ŒëŸ¬ê·¸ì¸ í™œì„±í™” with <code>ë”¸ê¹</code></h3>
<p><img src="images/just-click-to-use-amp-as-datasource.png" alt="just-click-to-use-amp-as-datasource"></p>
<h3 id="c-prometheus-datasource-ì„¤ì •">(c) Prometheus Datasource ì„¤ì •</h3>
<ul>
<li>
<p>ê²½ë¡œ: Home &gt; Connections &gt; Data sources &gt; grafana-amazonprometheus-datasource</p>
</li>
<li>
<p>URL ì˜ˆì‹œ: <code>https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/ws-0d032a51-2b98-43b1-90cb-f5069329f1af</code></p>
<ul>
<li>ëì— <code>/api/v1/query</code> ë„£ì—ˆë‹¤ê°€ ê³„ì† ì—ëŸ¬ë‚˜ì„œ ë­”ê°€ í–ˆë„¤ìš”.</li>
<li>Docs: <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-query-standalone-grafana.html#AMP-onboard-query-standalone-grafana-datasource">Add the Prometheus data source in Grafana</a></li>
</ul>
</li>
</ul>
<p><img src="images/datasource-url.png" alt="datasource-url"></p>
<ul>
<li>Auth: AWSì˜ SigV4ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
<ul>
<li>Access Key ID / Secret Access Key ì…ë ¥.</li>
<li>Assume Roleì˜ ê²½ìš°, Previewë¥¼ ìœ„í•œ í‹°ì¼“ì„ í•˜ê¸°ì—” ì‹œê°„ì´ ì—†ì–´ Skip.</li>
</ul>
</li>
</ul>
<p><img src="images/datasource-key.png" alt="datasource-key"></p>
<ul>
<li>Additional: ë¦¬ì „ê³¼ TLS ì„¤ì •</li>
</ul>
<p><img src="images/datasource-additional.png" alt="datasource-additional"></p>
<h2 id="4-query-ì‘ì„±-í›„-í™•ì¸">4. Query ì‘ì„± í›„ í™•ì¸</h2>
<p><img src="images/query-in-grafana-cloud.png" alt="query-in-grafana-cloud"></p>
<p>ë¸”ë¡œê·¸ì— ë‚˜ì˜¨ ëŒ€ë¡œ, ì •ìƒ ì¶œë ¥ë˜ëŠ” ê²ƒì€ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
<h2 id="9-vaporware">9. Vaporware</h2>
<blockquote>
<p>ì¤‘ê°„ì— íŒ¨ë‹‰ì´ ê±¸ë ¤ì„œ, Grafana Cloudì™€ ì—°ê²° ëª©ì ìœ¼ë¡œ Grafana Cloud Agentë¥¼ ë°°í¬í•´ì•¼í•˜ë‚˜ í–ˆëŠ”ë°, ê¸°ìš°ì˜€ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•„ìš”ëŠ” ì—†ì–´ë³´ì…ë‹ˆë‹¤.</p>
</blockquote>
<ul>
<li><a href="https://aws.amazon.com/blogs/opensource/configuring-grafana-cloud-agent-for-amazon-managed-service-for-prometheus/">Configuring Grafana Cloud Agent for Amazon Managed Service for Prometheus/AWS Open Source Blog</a></li>
<li><a href="https://grafana.com/grafana/plugins/grafana-amazonprometheus-datasource/">Amazon Managed Service for Prometheus/Grafana Labs Plugins</a></li>
</ul>
<h3 id="a-ê¶Œí•œ-ë¶€ì—¬-ì‘ì—…">(a) ê¶Œí•œ ë¶€ì—¬ ì‘ì—…</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://gist.githubusercontent.com/rfratto/b6c5888e89faed3b04fa2533e0bec1a2/raw/bb9aa5e560009e98b48861d0b2ce54fc8a4303e6/script.bash -o agent-permissions-aks.bash
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/YOUR_EKS_CLUSTER_NAME/</span><span style="color:#e6db74">${</span>EKS_CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">/g&#34;</span> agent-permissions-aks.bash
</span></span><span style="display:flex;"><span>cat agent-permissions-aks.bash | head -n <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ##!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CLUSTER_NAME=myeks # SEE THIS LINE IF CHANGED TO YOUR CLUSTER NAME  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query &#34;Account&#34; --output text)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OIDC_PROVIDER=$(aws eks describe-cluster --name $CLUSTER_NAME --query &#34;cluster.identity.oidc.issuer&#34; --output text | sed -e &#34;s/^https:\/\///&#34;)</span>
</span></span></code></pre></div><p>ì‹¤í–‰í•©ì‹œë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -al agent-permissions-aks.bash 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -rw-r--r-- 1 root root 4341 Nov  3 12:09 agent-permissions-aks.bash</span>
</span></span><span style="display:flex;"><span>chmod u+x agent-permissions-aks.bash
</span></span><span style="display:flex;"><span>ls -al agent-permissions-aks.bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -rwxr--r-- 1 root root 4341 Nov  3 12:09 agent-permissions-aks.bash</span>
</span></span><span style="display:flex;"><span>./agent-permissions-aks.bash
</span></span></code></pre></div><p>ì¤‘ê°„ ì¤‘ê°„, <code>error</code>ì— ì„¬ì°Ÿí–ˆì§€ë§Œ, ìƒì„±ì€ ëœê±° ê°™ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># ./agent-permissions-aks.bash
</span></span><span style="display:flex;"><span>Creating a new trust policy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>An error occurred (NoSuchEntity) when calling the GetRole operation: The role with name EKS-GrafanaAgent-AMP-ServiceAccount-Role cannot be found.
</span></span><span style="display:flex;"><span>Appending to the existing trust policy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>An error occurred (NoSuchEntity) when calling the GetPolicy operation: Policy arn:aws:iam::&lt;ACCOUNT-ID&gt;:policy/AWSManagedPrometheusWriteAccessPolicy was not found.
</span></span><span style="display:flex;"><span>Creating a new permission policy AWSManagedPrometheusWriteAccessPolicy
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;Policy&#34;: {
</span></span><span style="display:flex;"><span>        &#34;PolicyName&#34;: &#34;AWSManagedPrometheusWriteAccessPolicy&#34;,
</span></span><span style="display:flex;"><span>        &#34;PolicyId&#34;: &#34;ANPASTWNT54JUITZSLWOX&#34;,
</span></span><span style="display:flex;"><span>        &#34;Arn&#34;: &#34;arn:aws:iam::&lt;ACCOUNT-ID&gt;:policy/AWSManagedPrometheusWriteAccessPolicy&#34;,
</span></span><span style="display:flex;"><span>        &#34;Path&#34;: &#34;/&#34;,
</span></span><span style="display:flex;"><span>        &#34;DefaultVersionId&#34;: &#34;v1&#34;,
</span></span><span style="display:flex;"><span>        &#34;AttachmentCount&#34;: 0,
</span></span><span style="display:flex;"><span>        &#34;PermissionsBoundaryUsageCount&#34;: 0,
</span></span><span style="display:flex;"><span>        &#34;IsAttachable&#34;: true,
</span></span><span style="display:flex;"><span>        &#34;CreateDate&#34;: &#34;2024-11-03T03:16:10+00:00&#34;,
</span></span><span style="display:flex;"><span>        &#34;UpdateDate&#34;: &#34;2024-11-03T03:16:10+00:00&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>An error occurred (NoSuchEntity) when calling the GetRole operation: The role with name EKS-GrafanaAgent-AMP-ServiceAccount-Role cannot be found.
</span></span><span style="display:flex;"><span>EKS-GrafanaAgent-AMP-ServiceAccount-Role role does not exist. Creating a new role with a trust and permission policy
</span></span><span style="display:flex;"><span>arn:aws:iam::&lt;ACCOUNT-ID&gt;:role/EKS-GrafanaAgent-AMP-ServiceAccount-Role
</span></span><span style="display:flex;"><span>2024-11-03 12:16:16 [â„¹]  IAM Open ID Connect provider is already associated with cluster &#34;myeks&#34; in &#34;ap-northeast-2&#34;
</span></span></code></pre></div><h3 id="b-grafana-cloud-agent-ë°°í¬">(b) Grafana Cloud Agent ë°°í¬</h3>
<ul>
<li><a href="https://github.com/grafana/agent/tree/v0.18.4/production/kubernetes">grafana/agent@v0.18.4</a></li>
<li><a href="https://github.com/grafana/agent/commit/254819f1e4ee99e351533cf6366893871cf593b2">Clean up K8s deployment methods (#749)</a></li>
</ul>
<p>ë¸”ë¡œê·¸ì²˜ëŸ¼ í•´ë³´ë ¤ê³  í–ˆëŠ”ë°, í•´ë‹¹ <code>install-sigv4.sh</code> íŒŒì¼ì´ <code>v0.18.4</code> ê¹Œì§€ë§Œ ì§€ì›í•˜ëŠ” ê²ƒì´ì–´ì„œ í•´ë³´ê³  ì•ˆë˜ë©´ ì¢…ë£Œí•˜ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create namespace grafana-agent; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>WORKSPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ws-0d032a51-2b98-43b1-90cb-f5069329f1af&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>ROLE_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arn:aws:iam::&lt;ACCOUNT-ID&gt;:role/EKS-GrafanaAgent-AMP-ServiceAccount-Role&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>REGION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ap-northeast-2&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;grafana-agent&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>REMOTE_WRITE_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://aps-workspaces.</span>$REGION<span style="color:#e6db74">.amazonaws.com/workspaces/</span>$WORKSPACE<span style="color:#e6db74">/api/v1/remote_write&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/bin/bash -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/grafana/agent/v0.18.4/production/kubernetes/install-sigv4.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> | kubectl apply -f -
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># namespace/grafana-agent created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># serviceaccount/grafana-agent created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># configmap/grafana-agent created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># configmap/grafana-agent-deployment created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># daemonset.apps/grafana-agent created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># deployment.apps/grafana-agent-deployment created</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resource mapping not found for name: &#34;grafana-agent&#34; namespace: &#34;&#34; from &#34;STDIN&#34;: no matches for kind &#34;ClusterRole&#34; in version &#34;rbac.authorization.k8s.io/v1beta1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ensure CRDs are installed first</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resource mapping not found for name: &#34;grafana-agent&#34; namespace: &#34;&#34; from &#34;STDIN&#34;: no matches for kind &#34;ClusterRoleBinding&#34; in version &#34;rbac.authorization.k8s.io/v1beta1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ensure CRDs are installed first</span>
</span></span></code></pre></div><p>ê·¸ë˜ì„œ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ë™ìœ¼ë¡œ ì¬êµ¬ì„±í•´ì„œ ë°°í¬ ë‹¤ì‹œ í–ˆìŠµë‹ˆë‹¤.</p>
<ul>
<li>ìˆ˜ì •ëœ ë¶€ë¶„
<ul>
<li>ê¸°ì¡´: v1beta1</li>
<li>ìˆ˜ì •: v1</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grafana-agent</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes/proxy</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">nonResourceURLs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grafana-agent</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grafana-agent</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grafana-agent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">grafana-agent</span>
</span></span></code></pre></div>
  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <div class="card w-full bg-base-100 shadow-xl">
  <div class="card-body" id="adbody">
      <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1254864146899485"
          crossorigin="anonymous"></script>
      
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1254864146899485"
          data-ad-slot="3556422150" data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </div>
  
  <script>
      let adsection = document.getElementsByClassName("adsbygoogle")[0];
      let adfallback = document.getElementById("adfallback");
      adfallback.style.display = "none";
      if (window.getComputedStyle(adsection).display == "none") {
          document.getElementById("adbody").style.display = "none";
          adfallback.style.display = "block";
      } 
  </script>
</div>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho7969@ubuntu.com">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/kans-8w-cilium-trial/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">Kubernetes Service(5): Cillium Quick-start w/Hubble UI</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/getting-started-amazon-managed-grafana-workspace/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">SAML for using Amazon Managed Grafana Workspace (To-Do)</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho7969@ubuntu.com">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
      <p>
        Â© 2025 kkumtree and contributors All rights reserved.<br>
        Licensed under <br>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
          CC BY-NC-ND 4.0
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg">
        </a>
      </p>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
