<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>Kubernetes Service(5): Cillium Quick-start w/Hubble UI | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="Kubernetes Service(5): Cillium Quick-start w/Hubble UI" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/kans-8w-cilium-trial/cover.png' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/kans-8w-cilium-trial/cover.png' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/kans-8w-cilium-trial/cover.png' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.05bc9a89b9988ba7449154a7ccd83133b7df79fac13cc1945cffac151ac54dbb.css">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCJ1CESNKD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCJ1CESNKD');
</script><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>
     
     <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸŒ
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
            
            
          </ul>
        </li>
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
<div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.png'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>Kubernetes Service(5): Cillium Quick-start w/Hubble UI</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2024-10-26T01:35:59&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/kans" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">kans</span>
              </div>
            </a>
            
            <a href="/tags/ebpf" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">ebpf</span>
              </div>
            </a>
            
            <a href="/tags/cilium" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">cilium</span>
              </div>
            </a>
            
            <a href="/tags/kubeadm" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">kubeadm</span>
              </div>
            </a>
            
            <a href="/tags/kubernetes" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">kubernetes</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>ê·¸ëŸ¼ ë§¤ë²ˆ ì‹¤íŒ¨ë§Œ í–ˆë˜ Cilium ë°°í¬ë¥¼ í•œë²ˆ í•´ë³¼ê¹Œìš”?</p>
<p><a href="https://gasidaseo.notion.site/CloudNet-Blog-c9dfa44a27ff431dafdd2edacc8a1863">CloudNet@</a>ì—ì„œ ì§„í–‰í•˜ê³  ìˆëŠ” <strong>K</strong>8s <strong>A</strong>dvanced <strong>N</strong>etwork <strong>S</strong>tudy(ì´í•˜, KANS)ë¥¼ í†µí•´ í•™ìŠµí•œ ë‚´ìš©ì„ ì •ë¦¬í•©ë‹ˆë‹¤.</p>
<h2 id="1-csp-vm-ê³¨ë¼ë³´ê¸°">1. CSP VM ê³¨ë¼ë³´ê¸°</h2>
<p>ì´ë ‡ê²Œ ì“´ ì´ìœ ëŠ” ê²°êµ­ ë„¤íŠ¸ì›Œí¬ë¥¼ <code>ì˜</code> ì•Œì•„ì•¼í•˜ëŠ”ë°,<br>
ì‘ë…„ì— í•  ë•ŒëŠ” ê·¸ëŸ°ê±° ìƒê°ë„ ì•ˆí•˜ê³  ê·¸ëƒ¥ ì˜¬ë ¤ë³´ë ¤ í–ˆìœ¼ë‹ˆ ë‹¹ì—°íˆ ì•ˆ ëŒì•„ê°€ê² ì£ ?</p>
<ul>
<li><a href="https://trying2adult.com/what-is-xdp-and-how-do-you-use-it-in-linux-amazon-ec2-example/">trying2adult/What Is XDP And How Do You Use It In Linux</a></li>
</ul>
<p>ê·¸ëƒ¥ ê³°ê³°íˆ ì˜¤ë¦¬<del>duckduckgo</del>ë‘ íˆ¬ë‹¥ê±°ë¦¬ë‹¤ë³´ë‹ˆ, ë¹„ë¡ ì—°ì‹ì´ ë˜ê¸´ í–ˆì§€ë§Œ<br>
í´ë¦­ì„ ì•ˆí•˜ê³ ëŠ” ëª»ë°°ê¸¸ ìœ„ì˜ ë¸”ë¡œê·¸ ì œëª©ì´ ëˆˆì— ë„ì˜€ìŠµë‹ˆë‹¤.</p>
<h3 id="a-ì‚¬ì „-ì¡°ì‚¬">a. ì‚¬ì „ ì¡°ì‚¬</h3>
<ol>
<li>ì»¤ë„:</li>
</ol>
<ul>
<li>í˜„ì¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë²„ì „ì´ ë§ˆì´ë„ˆ ë²„ì „ì€ ëª» ì™¸ìš°ê² ì§€ë§Œ, ëŒ€ì¶© ë©”ì´ì €ê°€ 6ë²„ì „ì´ë‹ˆ PASS</li>
</ul>
<ol start="2">
<li>NIC:</li>
</ol>
<ul>
<li>ENA(Elastic Network Adapter) ë“œë¼ì´ë²„ ì–¸ê¸‰ì´ ë‚˜ì˜¨ ê²ƒìœ¼ë¡œ ë´ì„ ,<br>
ì§€ì› ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ëœ í—¤ë©œ ê²ƒ ê°™ì€ ëŠë‚Œì´ ë“­ë‹ˆë‹¤.</li>
</ul>
<ol start="3">
<li>MTU ìƒí•œ:</li>
</ol>
<ul>
<li>cilium ìµœì‹  ë²„ì „ë„ ìƒí•œê°’ì´ 3818ì¸ì§€ í™•ì¸í•˜ë©´ ì¢‹ì„ ë“¯í•©ë‹ˆë‹¤.</li>
</ul>
<ol start="4">
<li>NIC channels for RX/TX Queue:</li>
</ol>
<ul>
<li>ì ˆë°˜ ì´ìƒì„ ë¹„ì›Œì•¼í•œë‹¤ëŠ”ë°, ì±„ë„ ìˆ˜ ëª¨ë¥´ë©´ ì¢€ ë§ì´ í—¤ë§¬ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>
<h3 id="b-aws-clië¡œ-í™•ì¸">b. AWS CLIë¡œ í™•ì¸</h3>
<ul>
<li>Docs:
<ul>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking-ena.html#test-enhanced-networking-ena">Test whether enhanced networking is enabled</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/query-for-the-latest-amazon-linux-ami-ids-using-aws-systems-manager-parameter-store/">Query for the latest Amazon Linux AMI IDs using AWS Systems Manager Parameter Store</a></li>
</ul>
</li>
</ul>
<p>ìŠ¤í„°ë””ì—ì„œ ì œê³µëœ CloudFormationíŒŒì¼ ì¤‘ AMIì€<br>
Canonicalì—ì„œ ê´€ë¦¬í•˜ëŠ” SSM íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ ìµœì‹ í™”ë¥¼ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.<br>
ê·¸ë˜ì„œ ê·¸ëƒ¥ ì´ SSM íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ AMI IDë¥¼ ì–»ì–´ì™€ ë³´ì£ .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws ssm get-parameters --names /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id --region ap-northeast-2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Parameters&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Type&#34;</span>: <span style="color:#e6db74">&#34;String&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Value&#34;</span>: <span style="color:#e6db74">&#34;ami-042e76978adeb8c48&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#ae81ff">30</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;LastModifiedDate&#34;</span>: <span style="color:#e6db74">&#34;2024-09-27T13:11:50.127000+09:00&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;ARN&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:ssm:ap-northeast-2::parameter/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;DataType&#34;</span>: <span style="color:#e6db74">&#34;aws:ec2:image&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;InvalidParameters&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ë‹¹ì—°íˆ <code>enaSupport</code>ê°€ <code>true</code>ë¡œ ë‚˜ì˜¤ë„¤ìš”.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws ec2 describe-images --image-id ami-042e76978adeb8c48 --query <span style="color:#e6db74">&#34;Images[].EnaSupport&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ]</span>
</span></span></code></pre></div><p>ëˆˆê°ê³  <code>c5.16xlarge</code> ë¥¼ ë„ì›Œë³¼ê¹Œ ì‹¶ê¸´í•œë°, ì•„ë˜ ë¬¸ì„œì—ì„œ Nitro v2 ë²„ì „ íƒ­ì— T3ë„ ìˆëŠ” ê²ƒì„ í™•ì¸í–ˆë„¤ìš”.<br>
Cloudformation YAMLì— ê¸°ë³¸ ì •ì˜ëœ <code>t3.xlarge</code>ë¥¼ ì¨ë³´ê² ìŠµë‹ˆë‹¤.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/ec2/latest/instancetypes/ec2-nitro-instances.html#nitro-instance-types">Virtualized instances
/AWS</a></li>
</ul>
<h3 id="c-í”„ë¡œë¹„ì €ë‹-í›„-ê¸°ë³¸-ì²´í¬">c. í”„ë¡œë¹„ì €ë‹ í›„ ê¸°ë³¸ ì²´í¬</h3>
<ul>
<li>
<p>ìŠ¤í„°ë””ì—ì„œ ì œê³µëœ ëŒ€ë¡œ, <code>kube-proxy</code> ì—†ì´ ìš´ìš© í…ŒìŠ¤íŠ¸ë¥¼ í•  ê²ƒì´ê¸°ì— í™•ì¸ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
</li>
<li>
<p>ì´ë¯¸ <code>kubeadm</code> ë°°í¬ ì‹œ, <code>--skip-phases=addon/kube-proxy</code> paramì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
</li>
<li>
<p>No <code>kube-proxy</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Access to Control Plane Node</span>
</span></span><span style="display:flex;"><span>ssh -i $Keypair ubuntu@$ControlPlaneIP  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Not ready because of no kube-proxy </span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME     STATUS     ROLES           AGE   VERSION</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-s    NotReady   control-plane   14m   v1.30.6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-w1   NotReady   &lt;none&gt;          13m   v1.30.6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-w2   NotReady   &lt;none&gt;          13m   v1.30.6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No kube-proxy</span>
</span></span><span style="display:flex;"><span>kubectl cluster-info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes control plane is running at https://192.168.10.10:6443</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CoreDNS is running at https://192.168.10.10:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No kube-proxy  </span>
</span></span><span style="display:flex;"><span>kubectl get pod -A
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAMESPACE     NAME                            READY   STATUS    RESTARTS   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   coredns-55cb58b774-h9dnm        0/1     Pending   0          14m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   coredns-55cb58b774-vjzrk        0/1     Pending   0          14m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   etcd-k8s-s                      1/1     Running   0          14m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-apiserver-k8s-s            1/1     Running   0          14m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-controller-manager-k8s-s   1/1     Running   0          14m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-scheduler-k8s-s            1/1     Running   0          14m</span>
</span></span></code></pre></div><ul>
<li>ì»¤ë„ í™•ì¸: ì•ˆí•´ë„ ë˜ì§€ë§Œ, í•œë²ˆ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Kernel Version</span>
</span></span><span style="display:flex;"><span>uname -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Linux k8s-s 6.8.0-1015-aws #16~22.04.1-Ubuntu SMP Mon Aug 19 19:38:17 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span style="display:flex;"><span>hostnamectl | grep Kernel
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># Kernel: Linux 6.8.0-1015-aws</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># XDP Support</span>
</span></span><span style="display:flex;"><span>grep -i CONFIG_XDP_SOCKETS /boot/config-<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CONFIG_XDP_SOCKETS=y</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CONFIG_XDP_SOCKETS_DIAG=m</span>
</span></span></code></pre></div><ul>
<li>NIC í™•ì¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>netplan status | grep ethernet
</span></span><span style="display:flex;"><span><span style="color:#75715e"># â—  1: lo ethernet UNKNOWN/UP (unmanaged)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># â—  2: ens5 ethernet UP (networkd: ens5)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MTU</span>
</span></span><span style="display:flex;"><span>ip link show ens5 | grep mtu
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2: ens5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX/TX Queue</span>
</span></span><span style="display:flex;"><span>ethtool -l ens5
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Channel parameters for ens5:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pre-set maximums:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Combined:	4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Current hardware settings:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Combined:	4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Driver</span>
</span></span><span style="display:flex;"><span>ethtool -i ens5 | grep ena
</span></span><span style="display:flex;"><span><span style="color:#75715e"># driver: ena</span>
</span></span></code></pre></div><p>Ciliumì—ì„œ ìš”êµ¬ì‚¬í•­ì„ ë”°ë¡œ ì‚´í´ë´ì•¼ê² ì§€ë§Œ,<br>
MTU ë° RX/TX Queue ê´€ë ¨ ì±„ë„ ê°’ì„ ë°”ê¿”ì•¼í•  ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</p>
<h2 id="2-cilium-ì„¤ì¹˜">2. Cilium ì„¤ì¹˜</h2>
<ul>
<li>ì„¤ì¹˜ ì „ì— ë¯¸ë¦¬ OSì—ì„œ íŒŒë¼ë¯¸í„° ì¡°ì •ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>
<h3 id="a-íŒŒë¼ë¯¸í„°-ì¡°ì •">a. íŒŒë¼ë¯¸í„° ì¡°ì •</h3>
<p>í¬ê²Œ ë‘ ê°€ì§€ íŒŒë¼ë¯¸í„° ì¡°ì •í•´ë‘¡ë‹ˆë‹¤.</p>
<ul>
<li>Maxium MTU: 3498
<ul>
<li>ìµœì‹ ë¬¸ì„œ(v1.16.3)ì—ì„œëŠ” ê°’ì´ ë” ë‚®ì•„ì ¸ì„œ 3498ë¡œ ì¡°ì •í•©ë‹ˆë‹¤.</li>
</ul>
</li>
<li>RX/TX Queue: more than half</li>
</ul>
<p>RX/TX QueueëŠ” ê·¸ë ‡ë‹¤ê³  ì¹˜ê³ , MTUì˜ ê²½ìš°ì—ëŠ” ì™œ ì¡°ì •í•´ì•¼ë˜ëŠ”ì§€ ì•„ë˜ì—ë„ ì„¤ëª…ë˜ì–´ìˆìœ¼ë‹ˆ ì°¸ì¡°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</p>
<ul>
<li><a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#nodeport-xdp-on-aws">NodPort on AWS/cilium</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># MTU</span>
</span></span><span style="display:flex;"><span>ip link set dev ens5 mtu <span style="color:#ae81ff">3498</span>
</span></span><span style="display:flex;"><span>ip link show ens5 | grep mtu
</span></span><span style="display:flex;"><span>2: ens5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">3498</span> qdisc mq state UP mode DEFAULT group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX/TX Queue</span>
</span></span><span style="display:flex;"><span>ethtool -L ens5 combined <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ethtool -l ens5
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Channel parameters for ens5:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pre-set maximums:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Combined:	4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Current hardware settings:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TX:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other:		n/a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Combined:	1</span>
</span></span></code></pre></div><h3 id="b-cilium-cli-ì„¤ì¹˜">b. Cilium CLI ì„¤ì¹˜</h3>
<p>ê·¸ëƒ¥ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ Cilium CLI ì„¤ì¹˜ ë¯¸ë¦¬ í•´ë‘ê² ìŠµë‹ˆë‹¤. ì•„ì§ Majorê°€ v1ì€ ì•„ë‹™ë‹ˆë‹¤.</p>
<ul>
<li>Docs: <a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-the-cilium-cli">Install the Cilium CLI</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v0.16.19</span>
</span></span><span style="display:flex;"><span>CILIUM_CLI_VERSION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>CLI_ARCH<span style="color:#f92672">=</span>amd64
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;aarch64&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> CLI_ARCH<span style="color:#f92672">=</span>arm64; <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/<span style="color:#e6db74">${</span>CILIUM_CLI_VERSION<span style="color:#e6db74">}</span>/cilium-linux-<span style="color:#e6db74">${</span>CLI_ARCH<span style="color:#e6db74">}</span>.tar.gz<span style="color:#f92672">{</span>,.sha256sum<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>sha256sum --check cilium-linux-<span style="color:#e6db74">${</span>CLI_ARCH<span style="color:#e6db74">}</span>.tar.gz.sha256sum
</span></span><span style="display:flex;"><span>sudo tar xzvfC cilium-linux-<span style="color:#e6db74">${</span>CLI_ARCH<span style="color:#e6db74">}</span>.tar.gz /usr/local/bin
</span></span><span style="display:flex;"><span>rm cilium-linux-<span style="color:#e6db74">${</span>CLI_ARCH<span style="color:#e6db74">}</span>.tar.gz<span style="color:#f92672">{</span>,.sha256sum<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ë²„ì „ í™•ì¸ì„ ì•ˆë‚´ëŒ€ë¡œ í•´ë´…ì‹œë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cilium version --client
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium-cli: v0.16.19 compiled with go1.23.1 on linux/amd64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium image (default): v1.16.2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium image (stable): v1.16.3</span>
</span></span></code></pre></div><h3 id="c-helm-ë°°í¬">c. helm ë°°í¬</h3>
<p>ê·¸ëƒ¥ ì‹¤íŒ¨í•˜ë©´ cilium CLIë¡œ ì„¤ì¹˜í•˜ê³  ëˆˆ ê°ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add cilium https://helm.cilium.io/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;cilium&#34; has been added to your repositories</span>
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hang tight while we grab the latest from your chart repositories...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ...Successfully got an update from the &#34;cilium&#34; chart repository</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update Complete. âˆHappy Helming!âˆ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm install cilium cilium/cilium --version 1.16.3 --namespace kube-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set k8sServiceHost<span style="color:#f92672">=</span>192.168.10.10 --set k8sServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span> --set debug.enabled<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set rollOutCiliumPods<span style="color:#f92672">=</span>true --set routingMode<span style="color:#f92672">=</span>native --set autoDirectNodeRoutes<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set bpf.masquerade<span style="color:#f92672">=</span>true --set bpf.hostRouting<span style="color:#f92672">=</span>true --set endpointRoutes.enabled<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set ipam.mode<span style="color:#f92672">=</span>kubernetes --set k8s.requireIPv4PodCIDR<span style="color:#f92672">=</span>true --set kubeProxyReplacement<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set ipv4NativeRoutingCIDR<span style="color:#f92672">=</span>192.168.0.0/16 --set installNoConntrackIptablesRules<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set hubble.ui.enabled<span style="color:#f92672">=</span>true --set hubble.relay.enabled<span style="color:#f92672">=</span>true --set prometheus.enabled<span style="color:#f92672">=</span>true --set operator.prometheus.enabled<span style="color:#f92672">=</span>true --set hubble.metrics.enableOpenMetrics<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set hubble.metrics.enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{dns:query;ignoreAAAA,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set operator.replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><ul>
<li>ì£¼ìš” íŒŒë¼ë¯¸í„° ì„¤ëª…</li>
</ul>
<table>
<thead>
<tr>
<th>íŒŒë¼ë¯¸í„°</th>
<th>ì„¤ëª…</th>
</tr>
</thead>
<tbody>
<tr>
<td>debug.enabled</td>
<td>cilium íŒŒë“œì— ë¡œê·¸ ë ˆë²¨ì„ debug ì„¤ì •</td>
</tr>
<tr>
<td>autoDirectNodeRoutes</td>
<td>ë™ì¼ ëŒ€ì—­ ë‚´ì˜ ë…¸ë“œë“¤ ë¼ë¦¬ëŠ” ìƒëŒ€ ë…¸ë“œì˜ podCIDR ëŒ€ì—­ì˜ ë¼ìš°íŒ…ì´ ìë™ìœ¼ë¡œ ì„¤ì •</td>
</tr>
<tr>
<td>endpointRoutes.enabled</td>
<td>í˜¸ìŠ¤íŠ¸ì— endpoint(íŒŒë“œ)ë³„ ê°œë³„ ë¼ìš°íŒ… ì„¤ì •</td>
</tr>
<tr>
<td>hubble.relay.enabled</td>
<td>hubble í™œì„±í™”</td>
</tr>
<tr>
<td>hubble.ui.enabled</td>
<td>hubble UI í™œì„±í™”</td>
</tr>
<tr>
<td>ipam.mode</td>
<td>k8s IPAM í™œìš©</td>
</tr>
<tr>
<td>k8s.requireIPv4PodCIDR</td>
<td>k8sì—ì„œ IPv4 Pod CIDRë¥¼ ìš”êµ¬</td>
</tr>
<tr>
<td>kubeProxyReplacement</td>
<td>kube-proxy ì—†ì´ (ìµœëŒ€í•œ) ëŒ€ì²´í• ìˆ˜ ìˆìˆ˜ ìˆê²Œ</td>
</tr>
<tr>
<td>ipv4NativeRoutingCIDR=192.168.0.0/16</td>
<td>í•´ë‹¹ ëŒ€ì—­ê³¼ í†µì‹  ì‹œ IP Masq í•˜ì§€ ì•ŠìŒ, ë³´í†µ ì‚¬ë‚´ë§ ëŒ€ì—­ì„ ì§€ì •</td>
</tr>
<tr>
<td>operator.replicas</td>
<td>cilium-operator íŒŒë“œ ê¸°ë³¸ 1ê°œ</td>
</tr>
<tr>
<td>enableIPv4Masquerade</td>
<td>íŒŒë“œë¥¼ ìœ„í•œ Masquerade</td>
</tr>
<tr>
<td>bpf.masquerade</td>
<td>ì¶”ê°€ë¡œ Masquerade ì„ BPF ë¡œ ì²˜ë¦¬</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME: cilium
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Sun Oct <span style="color:#ae81ff">27</span> 11:58:59 <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>NAMESPACE: kube-system
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Your release version is 1.16.3.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For any further help, visit https://docs.cilium.io/en/v1.16/gettinghelp
</span></span></code></pre></div><p>&hellip; ìŠ¤í„°ë””ì—ì„œ ì•ˆë‚´í•´ì£¼ì‹  íŒŒë¼ë¯¸í„°ë¥¼ ë„£ì–´ì„œ í–ˆìŠµë‹ˆë‹¤<del>ë§Œ, ì´ê²Œ ì™œ ë˜ì§€&hellip;?</del><br>
ì´ì œ, ì¶”ê°€ íŒŒë¼ë¯¸í„° ì£¼ì…ì•ˆí•´ë„ ì •ìƒì ìœ¼ë¡œ í•´ë‹¹ ë²„ì „ì´ ì‘ë™í•˜ê³  ìˆë‹¤ê³  í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cilium version
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium-cli: v0.16.19 compiled with go1.23.1 on linux/amd64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium image (default): v1.16.2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium image (stable): v1.16.3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium image (running): 1.16.3</span>
</span></span></code></pre></div><h2 id="3-cilium-ì‚´í´ë³´ê¸°">3. Cilium ì‚´í´ë³´ê¸°</h2>
<h3 id="a-ë°°í¬-ì´í›„-ìƒíƒœ">a. ë°°í¬ ì´í›„ ìƒíƒœ</h3>
<p>ì´ì œ <code>kube-proxy</code> ì—†ì´ë„ ê° Nodeê°€ Ready ìƒíƒœì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME     STATUS   ROLES           AGE   VERSION</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-s    Ready    control-plane   20h   v1.30.6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-w1   Ready    &lt;none&gt;          20h   v1.30.6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-w2   Ready    &lt;none&gt;          20h   v1.30.6</span>
</span></span></code></pre></div><p><code>kube-proxy</code>ëŠ” ì—†ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pods -A
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-2g4bh                       1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-522nn                       1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-csdd7                       1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-envoy-82drs                 1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-envoy-96vst                 1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-envoy-gnh2q                 1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-operator-76bb588dbc-57945   1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   coredns-55cb58b774-h9dnm           1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   coredns-55cb58b774-vjzrk           1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   etcd-k8s-s                         1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-relay-88f7f89d4-r4ccq       1/1     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-ui-59bb4cb67b-l5ttc         2/2     Running   0          91m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-apiserver-k8s-s               1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-controller-manager-k8s-s      1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-scheduler-k8s-s               1/1     Running   0          20h</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get svc -A
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAMESPACE     NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default       kubernetes       ClusterIP   10.10.0.1       &lt;none&gt;        443/TCP                  20h</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   cilium-envoy     ClusterIP   None            &lt;none&gt;        9964/TCP                 93m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-metrics   ClusterIP   None            &lt;none&gt;        9965/TCP                 93m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-peer      ClusterIP   10.10.161.48    &lt;none&gt;        443/TCP                  93m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-relay     ClusterIP   10.10.150.231   &lt;none&gt;        80/TCP                   93m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   hubble-ui        ClusterIP   10.10.183.16    &lt;none&gt;        80/TCP                   93m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-system   kube-dns         ClusterIP   10.10.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   20h</span>
</span></span></code></pre></div><p>NAT í…Œì´ë¸”ì— ì„¤ì •ëœ ëª¨ë“  ê·œì¹™ì„ ì•Œì•„ë´…ì‹œë‹¤: <code>iptables -t -nat -S</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -t nat -S
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -P PREROUTING ACCEPT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -P INPUT ACCEPT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -P OUTPUT ACCEPT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -P POSTROUTING ACCEPT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N CILIUM_OUTPUT_nat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N CILIUM_POST_nat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N CILIUM_PRE_nat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -N KUBE-KUBELET-CANARY</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -A PREROUTING -m comment --comment &#34;cilium-feeder: CILIUM_PRE_nat&#34; -j CILIUM_PRE_nat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -A OUTPUT -m comment --comment &#34;cilium-feeder: CILIUM_OUTPUT_nat&#34; -j CILIUM_OUTPUT_nat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -A POSTROUTING -m comment --comment &#34;cilium-feeder: CILIUM_POST_nat&#34; -j CILIUM_POST_nat</span>
</span></span></code></pre></div><h3 id="b-cilium-cli-í™œìš©í•˜ê¸°">b. Cilium CLI í™œìš©í•˜ê¸°</h3>
<p><a href="https://sigridjin.medium.com/ebpf-and-cillum-cni-1c3ad2a1e4e9">Sigrid Jin</a>ë‹˜ì˜ ê°€ì´ë“œë¥¼ ì°¸ì¡°í–ˆìŠµë‹ˆë‹¤.</p>
<p>Alias ì„¤ì •ì„ í•´ë‘ë©´ í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ê³  í•˜ë‹ˆ, ì¼ë‹¨ í•´ë´…ì‹œë‹¤.<br>
helm ë°°í¬ ì‹œ, <code>kube-proxy</code>ë¥¼ ëŒ€ì²´í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìœ¼ë‹ˆ,<br>
ë§ˆì§€ë§‰ì— ë‹¹ì—°íˆ Trueê°€ ë‚˜ì˜¤ê¸´ í•´ì•¼í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get -l k8s-app<span style="color:#f92672">=</span>cilium pods -n kube-system --field-selector spec.nodeName<span style="color:#f92672">=</span>k8s-s  -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].metadata.name}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cilium-522nn</span>
</span></span><span style="display:flex;"><span>export CILIUMPOD0<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get -l k8s-app<span style="color:#f92672">=</span>cilium pods -n kube-system --field-selector spec.nodeName<span style="color:#f92672">=</span>k8s-s  -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].metadata.name}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- cilium status
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KVStore:                 Ok   Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes:              Ok   1.30 (v1.30.6) [linux/amd64]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes APIs:         [&#34;EndpointSliceOrEndpoint&#34;, &#34;cilium/v2::CiliumClusterwideNetworkPolicy&#34;, &#34;cilium/v2::CiliumEndpoint&#34;, &#34;cilium/v2::CiliumNetworkPolicy&#34;, &#34;cilium/v2::CiliumNode&#34;, &#34;cilium/v2alpha1::CiliumCIDRGroup&#34;, &#34;core/v1::Namespace&#34;, &#34;core/v1::Pods&#34;, &#34;core/v1::Service&#34;, &#34;networking.k8s.io/v1::NetworkPolicy&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KubeProxyReplacement:    True   [ens5   192.168.10.10 fe80::b1:11ff:feba:7ce9 (Direct Routing)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Host firewall:           Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SRv6:                    Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CNI Chaining:            none</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cilium:                  Ok   1.16.3 (v1.16.3-f2217191)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NodeMonitor:             Listening for events on 4 CPUs with 64x4096 of shared memory</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cilium health daemon:    Ok   </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPAM:                    IPv4: 4/254 allocated from 172.16.0.0/24, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv4 BIG TCP:            Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv6 BIG TCP:            Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># BandwidthManager:        Disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Routing:                 Network: Native   Host: BPF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Attach Mode:             TCX</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Device Mode:             veth</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Masquerading:            BPF   [ens5]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Controller Status:       29/29 healthy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Proxy Status:            OK, ip 172.16.0.231, 0 redirects active on ports 10000-20000, Envoy: external</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global Identity Range:   min 256, max 65535</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hubble:                  Ok              Current/Max Flows: 4095/4095 (100.00%), Flows/s: 26.15   Metrics: Ok</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encryption:              Disabled        </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cluster health:          3/3 reachable   (2024-10-27T05:05:44Z)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Modules Health:          Stopped(0) Degraded(0) OK(45)</span>
</span></span><span style="display:flex;"><span>alias c0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kubectl exec -it </span>$CILIUMPOD0<span style="color:#e6db74"> -n kube-system -c cilium-agent -- cilium&#34;</span>
</span></span><span style="display:flex;"><span>c0 status | grep KubeProxyReplacement
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KubeProxyReplacement:    True   [ens5   192.168.10.10 fe80::b1:11ff:feba:7ce9 (Direct Routing)]</span>
</span></span></code></pre></div><p>iptables MASQ ëŒ€ì‹  eBPF MASQ ì‚¬ìš©ì„ ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cilium config view | grep -i masq
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable-bpf-masquerade                             true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable-ipv4-masquerade                            true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable-ipv6-masquerade                            true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable-masquerade-to-route-source                 false</span>
</span></span></code></pre></div><h3 id="c-hubble-ui">c. Hubble UI</h3>
<p>ê°€ì‹œì„±ì´ ìˆëŠ” ê²ƒì„ ë‹¤ë“¤ ì¢‹ì•„í•˜ê³ , ì €ë„&hellip; ì‚´ì§ ê»˜ë¦„ì¹™í•˜ì§€ë§Œ ì¢‹ì•„í•˜ê¸° ë•Œë¬¸ì—<br>
Hublle UIë¥¼ ë„ì›Œë³¼ê¹Œìš”?</p>
<p>ì´ë¯¸ helmì„ í†µí•´ì„œ, í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ ì˜¬ë¼ì™€ ìˆëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get -n kube-system svc hubble-ui
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NAME        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hubble-ui   ClusterIP   10.10.183.16   &lt;none&gt;        80/TCP    146m</span>
</span></span></code></pre></div><p>ì´ê±¸ <del>ì‚´ì§ ë§˜ì—ëŠ” ì•ˆë“¤ì§€ë§Œ</del> NodePortë¡œ ë…¸ì¶œì‹œì¼œë´…ì‹œë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch -n kube-system svc hubble-ui -p <span style="color:#e6db74">&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># service/hubble-ui patched</span>
</span></span><span style="display:flex;"><span>b
</span></span><span style="display:flex;"><span>HubbleUiNodePort<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get svc -n kube-system hubble-ui -o jsonpath<span style="color:#f92672">={</span>.spec.ports<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.nodePort<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 30401</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Hubble UI URL = http://</span><span style="color:#66d9ef">$(</span>curl -s ipinfo.io/ip<span style="color:#66d9ef">)</span><span style="color:#e6db74">:</span>$HubbleUiNodePort<span style="color:#e6db74">&#34;</span>Port<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Hubble UI URL = http://13.125.233.122:30401
</span></span></span></code></pre></div><p>ìš°ì˜¤ì˜¤ì˜¤&hellip; UI ì˜ ëœ¨ë„¤ìš”.</p>
<p><img src="images/hubble-ui-first-glance.png" alt="hubble-ui-first-glance"></p>
<p>ì•„ë¬´ê²ƒë„ ì•ˆë„ì›Œì„œ, <code>kube-system</code> ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>
<p><img src="images/hubble-in-kube-system.png" alt="hubble-in-kube-system"></p>
<h2 id="9-ë±€ë‹¤ë¦¬">9. ë±€ë‹¤ë¦¬</h2>
<h3 id="a-netplan">a. Netplan</h3>
<p>Ubuntu ì—ì„œëŠ” ì–¸ì œë¶€í„°ì¸ì§€ ê¸°ì–µì´ ì•ˆë‚˜ëŠ”ë°, ê¸°ë³¸ê°’ìœ¼ë¡œ netplanì„ ë„¤íŠ¸ì›Œí¬ ì„¤ì • ë„êµ¬ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
YAMLë¡œ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ í¬í•¨í•´ ë§ì€ ì´ì ë„ ìˆê³ ,<br>
ë²„ì „ ì—¡ë°ì´íŠ¸ë¥¼ í†µí•´ ê°œì„ ì´ ë§ì´ ì´ë£¨ì–´ì ¸ì„œ ê´€ì‹¬ì´ ìˆë‹¤ë©´ ì‚´í´ë³´ëŠ” ê²ƒë„ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>
<p><a href="https://netplan.io/design#design-overview">Design Overview/Netplan</a></p>
<p>ì‹¤ì œë¡œë„ Ubuntu ê¸°ë°˜ì˜ EC2ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /etc/netplan/50-cloud-init.yaml 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # This file is generated from information provided by the datasource.  Changes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # to it will not persist across an instance reboot.  To disable cloud-init&#39;s</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # network configuration capabilities, write a file</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # network: {config: disabled}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># network:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ethernets:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         ens5:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             dhcp4: true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             dhcp6: false</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             match:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                 macaddress: 02:b1:11:ba:7c:e9</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             set-name: ens5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     version: 2</span>
</span></span></code></pre></div><h3 id="b-ê·¸ë˜ì„œ-xdpëŠ”-ì–´ë””ì—-ìˆë‚˜ìš”">b. ê·¸ë˜ì„œ XDPëŠ” ì–´ë””ì— ìˆë‚˜ìš”?</h3>
<p>ì´ ê¸€ì—ì„œ ì¼ë‹¨ helmìœ¼ë¡œ hubble UIê¹Œì§€ ëœ¨ëŠ” ê²ƒì„ ë´¤ìœ¼ë‹ˆ, ì–¸ì  ê°€&hellip; ì´ì–´ì„œ ì¨ë³´ê³  ì‹¶ë„¤ìš”.</p>
<h2 id="reference">Reference</h2>
<p>ì¤‘ê°„ì— ì–¸ê¸‰ëœ Docs ì™¸ì— ì°¸ê³ í•œ ìœ ìš©í•œ ë§í¬ì…ë‹ˆë‹¤.</p>
<ul>
<li><a href="https://nuguni.tistory.com/96">Bonding ì¸í„°í˜ì´ìŠ¤ì—ì„œ Cilium XDP í™œì„±í™” í•˜ê¸°/ìŒí•˜í•˜</a></li>
<li><a href="https://sigridjin.medium.com/ebpf-and-cillum-cni-1c3ad2a1e4e9">eBPF and Cillum CNI/Sigrid Jin@Medium</a></li>
</ul>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <div class="card w-full bg-base-100 shadow-xl">
  <div class="card-body" id="adbody">
      <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1254864146899485"
          crossorigin="anonymous"></script>
      
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1254864146899485"
          data-ad-slot="3556422150" data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </div>
  
  <script>
      let adsection = document.getElementsByClassName("adsbygoogle")[0];
      let adfallback = document.getElementById("adfallback");
      adfallback.style.display = "none";
      if (window.getComputedStyle(adsection).display == "none") {
          document.getElementById("adbody").style.display = "none";
          adfallback.style.display = "block";
      } 
  </script>
</div>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho7969@ubuntu.com">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/kans-8w-why-ebpf/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">Why eBPF?</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/kans-9w-monitoring-codedns-in-eks-with-amg/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">Monitoring CoreDNS in EKS with Grafana Cloud</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho7969@ubuntu.com">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
      <p>
        Â© 2024 kkumtree and contributors All rights reserved.<br>
        Licensed under <br>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
          CC BY-NC-ND 4.0
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg">
        </a>
      </p>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
