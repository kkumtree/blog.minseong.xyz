<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 5ì£¼ì°¨ - Autoscaling | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 5ì£¼ì°¨ - Autoscaling" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week5/cover.jpg' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week5/cover.jpg' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week5/cover.jpg' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.05bc9a89b9988ba7449154a7ccd83133b7df79fac13cc1945cffac151ac54dbb.css">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCJ1CESNKD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCJ1CESNKD');
</script><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/%20/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>

      <ul class="p-navigation__items">
        
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header><div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.jpg'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 5ì£¼ì°¨ - Autoscaling</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-05-22T19:23:37&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/autoscaling" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">autoscaling</span>
              </div>
            </a>
            
            <a href="/tags/karpenter" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">karpenter</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>ì´ë²ˆ ì£¼ì°¨ëŠ” ì˜¤í† ìŠ¤ì¼€ì¼ë§ì„ ë©”ì¸ìœ¼ë¡œ í•˜ì—¬, ìˆ˜í‰/ìˆ˜ì§ í”„ë¡œë¹„ì €ë‹ì„ í•™ìŠµí•´ë³´ì•˜ìŠµë‹ˆë‹¤.<br>
ë§ˆì§€ë§‰ì—ëŠ” ê³ ì„±ëŠ¥ ì˜¤í† ìŠ¤ì¼€ì¼ëŸ¬ì¸ Karpenterë¥¼ ë³„ë„ë¡œ ì‹¤ìŠµí•´ë³´ì•˜ìŠµë‹ˆë‹¤.
íŠ¹íˆ..</p>
<ul>
<li>
<p>HPA custom metrics(ì‚¬ìš©ì ì •ì˜ ë©”íŠ¸ë¦­) ì ìš©</p>
</li>
<li>
<p>YAML ì„¤ì •ê°’ì„ CPUë¡œ ë§ì¶˜ ê²ƒì„ ìŠê³ , í”„ë¡œë¹„ì €ë‹ì„ ì˜ëª» ì˜ˆì¸¡í•œ ê²ƒë„ í•¨ê»˜ ê³µìœ í•©ë‹ˆë‹¤.</p>
</li>
<li>
<p>AutoScaling</p>
<ul>
<li>HPA: Horizontal Pod Autoscaler</li>
<li>VPA: Vertical Pod Autoscaler</li>
<li>CA: Cluster Autoscaler
<ul>
<li>ê° CSP ì˜ì¡´ì , ì›Œì»¤ ë…¸ë“œ ë ˆë²¨ì—ì„œì˜ ì˜¤í† ìŠ¤ì¼€ì¼ë§</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-ì‹¤ìŠµ-í™˜ê²½-ë°°í¬">1. ì‹¤ìŠµ í™˜ê²½ ë°°í¬</h2>
<ul>
<li>4ì£¼ì°¨ì˜ ì´ˆê¸° ë°°í¬ ë‚´ìš©ì— p8s ë° Grafanaë¥¼ ì¶”ê°€í•˜ì—¬ ë°°í¬
<ul>
<li><strong>verticalPodAutoscaler í™œì„±í™”</strong></li>
<li>ì¶”ì²œ ëŒ€ì‹œë³´ë“œ: 15757, 17900, 15172</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick4.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´í•˜ ì¤‘ëµ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Prometheus &amp; Grafana ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸ì¦ì„œ ARN</span>
</span></span><span style="display:flex;"><span>CERT_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>aws acm list-certificates --query <span style="color:#e6db74">&#39;CertificateSummaryList[].CertificateArn[]&#39;</span> --output text<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>echo $CERT_ARN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„± ë° ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; monitor-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  prometheusSpec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    podMonitorSelectorNilUsesHelmValues: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    serviceMonitorSelectorNilUsesHelmValues: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    retention: 5d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    retentionSize: &#34;10GiB&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  verticalPodAutoscaler:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - prometheus.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    paths: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">grafana:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  defaultDashboardsTimezone: Asia/Seoul
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  adminPassword: prom-operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingress:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ingressClassName: alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    hosts: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - grafana.$MyDomain
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    paths: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - /*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/scheme: internet-facing
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/target-type: ip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/listen-ports: &#39;[{&#34;HTTPS&#34;:443}, {&#34;HTTP&#34;:80}]&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/success-codes: 200-399
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/group.name: study
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      alb.ingress.kubernetes.io/ssl-redirect: &#39;443&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">defaultRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  create: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeControllerManager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeEtcd:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubeScheduler:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alertmanager:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create ns monitoring
</span></span><span style="display:flex;"><span>helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 45.27.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set prometheus.prometheusSpec.scrapeInterval<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;15s&#39;</span> --set prometheus.prometheusSpec.evaluationInterval<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;15s&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f monitor-values.yaml --namespace monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># metrics-server ë°°í¬</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span></code></pre></div><h3 id="1-1-eks-node-viewer-ì„¤ì¹˜">1-1. EKS Node Viewer ì„¤ì¹˜</h3>
<ul>
<li>íŒŒë“œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìš”ì²­ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” ëŒ€ì‹œë³´ë“œ
<ul>
<li>í•´ë‹¹ ë…¸ë“œì— í• ë‹¹ ê°€ëŠ¥í•œ ìš©ëŸ‰ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ</li>
</ul>
</li>
<li>ì‹¤ì œ ì‚¬ìš©ëŸ‰ì´ ì•„ë‹ˆë¼, ìš”ì²­ëœ ë¦¬ì†ŒìŠ¤(CPU, Memory)ì— ëŒ€í•œ í‘œì‹œ</li>
<li>ì‹¤ìŠµ ìŠ¤ì±… ìƒì—ì„œ go ì„¤ì¹˜ ë° ë·°ì–´ ì„¤ì¹˜ì‹œ ë‹¤ì†Œ ì‹œê°„ì´ ì†Œìš” (ì•½ 5ë¶„)</li>
<li>Karpenter ì‹¤ìŠµ ì‹œì—ë„ ì–¸ê¸‰ë˜ê² ì§€ë§Œ, EKSê°€ êµ¬ì¶•ëœ ë’¤ì— ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># go ë° EKS Node Viewer ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>yum install -y go
</span></span><span style="display:flex;"><span>go install github.com/awslabs/eks-node-viewer/cmd/eks-node-viewer@latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EKS Node Viewer ì‹¤í–‰</span>
</span></span><span style="display:flex;"><span>tree ~/go/bin
</span></span><span style="display:flex;"><span>cd ~/go/bin <span style="color:#f92672">&amp;&amp;</span> ./eks-node-viewer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## EKS Node Viewer ëª…ë ¹ ìƒ˜í”Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display both CPU and Memory Usage</span>
</span></span><span style="display:flex;"><span>./eks-node-viewer --resources cpu,memory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Karenter nodes only</span>
</span></span><span style="display:flex;"><span>./eks-node-viewer --node-selector <span style="color:#e6db74">&#34;karpenter.sh/provisioner-name&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display extra labels, i.e. AZ</span>
</span></span><span style="display:flex;"><span>./eks-node-viewer --extra-labels topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Specify a particular AWS profile and region</span>
</span></span><span style="display:flex;"><span>AWS_PROFILE<span style="color:#f92672">=</span>myprofile AWS_REGION<span style="color:#f92672">=</span>ap-northeast-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ê¸°ë³¸ ì˜µì…˜ í™˜ê²½ ë³€ìˆ˜</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># select only Karpenter managed nodes</span>
</span></span><span style="display:flex;"><span>node-selector<span style="color:#f92672">=</span>karpenter.sh/provisioner-name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># display both CPU and memory</span>
</span></span><span style="display:flex;"><span>resources<span style="color:#f92672">=</span>cpu,memory
</span></span></code></pre></div><p><img src="./images/eks-node-viewer.png" alt="EKS node viewer"></p>
<h2 id="2-horizontal-pod-autoscaler---hpa">2. Horizontal Pod Autoscaler - HPA</h2>
<ul>
<li>kube-ops-view ë° Grafana(17125)ì—ì„œ ëª¨ë‹ˆí„°ë§ ë³‘í–‰</li>
<li>php-apache ë°ëª¨ë¥¼ ë°°í¬í•˜ì—¬ ì§„í–‰
<ul>
<li>ë§ˆì§€ë§‰ ë¶€í•˜ ë°©ë²•ìœ¼ë¡œ í•´ë„, ì›Œì»¤ë…¸ë“œê°€ 10ê°œê¹Œì§€ ëŠ˜ì–´ë‚˜ì§€ ì•ŠìŒ<br>
HPA ì¡°ê±´ì´ CPU 50% ì´ê¸° ë•Œë¬¸ì—, 6~7ê°œì—ì„œ ìœ ì§€ë¨</li>
</ul>
</li>
</ul>
<p><img src="./images/CPU-metrics-in-described-hpa.png" alt="CPU-metrics-in-described-hpa"></p>
<p><img src="./images/target-CPU-utilization-with-neat.png" alt="target-CPU-utilization-with-neat"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># CPU: 0.2ì½”ì–´ ~ 0.5ì½”ì–´(50%, 500m) í•˜í•œ/ìƒí•œ ì¡°ê±´ ì„¤ì •</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/php-apache.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f php-apache.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pod ë°°í¬ í›„ì— í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it deploy/php-apache -- cat /var/www/html/index.php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#39;kubectl get hpa,pod;echo;kubectl top pod;echo;kubectl top node&#39;</span>
</span></span><span style="display:flex;"><span>kubectl exec -it deploy/php-apache -- top
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ íŠ¹ì • í›„ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
</span></span><span style="display:flex;"><span>PODIP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pod -l run<span style="color:#f92672">=</span>php-apache -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.podIP<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> curl -s $PODIP; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ì…‹ì—… ì„¤ì • í›„ ë¶€í•˜ ë°œìƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># HPA: requests.cpu=200m</span>
</span></span><span style="display:flex;"><span>kubectl autoscale deployment php-apache --cpu-percent<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span> --min<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>kubectl describe hpa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì…‹ì—… ì„¤ì • í™•ì¸: CPU ì‚¬ìš©ë¥  50%, Replicas ë²”ìœ„ 1~10ê°œ</span>
</span></span><span style="display:flex;"><span>kubectl krew install neat
</span></span><span style="display:flex;"><span>kubectl get hpa php-apache -o yaml | kubectl neat | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¶€í•˜ ë°œìƒ, ë‘ë²ˆì§¸ ë°©ë²•ì´ ë” ë¶€í•˜ê°€ ë§ì´ ê±¸ë¦¼</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true;<span style="color:#66d9ef">do</span> curl -s $PODIP; sleep 0.5; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>kubectl run -i --tty load-generator --rm --image<span style="color:#f92672">=</span>busybox:1.28 --restart<span style="color:#f92672">=</span>Never -- /bin/sh -c <span style="color:#e6db74">&#34;while sleep 0.01; do wget -q -O- http://php-apache; done&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°”ë¡œ ë°‘ì˜ ì‹¤ìŠµ ì´í›„ì— ê´€ë ¨ ì˜¤ë¸Œì íŠ¸ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete deploy,svc,hpa,pod --all
</span></span></code></pre></div><p><img src="./images/stress-test-for-autoscaling-with-hpa.png" alt="stress-test-for-autoscaling-with-hpa"></p>
<p><img src="./images/stress-test-ended-with-7-replicas-in-grafana.png" alt="stress-test-ended-with-7-replicas-in-grafana"></p>
<h3 id="2-1-hpa-w-multiple--custom-metrics">2-1. HPA w/ multiple &amp; custom metrics</h3>
<ul>
<li>ìœ„ì—ì„œ ì›Œì»¤ë…¸ë“œ 10ê°œê¹Œì§€ scale-up ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—,
ì¶”ê°€ë¡œ ë©”íŠ¸ë¦­ì„ ë„£ê³ , ì‚¬ìš©ì ì •ì˜ëœ ë©”íŠ¸ë¦­ìœ¼ë¡œ ë¶€í•˜ ì¡°ê±´ ì¶©ì¡±ì„ ëª©í‘œ</li>
<li>ë°”ë¡œ ìœ„ì˜ ì‹¤ìŠµì—ì„œ ì´ì–´ì„œ, ì§„í–‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ìœ„ì—ì„œ ì •ì˜ëœ HPA ì˜¤í† ìŠ¤ì¼€ì¼ë§ ìˆ˜ì • ì‘ì—…ì„ ì§„í–‰</span>
</span></span><span style="display:flex;"><span>kubectl edit horizontalpodautoscaler.autoscaling
</span></span></code></pre></div><p><img src="./images/edit-hpa-setup.png" alt="edit-hpa-setup"></p>
<ul>
<li>í¸ì§‘ê¸°ì—ì„œ ì•„ë˜ì™€ ê°™ì´ <code>metrics:</code> í•˜ìœ„ë¥¼ ìˆ˜ì • í›„,<br>
ë¶€í•˜ë¥¼ ê³„ì† ë°œìƒí•˜ë©´, CPU 50% ì´ìƒì„ ì¶©ì¡±í•˜ì§€ ì•Šì•˜ì–´ë„, ì›Œì»¤ë…¸ë“œê°€ 10ê°œê¹Œì§€ ëŠ˜ì–´ë‚¨</li>
<li>describedObject: apiVersion, kind, name ì„ ì§€ì •í•˜ì—¬,<br>
í•´ë‹¹ ì˜¤ë¸Œì íŠ¸ì˜ ë©”íŠ¸ë¦­ì„ <strong>ì‚¬ìš©ì ì •ì˜</strong>ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŒ</li>
<li>ë‹¤ë§Œ, ì‚¬ìš©ì ì •ì˜ ë©”íŠ¸ë¦­ì´ê¸° ë•Œë¬¸ì—, eks-node-viewerì—ì„œ ì œëŒ€ë¡œ ì¡°ê±´ì„ í™•ì¸í•  ìˆ˜ ì—†ìŒ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># ì „ëµ</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resource</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cpu</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Utilization</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">averageUtilization</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Pods</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pods</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">metric</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">packets-per-second</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">AverageValue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">averageValue</span>: <span style="color:#ae81ff">1k</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">object</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">metric</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">requests-per-second</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">describedObject</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main-route</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#ae81ff">10k</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í›„ëµ</span>
</span></span></code></pre></div><p><img src="./images/use-custom-metrics-by-editor.png" alt="use-custom-metrics-by-editor"></p>
<p><img src="./images/max-10-replicas-in-grafana.png" alt="max-10-replicas-in-grafana"></p>
<p><img src="./images/custom-metrics-in-described-hpa.png" alt="custom-metrics-in-described-hpa"></p>
<h2 id="3-k8s-based-event-driven-autoscaling---keda">3. k8s based Event Driven Autoscaling - KEDA</h2>
<ul>
<li>
<p>HPA, KEDA ë¹„êµ</p>
<table>
<thead>
<tr>
<th>êµ¬ë¶„</th>
<th>HPA</th>
<th>KEDA</th>
</tr>
</thead>
<tbody>
<tr>
<td>resource metrics</td>
<td>O</td>
<td>X</td>
</tr>
<tr>
<td>event driven</td>
<td>X</td>
<td>O</td>
</tr>
<tr>
<td>metrics reference</td>
<td>metrics-server</td>
<td>keda-metrics-api-server</td>
</tr>
<tr>
<td>scaling job</td>
<td>O</td>
<td><strong>X</strong></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>KEDAëŠ” HPA ëŒ€ì²´ê°€ ì•„ë‹Œ, í™•ì¥ ë³´ì¡° ë„êµ¬.</p>
</li>
<li>
<p>ì‹¤ìŠµì—ì„œëŠ” helm ì°¨íŠ¸ë¥¼ í†µí•´ ì„¤ì¹˜í•˜ê³ , Grafana ëŒ€ì‹œë³´ë“œë¥¼ í†µí•´ì„œ í™•ì¸</p>
<ul>
<li>ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œì˜ ê²½ìš°, í…œí”Œë¦¿ìœ¼ë¡œ ê²€ìƒ‰ë˜ëŠ” ê²ƒì€ ì—ëŸ¬ê°€ ë‚˜ì„œ, <a href="https://raw.githubusercontent.com/kedacore/keda/main/config/grafana/keda-dashboard.json">JSON</a>ì„ ì‚¬ìš©</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># KEDA ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; keda-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsServer:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  useHostNetwork: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">prometheus:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  metricServer:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port: 9022
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    portName: metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    path: /metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    serviceMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Enables ServiceMonitor creation for the Prometheus Operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    podMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Enables PodMonitor creation for the Prometheus Operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  operator:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port: 8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    serviceMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Enables ServiceMonitor creation for the Prometheus Operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    podMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Enables PodMonitor creation for the Prometheus Operator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  webhooks:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    port: 8080
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    serviceMonitor:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Enables ServiceMonitor creation for the Prometheus webhooks
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create namespace keda
</span></span><span style="display:flex;"><span>helm repo add kedacore https://kedacore.github.io/charts
</span></span><span style="display:flex;"><span>helm install keda kedacore/keda --version 2.10.2 --namespace keda -f keda-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KEDA ì„¤ì¹˜ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get-all -n keda
</span></span><span style="display:flex;"><span>kubectl get all -n keda
</span></span><span style="display:flex;"><span>kubectl get crd | grep keda
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keda ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl apply -f php-apache.yaml -n keda
</span></span><span style="display:flex;"><span>kubectl get pod -n keda
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ScaledObject ì •ì±… ìƒì„± : cron</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; keda-cron.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: keda.sh/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ScaledObject
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: php-apache-cron-scaled
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  minReplicaCount: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  maxReplicaCount: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  pollingInterval: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cooldownPeriod: 300
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  scaleTargetRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: php-apache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  triggers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - type: cron
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      timezone: Asia/Seoul
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      start: 00,15,30,45 * * * *
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      end: 05,20,35,50 * * * *
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      desiredReplicas: &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f keda-cron.yaml -n keda
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ ì¶”ê°€ í›„ ì•„ë˜ ì§„í–‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ë¼íŒŒë‚˜ í…œí”Œë¦¿ìœ¼ë¡œëŠ” ì—ëŸ¬ê°€ ë‚˜ì„œ, JSONì„ ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>watch -d <span style="color:#e6db74">&#39;kubectl get ScaledObject,hpa,pod -n keda&#39;</span>
</span></span><span style="display:flex;"><span>kubectl get ScaledObject -w
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;scaledobject.keda.sh/name&#34;: &#34;php-apache-cron-scaled&#34; ë¼ë²¨ ëŒ€ìƒ ì´ë²¤íŠ¸ ìˆ˜ì§‘</span>
</span></span><span style="display:flex;"><span>kubectl get ScaledObject,hpa,pod -n keda
</span></span><span style="display:flex;"><span>kubectl get hpa -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.spec<span style="color:#f92672">}</span> -n keda | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># KEDA ë° deployment ë“± ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f keda-cron.yaml -n keda <span style="color:#f92672">&amp;&amp;</span> kubectl delete deploy php-apache -n keda <span style="color:#f92672">&amp;&amp;</span> helm uninstall keda -n keda
</span></span><span style="display:flex;"><span>kubectl delete namespace keda
</span></span></code></pre></div><p><img src="./images/labals-for-receiving-events.png" alt="labals-for-receiving-events"></p>
<p><img src="./images/keda-status-in-grafana.png" alt="keda-status-in-grafana"></p>
<h2 id="4-vertical-pod-autoscaler---vpa">4. Vertical Pod Autoscaler - VPA</h2>
<ul>
<li>ìˆ˜ì§ ìŠ¤ì¼€ì¼ë§: íŒŒë“œì˜ CPU, ë©”ëª¨ë¦¬ ìµœì í™”ë¥¼ í†µí•œ ë…¸ë“œ ìì› íš¨ìœ¨í™”</li>
<li>ê·¸ëŒ€ë¡œ ë°°í¬í•˜ë©´ OpenSSL CA ì—ëŸ¬ê°€ ë°œìƒ.<br>
OpenSSLì„ 1.1.1 ì´ìƒìœ¼ë¡œ ë²„ì „ ì—…ë°ì´íŠ¸ ì§„í–‰</li>
<li>Grafana ëŒ€ì‹œë³´ë“œì˜ ê²½ìš°, í…œí”Œë¦¿(<del>14588, 16294</del>)ì—ì„œ ì—ëŸ¬ ë°œìƒ</li>
<li>ë‹¨ì : AWS ê¸°ì¤€, í•˜ë‚˜ì˜ ìì›ì— ëŒ€í•´ ASGì™€ EKSì—ì„œ ê°ê°ì˜ ë°©ì‹ìœ¼ë¡œ ê´€ë¦¬
-&gt; ê´€ë¦¬ì •ë³´ê°€ ë™ê¸°í™”ë˜ì§€ ì•Šê³ , ìŠ¤ì¼€ì¼ë§ ì†ë„ê°€ ëŠë¦¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì½”ë“œ ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/kubernetes/autoscaler.git
</span></span><span style="display:flex;"><span>cd ~/autoscaler/vertical-pod-autoscaler/
</span></span><span style="display:flex;"><span>tree hack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># openssl ë²„ì „ í™•ì¸</span>
</span></span><span style="display:flex;"><span>openssl version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># openssl 1.1.1 ì´ìƒ ë²„ì „ í™•ì¸</span>
</span></span><span style="display:flex;"><span>yum install openssl11 -y
</span></span><span style="display:flex;"><span>openssl11 version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìŠ¤í¬ë¦½íŠ¸íŒŒì¼ë‚´ì— openssl11 ìˆ˜ì •</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/openssl/openssl11/g&#39;</span> ~/autoscaler/vertical-pod-autoscaler/pkg/admission-controller/gencerts.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VPA ë°°í¬</span>
</span></span><span style="display:flex;"><span>watch -d kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>cat hack/vpa-up.sh
</span></span><span style="display:flex;"><span>./hack/vpa-up.sh
</span></span><span style="display:flex;"><span>kubectl get crd | grep autoscaling
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ì˜ˆì œ </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## pod ì‹¤í–‰ ìˆ˜ ë¶„ ë’¤ì— pod resource.requestê°€ VPAì— ì˜í•´ ìˆ˜ì •</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>watch -d kubectl top pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê³µì‹ ì˜ˆì œ ë°°í¬</span>
</span></span><span style="display:flex;"><span>cd ~/autoscaler/vertical-pod-autoscaler/
</span></span><span style="display:flex;"><span>cat examples/hamster.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f examples/hamster.yaml <span style="color:#f92672">&amp;&amp;</span> kubectl get vpa -w
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ë¦¬ì†ŒìŠ¤ Requests í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl describe pod | grep Requests: -A2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VPAì— ì˜í•´ ê¸°ì¡´ íŒŒë“œ ì‚­ì œë˜ê³  ì‹ ê·œ íŒŒë“œê°€ ìƒì„±ë¨</span>
</span></span><span style="display:flex;"><span>kubectl get events --sort-by<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.metadata.creationTimestamp&#34;</span> | grep VPA
</span></span></code></pre></div><p><img src="./images/vpa-setup.png" alt="VPA-setup"></p>
<p><img src="./images/check-CPU-100m-requests-from-initial-pods.png" alt="check-CPU-100m-requests-from-initial-pods"></p>
<p><img src="./images/initial-pod-will-be-changed-by-new-pod.png" alt="initial-pod-will-be-changed-by-new-pod"></p>
<p><img src="./images/new-pod-with-more-requested-CPU-resource-by-VPA.png" alt="new-pod-with-more-requested-CPU-resource-by-VPA"></p>
<p><img src="./images/new-pods-creation-events-by-cli.png" alt="new-pods-creation-events-by-cli"></p>
<h2 id="5-cluster-autoscaler---ca">5. Cluster Autoscaler - CA</h2>
<ul>
<li>AWS CSPë¡œ ì‹¤ìŠµì„ ì§„í–‰í•˜ë¯€ë¡œ, CAë„ ì ìš©í•´ë³¼ ìˆ˜ ìˆìŒ
<ul>
<li>cluster-autoscaler íŒŒë“œë¥¼ ë°°í¬í•˜ì—¬ CA ë™ì‘ ê°€ëŠ¥</li>
<li>AWSì˜ ê²½ìš° ASGë¥¼ ì‚¬ìš©í•˜ì—¬ CA ì ìš©</li>
</ul>
</li>
<li>EKSì—ì„œ ê¸° ì ìš©ëœ íƒœê·¸ í™•ì¸
<ul>
<li>k8s.io/cluster-autoscaler/enabled : &rsquo;true'</li>
<li>k8s.io/cluster-autoscaler/myeks : owned</li>
</ul>
</li>
<li>CA ë™ì‘: ì£¼ê¸°ì ìœ¼ë¡œ ì‚¬ìš©ë¥ ì„ í™•ì¸í•˜ì—¬, ìŠ¤ì¼€ì¼ ì¸/ì•„ì›ƒì„ ìˆ˜í–‰</li>
</ul>
<p><img src="./images/check-tagged-already-in-EKS.png" alt="check-tagged-already-in-EKS"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># EKS ë…¸ë“œì—ì„œ íƒœê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-instances  --filters Name<span style="color:#f92672">=</span>tag:Name,Values<span style="color:#f92672">=</span>$CLUSTER_NAME-ng1-Node --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].Tags[*]&#34;</span> --output yaml | yh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í˜„ì¬ ASG í™•ì¸: 3 / 3 / 3</span>
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Maxsize ìˆ˜ì •: 3 -&gt; 6</span>
</span></span><span style="display:flex;"><span>export ASG_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].AutoScalingGroupName&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>aws autoscaling update-auto-scaling-group --auto-scaling-group-name <span style="color:#e6db74">${</span>ASG_NAME<span style="color:#e6db74">}</span> --min-size <span style="color:#ae81ff">3</span> --desired-capacity <span style="color:#ae81ff">3</span> --max-size <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë³€ê²½ëœ ASG í™•ì¸: 3 / 6 / 3</span>
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CA ë°°í¬</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/&lt;YOUR CLUSTER NAME&gt;/</span>$CLUSTER_NAME<span style="color:#e6db74">/g&#34;</span> cluster-autoscaler-autodiscover.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f cluster-autoscaler-autodiscover.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system | grep cluster-autoscaler
</span></span><span style="display:flex;"><span>kubectl describe deployments.apps -n kube-system cluster-autoscaler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) cluster-autoscaler íŒŒë“œê°€ ë™ì‘í•˜ëŠ” ì›Œì»¤ ë…¸ë“œê°€ í‡´ì¶œ(evict) ë˜ì§€ ì•Šê²Œ ì„¤ì •</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´ë²ˆ ì‹¤ìŠµì— ì ìš©í•˜ì§€ ì•ŠìŒ </span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system annotate deployment.apps/cluster-autoscaler cluster-autoscaler.kubernetes.io/safe-to-evict<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;false&#34;</span>
</span></span></code></pre></div><p><img src="./images/asg-maxsize-before-edit.png" alt="asg-maxsize-before-edit"></p>
<p><img src="./images/asg-maxsize-after-edit.png" alt="asg-maxsize-after-edit"></p>
<h3 id="5-1-ca-í…ŒìŠ¤íŠ¸">5-1. CA í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>nginx íŒŒë“œ ë°°í¬ í›„ ë ˆí”Œë¦¬ì¹´ì…‹ scale out í•˜ì—¬ í™•ì¸: 1 -&gt; 15
<ul>
<li>ì´í›„ ë…¸ë“œë„ ìë™ ì¦ê°€í•¨ì„ í™•ì¸</li>
</ul>
</li>
<li>ë‹¤ì‹œ, í•´ë‹¹ íŒŒë“œë¥¼ ì‚­ì œí•˜ë©´, scale down ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>kubectl get nodes -w
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> kubectl get node; echo <span style="color:#e6db74">&#34;------------------------------&#34;</span> ; date ; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> aws ec2 describe-instances --query <span style="color:#e6db74">&#34;Reservations[*].Instances[*].{PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#39;Name&#39;]|[0].Value,Status:State.Name}&#34;</span> --filters Name<span style="color:#f92672">=</span>instance-state-name,Values<span style="color:#f92672">=</span>running --output text ; echo <span style="color:#e6db74">&#34;------------------------------&#34;</span>; date; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx íŒŒë“œ ë°°í¬: ë ˆí”Œë¦¬ì¹´ì…‹ 1</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EoF&gt; nginx.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: nginx-to-scaleout
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        service: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - image: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: nginx-to-scaleout
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cpu: 500m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cpu: 500m
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            memory: 512Mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EoF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f nginx.yaml
</span></span><span style="display:flex;"><span>kubectl get deployment/nginx-to-scaleout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë ˆí”Œë¦¬ì¹´ì…‹ 15ë¡œ scale out</span>
</span></span><span style="display:flex;"><span>kubectl scale --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span> deployment/nginx-to-scaleout <span style="color:#f92672">&amp;&amp;</span> date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pods -l app<span style="color:#f92672">=</span>nginx -o wide --watch
</span></span><span style="display:flex;"><span>kubectl -n kube-system logs -f deployment/cluster-autoscaler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ìë™ ì¦ê°€ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì•ì„œ ì„¤ì¹˜í–ˆë˜ eks-node-viewerë¡œë„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./eks-node-viewer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬ ì‚­ì œ ë° (10ì—¬ë¶„ ì´í›„) ë…¸ë“œ ê°¯ìˆ˜ ì¶•ì†Œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl delete -f nginx.yaml <span style="color:#f92672">&amp;&amp;</span> date
</span></span><span style="display:flex;"><span>watch -d kubectl get node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) ì•„ë˜ flagë¥¼ í†µí•´, scale down ì‹œê°„ì„ ì¡°ì • ê°€ëŠ¥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì˜ˆì‹œ: --scale-down-delay-after-add=5m</span>
</span></span></code></pre></div><p><img src="./images/replicaset-scaled-out-to-15.png" alt="replicaset-scaled-out-to-15"></p>
<p><img src="./images/node-increased-automatically.png" alt="node-increased-automatically"></p>
<p><img src="./images/new-nodes-created-for-replicaset.png" alt="new-nodes-created-for-replicaset"></p>
<p><img src="./images/scale-down-automatically.png" alt="scale-down-automatically"></p>
<p><img src="./images/scale-down-in-kubeopsview-1.png" alt="scale-down-in-kubeopsview-1"></p>
<p><img src="./images/scale-down-in-kubeopsview-2.png" alt="scale-down-in-kubeopsview-2"></p>
<ul>
<li>ë¦¬ì†ŒìŠ¤ ì‚­ì œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete -f nginx.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ASG ì„¤ì • ì›ë³µ: 3 / 3 / 3</span>
</span></span><span style="display:flex;"><span>aws autoscaling update-auto-scaling-group --auto-scaling-group-name <span style="color:#e6db74">${</span>ASG_NAME<span style="color:#e6db74">}</span> --min-size <span style="color:#ae81ff">3</span> --desired-capacity <span style="color:#ae81ff">3</span> --max-size <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cluster Autoscaler ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f cluster-autoscaler-autodiscover.yaml
</span></span></code></pre></div><p><img src="./images/reset-asg-after-ca-test.png" alt="reset-asg-after-ca-test"></p>
<h2 id="6-cluster-propotional-autoscaler---cpa">6. Cluster Propotional Autoscaler - CPA</h2>
<ul>
<li>5ì™€ ê°™ì´ ë…¸ë“œ ìˆ˜ ì¦ê°€ì— ë¹„ë¡€í•˜ì—¬ ì„±ëŠ¥ ì²˜ë¦¬ê°€ í•„ìš”í•œ app(ì»¨í…Œì´ë„ˆ/íŒŒë“œ)ë¥¼ ìˆ˜í‰ìœ¼ë¡œ ìë™í™•ì¥
<ul>
<li>ì‹¤ìŠµì˜ ê²½ìš°, nginx ì‚¬ìš©</li>
</ul>
</li>
<li>CPAëŠ” CPA ruleì„ ë¨¼ì € ì„¤ì •í•´ì•¼ í•¨</li>
</ul>
<p><img src="./images/error-before-cpa-rule-creation.png" alt="error-before-cpa-rule-creation"></p>
<p><img src="./images/set-cpa-rule.png" alt="set-cpa-rule"></p>
<p><img src="./images/error-before-cpa-rule-creation.png" alt="error-before-cpa-rule-creation"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># helm ì°¨íŠ¸ë¥¼ í†µí•œ ë¦´ë¦¬ì¦ˆ ì‹œë„ -&gt; ì‹¤íŒ¨í•´ì•¼ ì •ìƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì´ìœ ) CPA ruleì„ ì„¤ì •í•˜ê³  helmì°¨íŠ¸ë¥¼ ë¦´ë¦¬ì¦ˆ í•„ìš”</span>
</span></span><span style="display:flex;"><span>helm repo add cluster-proportional-autoscaler https://kubernetes-sigs.github.io/cluster-proportional-autoscaler
</span></span><span style="display:flex;"><span>helm upgrade --install cluster-proportional-autoscaler cluster-proportional-autoscaler/cluster-proportional-autoscaler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¨¼ì € nginx ë°°í¬</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; cpa-nginx.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: nginx-deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image: nginx:latest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cpu: &#34;100m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            memory: &#34;64Mi&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cpu: &#34;100m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            memory: &#34;64Mi&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ports:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - containerPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f cpa-nginx.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CPA rule ì„¤ì •</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># config.ladder.nodesToReplicas: [ë…¸ë“œìˆ˜, ë ˆí”Œë¦¬ì¹´ìˆ˜] ì—ì„œ ê·œì¹™ í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; cpa-values.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ladder:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    nodesToReplicas:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - [1, 1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - [2, 2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - [3, 3]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - [4, 3]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - [5, 5]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">options:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  target: &#34;deployment/nginx-deployment&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span>watch -d kubectl get pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm ì—…ê·¸ë ˆì´ë“œ -&gt; ì„±ê³µ</span>
</span></span><span style="display:flex;"><span>helm upgrade --install cluster-proportional-autoscaler -f cpa-values.yaml cluster-proportional-autoscaler/cluster-proportional-autoscaler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ 5ê°œë¡œ ì¦ê°€: ruleì— ë”°ë¼ nginx ë ˆí”Œë¦¬ì¹´ì…‹ 5ê°œ ë°°í¬</span>
</span></span><span style="display:flex;"><span>export ASG_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].AutoScalingGroupName&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>aws autoscaling update-auto-scaling-group --auto-scaling-group-name <span style="color:#e6db74">${</span>ASG_NAME<span style="color:#e6db74">}</span> --min-size <span style="color:#ae81ff">5</span> --desired-capacity <span style="color:#ae81ff">5</span> --max-size <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ 4ê°œë¡œ ì¶•ì†Œ: ruleì— ë”°ë¼ nginx ë ˆí”Œë¦¬ì¹´ì…‹ 3ê°œ ë°°í¬</span>
</span></span><span style="display:flex;"><span>aws autoscaling update-auto-scaling-group --auto-scaling-group-name <span style="color:#e6db74">${</span>ASG_NAME<span style="color:#e6db74">}</span> --min-size <span style="color:#ae81ff">4</span> --desired-capacity <span style="color:#ae81ff">4</span> --max-size <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>aws autoscaling describe-auto-scaling-groups --query <span style="color:#e6db74">&#34;AutoScalingGroups[? Tags[? (Key==&#39;eks:cluster-name&#39;) &amp;&amp; Value==&#39;myeks&#39;]].[AutoScalingGroupName, MinSize, MaxSize,DesiredCapacity]&#34;</span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>helm uninstall cluster-proportional-autoscaler <span style="color:#f92672">&amp;&amp;</span> kubectl delete -f cpa-nginx.yaml
</span></span></code></pre></div><p><img src="./images/start-to-increase-replicaset-for-increasing-nodes.png" alt="start-to-increase-replicaset-for-increasing-nodes"></p>
<p><img src="./images/increase-nodes-and-replicaset-in-kubeopsview.png" alt="increase-nodes-and-replicaset-in-kubeopsview"></p>
<p><img src="./images/terminating-and-initializing-replicasets-when-nodes-decrease.png" alt="terminating-and-initializing-replicasets-when-nodes-decrease"></p>
<p><img src="./images/decreasing-in-kubeopsview.png" alt="decreasing-in-kubeopsview"></p>
<h2 id="7-karpenter-k8s-native-autoscaler">7. Karpenter: k8s Native AutoScaler</h2>
<ul>
<li>ë‹¨ì‹œê°„(nì´ˆ)ë§Œì— ì»´í“¨íŒ… ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë…¸ë“œ ìˆ˜ëª… ì£¼ê¸° ê´€ë¦¬ ì†”ë£¨ì…˜
<ul>
<li>ìŠ¤ì¼€ì¤„ëŸ¬ê°€ unschedulableë¡œ íƒœê¹…í•œ podsë¥¼ í¬ì°©í•˜ì—¬ JIT(Just-In-Time)ìœ¼ë¡œ ë…¸ë“œë¥¼ ìƒì„±</li>
<li>ë°˜ëŒ€ë¡œ ë…¸ë“œê°€ í•„ìš”ì—†ì–´ì§€ë©´, ì‚­ì œ</li>
<li>CAì™€ ASGë¥¼ ë‘˜ë‹¤ ê±°ì³ì•¼í•˜ëŠ” ë°©ì‹ì— ë¹„í•´, ë” ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ ë¦¬ì†ŒìŠ¤ ì œê³µ ê°€ëŠ¥</li>
</ul>
</li>
<li>ë‹¤ë¥¸ ë…¸ë“œ ê·¸ë£¹ì—ì„œ ì§„í–‰í•˜ë¯€ë¡œ ì•ì„œ ì§„í–‰í–ˆë˜ ëª¨ë“  EKS ì‹¤ìŠµí™˜ê²½ì„ ì‚­ì œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall -n kube-system kube-ops-view
</span></span><span style="display:flex;"><span>helm uninstall -n monitoring kube-prometheus-stack
</span></span><span style="display:flex;"><span>eksctl delete cluster --name $CLUSTER_NAME <span style="color:#f92672">&amp;&amp;</span> aws cloudformation delete-stack --stack-name $CLUSTER_NAME
</span></span></code></pre></div><ul>
<li>ìƒˆë¡œìš´ í™˜ê²½ìœ¼ë¡œ ì¬ë°°í¬: ë§¨ ì²˜ìŒì— í–ˆë˜ ì‹¤ìŠµí™˜ê²½ ë°°í¬ì™€ ë™ì¼(cloudformation)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/karpenter-preconfig.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´í•˜ ìƒëµ</span>
</span></span></code></pre></div><ul>
<li>ë°°í¬ ì™„ë£Œ í›„ ì ‘ì†í•œ ë’¤, í™•ì¸ ìš”ì†Œ
<ul>
<li>IP ì£¼ì†Œ í™•ì¸: 172.30.0.0/16 VPC ëŒ€ì—­ì—ì„œ 172.30.1.0/24 ëŒ€ì—­ì„ ì‚¬ìš©</li>
<li>eks-node-viewer ì¬ì„¤ì¹˜</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># IP ì£¼ì†Œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>ip -br -c addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eks-node-viewer ì¬ì„¤ì¹˜ </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EKS ë°°í¬ í›„ì— ì‹¤í–‰í•˜ì—¬ ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>go install github.com/awslabs/eks-node-viewer/cmd/eks-node-viewer@latest
</span></span></code></pre></div><p><img src="./images/check-ip-address-range-with-VPC.png" alt="check-ip-address-range-with-VPC"></p>
<ul>
<li>EKS ë°°í¬ ë° Karpenter í”„ë¡œë¹„ì €ë„ˆ ì„¤ì¹˜
<ul>
<li>í´ëŸ¬ìŠ¤í„° ìƒì„± ì‹œ, 20ì—¬ë¶„ ì†Œìš” (ì°¨ í•œì” í˜¹ì€ ì±…ì„ ì½ë„ë¡ í•˜ì)</li>
<li>helmì„ í†µí•œ Karpenter ì„¤ì¹˜ ì‹œ, í™˜ê²½ë³€ìˆ˜ ì¤‘ í•˜ë‚˜ë¼ë„ í™•ì¸ ì•ˆë˜ë©´ ì„¤ì¹˜ ì˜¤ë¥˜ê°€ ë°œìƒ</li>
<li>íƒ€ê²Ÿ ì§€ì •ì„ ìœ„í•œ, Provisioner ìƒì„±
<ul>
<li>ê´€ë¦¬ ëŒ€ìƒ ì§€ì •: securityGroupSelector, subnetSelectorë¥¼ ì‚¬ìš©, $CLUSTER_NAME ëŒ€ìƒ</li>
<li>30ì´ˆ ì´í›„ ë¯¸ì‚¬ìš© ë…¸ë“œ ì‚­ì œ: ë°ëª¬ì…‹ ì œì™¸, ì´ ê°’ì„ ì—†ì• ë©´, ì‚¬ìš©ë¥ ì´ ë‚®ì•„ë„ ë…¸ë“œê°€ ì¶•ì†Œë˜ì§€ ì•ŠìŒ!
<ul>
<li><code>ttlSecondsAfterEmpty: 30</code> (ì°¸ì¡°: <a href="https://aws.amazon.com/ko/blogs/korea/introducing-karpenter-an-open-source-high-performance-kubernetes-cluster-autoscaler/">AWS Blog</a>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./images/lots-of-time-for-reading-books-with-cloudformation.png" alt="lots-of-time-for-reading-books-with-cloudformation"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># í™˜ê²½ë³€ìˆ˜ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>export | egrep <span style="color:#e6db74">&#39;ACCOUNT|AWS_|CLUSTER&#39;</span> | egrep -v <span style="color:#e6db74">&#39;SECRET|KEY&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™˜ê²½ë³€ìˆ˜ ì„¤ì •</span>
</span></span><span style="display:flex;"><span>export KARPENTER_VERSION<span style="color:#f92672">=</span>v0.27.5
</span></span><span style="display:flex;"><span>export TEMPOUT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $KARPENTER_VERSION $CLUSTER_NAME $AWS_DEFAULT_REGION $AWS_ACCOUNT_ID $TEMPOUT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CloudFormationìœ¼ë¡œ IAM Policy, Role, EC2 Instance Profile ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -fsSL https://karpenter.sh/<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>KARPENTER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/getting-started/getting-started-with-karpenter/cloudformation.yaml  &gt; $TEMPOUT <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#f92672">&amp;&amp;</span> aws cloudformation deploy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --stack-name <span style="color:#e6db74">&#34;Karpenter-</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --template-file <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TEMPOUT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --capabilities CAPABILITY_NAMED_IAM <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --parameter-overrides <span style="color:#e6db74">&#34;ClusterName=</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í´ëŸ¬ìŠ¤í„° ìƒì„± : myeks2 EKS í´ëŸ¬ìŠ¤í„° ìƒì„±</span>
</span></span><span style="display:flex;"><span>eksctl create cluster -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: eksctl.io/v1alpha5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterConfig
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${CLUSTER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  region: ${AWS_DEFAULT_REGION}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  version: &#34;1.24&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tags:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    karpenter.sh/discovery: ${CLUSTER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">iam:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  withOIDC: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  serviceAccounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace: karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    roleName: ${CLUSTER_NAME}-karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    attachPolicyARNs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - arn:aws:iam::${AWS_ACCOUNT_ID}:policy/KarpenterControllerPolicy-${CLUSTER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    roleOnly: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">iamIdentityMappings:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- arn: &#34;arn:aws:iam::${AWS_ACCOUNT_ID}:role/KarpenterNodeRole-${CLUSTER_NAME}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  username: system:node:{{EC2PrivateDNSName}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  groups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - system:bootstrappers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - system:nodes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">managedNodeGroups:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- instanceType: m5.large
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  amiFamily: AmazonLinux2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ${CLUSTER_NAME}-ng
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  desiredCapacity: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  minSize: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  maxSize: 10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  iam:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    withAddonPolicies:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      externalDNS: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Optionally run on fargate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># fargateProfiles:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># - name: karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#  selectors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#  - namespace: karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EKS ë°°í¬ í™•ì¸</span>
</span></span><span style="display:flex;"><span>eksctl get cluster
</span></span><span style="display:flex;"><span>eksctl get nodegroup --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>eksctl get addon --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„: eks-node-viewer</span>
</span></span><span style="display:flex;"><span>cd ~/go/bin <span style="color:#f92672">&amp;&amp;</span> ./eks-node-viewer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aws-authì—ì„œ ê¶Œí•œ ë§¤í•‘ì„ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl cluster-info
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -owide
</span></span><span style="display:flex;"><span>kubectl describe cm -n kube-system aws-auth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¹´íœí„° ì„¤ì¹˜ë¥¼ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° í™•ì¸</span>
</span></span><span style="display:flex;"><span>export CLUSTER_ENDPOINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>aws eks describe-cluster --name <span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> --query <span style="color:#e6db74">&#34;cluster.endpoint&#34;</span> --output text<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>export KARPENTER_IAM_ROLE_ARN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arn:aws:iam::</span><span style="color:#e6db74">${</span>AWS_ACCOUNT_ID<span style="color:#e6db74">}</span><span style="color:#e6db74">:role/</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">-karpenter&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EC2 Spot Fleet ì‚¬ìš©ì„ ìœ„í•œ service-linked-role ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì œëŒ€ë¡œ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•˜ëŠ” ê±°ë¼ ì•„ë˜ ì—ëŸ¬ ì¶œë ¥ì´ ì •ìƒ!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># An error occurred (InvalidInput) when calling the CreateServiceLinkedRole operation: Service role name AWSServiceRoleForEC2Spot has been taken in this account, please try a different suffix.</span>
</span></span><span style="display:flex;"><span>aws iam create-service-linked-role --aws-service-name spot.amazonaws.com <span style="color:#f92672">||</span> true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># public ECRì—ì„œ ì¸ì¦ë˜ì§€ ì•Šì€ pull ìˆ˜í–‰ì„ ìœ„í•´, ë¯¸ë¦¬ ë¡œê·¸ì•„ì›ƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ì œ í”„ë¡œì íŠ¸ì— ì ìš©í•  ë•ŒëŠ”, ë¡œê·¸ì•„ì›ƒ ì•ˆí•œ ìƒíƒœì—ì„œ ì‹œí–‰í•´ë³´ê³  ì–´ë–¤ í˜„ìƒì´ ì¼ì–´ë‚˜ëŠ”ì§€ ë³¼ ì˜ˆì • (To-Do)</span>
</span></span><span style="display:flex;"><span>docker logout public.ecr.aws
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›í™œí•œ ì„¤ì¹˜ë¥¼ ìœ„í•œ ì¸ìê°’ í™•ì¸</span>
</span></span><span style="display:flex;"><span>echo $KARPENTER_VERSION $KARPENTER_IAM_ROLE_ARN $CLUSTER_NAME $CLUSTER_ENDPOINT 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># karpenter ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter --version <span style="color:#e6db74">${</span>KARPENTER_VERSION<span style="color:#e6db74">}</span> --namespace karpenter --create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set serviceAccount.annotations.<span style="color:#e6db74">&#34;eks\.amazonaws\.com/role-arn&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">${</span>KARPENTER_IAM_ROLE_ARN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set settings.aws.clusterName<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set settings.aws.defaultInstanceProfile<span style="color:#f92672">=</span>KarpenterNodeInstanceProfile-<span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set settings.aws.interruptionQueueName<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.resources.requests.cpu<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.resources.requests.memory<span style="color:#f92672">=</span>1Gi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.resources.limits.cpu<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.resources.limits.memory<span style="color:#f92672">=</span>1Gi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --wait
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get-all -n karpenter
</span></span><span style="display:flex;"><span>kubectl get all -n karpenter
</span></span><span style="display:flex;"><span>kubectl get cm -n karpenter karpenter-global-settings -o jsonpath<span style="color:#f92672">={</span>.data<span style="color:#f92672">}</span> | jq
</span></span><span style="display:flex;"><span>kubectl get crd | grep karpenter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í”„ë¡œë¹„ì €ë„ˆ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: karpenter.sh/v1alpha5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  requirements:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: karpenter.sh/capacity-type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      values: [&#34;spot&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cpu: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  providerRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ttlSecondsAfterEmpty: 30
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: karpenter.k8s.aws/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: AWSNodeTemplate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subnetSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    karpenter.sh/discovery: ${CLUSTER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  securityGroupSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    karpenter.sh/discovery: ${CLUSTER_NAME}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get awsnodetemplates,provisioners
</span></span></code></pre></div><p><img src="./images/check-auth-mapping-with-aws-auth.png" alt="check-auth-mapping-with-aws-auth"></p>
<p><img src="./images/karpenter-installation-with-variables.png" alt="karpenter-installation-with-variables"></p>
<p><img src="./images/check-karpenter-set-up-after-applying-provisioner.png" alt="check-karpenter-set-up-after-applying-provisioner"></p>
<ul>
<li>(ì˜µì…˜)ExternalDNS, kube-ops-view, grafana
<ul>
<li>ì‹¤ìŠµ ì‹œ, Grafanaë§Œ ì œëŒ€ë¡œ êµ¬ë™ì´ ë˜ì§€ ì•ŠìŒ (To-Do)</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>MyDomain<span style="color:#f92672">=</span>awskops.click
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export MyDomain=awskops.click&#34;</span> &gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>MyDnzHostedZoneId<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws route53 list-hosted-zones-by-name --dns-name <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MyDomain<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span> --query <span style="color:#e6db74">&#34;HostedZones[0].Id&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $MyDomain, $MyDnzHostedZoneId
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml
</span></span><span style="display:flex;"><span>MyDomain<span style="color:#f92672">=</span>$MyDomain MyDnzHostedZoneId<span style="color:#f92672">=</span>$MyDnzHostedZoneId envsubst &lt; externaldns.yaml | kubectl apply -f -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kube-ops-view</span>
</span></span><span style="display:flex;"><span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
</span></span><span style="display:flex;"><span>helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set env.TZ<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Asia/Seoul&#34;</span> --namespace kube-system
</span></span><span style="display:flex;"><span>kubectl patch svc -n kube-system kube-ops-view -p <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;LoadBalancer&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span>kubectl annotate service kube-ops-view -n kube-system <span style="color:#e6db74">&#34;external-dns.alpha.kubernetes.io/hostname=kubeopsview.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Kube Ops View URL = http://kubeopsview.</span>$MyDomain<span style="color:#e6db74">:8080/#scale=1.5&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm repo add grafana-charts https://grafana.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create namespace monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í”„ë¡œë©”í…Œìš°ìŠ¤ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>curl -fsSL https://karpenter.sh/<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>KARPENTER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/getting-started/getting-started-with-karpenter/prometheus-values.yaml | tee prometheus-values.yaml
</span></span><span style="display:flex;"><span>helm install --namespace monitoring prometheus prometheus-community/prometheus --values prometheus-values.yaml --set alertmanager.enabled<span style="color:#f92672">=</span>false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ë¼íŒŒë‚˜ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>curl -fsSL https://karpenter.sh/<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>KARPENTER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/getting-started/getting-started-with-karpenter/grafana-values.yaml | tee grafana-values.yaml
</span></span><span style="display:flex;"><span>helm install --namespace monitoring grafana grafana-charts/grafana --values grafana-values.yaml --set service.type<span style="color:#f92672">=</span>LoadBalancer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># admin ì•”í˜¸</span>
</span></span><span style="display:flex;"><span>kubectl get secret --namespace monitoring grafana -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.admin-password}&#34;</span> | base64 --decode ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê·¸ë¼íŒŒë‚˜ ì ‘ì†</span>
</span></span><span style="display:flex;"><span>kubectl annotate service grafana -n monitoring <span style="color:#e6db74">&#34;external-dns.alpha.kubernetes.io/hostname=grafana.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;grafana URL = http://grafana.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p><img src="./images/trying-to-enable-grafana.png" alt="trying-to-enable-grafana"></p>
<h3 id="7-1-karpenter-í…ŒìŠ¤íŠ¸-ì…‹ì—…">7-1. Karpenter í…ŒìŠ¤íŠ¸ ì…‹ì—…</h3>
<ul>
<li><code>terminationGracePeriodSeconds: 0</code>
<ul>
<li>ì •ìƒ ì¢…ë£Œ ë™ì‘ì´ ìˆ˜í–‰ë˜ëŠ” ì‹œê°„(Grace Period) ì„¤ì •, 0ìœ¼ë¡œ ì„¤ì • ì‹œ ë°”ë¡œ ê°•ì œ ì¢…ë£Œ</li>
<li>Docsì—ì„œëŠ” <strong>ê°•ë ¥í•˜ê²Œ ê¶Œì¥í•˜ì§€ ì•Šì§€ë§Œ</strong> ì‹¤ìŠµì˜ ë¹ ë¥¸ ì§„í–‰ì„ ìœ„í•´ ì„¤ì • (ì°¸ì¡°: <a href="https://kubernetes.io/ko/docs/tasks/run-application/force-delete-stateful-set-pod/">k8s Docs</a>)</li>
</ul>
</li>
<li>ì´ˆê¸° ì…‹ì—…ì˜ ë ˆí”Œë¦¬ì¹´ì…‹ ìš”ì²­ ìˆ˜ëŠ” 5ê°œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># pause íŒŒë“œ 1ê°œì— CPU 1ê°œ ìµœì†Œ ë³´ì¥ í• ë‹¹</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          image: public.ecr.aws/eks-distro/kubernetes/pause:3.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment inflate --replicas <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>kubectl logs -f -n karpenter -l app.kubernetes.io/name<span style="color:#f92672">=</span>karpenter -c controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ 1ê°œ ìƒì„±ì´ í™•ì¸ ë˜ì–´ì•¼ í•¨.</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-spot-instance-requests --filters <span style="color:#e6db74">&#34;Name=state,Values=active&#34;</span> --output table
</span></span><span style="display:flex;"><span>kubectl get node -l karpenter.sh/capacity-type<span style="color:#f92672">=</span>spot -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].metadata.labels}&#39;</span> | jq
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>eks.amazonaws.com/capacityType,karpenter.sh/capacity-type,node.kubernetes.io/instance-type
</span></span></code></pre></div><p><img src="./images/check-spot-instance-creation-for-karpenter-test.png" alt="check-spot-instance-creation-for-karpenter-test"></p>
<p><img src="./images/karpenter-monitoring-unschedulable-and-also-provisionable-pods.png" alt="karpenter-monitoring-unschedulable-and-also-provisionable-pods"></p>
<p><img src="./images/new-spot-instance-in-eks-node-viewer.png" alt="new-spot-instance-in-eks-node-viewer"></p>
<h3 id="7-2-scale-down-í…ŒìŠ¤íŠ¸">7-2. Scale down í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>Deploymentë¥¼ ì§€ìš°ë©´, 30ì´ˆ ì´í›„ &lsquo;ë¹„ì–´ìˆëŠ”&rsquo; ë…¸ë“œ(ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤)ë¥¼ ì‚­ì œ
<ul>
<li><code>ttlSecondsAfterEmpty: 30</code> ì§€ì •í•˜ì˜€ê¸° ë•Œë¬¸</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Now, delete the deployment. After 30 seconds (ttlSecondsAfterEmpty), Karpenter should terminate the now empty nodes.</span>
</span></span><span style="display:flex;"><span>kubectl delete deployment inflate
</span></span><span style="display:flex;"><span>kubectl logs -f -n karpenter -l app.kubernetes.io/name<span style="color:#f92672">=</span>karpenter -c controller
</span></span></code></pre></div><p><img src="./images/karpenter-terminates-spot-instance-ttlSecondsAfterEmpty.png" alt="karpenter-terminates-spot-instance-ttlSecondsAfterEmpty"></p>
<h3 id="7-3-consolidation-í…ŒìŠ¤íŠ¸">7-3. Consolidation í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>
<p>Consolidationì´ ìƒì†Œí•œ ë‹¨ì–´ë¼ ë”°ë¡œ ê²€ìƒ‰</p>
<ul>
<li>ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ í™œìš©ë„ë¥¼ ë†’ì´ê³  ë¹„ìš©ì„ ì ˆê°í•˜ê¸° ìœ„í•´ ì‘ì—… ë¶€í•˜ë¥¼ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì´ë™ì‹œí‚¤ëŠ” ê¸°ëŠ¥</li>
<li>ìœ„ì—ì„œ ì§€ì •í–ˆë˜ ttlSecondsAfterEmptyê³¼ ë™ì‹œ ì‚¬ìš© ë¶ˆê°€ (ì°¸ì¡°: <a href="https://kingofbackend.tistory.com/252">ì•„ì´ì—  !ë‚˜ì´ë¡±ë§¨ Blog</a>)</li>
</ul>
</li>
<li>
<p>ì‹¤ìŠµì—ì„œëŠ” 12ê°œì˜ ë ˆí”Œë¦¬ì¹´ì…‹ì„ ìƒì„±í•˜ì—¬ 12Giì˜ ë©”ëª¨ë¦¬ ìš”ì²­ì„ ë°œìƒ</p>
</li>
<li>
<p><strong>ì›ë˜ ì˜ˆìƒí•œ ê²ƒ</strong></p>
<ul>
<li>Karpenterê°€ m5.large ì¸ìŠ¤í„´ìŠ¤ 2ê°œì— ë¶„ì‚° ë°°ì¹˜ (m5.large: 8Gi)
<ul>
<li>(8Gi - ì•½ 600Mi) * 2 = 14.8Gi: kubeletì—ì„œ ì˜ˆì•½í•œ 600Mi ì œì™¸</li>
</ul>
</li>
<li>5ê°œë¡œ ì¤„ì´ë©´ ì¸ìŠ¤í„´ìŠ¤ í•˜ë‚˜ë¥¼ ì‚­ì œ, ë ˆí”Œë¦¬ì¹´ì…‹ì„ ìœ„í•œ m5.large ì¸ìŠ¤í„´ìŠ¤ 1ê°œë§Œ ë‚¨ìŒ</li>
<li>ë‹¤ì‹œ 1ê°œë¡œ ì¤„ì´ë©´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ c5.largeë¡œ ë³€ê²½í•˜ì—¬ ìµœì í™”ë¥¼ ì§„í–‰</li>
</ul>
</li>
<li>
<p><strong>ì‹¤ì œ</strong></p>
<ul>
<li>CPU í•˜ë‚˜ë‹¹ Pod í•˜ë‚˜, ì¦‰ 1:1 ë¦¬ì†ŒìŠ¤ ë§¤ì¹­
<ul>
<li><code>resources.requests.cpu: 1</code></li>
</ul>
</li>
<li>Karpenterê°€ m5.xlarge ì¸ìŠ¤í„´ìŠ¤ 3ê°œì— ë°°ì¹˜ (m5.xlarge.vCPU: 4)
<ul>
<li>4 * 3 = 12: ê° ë…¸ë“œ ë‹¹, Pod 4ê°œ ì”© ë°°ì¹˜</li>
<li>ê¸°ì¡´ spot ì¸ìŠ¤í„´ìŠ¤ëŠ” ì œê±°ë¨</li>
</ul>
</li>
<li>ë ˆí”Œë¦¬ì¹´ì…‹ì„ 5ê°œë¡œ ì¤„ì´ë©´ í•„ìš”ì—†ì–´ì§„ 2ê°œì˜ m5.xlarge ë…¸ë“œë§Œ ì‚­ì œ
<ul>
<li>log í™•ì¸ ì‹œ, í•œ ë²ˆì— ë…¸ë“œ 2ê°œ ì‚­ì œê°€ ì•„ë‹Œ <strong>1ê°œ ì‚­ì œ í›„ ì¬í™•ì¸ë‹¤ìŒ, ì¶”ê°€ ì‚­ì œ ì§„í–‰</strong></li>
<li>ë ˆí”Œë¦¬ì¹´ì…‹ì„ ìœ„í•œ m5.large ì¸ìŠ¤í„´ìŠ¤ëŠ” 2ê°œ ë‚¨ìŒ</li>
</ul>
</li>
<li><strong>(ì˜ˆìƒê³¼ ë™ì¼)</strong> ë‹¤ì‹œ 1ê°œë¡œ ì¤„ì´ë©´ c5.largeë¡œ ë³€ê²½í•˜ì—¬ ìµœì í™” ì§„í–‰</li>
</ul>
</li>
<li>
<p>(ì°¸ê³ ) condon: í†µì œ, ì°¨ë‹¨ (ì¶œì²˜: <a href="https://dictionary.cambridge.org/ko/%EC%82%AC%EC%A0%84/%EC%98%81%EC%96%B4/cordon">Cambrige Dictionary</a>)</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê¸°ì¡´ì˜ í”„ë¡œë¹„ì €ë„ˆ ì‚­ì œ(ttySecondsAfterEmpty ì¶©ëŒ) í›„ ìƒˆ í”„ë¡œë¹„ì €ë„ˆ ì ìš©</span>
</span></span><span style="display:flex;"><span>kubectl delete provisioners default
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: karpenter.sh/v1alpha5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  consolidation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    type: karpenter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  limits:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cpu: 1000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      memory: 1000Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  providerRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  requirements:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: karpenter.sh/capacity-type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - on-demand
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - key: node.kubernetes.io/instance-type
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      operator: In
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      values:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - c5.large
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - m5.large
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - m5.xlarge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì•ì—ì„œ í–ˆë˜ í…ŒìŠ¤íŠ¸ì™€ ë™ì¼í•œ deployment ì ìš©</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        app: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      terminationGracePeriodSeconds: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: inflate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          image: public.ecr.aws/eks-distro/kubernetes/pause:3.7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              cpu: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë ˆí”Œë¦¬ì¹´ì…‹ 12ê°œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment inflate --replicas <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>kubectl logs -f -n karpenter -l app.kubernetes.io/name<span style="color:#f92672">=</span>karpenter -c controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># m5.xlarge ë…¸ë“œ 4ê°œ ìƒì„± í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get node -l type<span style="color:#f92672">=</span>karpenter
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>eks.amazonaws.com/capacityType,karpenter.sh/capacity-type
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>node.kubernetes.io/instance-type,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë ˆí”Œë¦¬ì¹´ì…‹ 5ê°œë¡œ ì¶•ì†Œ</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment inflate --replicas <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë¡œê·¸ë¥¼ í†µí•´ í™•ì¸í•˜ë©´, í•„ìš”ì—†ëŠ” ë…¸ë“œë¥¼ ì°¨ë‹¨(í†µì œ)í•˜ê³  drainì„ ìˆ˜í–‰ì„ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INFO controller.deprovisioning deprovisioning via consolidation delete, terminating 1 machines ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INFO controller.termination cordoned node ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INFO controller.termination deleted node ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DEBUG controller deleted launch template ...</span>
</span></span><span style="display:flex;"><span>kubectl logs -f -n karpenter -l app.kubernetes.io/name<span style="color:#f92672">=</span>karpenter -c controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë ˆí”Œë¦¬ì¹´ì…‹ 1ê°œë¡œ ì¶•ì†Œ í›„ ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INFO controller.consolidation Launching node with 1 pods requesting ... from types c5.large</span>
</span></span><span style="display:flex;"><span>kubectl scale deployment inflate --replicas <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>kubectl logs -f -n karpenter -l app.kubernetes.io/name<span style="color:#f92672">=</span>karpenter -c controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ í™•ì¸ í›„ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl get node -l type<span style="color:#f92672">=</span>karpenter
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>eks.amazonaws.com/capacityType,karpenter.sh/capacity-type
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>node.kubernetes.io/instance-type,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>kubectl delete deployment inflate
</span></span></code></pre></div><p><img src="./images/karpenter-creates-4-m5-xlarge-nodes-in-logs.png" alt="karpenter-creates-4-m5-xlarge-nodes-in-logs"></p>
<p><img src="./images/karpenter-creates-4-m5-xlarge-nodes-in-eks-node-viewer.png" alt="karpenter-creates-4-m5-xlarge-nodes-in-eks-node-viewer"></p>
<p><img src="./images/karpenter-monitoring-changing-deprovisioning-in-logs.png" alt="karpenter-monitoring-changing-deprovisioning-in-logs"></p>
<p><img src="./images/karpenter-node-deprovisioning-consequently-in-kubeopsview-1.png" alt="karpenter-node-deprovisioning-consequently-in-kubeopsview-1"></p>
<p><img src="./images/karpenter-node-deprovisioning-consequently-in-kubeopsview-2.png" alt="karpenter-node-deprovisioning-consequently-in-kubeopsview-2"></p>
<p><img src="./images/karpenter-replace-node-to-c5-large-in-logs.png" alt="karpenter-replace-node-to-c5-large-in-logs"></p>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <div class="card w-full bg-base-100 shadow-xl">
  <div class="card-body" id="adbody">
      <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1254864146899485"
          crossorigin="anonymous"></script>
      
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1254864146899485"
          data-ad-slot="3556422150" data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </div>
  
  <script>
      let adsection = document.getElementsByClassName("adsbygoogle")[0];
      let adfallback = document.getElementById("adfallback");
      adfallback.style.display = "none";
      if (window.getComputedStyle(adsection).display == "none") {
          document.getElementById("adbody").style.display = "none";
          adfallback.style.display = "block";
      } 
  </script>
</div>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho7969@ubuntu.com">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/aws-eks-study-week4/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">AWS EKS ìŠ¤í„°ë”” 4ì£¼ì°¨ - Observability</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/how-to-backup-gpg-key-to-personal-media/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">GnuPG í‚¤ ë°±ì—…í•˜ê¸°</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho7969@ubuntu.com">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
      <p>
        Â© 2025 kkumtree and contributors All rights reserved.<br>
        Licensed under <br>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
          CC BY-NC-ND 4.0
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg">
        </a>
      </p>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
