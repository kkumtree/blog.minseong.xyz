<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="apple-icon-180x180" sizes="180x180" href='/img/favicon/apple-icon-180x180.png'>
    <link rel="icon" type="image/png" sizes="32x32" href='/img/favicon/favicon-32x32.png'>
    <link rel="icon" type="image/png" sizes="16x16" href='/img/favicon/favicon-16x16.png'>
    <title>AWS EKS ìŠ¤í„°ë”” 3ì£¼ì°¨ - Storage | kkumtree</title>
    
    <meta property="og:site_name" content="kkumtree" />
    <meta property="og:title" content="AWS EKS ìŠ¤í„°ë”” 3ì£¼ì°¨ - Storage" />

    
    <meta property="og:image" content='https://blog.minseong.xyz/post/aws-eks-study-week3/cover.jpg' />
    <meta property="og:image:secure_url" content='https://blog.minseong.xyz/post/aws-eks-study-week3/cover.jpg' />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content='https://blog.minseong.xyz/post/aws-eks-study-week3/cover.jpg' />

    
    <link rel="stylesheet" href="https://blog.minseong.xyz/sass/theme.min.05bc9a89b9988ba7449154a7ccd83133b7df79fac13cc1945cffac151ac54dbb.css">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCJ1CESNKD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCJ1CESNKD');
</script><body><header id="navigation" class="p-navigation is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo" style="min-width: 6rem;">
        <a class="p-navigation__link" href="/">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="/%20/img/BlogWhite.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Blog</span>
        </a>
      </div>
      <a href="#navigation" class="p-navigation__toggle--open" title="menu">Menu</a>
      <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">Close menu</a>
    </div>
    <nav class="p-navigation__nav" aria-label="Example sub navigation">
      <ul class="p-navigation__items">
        
      </ul>

      <ul class="p-navigation__items">
        
        <li class="p-navigation__item--dropdown-toggle" id="link-4">
          <a class="p-navigation__link" aria-controls="account-menu">
            ğŸ”—
          </a>
          <ul class="p-navigation__dropdown--right" id="account-menu" aria-hidden="true">
            
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header><div id="content">


<main>
  <section class="p-strip--image main-strip"
    }
    style="background-image:url('cover.jpg'); background-position: center; background-repeat: no-repeat; background-size: cover;"
    >
      <div class="row">
        
        <div class="col-6">
          <div class="p-card--overlay">
            <h2>AWS EKS ìŠ¤í„°ë”” 3ì£¼ì°¨ - Storage</h2>
            <ul class="p-card__content p-inline-list--middot">
              
              <li class="p-inline-list__item">
                kkumtree
              </li>
              
            </ul>
            <p><u class=" timedisplay" style="text-decoration-style: dotted;">2023-05-12T05:36:38&#43;09:00</u></p>
            <p class="p-card__content"></p>
            
            <a href="/tags/aws" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">AWS</span>
              </div>
            </a>
            
            <a href="/tags/eks" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">EKS</span>
              </div>
            </a>
            
            <a href="/tags/cloudnet@" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">CloudNet@</span>
              </div>
            </a>
            
            <a href="/tags/storage" class="tag">
              <div class="p-chip">
                <span class="p-chip__value">storage</span>
              </div>
            </a>
            
          </div>
        </div>
        
      </div>
  </section>
  <section class="p-strip">
  <div class="row">
  <p>ì´ë²ˆ ì£¼ì°¨ì—ëŠ” ìŠ¤í† ë¦¬ì§€ì— ëŒ€í•´ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
ì§€ë‚œë²ˆ kOps ìŠ¤í„°ë””ì—ì„œ ë‹¤ë£¨ì—ˆë˜ ë‚´ìš©ì´ì§€ë§Œ, ë¶€ì¡±í–ˆë˜ ë‚´ìš©ì„ ë³´ì¶©í•˜ë©´ì„œ ì‘ì„±ì„ í•´ë³´ì•˜ìŠµë‹ˆë‹¤.</p>
<p>ì£¼ìš”í•œ ë‚´ìš©ì€&hellip;</p>
<ul>
<li>NodeAffinityë¥¼ ì´ìš©í•œ ë¼ë²¨ë§</li>
<li>AWS EBS controllerì˜ ê²½ìš°, AWS managed policyë¥¼ í™œìš©</li>
<li>AWS Volume SnapShots Controllerë¥¼ í†µí•œ ë³¼ë¥¨ ë°±ì—…</li>
<li>AWS EFS controllerì—ì„œì˜ ë™ì  í”„ë¡œë¹„ì €ë‹</li>
<li>AWS EKS ì‹ ê·œ ë…¸ë“œê·¸ë£¹ ìƒì„±</li>
</ul>
<p>ë³„ë„ë¡œ <code>kube-ops-view</code>ì˜ ê²½ìš°, ì›¹ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì„ ë•Œê¹Œì§€ ì‹œê°„ì´ ì†Œìš”ëœë‹¤ëŠ” ì ì´ ìˆìŠµë‹ˆë‹¤.</p>
<h2 id="1-ì‹¤ìŠµ-í™˜ê²½-ë°°í¬">1. ì‹¤ìŠµ í™˜ê²½ ë°°í¬</h2>
<ul>
<li>2ì£¼ì°¨ì— ì‹¤ìŠµí–ˆë˜ ë‚´ìš©ë“¤ì„ ë¯¸ë¦¬ ë°°í¬
<ol>
<li>AWS LB</li>
<li>ExternalDNS</li>
<li>kube-ops-view</li>
</ol>
</li>
<li>context ì´ë¦„ ë³€ê²½
<ul>
<li>ì§€ë‚œ ë²ˆê¹Œì§€ pkosê°€ ëœ¨ëŠ” í˜„ìƒì´ ìˆì—ˆëŠ”ë°, ë‹‰ë„¤ì„ì„ ë³„ë„ ì§€ì •í•  ìˆ˜ ìˆìŒ</li>
</ul>
</li>
<li>EFS ìƒì„± ê´€ë ¨ cloudformationì´ ì¶”ê°€ë˜ì—ˆìŒ
<ul>
<li>EFS FS ID ì¡°íšŒë¥¼ í•˜ê¸° ìœ„í•´ aws-cli í•„í„° í™œìš© <a href="https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/cli-usage-filter.html">(ì¶œì²˜: AWS Docs)</a></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ìŠµ YAML íŒŒì¼</span>
</span></span><span style="display:flex;"><span>curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick2.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cloudformation ìŠ¤íƒ ìƒì„±</span>
</span></span><span style="display:flex;"><span>aws cloudformation deploy --template-file eks-oneclick2.yaml --stack-name myeks --parameter-overrides KeyName<span style="color:#f92672">=</span>aews SgIngressSshCidr<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s ipinfo.io/ip<span style="color:#66d9ef">)</span>/32  MyIamUserAccessKeyID<span style="color:#f92672">=</span>AKIA5... MyIamUserSecretAccessKey<span style="color:#f92672">=</span>CVNa2... ClusterBaseName<span style="color:#f92672">=</span>myeks --region ap-northeast-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh -i ~/.ssh/aews.pem ec2-user@<span style="color:#66d9ef">$(</span>aws cloudformation describe-stacks --stack-name myeks --query <span style="color:#e6db74">&#39;Stacks[*].Outputs[0].OutputValue&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©</span>
</span></span><span style="display:flex;"><span>kubectl ns default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) context ì´ë¦„ ë³€ê²½</span>
</span></span><span style="display:flex;"><span>NICK<span style="color:#f92672">=</span>kkumtree
</span></span><span style="display:flex;"><span>kubectl ctx
</span></span><span style="display:flex;"><span>kubectl config rename-context admin@myeks.ap-northeast-2.eksctl.io $NICK@myeks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EFS í™•ì¸ : AWS ê´€ë¦¬ì½˜ì†” EFS í™•ì¸</span>
</span></span><span style="display:flex;"><span>EfsFsId<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws efs describe-file-systems --query <span style="color:#e6db74">&#39;FileSystems[*].FileSystemId&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $EfsFsId
</span></span><span style="display:flex;"><span>mount -t nfs4 -o nfsvers<span style="color:#f92672">=</span>4.1,rsize<span style="color:#f92672">=</span>1048576,wsize<span style="color:#f92672">=</span>1048576,hard,timeo<span style="color:#f92672">=</span>600,retrans<span style="color:#f92672">=</span>2,noresvport $EfsFsId.efs.ap-northeast-2.amazonaws.com:/ /mnt/myefs
</span></span><span style="display:flex;"><span>df -hT --type nfs4
</span></span><span style="display:flex;"><span>mount | grep nfs4
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Test efs exist with file &#34;</span> &gt; /mnt/myefs/memo.txt
</span></span><span style="display:flex;"><span>cat /mnt/myefs/memo.txt
</span></span><span style="display:flex;"><span>rm -f /mnt/myefs/memo.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ë° CSI ë…¸ë“œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get sc
</span></span><span style="display:flex;"><span>kubectl get sc gp2 -o yaml | yh
</span></span><span style="display:flex;"><span>kubectl get csinodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>eksctl get iamidentitymapping --cluster myeks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ IP í™•ì¸ ë° PrivateIP ë³€ìˆ˜ ì§€ì •</span>
</span></span><span style="display:flex;"><span>N1<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2a -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>N2<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2b -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>N3<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.kubernetes.io/zone --selector<span style="color:#f92672">=</span>topology.kubernetes.io/zone<span style="color:#f92672">=</span>ap-northeast-2c -o jsonpath<span style="color:#f92672">={</span>.items<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.status.addresses<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.address<span style="color:#f92672">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N1=</span>$N1<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N2=</span>$N2<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;export N3=</span>$N3<span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span>echo $N1, $N2, $N3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>NGSGID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ec2 describe-security-groups --filters Name<span style="color:#f92672">=</span>group-name,Values<span style="color:#f92672">=</span>*ng1* --query <span style="color:#e6db74">&#34;SecurityGroups[*].[GroupId]&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>aws ec2 authorize-security-group-ingress --group-id $NGSGID --protocol <span style="color:#e6db74">&#39;-1&#39;</span> --cidr 192.168.1.100/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ ë…¸ë“œ SSH ì ‘ì†</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 hostname
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 hostname
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 hostname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œì— íˆ´ ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 sudo yum install links tree jq tcpdump sysstat -y
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 sudo yum install links tree jq tcpdump sysstat -y
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 sudo yum install links tree jq tcpdump sysstat -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS LB, ExternalDNS ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>helm repo add eks https://aws.github.io/eks-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName<span style="color:#f92672">=</span>$CLUSTER_NAME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set serviceAccount.create<span style="color:#f92672">=</span>false --set serviceAccount.name<span style="color:#f92672">=</span>aws-load-balancer-controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ExternalDNS</span>
</span></span><span style="display:flex;"><span>MyDomain<span style="color:#f92672">=</span>awskops.click
</span></span><span style="display:flex;"><span>MyDnzHostedZoneId<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws route53 list-hosted-zones-by-name --dns-name <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MyDomain<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span> --query <span style="color:#e6db74">&#34;HostedZones[0].Id&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>echo $MyDomain, $MyDnzHostedZoneId
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml
</span></span><span style="display:flex;"><span>MyDomain<span style="color:#f92672">=</span>$MyDomain MyDnzHostedZoneId<span style="color:#f92672">=</span>$MyDnzHostedZoneId envsubst &lt; externaldns.yaml | kubectl apply -f -
</span></span></code></pre></div><h3 id="1-1-kube-ops-view">1-1. kube-ops-view</h3>
<ul>
<li>ì‹œê°ì ìœ¼ë¡œ í˜„ì¬ k8sì˜ ìƒíƒœë¥¼ ë³¼ ìˆ˜ ìˆëŠ” íˆ´</li>
<li>ì•ˆë˜ëŠ” ì¤„ ì•Œì•˜ëŠ”ë°, ë·°ì–´ê°€ ëœ° ë•Œê¹Œì§€ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì´ì—ˆìŒ.</li>
</ul>
<p><img src="./images/1-kube-ops-view.png" alt="1-kube-ops-view"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># kube-ops-view</span>
</span></span><span style="display:flex;"><span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
</span></span><span style="display:flex;"><span>helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set env.TZ<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Asia/Seoul&#34;</span> --namespace kube-system
</span></span><span style="display:flex;"><span>kubectl patch svc -n kube-system kube-ops-view -p <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;LoadBalancer&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span>kubectl annotate service kube-ops-view -n kube-system <span style="color:#e6db74">&#34;external-dns.alpha.kubernetes.io/hostname=kubeopsview.</span>$MyDomain<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Kube Ops View URL = http://kubeopsview.</span>$MyDomain<span style="color:#e6db74">:8080/#scale=1.5&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì´ë¯¸ì§€ ì •ë³´ í™•ì¸ &gt; eksctl ì„¤ì¹˜/ì—…ë°ì´íŠ¸ addon í™•ì¸ &gt; IRSA í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pods --all-namespaces -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[*].spec.containers[*].image}&#34;</span> | tr -s <span style="color:#e6db74">&#39;[[:space:]]&#39;</span> <span style="color:#e6db74">&#39;\n&#39;</span> | sort | uniq -c
</span></span><span style="display:flex;"><span>eksctl get addon --cluster $CLUSTER_NAME
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster $CLUSTER_NAME
</span></span></code></pre></div><h2 id="2-ìŠ¤í† ë¦¬ì§€ì˜-ì´í•´">2. ìŠ¤í† ë¦¬ì§€ì˜ ì´í•´</h2>
<ul>
<li>git ì €ì¥ì†Œë¥¼ ë§ˆìš´íŠ¸í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” gitRepoë„ ìˆìŒ <a href="https://bcho.tistory.com/1259">(ì¶œì²˜: ì¡°ëŒ€í˜‘ë‹˜ì˜ ë¸”ë¡œê·¸)</a></li>
</ul>
<ol>
<li>EmptyDir(Pod ì„ì‹œ Volume)ì˜ Lifecycle
<ul>
<li>Pod ìƒì„± ì‹œ, Volumeì´ í•¨ê»˜ ìƒì„±ë˜ê³  Pod ì‚­ì œ ì‹œ, Volumeì´ <strong>ì‚­ì œ</strong> ë¨</li>
<li>ì´ë•Œ, PodëŠ” Stateless(ìƒíƒœê°€ ì—†ëŠ”) ì• í”Œë¦¬ì¼€ì´ì…˜</li>
<li>ì˜êµ¬ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ì¡´í•˜ë ¤ë©´ ë³„ë„ì˜ DBì²˜ëŸ¼ ë³„ë„ì˜ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•  í•„ìš”ì„±ì´ ìˆìŒ</li>
</ul>
</li>
<li>PV(Persistent Volume): Podì™€ëŠ” ë³„ê°œì¸ API ê°ì²´
<ol>
<li>hostPath(ë¡œì»¬ ë³¼ë¥¨)
<ul>
<li>PV: ë„¤íŠ¸ì›Œí¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ëª¨ë°©í•˜ê¸° ìœ„í•´, ì›Œì»¤ë…¸ë“œì˜ íŒŒì¼ì´ë‚˜ ë””ë ‰í„°ë¦¬ë¥¼ ë§ˆìš´íŠ¸í•˜ì—¬ ì‚¬ìš©
<ul>
<li>ì›Œì»¤ë…¸ë“œì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ëŠ”ë° ìœ ìš© (ì˜ˆ: ì›Œì»¤ë…¸ë“œì˜ ë¡œê·¸ íŒŒì¼ ì ‘ê·¼)</li>
<li>ê°™ì€ hostPathì— ìˆëŠ” ë³¼ë¥¨ì€ ì—¬ëŸ¬ Pod ì‚¬ì´ì—ì„œ ê³µìœ ë˜ì–´ ì‚¬ìš©ëœë‹¤.</li>
</ul>
</li>
<li>Stateful(ìƒíƒœê°€ ìˆëŠ”) ì• í”Œë¦¬ì¼€ì´ì…˜</li>
<li>RO(ReadOnly)ë¥¼ ê°•í•˜ê²Œ ê¶Œì¥í•˜ê³  ìˆìŒ: ë§ì€ ë³´ì•ˆ ìœ„í—˜</li>
<li>Podê°€ ì¬ì‹œì‘ ë˜ì–´ <strong>ë‹¤ë¥¸</strong> ë…¸ë“œì—ì„œ ê¸°ë™ë  ê²½ìš°, í•´ë‹¹ ë…¸ë“œì˜ hostPathë¥¼ ì‚¬ìš©</li>
<li>ì´ì „ì˜ ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ì‚¬ìš©í•œ hostPathì˜ íŒŒì¼ ë‚´ìš©ì€ ì•¡ì„¸ìŠ¤ ë¶ˆê°€</li>
</ul>
</li>
<li>CSI(Container Storage Interface)
<ul>
<li>ê³¼ê±°ì—”, AWS EBS provisionerë¥¼ ì‚¬ìš©<br>
ì‹ ê·œê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ k8s ë²„ì „ ì—…ê·¸ë ˆì´ë“œ í•„ìš”</li>
<li>ì§€ê¸ˆì€ CSI ë“œë¼ì´ë²„ë¼ëŠ” ë³„ë„ì˜ Controller Podë¥¼<br>
ë§Œë“¤ì–´ ë™ì  provisioningì„ ì§€ì›</li>
</ul>
</li>
</ol>
</li>
<li>PV ë¡œì§ ì´í•´(Static Provisioning ê¸°ì¤€)
<ol>
<li>AWS EBS FS Volume ìƒì„± í›„ FS ID í™•ì¸</li>
<li>PV YAMLì •ì˜ íŒŒì¼ì— FS IDë¥¼ ê¸°ì… í›„ PV ìƒì„±</li>
<li>PVCë¥¼ ìƒì„±í•˜ì—¬ PV ìš”ì²­</li>
<li>Pod YAMLì •ì˜ íŒŒì¼ì—ì„œ Pod ê°ì²´ì— PVCë¥¼ ê¸°ì…(ë§ˆìš´íŠ¸)</li>
</ol>
</li>
<li>Dynamic Provisioning
<ul>
<li>ì¥ì : PVê°ì²´ë¥¼ ë³„ë„ë¡œ ìƒì„±í•  í•„ìš”ê°€ ì—†ìŒ</li>
<li>PVC ìƒì„±ì‹œ PVê°€ ìë™ìœ¼ë¡œ ìƒì„±ë¨</li>
<li>ìš”êµ¬ì‚¬í•­: AWS EBSì˜ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë¥¼ ì •ì˜í•˜ëŠ” Storage Class (ì¶”ìƒí™”)ê°ì²´ê°€ í•„ìš”
<ul>
<li>Name: ê³ ìœ í•œ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ê°ì²´ë¥¼ ì‹ë³„</li>
<li>Provisioner: CSI ë“œë¼ì´ë²„. ì—°ê²°ë˜ëŠ” ìŠ¤í† ë¦¬ì§€ ê¸°ìˆ  ì •ì˜
<ul>
<li>AWS EFS: efs.csi.aws.com (ë³€ê²½ë  ìˆ˜ ìˆìŒ)</li>
<li>AWS EBS: ebs.csi.aws.com (ìƒë™)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="2-1-ê¸°ë³¸-ì»¨í…Œì´ë„ˆ-í™˜ê²½ì—ì„œì˜-ì„ì‹œ-fsemptydir-ì‚¬ìš©">2-1. ê¸°ë³¸ ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œì˜ ì„ì‹œ fs(EmptyDir) ì‚¬ìš©</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ë°°í¬</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># date ëª…ë ¹ì–´ë¡œ í˜„ì¬ ì‹œê°„ì„ 10ì´ˆ ê°„ê²©ìœ¼ë¡œ /home/pod-out.txt íŒŒì¼ì— ì €ì¥</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/date-busybox-pod.yaml
</span></span><span style="display:flex;"><span>cat date-busybox-pod.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f date-busybox-pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒì¼ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod
</span></span><span style="display:flex;"><span>kubectl exec busybox -- tail -f /home/pod-out.txt
</span></span><span style="display:flex;"><span>Sat Jan <span style="color:#ae81ff">28</span> 15:33:11 UTC <span style="color:#ae81ff">2023</span>
</span></span><span style="display:flex;"><span>Sat Jan <span style="color:#ae81ff">28</span> 15:33:21 UTC <span style="color:#ae81ff">2023</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚­ì œ í›„ ë‹¤ì‹œ ìƒì„± í›„ íŒŒì¼ ì •ë³´ í™•ì¸ &gt; ì´ì „ ê¸°ë¡ì´ ë³´ì¡´ë˜ì–´ ìˆëŠ”ì§€?</span>
</span></span><span style="display:flex;"><span>kubectl delete pod busybox
</span></span><span style="display:flex;"><span>kubectl apply -f date-busybox-pod.yaml
</span></span><span style="display:flex;"><span>kubectl exec busybox -- tail -f /home/pod-out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ìŠµ ì™„ë£Œ í›„ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod busybox
</span></span></code></pre></div><p><img src="./images/2-emptydir.png" alt="EmptyDir-test"></p>
<h3 id="2-2-local-path-provisioner-ìŠ¤í† ë¦¬ì§€-í´ë˜ìŠ¤-ë°°í¬-pvpvc">2-2. local-path-provisioner ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ë°°í¬ (PV/PVC)</h3>
<ul>
<li>hostPath ì‚¬ìš©</li>
<li>nodeAffinity: Podë¥¼ ë°°ì¹˜í•  ìœ„ì¹˜ ì§€ì •í•˜ëŠ” íŒíŠ¸ë¥¼ ì œê³µí•˜ëŠ” ìŠ¤ì¼€ì¥´ëŸ¬ì— ì œê³µ
<ul>
<li>ìˆ˜ë™ìœ¼ë¡œ ì •ì˜ë¥¼ í•˜ì§€ ì•Šì•˜ìœ¼ë‚˜, í•´ë‹¹ ì›Œì»¤ë…¸ë“œì˜ ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ<br>
ì˜ˆ) kubernetes.io/hostname in [ip-192-168-2-xxx.ap-northeast-2.compute.internal]</li>
</ul>
</li>
</ul>
<p><img src="./images/12-node_affinity_in_pv_yaml.png" alt="nodeAffinity_in_pv_yaml"></p>
<p><img src="./images/13-node_affinity_in_node_label.png" alt="nodeAffinity_int_node_label"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ë°°í¬</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f local-path-storage.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get-all -n local-path-storage
</span></span><span style="display:flex;"><span>kubectl get pod -n local-path-storage -owide
</span></span><span style="display:flex;"><span>kubectl describe cm -n local-path-storage local-path-config
</span></span><span style="display:flex;"><span>kubectl get sc
</span></span><span style="display:flex;"><span>kubectl get sc local-path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/localpath1.yaml
</span></span><span style="display:flex;"><span>cat localpath1.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f localpath1.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pvc
</span></span><span style="display:flex;"><span>kubectl describe pvc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/localpath2.yaml
</span></span><span style="display:flex;"><span>cat localpath2.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f localpath2.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod,pv,pvc
</span></span><span style="display:flex;"><span>kubectl describe pv    <span style="color:#75715e"># Node Affinity í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- tail -f /data/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ë…¸ë“œ ì¤‘ ì–´ë””ì— íŒŒë“œê°€ ë°°í¬ë˜ì–´ ìˆëŠ”ì§€, ì•„ë˜ ê²½ë¡œì— out.txt íŒŒì¼ ì¡´ì¬ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N1ì— ì—†ëŠ” ê²½ìš° N1 -&gt; N2 -&gt; N3 ìˆœìœ¼ë¡œ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## /opt/local-path-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## â””â”€â”€ pvc-pvc-898b3f68-aec0-478f-aa55-184a107780cd_default_localpath-claim</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##    â””â”€â”€ out.txt</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 tree /opt/local-path-provisioner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í•´ë‹¹ ì›Œì»¤ë…¸ë“œ ìì²´ì—ì„œ out.txt íŒŒì¼ í™•ì¸ : pvc ê²½ë¡œëŠ” ê°ì ì‹¤ìŠµ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¦„</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 tail -f /opt/local-path-provisioner/pvc-898b3f68-aec0-478f-aa55-184a107780cd_default_localpath-claim/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì‚­ì œ í›„ PV/PVC í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app
</span></span><span style="display:flex;"><span>kubectl get pod,pv,pvc
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 tree /opt/local-path-provisioner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ë‹¤ì‹œ ì‹¤í–‰</span>
</span></span><span style="display:flex;"><span>kubectl apply -f localpath2.yaml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- head /data/out.txt
</span></span><span style="display:flex;"><span>kubectl exec -it app -- tail -f /data/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œì™€ PVC ì‚­ì œ </span>
</span></span><span style="display:flex;"><span>kubectl delete pod app
</span></span><span style="display:flex;"><span>kubectl get pv,pvc
</span></span><span style="display:flex;"><span>kubectl delete pvc localpath-claim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pv
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 tree /opt/local-path-provisioner
</span></span></code></pre></div><p><img src="./images/3-local-path-provisioner.png" alt="local-path-provisioner"></p>
<p><img src="./images/4-pvc_pending_before_app.png" alt="pvc_pending_before_pod"></p>
<p><img src="./images/5-pvc_bound_with_node_affinity.png" alt="pvc_bound_with_node_affinity"></p>
<p><img src="./images/6-volume_lost_data_after_delete_pod.png" alt="volume_lost_data_after_delete_pod"></p>
<h3 id="2-3-ì°¸ê³ -kubestr-ëª¨ë‹ˆí„°ë§-ë°-ì„±ëŠ¥-ì¸¡ì •-nvme-ssd">2-3. (ì°¸ê³ ) kubestr ëª¨ë‹ˆí„°ë§ ë° ì„±ëŠ¥ ì¸¡ì • (NVMe SSD)</h3>
<ul>
<li>ë””ìŠ¤í¬ I/O ì„±ëŠ¥ì„ ì¸¡ì •</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># kubestr íˆ´ ë‹¤ìš´ë¡œë“œ</span>
</span></span><span style="display:flex;"><span>wget https://github.com/kastenhq/kubestr/releases/download/v0.4.37/kubestr_0.4.37_Linux_amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xvfz kubestr_0.4.37_Linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> mv kubestr /usr/local/bin/ <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/kubestr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ë…¸ë“œë³„ iostat í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N1 iostat -xmdz <span style="color:#ae81ff">1</span> -p nvme0n1
</span></span><span style="display:flex;"><span>ssh ec2-user@$N2 iostat -xmdz <span style="color:#ae81ff">1</span> -p nvme0n1
</span></span><span style="display:flex;"><span>ssh ec2-user@$N3 iostat -xmdz <span style="color:#ae81ff">1</span> -p nvme0n1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„ </span>
</span></span><span style="display:flex;"><span>watch <span style="color:#e6db74">&#39;kubectl get pod -owide;echo;kubectl get pv,pvc&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸¡ì • : Read</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [NVMe] 4k ë””ìŠ¤í¬ ë¸”ë¡ ê¸°ì¤€ Read í‰ê·  IOPSëŠ” 20309 &gt;&gt; 4ë¶„ ì •ë„ ì†Œìš”</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/wikibook/kubepractice/main/ch10/fio-read.fio
</span></span><span style="display:flex;"><span>kubestr fio -f fio-read.fio -s local-path --size 10G
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸¡ì • : Write</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [NVMe] 4k ë””ìŠ¤í¬ ë¸”ë¡ ê¸°ì¤€ Write í‰ê·  IOPSëŠ” 9082 &gt;&gt; 9ë¶„ ì •ë„ ì†Œìš”</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/wikibook/kubepractice/main/ch10/fio-write.fio
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/directory/d&#39;</span> fio-write.fio
</span></span><span style="display:flex;"><span>kubestr fio -f fio-write.fio -s local-path --size 10G
</span></span></code></pre></div><p><img src="./images/7-kubestr-io-test.png" alt="7-kubestr-io-test"></p>
<h2 id="3-aws-ebs-controller">3. AWS EBS Controller</h2>
<ul>
<li>EBS CSI driver: EBS ë³¼ë¥¨ì„ ìƒì„±í•˜ê³  Podì— ì´ë¥¼ ì—°ê²°</li>
<li>PV/PVCëŠ” ReadWriteOnceë¡œ ì„¤ì •í•´ì•¼ í•¨: EBS ê¸°ë³¸ ì„¤ì •ì´ ë™ì¼ AZì˜ EC2ì¸ìŠ¤í„´ìŠ¤ë§Œ ì—°ê²° í•  ìˆ˜ ìˆìŒ <a href="https://malwareanalysis.tistory.com/598">(ì¶œì²˜: ì•…ë¶„ì¼ìƒë‹˜)</a></li>
<li>íŠ¹ì§•: ISRA ì •ì±… ì„¤ì •ì‹œ <strong>AWS Managed Policy</strong>(AWS ê´€ë¦¬í˜• ì •ì±…)ì¸ AmazonEBSCSIDriverPolicy ì‚¬ìš©
<ul>
<li>AWS LB, ExternalDNSì˜ ê²½ìš°, Customer Policy(ê³ ê° ê´€ë¦¬í˜• ì •ì±…)</li>
</ul>
</li>
<li>(ì°¸ê³ ) k8s v1.22+ ì—ì„œëŠ” ReadWriteOncePodë¥¼ ì§€ì›í•˜ë¯€ë¡œ, ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ë‹¤ë£°ë•Œ í™œìš©í•  ìˆ˜ ìˆìŒ. <a href="https://kubernetes.io/blog/2021/09/13/read-write-once-pod-access-mode-alpha/">(ì¶œì²˜: k8s blog)</a></li>
</ul>
<p><img src="./images/8-isra_aws_managed_policy_in_aws_ebs_controller.png" alt="IRSA_AWS_managed_policy_in_AWS_EBS_Controller"></p>
<h3 id="3-1-ì„¤ì¹˜-amazon-ebs-csi-driver-as-an-amazon-eks-add-on">3-1. (ì„¤ì¹˜) Amazon EBS CSI driver as an Amazon EKS add-on</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># aws-ebs-csi-driver ì „ì²´ ë²„ì „ ì •ë³´ì™€ ê¸°ë³¸ ì„¤ì¹˜ ë²„ì „(True) ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># v1.18.0-eksbuild.1</span>
</span></span><span style="display:flex;"><span>aws eks describe-addon-versions <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --addon-name aws-ebs-csi-driver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --kubernetes-version 1.24 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --query <span style="color:#e6db74">&#34;addons[].addonVersions[].[addonVersion, compatibilities[].defaultVersion]&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISRA ì„¤ì • : AWSê´€ë¦¬í˜• ì •ì±… AmazonEBSCSIDriverPolicy ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name ebs-csi-controller-sa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace kube-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster <span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --approve <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --role-only <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --role-name AmazonEKS_EBS_CSI_DriverRole
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISRA í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get sa -n kube-system ebs-csi-controller-sa -o yaml | head -5
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster myeks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>eksctl get addon --cluster <span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>kubectl get deploy,ds -l<span style="color:#f92672">=</span>app.kubernetes.io/name<span style="color:#f92672">=</span>aws-ebs-csi-driver -n kube-system
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l <span style="color:#e6db74">&#39;app in (ebs-csi-controller,ebs-csi-node)&#39;</span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l app.kubernetes.io/component<span style="color:#f92672">=</span>csi-driver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ebs-csi-controller íŒŒë“œì— 6ê°œ ì»¨í…Œì´ë„ˆ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l app<span style="color:#f92672">=</span>ebs-csi-controller -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[0].spec.containers[*].name}&#39;</span> ; echo
</span></span><span style="display:flex;"><span>ebs-plugin csi-provisioner csi-attacher csi-snapshotter csi-resizer liveness-probe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gp3 ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl get sc
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; gp3-sc.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: storage.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: gp3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">allowVolumeExpansion: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">provisioner: ebs.csi.aws.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">volumeBindingMode: WaitForFirstConsumer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  type: gp3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  allowAutoIOPSPerGBIncrease: &#39;true&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  encrypted: &#39;true&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  #fsType: ext4 # ê¸°ë³¸ê°’ì´ ext4 ì´ë©° xfs ë“± ë³€ê²½ ê°€ëŠ¥ &gt;&gt; ë‹¨ ìŠ¤ëƒ…ìƒ· ê²½ìš° ext4ë¥¼ ê¸°ë³¸ìœ¼ë¡œí•˜ì—¬ ë™ì‘í•˜ì—¬ xfs ì‚¬ìš© ì‹œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŒ - í…ŒìŠ¤íŠ¸í•´ë³´ì
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f gp3-sc.yaml
</span></span><span style="display:flex;"><span>kubectl get sc
</span></span><span style="display:flex;"><span>kubectl describe sc gp3 | grep Parameters
</span></span></code></pre></div><p><img src="./images/9-aws_ebs_controller_installation.png" alt="9-AWS_EBS_controller_installation"></p>
<h3 id="3-2-pvcpv-íŒŒë“œ-í…ŒìŠ¤íŠ¸">3-2. PVC/PV íŒŒë“œ í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>PV YAMLì„ ë”°ë¡œ ì¤€ë¹„í•˜ì§€ ì•Šì•„ë„ PVCì— ì˜í•´ PVê°€ ìƒì„±ì„ í™•ì¸
<ul>
<li>nodeAffinity: {matchExpressions: {key: topology.ebs.csi.aws.com/zone}} êµ¬ì¡°
<ul>
<li>topology.ebs.csi.aws.com/zone ë¼ë²¨ì´ ìˆëŠ” ì›Œì»¤ë…¸ë“œì— ì—°ê²°</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ë…¸ë“œì˜ EBS ë³¼ë¥¨ í™•ì¸ : tag(í‚¤/ê°’) í•„í„°ë§</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --filters Name<span style="color:#f92672">=</span>tag:Name,Values<span style="color:#f92672">=</span>$CLUSTER_NAME-ng1-Node --output table
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --filters Name<span style="color:#f92672">=</span>tag:Name,Values<span style="color:#f92672">=</span>$CLUSTER_NAME-ng1-Node --query <span style="color:#e6db74">&#34;Volumes[].{VolumeId: VolumeId, VolumeType: VolumeType, InstanceId: Attachments[0].InstanceId, State: Attachments[0].State}&#34;</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ë…¸ë“œì—ì„œ íŒŒë“œì— ì¶”ê°€í•œ EBS ë³¼ë¥¨ í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --filters Name<span style="color:#f92672">=</span>tag:ebs.csi.aws.com/cluster,Values<span style="color:#f92672">=</span>true --output table
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --filters Name<span style="color:#f92672">=</span>tag:ebs.csi.aws.com/cluster,Values<span style="color:#f92672">=</span>true --query <span style="color:#e6db74">&#34;Volumes[].{VolumeId: VolumeId, VolumeType: VolumeType, InstanceId: Attachments[0].InstanceId, State: Attachments[0].State}&#34;</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ë…¸ë“œì—ì„œ íŒŒë“œì— ì¶”ê°€í•œ EBS ë³¼ë¥¨ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> aws ec2 describe-volumes --filters Name<span style="color:#f92672">=</span>tag:ebs.csi.aws.com/cluster,Values<span style="color:#f92672">=</span>true --query <span style="color:#e6db74">&#34;Volumes[].{VolumeId: VolumeId, VolumeType: VolumeType, InstanceId: Attachments[0].InstanceId, State: Attachments[0].State}&#34;</span> --output text; date; sleep 1; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; awsebs-pvc.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ebs-claim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 4Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: gp3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f awsebs-pvc.yaml
</span></span><span style="display:flex;"><span>kubectl get pvc,pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; awsebs-pod.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: app
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  terminationGracePeriodSeconds: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: app
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    image: centos
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    command: [&#34;/bin/sh&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    args: [&#34;-c&#34;, &#34;while true; do echo \$(date -u) &gt;&gt; /data/out.txt; sleep 5; done&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: persistent-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mountPath: /data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: persistent-storage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    persistentVolumeClaim:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      claimName: ebs-claim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>kubectl apply -f awsebs-pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get VolumeAttachment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¶”ê°€ëœ EBS ë³¼ë¥¨ ìƒì„¸ ì •ë³´ í™•ì¸ </span>
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --volume-ids <span style="color:#66d9ef">$(</span>kubectl get pv -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].spec.csi.volumeHandle}&#34;</span><span style="color:#66d9ef">)</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PV ìƒì„¸ í™•ì¸ : nodeAffinity</span>
</span></span><span style="display:flex;"><span>kubectl get pv -o yaml | yh
</span></span><span style="display:flex;"><span>kubectl get node --label-columns<span style="color:#f92672">=</span>topology.ebs.csi.aws.com/zone,topology.kubernetes.io/zone
</span></span><span style="display:flex;"><span>kubectl describe node | more
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒì¼ ë‚´ìš© ì¶”ê°€ ì €ì¥ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec app -- tail -f /data/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì•„ë˜ ëª…ë ¹ì–´ëŠ” í™•ì¸ê¹Œì§€ ë‹¤ì†Œ ì‹œê°„ì´ ì†Œìš”ë¨</span>
</span></span><span style="display:flex;"><span>kubectl df-pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## íŒŒë“œ ë‚´ì—ì„œ ë³¼ë¥¨ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- sh -c <span style="color:#e6db74">&#39;df -hT --type=overlay&#39;</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- sh -c <span style="color:#e6db74">&#39;df -hT --type=ext4&#39;</span>
</span></span></code></pre></div><p><img src="./images/10-check_ebs_volume_before_pod.png" alt="check_EBS_volume_before_pod"></p>
<p><img src="./images/11-check_ebs_bound_with_pvc.png" alt="check_EBS_bound_with_pvc"></p>
<h3 id="3-3-ë³¼ë¥¨-ì¦ê°€-í…ŒìŠ¤íŠ¸">3-3. ë³¼ë¥¨ ì¦ê°€ í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>ë‹¹ì—°í•œ ì´ì•¼ê¸°ì§€ë§Œ, ì¤„ì´ëŠ” ê±´ ì•ˆë¨: ìƒˆë¡œ ì‘ì€ê±° ë§Œë“¤ì–´ì„œ ì˜®ê¸°ë©´ ëœë‹¤.
<ul>
<li>í•˜ë“œë””ìŠ¤í¬ ì¡°ê° ëª¨ìŒì„ ìƒê°í•´ë³´ì</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># í˜„ì¬ pv ì˜ ì´ë¦„ì„ ê¸°ì¤€í•˜ì—¬ 4G &gt; 10G ë¡œ ì¦ê°€ : .spec.resources.requests.storageì˜ 4Gi ë¥¼ 10Gië¡œ ë³€ê²½</span>
</span></span><span style="display:flex;"><span>kubectl get pvc ebs-claim -o jsonpath<span style="color:#f92672">={</span>.spec.resources.requests.storage<span style="color:#f92672">}</span> ; echo
</span></span><span style="display:flex;"><span>kubectl get pvc ebs-claim -o jsonpath<span style="color:#f92672">={</span>.status.capacity.storage<span style="color:#f92672">}</span> ; echo
</span></span><span style="display:flex;"><span>kubectl patch pvc ebs-claim -p <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;resources&#34;:{&#34;requests&#34;:{&#34;storage&#34;:&#34;10Gi&#34;}}}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸ : ë³¼ë¥¨ ìš©ëŸ‰ ìˆ˜ì • ë°˜ì˜ì´ ë˜ì–´ì•¼ ë˜ë‹ˆ, ìˆ˜ì¹˜ ë°˜ì˜ì´ ì¡°ê¸ˆ ëŠë¦´ìˆ˜ ìˆë‹¤</span>
</span></span><span style="display:flex;"><span>kubectl exec -it app -- sh -c <span style="color:#e6db74">&#39;df -hT --type=ext4&#39;</span>
</span></span><span style="display:flex;"><span>kubectl df-pv
</span></span><span style="display:flex;"><span>aws ec2 describe-volumes --volume-ids <span style="color:#66d9ef">$(</span>kubectl get pv -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].spec.csi.volumeHandle}&#34;</span><span style="color:#66d9ef">)</span> | jq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ìì› ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app &amp; kubectl delete pvc ebs-claim
</span></span></code></pre></div><p><img src="./images/14-resizing_ebs_volume.png" alt="resizing_EBS_volume"></p>
<h2 id="4-aws-volume-snapshots-controller">4. AWS Volume SnapShots Controller</h2>
<ul>
<li>ê°œì¸ì ìœ¼ë¡œëŠ” ì‹ ì„ í•˜ê²Œ ë‹¤ê°€ì™”ë‹¤. í‰ì†Œì—ëŠ” EC2ë¥¼ í†µìœ¼ë¡œ AMI ë°±ì—…í•˜ëŠ” ì‹ìœ¼ë¡œ ì§„í–‰í–ˆì—ˆìŒ</li>
</ul>
<h3 id="4-1-volumesnapshots-controller-ì„¤ì¹˜">4-1. Volumesnapshots Controller ì„¤ì¹˜</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install Snapshot CRDs</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f snapshot.storage.k8s.io_volumesnapshots.yaml,snapshot.storage.k8s.io_volumesnapshotclasses.yaml,snapshot.storage.k8s.io_volumesnapshotcontents.yaml
</span></span><span style="display:flex;"><span>kubectl get crd | grep snapshot
</span></span><span style="display:flex;"><span>kubectl api-resources  | grep snapshot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install Common Snapshot Controller</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f rbac-snapshot-controller.yaml,setup-snapshot-controller.yaml
</span></span><span style="display:flex;"><span>kubectl get deploy -n kube-system snapshot-controller
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l app<span style="color:#f92672">=</span>snapshot-controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install Snapshotclass</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/examples/kubernetes/snapshot/manifests/classes/snapshotclass.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f snapshotclass.yaml
</span></span><span style="display:flex;"><span>kubectl get vsclass <span style="color:#75715e"># volumesnapshotclasses</span>
</span></span></code></pre></div><p><img src="./images/15-volumesnapshots_controller.png" alt="15-volumesnapshots_controller"></p>
<h3 id="4-2-volumesnapshots-controller-í…ŒìŠ¤íŠ¸">4-2. Volumesnapshots Controller í…ŒìŠ¤íŠ¸</h3>
<ul>
<li>í…ŒìŠ¤íŠ¸ PVC/íŒŒë“œ ìƒì„± ë° ì¥ì•  ì¬í˜„</li>
<li>ì‹¤ìŠµ YAMLíŒŒì¼ì—ì„œ ebs-claimì´ë€ ì´ë¦„ì„ ê°€ì§„ PVCë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ì˜€ìŒ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># PVC ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl apply -f awsebs-pvc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>kubectl apply -f awsebs-pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒì¼ ë‚´ìš© ì¶”ê°€ ì €ì¥ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec app -- tail -f /data/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VolumeSnapshot ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/ebs-volume-snapshot.yaml
</span></span><span style="display:flex;"><span>cat ebs-volume-snapshot.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f ebs-volume-snapshot.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VolumeSnapshot í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get volumesnapshot
</span></span><span style="display:flex;"><span>kubectl get volumesnapshot ebs-volume-snapshot -o jsonpath<span style="color:#f92672">={</span>.status.boundVolumeSnapshotContentName<span style="color:#f92672">}</span> ; echo
</span></span><span style="display:flex;"><span>kubectl describe volumesnapshot.snapshot.storage.k8s.io ebs-volume-snapshot
</span></span><span style="display:flex;"><span>kubectl get volumesnapshotcontents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VolumeSnapshot ID í™•ì¸ </span>
</span></span><span style="display:flex;"><span>kubectl get volumesnapshotcontents -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[*].status.snapshotHandle}&#39;</span> ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS EBS ìŠ¤ëƒ…ìƒ· í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-snapshots --owner-ids self | jq
</span></span><span style="display:flex;"><span>aws ec2 describe-snapshots --owner-ids self --query <span style="color:#e6db74">&#39;Snapshots[]&#39;</span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># app &amp; pvc ì œê±° : ê°•ì œë¡œ ì¥ì•  ì¬í˜„</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app <span style="color:#f92672">&amp;&amp;</span> kubectl delete pvc ebs-claim
</span></span></code></pre></div><p><img src="./images/16-ebs_vol_snapshot_creation.png" alt="EBS_volume_snapshot_creation"></p>
<ul>
<li>ìŠ¤ëƒ…ìƒ· ë³µì› í…ŒìŠ¤íŠ¸</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ìŠ¤ëƒ…ìƒ·ì—ì„œ PVC ë¡œ ë³µì›</span>
</span></span><span style="display:flex;"><span>kubectl get pvc,pv
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; ebs-snapshot-restored-claim.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: PersistentVolumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: ebs-snapshot-restored-claim
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  storageClassName: gp3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  accessModes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - ReadWriteOnce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  resources:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    requests:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      storage: 4Gi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  dataSource:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: ebs-volume-snapshot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: VolumeSnapshot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    apiGroup: snapshot.storage.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>cat ebs-snapshot-restored-claim.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f ebs-snapshot-restored-claim.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get pvc,pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/ebs-snapshot-restored-pod.yaml
</span></span><span style="display:flex;"><span>cat ebs-snapshot-restored-pod.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f ebs-snapshot-restored-pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒì¼ ë‚´ìš© ì €ì¥ í™•ì¸ : íŒŒë“œ ì‚­ì œ ì „ê¹Œì§€ì˜ ì €ì¥ ê¸°ë¡ë„ ë‚¨ì•„ìˆê³ , íŒŒë“œ ì¬ìƒì„± í›„ ê¸°ë¡ë„ ì˜ ì €ì¥ë˜ì–´ìˆìŒ</span>
</span></span><span style="display:flex;"><span>kubectl exec app -- cat /data/out.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app <span style="color:#f92672">&amp;&amp;</span> kubectl delete pvc ebs-snapshot-restored-claim <span style="color:#f92672">&amp;&amp;</span> kubectl delete volumesnapshots ebs-volume-snapshot
</span></span></code></pre></div><p><img src="./images/17-ebs_snapshot_restored_claim.png" alt="EBS_snapshot_restored_claim"></p>
<h2 id="5-aws-efs-controller">5. AWS EFS Controller</h2>
<ul>
<li>GiB(ê¸°ë¹„ë°”ì´íŠ¸) ë‹¨ìœ„ ê¸°ì¤€ìœ¼ë¡œ ë³¼ë¥¨ì„ ì…ë ¥í–ˆëŠ”ë° ë‹¨ìœ„ 8.0E(ì—‘ì‚¬ë°”ì´íŠ¸)ê°€ ëœ¨ëŠ” ì´ìœ ?
<ul>
<li>AWS EFSëŠ” ì „ì²´ ìš©ëŸ‰ ì œí•œì´ ì—†ìŒ(ë³¼ë¥¨ í¬ê¸° í”„ë¡œë¹„ì €ë‹ ë¶ˆí•„ìš”) <a href="https://www.wisen.co.kr/pages/blog/blog-detail.html?idx=6883">(ì¶œì²˜: GS Neotek blog)</a></li>
<li>ìë™ìœ¼ë¡œ í™•ì¥ë˜ëŠ” &lsquo;í˜íƒ€ë°”ì´íŠ¸ê¸‰&rsquo; ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤ê³  í•˜ê¸° ë•Œë¬¸ì— ìì‹ ê°ìœ¼ë¡œ í‘œí˜„í•œ ê²ƒìœ¼ë¡œ ë³´ì„
<ul>
<li>íƒ„ë ¥ì ìœ¼ë¡œ ìë™ìœ¼ë¡œ ì¦ê°€í•˜ê³  ì¤„ì–´ë“¤ ìˆ˜ ìˆë‹¤ê³  í•¨ <a href="https://aws.amazon.com/ko/efs/faq/">(ì¶œì²˜: AWS EFS FAQ)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./images/18-aws_efs_almost_unlimited_storage.png" alt="AWS_EFS_almost_unlimited_storage"></p>
<h3 id="5-1-aws-efs-controller-ì„¤ì¹˜">5-1. AWS EFS Controller ì„¤ì¹˜</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># EFS ì •ë³´ í™•ì¸ </span>
</span></span><span style="display:flex;"><span>aws efs describe-file-systems --query <span style="color:#e6db74">&#34;FileSystems[*].FileSystemId&#34;</span> --output text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IAM ì •ì±… ìƒì„±</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json
</span></span><span style="display:flex;"><span>aws iam create-policy --policy-name AmazonEKS_EFS_CSI_Driver_Policy --policy-document file://iam-policy-example.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISRA ì„¤ì • : ê³ ê°ê´€ë¦¬í˜• ì •ì±… AmazonEKS_EFS_CSI_Driver_Policy ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>eksctl create iamserviceaccount <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --name efs-csi-controller-sa <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace kube-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --cluster <span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --attach-policy-arn arn:aws:iam::<span style="color:#e6db74">${</span>ACCOUNT_ID<span style="color:#e6db74">}</span>:policy/AmazonEKS_EFS_CSI_Driver_Policy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --approve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISRA í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl get sa -n kube-system efs-csi-controller-sa -o yaml | head -5
</span></span><span style="display:flex;"><span>eksctl get iamserviceaccount --cluster myeks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EFS Controller ì„¤ì¹˜</span>
</span></span><span style="display:flex;"><span>helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm upgrade -i aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --namespace kube-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --set image.repository<span style="color:#f92672">=</span>602401143452.dkr.ecr.<span style="color:#e6db74">${</span>AWS_DEFAULT_REGION<span style="color:#e6db74">}</span>.amazonaws.com/eks/aws-efs-csi-driver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --set controller.serviceAccount.create<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --set controller.serviceAccount.name<span style="color:#f92672">=</span>efs-csi-controller-sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>helm list -n kube-system
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -l <span style="color:#e6db74">&#34;app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver&#34;</span>
</span></span></code></pre></div><p><img src="./images/19-efs_controller_installation_with_customer_managed_policy.png" alt="EFS_controller_install_with_customer_managed_policy"></p>
<h3 id="5-2-static-provisioning-efs-íŒŒì¼ì‹œìŠ¤í…œì„-ë‹¤ìˆ˜ì˜-íŒŒë“œê°€-ì‚¬ìš©í•˜ê²Œ-ì„¤ì •">5-2. (Static provisioning) EFS íŒŒì¼ì‹œìŠ¤í…œì„ ë‹¤ìˆ˜ì˜ íŒŒë“œê°€ ì‚¬ìš©í•˜ê²Œ ì„¤ì •</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>watch <span style="color:#e6db74">&#39;kubectl get sc efs-sc; echo; kubectl get pv,pvc,pod&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹¤ìŠµ ì½”ë“œ clone</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/kubernetes-sigs/aws-efs-csi-driver.git /root/efs-csi
</span></span><span style="display:flex;"><span>cd /root/efs-csi/examples/kubernetes/multiple_pods/specs <span style="color:#f92672">&amp;&amp;</span> tree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EFS ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ìƒì„± ë° í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat storageclass.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f storageclass.yaml
</span></span><span style="display:flex;"><span>kubectl get sc efs-sc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PV ìƒì„± ë° í™•ì¸ : volumeHandleì„ ìì‹ ì˜ EFS íŒŒì¼ì‹œìŠ¤í…œIDë¡œ ë³€ê²½</span>
</span></span><span style="display:flex;"><span>EfsFsId<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws efs describe-file-systems --query <span style="color:#e6db74">&#34;FileSystems[*].FileSystemId&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/fs-4af69aab/</span>$EfsFsId<span style="color:#e6db74">/g&#34;</span> pv.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat pv.yaml | yh
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: PersistentVolume
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: efs-pv
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  capacity:
</span></span><span style="display:flex;"><span>    storage: 5Gi
</span></span><span style="display:flex;"><span>  volumeMode: Filesystem
</span></span><span style="display:flex;"><span>  accessModes:
</span></span><span style="display:flex;"><span>    - ReadWriteMany
</span></span><span style="display:flex;"><span>  persistentVolumeReclaimPolicy: Retain
</span></span><span style="display:flex;"><span>  storageClassName: efs-sc
</span></span><span style="display:flex;"><span>  csi:
</span></span><span style="display:flex;"><span>    driver: efs.csi.aws.com
</span></span><span style="display:flex;"><span>    volumeHandle: fs-05699d3c12ef609e2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f pv.yaml
</span></span><span style="display:flex;"><span>kubectl get pv; kubectl describe pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC ìƒì„± ë° í™•ì¸</span>
</span></span><span style="display:flex;"><span>cat claim.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f claim.yaml
</span></span><span style="display:flex;"><span>kubectl get pvc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ìƒì„± ë° ì—°ë™ : íŒŒë“œ ë‚´ì— /data ë°ì´í„°ëŠ” EFSë¥¼ ì‚¬ìš©</span>
</span></span><span style="display:flex;"><span>cat pod1.yaml pod2.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f pod1.yaml,pod2.yaml
</span></span><span style="display:flex;"><span>kubectl df-pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì •ë³´ í™•ì¸ : PVì— 5Gi ì™€ íŒŒë“œ ë‚´ì—ì„œ í™•ì¸í•œ NFS4 ë³¼ë¥¨ í¬ê¸° 8.0Eì˜ ì°¨ì´ëŠ” ë¬´ì—‡? íŒŒë“œì— 6Gi ì´ìƒ ì €ì¥ ê°€ëŠ¥í•œê°€?</span>
</span></span><span style="display:flex;"><span>kubectl get pods
</span></span><span style="display:flex;"><span>kubectl exec -ti app1 -- sh -c <span style="color:#e6db74">&#34;df -hT -t nfs4&#34;</span>
</span></span><span style="display:flex;"><span>kubectl exec -ti app2 -- sh -c <span style="color:#e6db74">&#34;df -hT -t nfs4&#34;</span>
</span></span><span style="display:flex;"><span>Filesystem           Type            Size      Used Available Use% Mounted on
</span></span><span style="display:flex;"><span>127.0.0.1:/          nfs4            8.0E         <span style="color:#ae81ff">0</span>      8.0E   0% /data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê³µìœ  ì €ì¥ì†Œ ì €ì¥ ë™ì‘ í™•ì¸</span>
</span></span><span style="display:flex;"><span>tree /mnt/myefs              <span style="color:#75715e"># ì‘ì—…ìš©EC2ì—ì„œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>tail -f /mnt/myefs/out1.txt  <span style="color:#75715e"># ì‘ì—…ìš©EC2ì—ì„œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -ti app1 -- tail -f /data/out1.txt
</span></span><span style="display:flex;"><span>kubectl exec -ti app2 -- tail -f /data/out2.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete pod app1 app2 
</span></span><span style="display:flex;"><span>kubectl delete pvc efs-claim <span style="color:#f92672">&amp;&amp;</span> kubectl delete pv efs-pv <span style="color:#f92672">&amp;&amp;</span> kubectl delete sc efs-sc
</span></span></code></pre></div><p><img src="./images/20-efs_static_provisioning_with_rwm_mode.png" alt="EFS_static_provisioning_with_rwm_mode"></p>
<h3 id="5-3-dynamic-provisioning-efs-íŒŒì¼ì‹œìŠ¤í…œì„-ë‹¤ìˆ˜ì˜-íŒŒë“œê°€-ì‚¬ìš©í•˜ê²Œ-ì„¤ì •">5-3. (Dynamic provisioning) EFS íŒŒì¼ì‹œìŠ¤í…œì„ ë‹¤ìˆ˜ì˜ íŒŒë“œê°€ ì‚¬ìš©í•˜ê²Œ ì„¤ì •</h3>
<ul>
<li>5-2ì²˜ëŸ¼ í•˜ë©´, ë§¤ ìˆœê°„ ì‚¬ëŒì˜ ì†ì´ ë” ë§ì´ ê°€ë¯€ë¡œ ë™ì  í”„ë¡œë¹„ì €ë‹ì„ ì‹¤ìŠµ</li>
<li>PVC ìƒì„±ì‹œ {provisioningMode: efs-ap}ë¥¼ ë¹„ë¡¯í•œ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€
<ul>
<li>AccessPointsë¥¼ í†µí•´ êµ¬í˜„ë˜ë©°, ì•„ì§ Fargate ë…¸ë“œëŠ” ë¯¸ì§€ì›</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>watch <span style="color:#e6db74">&#39;kubectl get sc efs-sc; echo; kubectl get pv,pvc,pod&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EFS ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ìƒì„± ë° í™•ì¸</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/storageclass.yaml
</span></span><span style="display:flex;"><span>cat storageclass.yaml | yh
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/fs-92107410/</span>$EfsFsId<span style="color:#e6db74">/g&#34;</span> storageclass.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f storageclass.yaml
</span></span><span style="display:flex;"><span>kubectl get sc efs-sc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC/íŒŒë“œ ìƒì„± ë° í™•ì¸</span>
</span></span><span style="display:flex;"><span>curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/pod.yaml
</span></span><span style="display:flex;"><span>cat pod.yaml | yh
</span></span><span style="display:flex;"><span>kubectl apply -f pod.yaml
</span></span><span style="display:flex;"><span>kubectl get pvc,pv,pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PVC/PV ìƒì„± ë¡œê·¸ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl logs -n kube-system -l app<span style="color:#f92672">=</span>efs-csi-controller -c csi-provisioner -f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec -it efs-app -- sh -c <span style="color:#e6db74">&#34;df -hT -t nfs4&#34;</span>
</span></span><span style="display:flex;"><span>Filesystem           Type            Size      Used Available Use% Mounted on
</span></span><span style="display:flex;"><span>127.0.0.1:/          nfs4            8.0E         <span style="color:#ae81ff">0</span>      8.0E   0% /data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê³µìœ  ì €ì¥ì†Œ ì €ì¥ ë™ì‘ í™•ì¸</span>
</span></span><span style="display:flex;"><span>tree /mnt/myefs              <span style="color:#75715e"># ì‘ì—…ìš©EC2ì—ì„œ í™•ì¸</span>
</span></span><span style="display:flex;"><span>kubectl exec efs-app -- bash -c <span style="color:#e6db74">&#34;cat data/out&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f pod.yaml
</span></span><span style="display:flex;"><span>kubectl delete -f storageclass.yaml
</span></span></code></pre></div><p><img src="./images/21-efs_dynamic_provisioning_in_efs-ap_mode.png" alt="EFS_dynamic_provisioning_in_efs-ap_mode"></p>
<p><img src="./images/22-check_shared_efs_and_storageclass_efs-sc_defined_in_pvc.png" alt="check_shared_EFS_&amp;_storageclass_efs-sc_defined_in_pvc"></p>
<h2 id="6-eks-pvs-for-instance-store--add-nodegroup">6. EKS PVs for Instance Store &amp; Add NodeGroup</h2>
<ul>
<li>EC2ì˜ ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ëŠ”&hellip;
<ul>
<li><a href="https://kubernetes.io/ko/docs/concepts/storage/ephemeral-volumes/">ephemeral-storage(ì„ì‹œ ë³¼ë¥¨)</a></li>
<li>ì›¹ ì½˜ì†”ì˜ EC2 ìŠ¤í† ë¦¬(EBS)ì •ë³´ì— ì¶œë ¥ë˜ì§€ ì•ŠìŒ. í„°ë¯¸ë„ì—ì„œ í™•ì¸.</li>
</ul>
</li>
<li>ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ë¦¬ì§€ì˜ ë°ì´í„° ì†ì‹¤ì˜ ì£¼ìš”í•œ ìœ í˜•ì€ ì•„ë˜ì™€ ê°™ìŒ.
<ol>
<li>ê¸°ë³¸ ë””ìŠ¤í¬ ë“œë¼ì´ë¸Œ ì˜¤ë¥˜</li>
<li>ì¸ìŠ¤í„´ìŠ¤ <strong>ì¤‘ì§€</strong></li>
<li>ì¸ìŠ¤í„´ìŠ¤ <strong>ìµœëŒ€ ì ˆì „ ëª¨ë“œ</strong> ì „í™˜</li>
<li>ì¸ìŠ¤í„´ìŠ¤ <strong>ì¢…ë£Œ</strong></li>
</ol>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/InstanceStorage.html">(ì¶œì²˜: AWS Docs)</a></li>
</ul>
<h3 id="6-1-ì‹ ê·œ-ë…¸ë“œ-ê·¸ë£¹-ìƒì„±">6-1. ì‹ ê·œ ë…¸ë“œ ê·¸ë£¹ ìƒì„±</h3>
<ul>
<li>ì‹ ê·œ ë…¸ë“œ ê·¸ë£¹ ng2ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤ìŠµ ì§„í–‰
<ul>
<li>c5d.largeì˜ EC2 ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´(ì„ì‹œ ë¸”ë¡ ìŠ¤í† ë¦¬ì§€)ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ë³¼ë¥¨ì´ ìˆëŠ” c5 ëª¨ë“  íƒ€ì…ì˜ ìŠ¤í† ë¦¬ì§€ í¬ê¸° í™•ì¸</span>
</span></span><span style="display:flex;"><span>aws ec2 describe-instance-types <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --filters <span style="color:#e6db74">&#34;Name=instance-type,Values=c5*&#34;</span> <span style="color:#e6db74">&#34;Name=instance-storage-supported,Values=true&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --query <span style="color:#e6db74">&#34;InstanceTypes[].[InstanceType, InstanceStorageInfo.TotalSizeInGB]&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‹ ê·œ ë…¸ë“œ ê·¸ë£¹ ìƒì„±</span>
</span></span><span style="display:flex;"><span>eksctl create nodegroup --help
</span></span><span style="display:flex;"><span>eksctl create nodegroup -c $CLUSTER_NAME -r $AWS_DEFAULT_REGION --subnet-ids <span style="color:#e6db74">&#34;</span>$PubSubnet1<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;</span>$PubSubnet2<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;</span>$PubSubnet3<span style="color:#e6db74">&#34;</span> --ssh-access <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -n ng2 -t c5d.large -N <span style="color:#ae81ff">1</span> -m <span style="color:#ae81ff">1</span> -M <span style="color:#ae81ff">1</span> --node-volume-size<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> --node-labels disk<span style="color:#f92672">=</span>nvme --max-pods-per-node <span style="color:#ae81ff">100</span> --dry-run &gt; myng2.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOT &gt; nvme.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  preBootstrapCommands:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Install Tools
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      yum install nvme-cli links tree jq tcpdump sysstat -y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Filesystem &amp; Mount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mkfs -t xfs /dev/nvme1n1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mkdir /data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      mount /dev/nvme1n1 /data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Get disk UUID
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      uuid=\$(blkid -o value -s UUID mount /dev/nvme1n1 /data) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # Mount the disk during a reboot
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      echo /dev/nvme1n1 /data xfs defaults,noatime 0 2 &gt;&gt; /etc/fstab
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOT</span>
</span></span><span style="display:flex;"><span>sed -i -n -e <span style="color:#e6db74">&#39;/volumeType/r nvme.yaml&#39;</span> -e <span style="color:#e6db74">&#39;1,$p&#39;</span> myng2.yaml
</span></span><span style="display:flex;"><span>eksctl create nodegroup -f myng2.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ ID í™•ì¸</span>
</span></span><span style="display:flex;"><span>NG2SGID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ec2 describe-security-groups --filters Name<span style="color:#f92672">=</span>group-name,Values<span style="color:#f92672">=</span>*ng2* --query <span style="color:#e6db74">&#34;SecurityGroups[*].[GroupId]&#34;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>aws ec2 authorize-security-group-ingress --group-id $NG2SGID --protocol <span style="color:#e6db74">&#39;-1&#39;</span> --cidr 192.168.1.100/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì›Œì»¤ ë…¸ë“œ SSH ì ‘ì†</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë…¸ë“œ ê·¸ë£¹ ìƒì„±ì‹œ ë‚˜ì˜¤ëŠ” í”„ë¡¬í”„íŠ¸ì—ì„œ ë…¸ë“œ ipë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ</span>
</span></span><span style="display:flex;"><span>N4<span style="color:#f92672">=</span>192.168.1.209
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 hostname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># í™•ì¸</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo nvme list
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo lsblk -e <span style="color:#ae81ff">7</span> -d
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo df -hT -t xfs
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo tree /data
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo cat /etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) max-pod í™•ì¸: 100ê°œ</span>
</span></span><span style="display:flex;"><span>kubectl describe node -l disk<span style="color:#f92672">=</span>nvme | grep Allocatable: -A7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (ì˜µì…˜) kubelet ë°ëª¬ íŒŒë¼ë¯¸í„° í™•ì¸ : --max-pods=29 --max-pods=100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë™ì¼ íŒŒë¼ë¯¸í„°ê°€ 2ê°œ ëœ¨ëŠ”ë°, 29ëŠ” ê¸°ë³¸ê°’ì´ê³ , 100ì€ ë…¸ë“œê·¸ë£¹ ìƒì„±ì‹œ ì§€ì •í•œ ê°’ì„.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ì— ë§ì”Œì›Œì ¸ì„œ ì ìš©ë˜ëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨. </span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 sudo ps -ef | grep kubelet
</span></span></code></pre></div><p><img src="./images/23-create_new_node_group_with_preBootstrapCommands.png" alt="create_new_node_group_with_preBootstrapCommands"></p>
<p><img src="./images/24-confirm_new_node_ip.png" alt="confirm_new_node_ip"></p>
<p><img src="./images/25-overrided_max-pods_parameter.png" alt="overrided_max-pods_parameter"></p>
<h3 id="6-2-ìŠ¤í† ë¦¬ì§€-í´ë˜ìŠ¤-ì¬ìƒì„±-ë°-io-í…ŒìŠ¤íŠ¸">6-2. ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì¬ìƒì„± ë° I/O í…ŒìŠ¤íŠ¸</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ê¸°ì¡´ ì‚­ì œ (2-2ì—ì„œ ì‹¤ìŠµí•œ ë‚´ìš© ì´ˆê¸°í™”)</span>
</span></span><span style="display:flex;"><span>kubectl delete -f local-path-storage.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ê²½ë¡œ ë³€ê²½ opt -&gt; data í›„ ì¬ìƒì„±</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/opt/data/g&#39;</span> local-path-storage.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f local-path-storage.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ëª¨ë‹ˆí„°ë§</span>
</span></span><span style="display:flex;"><span>watch <span style="color:#e6db74">&#39;kubectl get pod -owide;echo;kubectl get pv,pvc&#39;</span>
</span></span><span style="display:flex;"><span>ssh ec2-user@$N4 iostat -xmdz <span style="color:#ae81ff">1</span> -p nvme1n1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì¸¡ì • : Read</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#curl -s -O https://raw.githubusercontent.com/wikibook/kubepractice/main/ch10/fio-read.fio</span>
</span></span><span style="display:flex;"><span>kubestr fio -f fio-read.fio -s local-path --size 10G --nodeselector disk<span style="color:#f92672">=</span>nvme
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ì‚­ì œ</span>
</span></span><span style="display:flex;"><span>kubectl delete -f local-path-storage.yaml
</span></span><span style="display:flex;"><span>eksctl delete nodegroup -c $CLUSTER_NAME -n ng2
</span></span></code></pre></div><p><img src="./images/26-read_test_on_new_node_nvme.png" alt="read_test_on_new_node_nvme"></p>
<h2 id="reference">reference</h2>
<ul>
<li><a href="https://gasidaseo.notion.site/CloudNet-Blog-c9dfa44a27ff431dafdd2edacc8a1863">CloudNet@</a> Notion ë° Slack ì±„ë„</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/cli-usage-filter.html">aws-cli filter @AWS Docs</a></li>
<li><a href="https://bcho.tistory.com/1259">k8s volume @ì¡°ëŒ€í˜‘ë‹˜ì˜ ë¸”ë¡œê·¸</a></li>
<li><a href="https://malwareanalysis.tistory.com/598">AWS EBS Controller @ì•…ë¶„ì¼ìƒë‹˜ì˜ ë¸”ë¡œê·¸</a></li>
<li><a href="https://kubernetes.io/blog/2021/09/13/read-write-once-pod-access-mode-alpha/">ReadWriteOncePod(RWOP) access mode @k8s Blog</a></li>
<li><a href="https://www.wisen.co.kr/pages/blog/blog-detail.html?idx=6883">AWS EFS ap-northeast-2 region @GS Neotek Blog</a></li>
<li><a href="https://aws.amazon.com/ko/efs/faq/">EFS FAQ @AWS</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/storage/ephemeral-volumes/">ephemeral-storage @k8s Docs</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/InstanceStorage.html">EC2 Instance Store @AWS Docs</a></li>
</ul>

  </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <script src="https://giscus.app/client.js"
        data-repo="kkumtree/blog.minseong.xyz"
        data-repo-id="R_kgDOIv-sqA"
        data-category="Blog Comments"
        data-category-id="DIC_kwDOIv-sqM4CW7uO"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
      </script>
    </div>
  </section>
  <div class="card w-full bg-base-100 shadow-xl">
  <div class="card-body" id="adbody">
      <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1254864146899485"
          crossorigin="anonymous"></script>
      
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1254864146899485"
          data-ad-slot="3556422150" data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </div>
  
  <script>
      let adsection = document.getElementsByClassName("adsbygoogle")[0];
      let adfallback = document.getElementById("adfallback");
      adfallback.style.display = "none";
      if (window.getComputedStyle(adsection).display == "none") {
          document.getElementById("adbody").style.display = "none";
          adfallback.style.display = "block";
      } 
  </script>
</div>
  <section class="p-strip--light">
    <div class="row">
      
      <div class="col-12">
        <div class="p-media-object">
          <img src="https://avatars.githubusercontent.com/u/52643858?v=4" class="p-media-object__image is-round" alt="">
          <div class="p-media-object__details">
            <h3 class="p-media-object__title">
              <a href="#">kkumtree</a>
            </h3>
            <p class="p-media-object__content">plumber for infra</p>
            <ul class="p-inline-list--middot">
              <li class="p-inline-list__item"><a href="mailto:mscho7969@ubuntu.com">Email</a></li>
              <li class="p-inline-list__item"><a href="https://launchpad.net/~mscho7969">Launchpad</a></li>
              <li class="p-inline-list__item"><a href="https://github.com/kkumtree">GitHub</a></li>
            </ul>
          </div>
        </div>
         
    </div>
  </section>
  <section class="p-strip">
    <div class="row">
      <footer class="p-article-pagination">
        
        <a class="p-article-pagination__link--previous" href="/post/aws-eks-study-week2/">
          <span class="p-article-pagination__label">Previous</span>
          <span class="p-article-pagination__title">AWS EKS ìŠ¤í„°ë”” 2ì£¼ì°¨ - Network</span>
        </a>
        
        
        <a class="p-article-pagination__link--next" href="/post/modify-bastion-cidr-with-aws-cli/">
          <span class="p-article-pagination__label">Next</span>
          <span class="p-article-pagination__title">aws-clië¥¼ ì´ìš©í•œ bastion CIDR ë³€ê²½</span>
        </a>
        
      </footer>
    </div>
  </section>
</main>

        </div><section class="p-strip--accent">
  <div class="row">
    <div class="col-12">
      <h2>kkumtree</h2>
      <ul class="p-inline-list--middot is-dark">
        <li class="p-inline-list__item">
          <a href="mailto:mscho7969@ubuntu.com">Contact with (Email)</a>
        </li>
        
        
        
        <li class="p-inline-list__item">
          <a href="https://github.com/kkumtree">GitHub</a>
        </li>
        <li class="p-inline-list__item">
          <a href="https://launchpad.net/~mscho7969">Launchpad</a>
        </li>
      </ul>
      <a href="https://github.com/kkumtree/blog.minseong.xyz">Source code on GitHub</a>
      <p>
        Â© 2025 kkumtree and contributors All rights reserved.<br>
        Licensed under <br>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
          CC BY-NC-ND 4.0
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg">
          <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg">
        </a>
      </p>
    </div>
  </div><script type="text/javascript" src='/js/v-framework.js'></script>
<script type="text/javascript" src='/js/timedisplay.js'></script>
<script>

let slides = document.getElementsByClassName("main-slide");
let index = 0;
let count = slides.length;
function setSlideIndex(destination) {
    index = destination % count;
    index = index < 0 ? index * -1 : index;
    for (let i = 0; i < count; i++) {
        if(i == index) {
            slides[i].style.display = "block";
        } else {
            slides[i].style.display = "none";
        }
    }
}
function nextSlide() {
    setSlideIndex(index + 1);
}
function prevSlide() {
    setSlideIndex(index - 1);
}
setSlideIndex(0);
setInterval(nextSlide, 5000);
</script>

</body>
</html>
